<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>环境数据分析与机器学习 - 5&nbsp; R语言机器学习建模</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./CH6.html" rel="next">
<link href="./CH4.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "没有结果",
    "search-matching-documents-text": "匹配的文档",
    "search-copy-link-title": "复制搜索链接",
    "search-hide-matches-text": "隐藏其它匹配结果",
    "search-more-match-text": "更多匹配结果",
    "search-more-matches-text": "更多匹配结果",
    "search-clear-button-title": "清除",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "提交",
    "search-label": "搜索"
  }
}</script>
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>

<link href="site_libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">

<script src="site_libs/vis-9.1.0/vis-network.min.js"></script>

<script src="site_libs/visNetwork-binding-2.1.2/visNetwork.js"></script>


  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="edaml.scss">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="展开或折叠侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./CH4.html">进阶知识</a></li><li class="breadcrumb-item"><a href="./CH5.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">R语言机器学习建模</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="展开或折叠侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">环境数据分析与机器学习</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="搜索"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">前言</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">基础知识</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">绪论</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">R语言编程基础</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">环境数据整理与可视化</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">进阶知识</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">环境数据统计分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH5.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">R语言机器学习建模</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">高阶知识</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R语言深度学习建模</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">参考文献</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目录</h2>
   
  <ul>
  <li><a href="#机器学习概述" id="toc-机器学习概述" class="nav-link active" data-scroll-target="#机器学习概述"><span class="header-section-number">5.1</span> 机器学习概述</a>
  <ul>
  <li><a href="#机器学习的方式" id="toc-机器学习的方式" class="nav-link" data-scroll-target="#机器学习的方式"><span class="header-section-number">5.1.1</span> 机器学习的方式</a></li>
  <li><a href="#机器学习的任务类型" id="toc-机器学习的任务类型" class="nav-link" data-scroll-target="#机器学习的任务类型"><span class="header-section-number">5.1.2</span> 机器学习的任务类型</a></li>
  <li><a href="#机器学习的基本术语" id="toc-机器学习的基本术语" class="nav-link" data-scroll-target="#机器学习的基本术语"><span class="header-section-number">5.1.3</span> 机器学习的基本术语</a>
  <ul class="collapse">
  <li><a href="#算法与模型参数与超参数" id="toc-算法与模型参数与超参数" class="nav-link" data-scroll-target="#算法与模型参数与超参数"><span class="header-section-number">5.1.3.1</span> 算法与模型、参数与超参数</a></li>
  <li><a href="#训练集测试集和验证集" id="toc-训练集测试集和验证集" class="nav-link" data-scroll-target="#训练集测试集和验证集"><span class="header-section-number">5.1.3.2</span> 训练集、测试集和验证集</a></li>
  <li><a href="#欠拟合和过拟合" id="toc-欠拟合和过拟合" class="nav-link" data-scroll-target="#欠拟合和过拟合"><span class="header-section-number">5.1.3.3</span> 欠拟合和过拟合</a></li>
  <li><a href="#目标函数代价函数和损失函数" id="toc-目标函数代价函数和损失函数" class="nav-link" data-scroll-target="#目标函数代价函数和损失函数"><span class="header-section-number">5.1.3.4</span> 目标函数、代价函数和损失函数</a></li>
  <li><a href="#泛化性能和交叉验证误差" id="toc-泛化性能和交叉验证误差" class="nav-link" data-scroll-target="#泛化性能和交叉验证误差"><span class="header-section-number">5.1.3.5</span> 泛化性能和交叉验证误差</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#机器学习建模的步骤" id="toc-机器学习建模的步骤" class="nav-link" data-scroll-target="#机器学习建模的步骤"><span class="header-section-number">5.2</span> 机器学习建模的步骤</a></li>
  <li><a href="#mlr3机器学习建模基础" id="toc-mlr3机器学习建模基础" class="nav-link" data-scroll-target="#mlr3机器学习建模基础"><span class="header-section-number">5.3</span> mlr3机器学习建模基础</a>
  <ul>
  <li><a href="#mlr3verse的安装" id="toc-mlr3verse的安装" class="nav-link" data-scroll-target="#mlr3verse的安装"><span class="header-section-number">5.3.1</span> mlr3verse的安装</a></li>
  <li><a href="#创建任务" id="toc-创建任务" class="nav-link" data-scroll-target="#创建任务"><span class="header-section-number">5.3.2</span> 创建任务</a>
  <ul class="collapse">
  <li><a href="#创建分类任务" id="toc-创建分类任务" class="nav-link" data-scroll-target="#创建分类任务"><span class="header-section-number">5.3.2.1</span> 创建分类任务</a></li>
  <li><a href="#创建回归任务" id="toc-创建回归任务" class="nav-link" data-scroll-target="#创建回归任务"><span class="header-section-number">5.3.2.2</span> 创建回归任务</a></li>
  <li><a href="#任务对象的属性和方法" id="toc-任务对象的属性和方法" class="nav-link" data-scroll-target="#任务对象的属性和方法"><span class="header-section-number">5.3.2.3</span> 任务对象的属性和方法</a></li>
  <li><a href="#任务对象的可视化" id="toc-任务对象的可视化" class="nav-link" data-scroll-target="#任务对象的可视化"><span class="header-section-number">5.3.2.4</span> 任务对象的可视化</a></li>
  </ul></li>
  <li><a href="#划分数据" id="toc-划分数据" class="nav-link" data-scroll-target="#划分数据"><span class="header-section-number">5.3.3</span> 划分数据</a></li>
  <li><a href="#创建学习器" id="toc-创建学习器" class="nav-link" data-scroll-target="#创建学习器"><span class="header-section-number">5.3.4</span> 创建学习器</a></li>
  <li><a href="#训练模型" id="toc-训练模型" class="nav-link" data-scroll-target="#训练模型"><span class="header-section-number">5.3.5</span> 训练模型</a></li>
  <li><a href="#模型预测与预测性能" id="toc-模型预测与预测性能" class="nav-link" data-scroll-target="#模型预测与预测性能"><span class="header-section-number">5.3.6</span> 模型预测与预测性能</a></li>
  </ul></li>
  <li><a href="#超参数优化" id="toc-超参数优化" class="nav-link" data-scroll-target="#超参数优化"><span class="header-section-number">5.4</span> 超参数优化</a>
  <ul>
  <li><a href="#创建调优实例" id="toc-创建调优实例" class="nav-link" data-scroll-target="#创建调优实例"><span class="header-section-number">5.4.1</span> 创建调优实例</a></li>
  <li><a href="#创建调优器并运行调优" id="toc-创建调优器并运行调优" class="nav-link" data-scroll-target="#创建调优器并运行调优"><span class="header-section-number">5.4.2</span> 创建调优器并运行调优</a></li>
  <li><a href="#训练最优模型" id="toc-训练最优模型" class="nav-link" data-scroll-target="#训练最优模型"><span class="header-section-number">5.4.3</span> 训练最优模型</a></li>
  <li><a href="#简化超参数优化操作" id="toc-简化超参数优化操作" class="nav-link" data-scroll-target="#简化超参数优化操作"><span class="header-section-number">5.4.4</span> 简化超参数优化操作</a></li>
  <li><a href="#设置超参数配置搜索空间的其他方法" id="toc-设置超参数配置搜索空间的其他方法" class="nav-link" data-scroll-target="#设置超参数配置搜索空间的其他方法"><span class="header-section-number">5.4.5</span> 设置超参数配置搜索空间的其他方法</a>
  <ul class="collapse">
  <li><a href="#利用ps函数" id="toc-利用ps函数" class="nav-link" data-scroll-target="#利用ps函数"><span class="header-section-number">5.4.5.1</span> 利用<strong><code>ps()</code></strong>函数</a></li>
  <li><a href="#利用mlr3tuningspaces工具包" id="toc-利用mlr3tuningspaces工具包" class="nav-link" data-scroll-target="#利用mlr3tuningspaces工具包"><span class="header-section-number">5.4.5.2</span> 利用mlr3tuningspaces工具包</a></li>
  </ul></li>
  <li><a href="#基于嵌套重抽样的泛化性能评估" id="toc-基于嵌套重抽样的泛化性能评估" class="nav-link" data-scroll-target="#基于嵌套重抽样的泛化性能评估"><span class="header-section-number">5.4.6</span> 基于嵌套重抽样的泛化性能评估</a></li>
  </ul></li>
  <li><a href="#特征选择" id="toc-特征选择" class="nav-link" data-scroll-target="#特征选择"><span class="header-section-number">5.5</span> 特征选择</a>
  <ul>
  <li><a href="#特征过滤器" id="toc-特征过滤器" class="nav-link" data-scroll-target="#特征过滤器"><span class="header-section-number">5.5.1</span> 特征过滤器</a></li>
  <li><a href="#特征选择封装方法" id="toc-特征选择封装方法" class="nav-link" data-scroll-target="#特征选择封装方法"><span class="header-section-number">5.5.2</span> 特征选择封装方法</a></li>
  </ul></li>
  <li><a href="#管道与图学习器" id="toc-管道与图学习器" class="nav-link" data-scroll-target="#管道与图学习器"><span class="header-section-number">5.6</span> 管道与图学习器</a>
  <ul>
  <li><a href="#管道操作与图对象" id="toc-管道操作与图对象" class="nav-link" data-scroll-target="#管道操作与图对象"><span class="header-section-number">5.6.1</span> 管道操作与图对象</a></li>
  <li><a href="#图学习器" id="toc-图学习器" class="nav-link" data-scroll-target="#图学习器"><span class="header-section-number">5.6.2</span> 图学习器</a></li>
  </ul></li>
  <li><a href="#常用有监督机器学习算法" id="toc-常用有监督机器学习算法" class="nav-link" data-scroll-target="#常用有监督机器学习算法"><span class="header-section-number">5.7</span> 常用有监督机器学习算法</a>
  <ul>
  <li><a href="#knn算法" id="toc-knn算法" class="nav-link" data-scroll-target="#knn算法"><span class="header-section-number">5.7.1</span> KNN算法</a></li>
  <li><a href="#svm算法" id="toc-svm算法" class="nav-link" data-scroll-target="#svm算法"><span class="header-section-number">5.7.2</span> SVM算法</a></li>
  <li><a href="#cart算法" id="toc-cart算法" class="nav-link" data-scroll-target="#cart算法"><span class="header-section-number">5.7.3</span> CART算法</a></li>
  <li><a href="#nb算法" id="toc-nb算法" class="nav-link" data-scroll-target="#nb算法"><span class="header-section-number">5.7.4</span> NB算法</a></li>
  <li><a href="#集成学习方法" id="toc-集成学习方法" class="nav-link" data-scroll-target="#集成学习方法"><span class="header-section-number">5.7.5</span> 集成学习方法</a>
  <ul class="collapse">
  <li><a href="#bagging集成学习方法" id="toc-bagging集成学习方法" class="nav-link" data-scroll-target="#bagging集成学习方法"><span class="header-section-number">5.7.5.1</span> Bagging集成学习方法</a></li>
  <li><a href="#boosting集成学习方法" id="toc-boosting集成学习方法" class="nav-link" data-scroll-target="#boosting集成学习方法"><span class="header-section-number">5.7.5.2</span> Boosting集成学习方法</a></li>
  <li><a href="#stacking集成学习方法" id="toc-stacking集成学习方法" class="nav-link" data-scroll-target="#stacking集成学习方法"><span class="header-section-number">5.7.5.3</span> Stacking集成学习方法</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./CH4.html">进阶知识</a></li><li class="breadcrumb-item"><a href="./CH5.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">R语言机器学习建模</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">R语言机器学习建模</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>1955 年，人工智能之父John McCarthy等人为次年的达特茅斯会议撰写的建议书中提出了“<strong>人工智能</strong>”(Artificial Intelligence，<strong>AI</strong>)。1959年，当时在IBM公司研究跳棋游戏的Arthur Samuel提出了“<strong>机器学习</strong>”(ML)，他开发的跳棋程序能够通过跟人下棋来提升下棋水平。此后，人工智能发展几经高潮和低谷，直到进入21世纪，由于计算机硬件特别是GPU(图形处理单元)性能的大幅度提升，让机器学习技术获得突破。2006年，神经网络之父Geoffrey Hinton提出了“<strong>深度学习</strong>”的概念，再一次推动神经网络的发展。2012年，Alex Krizhevsky开发的基于卷积神经网络(CNN)的AlexNet模型在著名的ImageNet挑战中一举夺魁，识别错误率比上年冠军模型降低了10个百分点。AlexNet的出现及其优异表现让深度学习研究和应用进入空前的高潮期。2017年Google公司提出的基于注意力的Transformer模型是一个重要的转折点，极大地推动了自然语言处理(NLP)模型的发展，涌现了一批如GPT、BERT等优秀的NLP模型。2023年3月，OpenAI公司推出的ChatGPT 4.0版本大语言模型(LLM)，能够根据用户的输入生成相关内容，即<strong>AIGC</strong>(人工智能内容生成)，包括文本、代码、图片等，可以协助人类提高工作效率。华为、阿里巴巴和百度也分别推出盘古、通义千问和文心一言等LLM。</p>
<p>今天，AI几乎覆盖了人类生活和生产的各个领域，例如智能制造、智慧医疗、智慧农业、智慧教育、智慧家居、智慧交通、智慧金融等，并已经开始帮助科学家更高效地开展科学研究。</p>
<p>本章主要基于R语言中的<strong>mlr3verse</strong>套件开展传统机器学习建模，通过案例学习和掌握机器学习的基础知识、建模步骤和主要算法。</p>
<section id="机器学习概述" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="机器学习概述"><span class="header-section-number">5.1</span> 机器学习概述</h2>
<p>百度百科对人工智能的定义是：“人工智能是研究、开发用于模拟、延伸和扩展人的智能的理论、方法、技术及应用系统的一门新的技术科学”。机器学习是实现人工智能的一个重要途径，而深度学习则是机器学习的子领域。深度学习能够利用更强大的算力构建更复杂的深层神经网络模型，实现了特征工程的自动化，能够更好地从文本、语音、图像、视频等非结构性数据中学习内在规律和表示层次，代表了目前机器学习的最高水平。目前，除了我国学者周志华教授的团队于2020年提出的基于决策树集成技术的深度森林模型(gcForest)外，深度学习主要基于人工神经网络。</p>
<p>卡内基梅隆大学汤姆·米歇尔教授对<strong>机器学习</strong>的定义：<strong>对于某类任务T和性能度量P</strong>，<strong>若一个计算机程序在T上用P衡量的性能随着经验E而自我完善</strong>，<strong>则称该计算机程序在从经验E学习</strong>。大多数场景下，机器学习就是让计算机通过算法对大量历史数据进行学习，生成经验模型，然后利用经验模型进行预测。机器学习更加注重模型的性能，如预测的准确性，而统计分析与建模则注重可解释性，但其理论仍然是机器学习的重要基础，并在机器学习模型可解释性的研究中发挥着重要作用。更重要的是，机器学习更擅长于解决现实世界中绝大部分的本质非线性关系的复杂问题。</p>
<section id="机器学习的方式" class="level3" data-number="5.1.1">
<h3 data-number="5.1.1" class="anchored" data-anchor-id="机器学习的方式"><span class="header-section-number">5.1.1</span> 机器学习的方式</h3>
<p>机器学习根据学习方式可分为<strong>有监督学习</strong>、<strong>无监督学习</strong>、<strong>半监督学习</strong>和<strong>强化学习</strong>。<br>
有监督学习使用一组由输入特征(Feature)和对应的输出标签(Label)构成的学习数据来建立模型，然后利用模型预测新的输入特征的输出标签(<a href="#fig-5.1" class="quarto-xref">图&nbsp;<span>5.1</span></a> 左图)。例如，根据已有的水质指标(输入特征)及对应富营养化程度(输出标签)的样本建立机器学习模型，然后用来预测新的输入特征对应的富营养程度。</p>
<p>无监督学习使用只有输入特征而没有输出标签的学习数据，让机器学习算法挖掘学习数据中的内在规律和逻辑，形成合理的知识表示(<a href="#fig-5.1" class="quarto-xref">图&nbsp;<span>5.1</span></a> 右图)。例如，根据大量来自不同污染源的特征，让无监督学习算法自动分析其中哪些污染源是相似的，或者哪些是异常的。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.1.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.1: 有监督学习和无监督学习
</figcaption>
</figure>
</div>
</div>
</div>
<p>半监督学习是前两种学习方式的混合，数据中大多没有输出标签，少数有输出标签。半监督学习利用少量有标签数据点建立预测模型，为大量无标签数据点预测对应标签，然后利用所有数据建立机器学习模型。由于现实中存在大量无标签的数据，人工标签数据工作量极大甚至不可能，利用半监督学习算法进行自动化标签，可以让大量无标签数据得到充分利用。</p>
<p>强化学习是在给定的环境中，通过环境的反馈机制和奖惩机制，让智能体以试错的方式去学习，改进行动方案以获胜或提升价值，从而适应环境。</p>
<p>在机器学习和深度学习中，统计分析与建模中的自变量或预测变量一般称为<strong>特征</strong>，而因变量或响应变量、目标变量称为<strong>标签</strong>。</p>
<p>由于机器学习涉及的知识范围极为广泛，本书只介绍基于R包mlr3的传统机器学习和基于R包torch的深度学习，并聚焦于有监督学习。</p>
</section>
<section id="机器学习的任务类型" class="level3" data-number="5.1.2">
<h3 data-number="5.1.2" class="anchored" data-anchor-id="机器学习的任务类型"><span class="header-section-number">5.1.2</span> 机器学习的任务类型</h3>
<p>常见的机器学习任务类型包括<strong>分类</strong>、<strong>回归</strong>、<strong>聚类</strong>和<strong>降维</strong>，如 <a href="#fig-5.2" class="quarto-xref">图&nbsp;<span>5.2</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.2.png" class="img-fluid figure-img" style="width:65.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.2: 机器学习任务类型
</figcaption>
</figure>
</div>
</div>
</div>
<p>分类和回归任务属于有监督学习。尽管分类模型输出标签是类别，回归模型输出标签是数值，但本质相同，因为类别可以用离散变量甚至连续变量(如概率值)来表示。</p>
<p>聚类是一种典型的无监督学习。作为一种重要的归纳方法，聚类通常用于数据预处理和探索性分析，从大量数据聚焦到少数类别上，以获得更有价值的数据洞察。</p>
<p>降维是将高维数据的维度降低，是在机器学习建模前对数据进行预处理的一种重要方法。大数据不仅观测多，更重要的是变量维度(特征)太多，如光谱分析数据、基因测序数据的变量动辄成千上万，存在大量冗余和噪声。降维算法能够显著减少冗余特征、弱化噪声干扰、降低存储空间占用、加快学习建模进程，并有利于实现可视化等。降维的途径主要有<strong>特征选择</strong>和<strong>特征提取</strong>。特征选择是从现有特征空间中取一个低维度的有代表性的子集，“取其精华、去其糟粕”，没有改变特征的物理意义。而特征提取则是将不同特征加以融合，形成新的特征空间，改变了原始特征的物理意义，主成分分析就是一种典型的特征提取算法。</p>
</section>
<section id="机器学习的基本术语" class="level3" data-number="5.1.3">
<h3 data-number="5.1.3" class="anchored" data-anchor-id="机器学习的基本术语"><span class="header-section-number">5.1.3</span> 机器学习的基本术语</h3>
<section id="算法与模型参数与超参数" class="level4" data-number="5.1.3.1">
<h4 data-number="5.1.3.1" class="anchored" data-anchor-id="算法与模型参数与超参数"><span class="header-section-number">5.1.3.1</span> 算法与模型、参数与超参数</h4>
<p>机器学习算法是在数据上运行并建立机器学习模型的过程，称为算法从数据“<strong>学习</strong>(learning)”或“<strong>拟合</strong>(fitting)”的过程，也称为<strong>训练</strong>(training)模型的过程。<strong>机器学习模型是机器学习算法在数据上运行的输出结果</strong>。机器学习算法有很多种，如神经网络、决策树、支持向量机等。</p>
<p>模型拥有确定的<strong>参数</strong>(parameters)，是算法参数空间中的一个具体示例。模型参数可以视为一种知识的归纳或表示，是算法从数据中学习或拟合得到的具体成果。算法在数据上运行之前需要根据学习任务的具体情况而设定的参数称为<strong>超参数</strong>(hyperparameters)。与模型参数不同，超参数不是算法从数据中学习得到的，而需要在学习前预先设定。超参数影响算法的学习过程，对模型性能有重要影响。例如神经网络的每个神经元层的激活函数类型、决策树的最大建树深度、支持向量机的惩罚系数等。算法的超参数可以通过调节或优化而让学习或建模过程更有效和更高效，从而提升最终模型的<strong>泛化性能</strong>(Generalization Performance)。</p>
</section>
<section id="训练集测试集和验证集" class="level4" data-number="5.1.3.2">
<h4 data-number="5.1.3.2" class="anchored" data-anchor-id="训练集测试集和验证集"><span class="header-section-number">5.1.3.2</span> 训练集、测试集和验证集</h4>
<p>机器学习建模前，通常需要将学习数据分割成<strong>训练集</strong>(train set)和<strong>测试集</strong>(test set)，分割比例一般根据学习数据量的大小来确定，对于中小规模的数据，训练集比例一般为2/3~4/5，而大规模数据，可以适当减少训练集的比例。算法在训练集上学习以建立模型，模型在测试集上预测，通过计算预测值和真实值的偏差来评估模型的预测性能(估计模型泛化性能)。此外，往往还需要在训练集中分割出<strong>验证集</strong>(validation set)，通过<strong>交叉验证</strong>或<strong>早期停止</strong>等方法，优化算法超参数或控制算法过拟合。训练集和测试集的分割，要特别注意样本对总体的代表性问题。</p>
</section>
<section id="欠拟合和过拟合" class="level4" data-number="5.1.3.3">
<h4 data-number="5.1.3.3" class="anchored" data-anchor-id="欠拟合和过拟合"><span class="header-section-number">5.1.3.3</span> 欠拟合和过拟合</h4>
<p><strong>欠拟合</strong>(under-fitting)表现为模型训练误差(模型对训练集的拟合误差)和预测误差(模型对于测试集的预测误差)都很大，即所谓的高偏差、高方差( <a href="#fig-5.3" class="quarto-xref">图&nbsp;<span>5.3</span></a> 左图)。这表明模型没有很好地学习到训练集中的知识。通常，提高模型复杂度可以有效改善欠拟合问题。</p>
<p><strong>过拟合</strong>(over-fitting)则表现为模型训练误差很小(甚至为0)而预测误差很大，即所谓的低偏差、高方差( <a href="#fig-5.3" class="quarto-xref">图&nbsp;<span>5.3</span></a> 右图)。这表明模型在训练集上拟合过度，对数据噪声也进行了拟合，严重干扰了模型对有效知识的学习。通常，降低模型复杂度可以有效改善过拟合问题。</p>
<p>机器学习的目的是获得恰当拟合的模型( <a href="#fig-5.3" class="quarto-xref">图&nbsp;<span>5.3</span></a> 中图)，即实现偏差和方差的权衡，获得更好的预测性能。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.3.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.3: 欠拟合与过拟合
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="目标函数代价函数和损失函数" class="level4" data-number="5.1.3.4">
<h4 data-number="5.1.3.4" class="anchored" data-anchor-id="目标函数代价函数和损失函数"><span class="header-section-number">5.1.3.4</span> 目标函数、代价函数和损失函数</h4>
<p>在有监督学习中，学习数据的每一行都由一组输入特征组成，每一组特征对应一个输出标签，这样的一组特征和对应的标签即为学习样本的一个样例或观测(即统计学概念中的个体)。有监督学习的目的是获得一个预测性能优良的模型，机器学习模型本质上是机器学习算法对学习样本进行拟合而得到的函数。在拟合学习样本建立模型的过程中，需要计算模型对样例的预测标签和实际标签之间的偏差，然后通过指定的优化算法进行迭代学习，以将偏差降低到允许的或可接受的水平，从而获得可以部署应用的具有良好预测性能的模型。</p>
<p><strong>损失函数</strong>(loss function)用于计算单个样例的实际标签与模型预测标签之间的偏差，亦即损失。<strong>代价函数</strong>(cost function)用于计算模型对全体样例的损失，通常是所有样例损失函数计算结果的平均值。<strong>目标函数</strong>(objective function)通常是代价函数加上正则化项(也称为惩罚项，一般是模型结构复杂度的函数)，其中代价函数代表经验风险，用于控制训练误差，而正则化项代表结构风险，用于控制模型复杂度。机器学习建模的过程就是最小化目标函数的过程，如果只是最小化经验风险，结构足够复杂的模型就可以让经验风险为0，但模型会过拟合。因此，目标函数引入正则化项，以控制模型结构复杂度，在训练过程中同时最小化经验风险和结构风险，即实现训练误差最小化和模型结构最简化的权衡，以获得恰当拟合的模型，实现更好的泛化性能。</p>
<p>对于回归任务，常用的损失函数是<strong>均方误差</strong>(MSE)和<strong>平均绝对误差</strong>(MAE)，前者让训练过程收敛更快，但后者对异常值更稳健。Huber损失函数则是 MSE 和 MAE的结合，在误差接近 0 时使用 MSE，在误差较大时使用 MAE。 对于分类任务，常用的损失函数是<strong>交叉熵</strong>(Cross Entropy，常用于二分类)，对于多分类任务，通常使用交叉熵的拓展形式即Softmax损失函数。 此外，机器学习中还有很多形式的损失函数，一些机器学习算法可能采用特殊的损失函数，例如支持向量机(SVM)模型采用的Hinge损失函数。</p>
</section>
<section id="泛化性能和交叉验证误差" class="level4" data-number="5.1.3.5">
<h4 data-number="5.1.3.5" class="anchored" data-anchor-id="泛化性能和交叉验证误差"><span class="header-section-number">5.1.3.5</span> 泛化性能和交叉验证误差</h4>
<p><strong>泛能性能</strong>是指模型推广到未见数据上的预测性能。显然，模型在测试集上的误差(测试误差)可以作为泛化性能的一个简单估计，但更优良的估计是模型的<strong>交叉验证误差</strong>(CVE)。交叉验证是指将训练集随机分割成<span class="math inline">n</span>个互不重叠的子集(<span class="math inline">n</span>折)，然后执行<span class="math inline">n</span>个重复的迭代：取出1个子集作为验证集，余下<span class="math inline">n-1</span>个子集合并作为训练集来训练中间模型，训练好的中间模型对验证集进行预测，然后计算本次迭代中的中间模型的性能测度。n个迭代结束后，计算n个性能测度的均值，即得到<span class="math inline">n</span>折CVE。特别的，当<span class="math inline">n</span>等于训练集的样例数量时，称为<strong>留一法</strong>(LOO)交叉验证，理论上，LOO法对应的CVE是模型泛化性能的最佳无偏估计。<br>
但模型训练的时间成本与n成正比。当训练集很大时，采用LOO或较大的<span class="math inline">n</span>折交叉验证会显著提高时间成本和能耗，此时应考虑采用3、5(如 <a href="#fig-5.4" class="quarto-xref">图&nbsp;<span>5.4</span></a> 所示)或10-折交叉验证。建议在<span class="math inline">n</span>折交叉验证基础上进行多次的重复，即重复<span class="math inline">n</span>折交叉验证(Repeated <span class="math inline">n</span>-fold CV)，以减小每一折内数据分布的差异。对于不平衡分类数据，需要采用分层分割的交叉验证方法，以提高每一折内各类样例的分布对总体具有更高的代表性。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.4" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.4.png" class="img-fluid figure-img" style="width:55.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.4: 5折交叉验证
</figcaption>
</figure>
</div>
</div>
</div>
<p>时间序列数据的顺序具有重要意义，不能随意打乱，不可采用随机分割的方法，其交叉验证一般按时间顺序划分训练集和验证集，如 <a href="#fig-5.5" class="quarto-xref">图&nbsp;<span>5.5</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.5" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.5.png" class="img-fluid figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.5: 时间序列数据的交叉验证
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="机器学习建模的步骤" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="机器学习建模的步骤"><span class="header-section-number">5.2</span> 机器学习建模的步骤</h2>
<p>机器学习建模的步骤一般包括明确任务、数据收集、数据整理、特征工程、模型筛选、模型优化、模型评估和模型部署八个环节。</p>
<p>(1)<strong>明确任务</strong>：明确任务的内容和目标，判定任务的类型，为选择模型确定范围。<br>
(2)<strong>数据收集</strong>：围绕任务收集相关数据，数据质量直接关系到机器学习建模质量。<br>
(3)<strong>数据整理</strong>：识别和处理错误值、重复值、缺失值、异常值等，开展数据变换(如归一化、标准化、对数化等)，进一步提升数据质量，并确保数据结构符合机器学习建模的要求。该环节也称为数据清洗。<br>
(4)<strong>特征工程</strong>：结合领域经验，尝试多种手段，选择或提取重要特征，形成高质量的建模数据。数据和特征决定了机器学习的上限，而机器学习算法只是逼近这个上限。因此，特征工程的好坏直接影响模型的性能。手动特征工程只适合中小规模数据，大数据建议采用自动化特征工程，但选择和提取特征的算法仍需要根据任务类型、数据分布、领域经验等确定。<br>
(5)<strong>模型筛选</strong>：选择若干合适的机器学习算法在训练集上预建模，采用统一的性能测度(亦即性能评价指标)，筛选出性能最优的算法。对特定的任务而言，没有最好的算法，只有最合适的算法。<br>
(6)<strong>模型优化</strong>：在训练集上用选定的算法进行学习，采用超参数优化算法并结合交叉验证等重抽样策略优化模型。模型优化往往会耗费较多的时间和算力成本。<br>
(7)<strong>模型评估</strong>：在测试集上估计模型的泛化性能，通常需要与基线模型(baseline model)和目前最先进模型(SOTA model)进行比较。如果不能满足任务要求，需要重新开展特征工程、模型选择及优化，甚至重新收集数据。<br>
(8)<strong>模型部署</strong>：将满足要求的最终模型部署到生产环境中应用，并定期监测和更新。</p>
<p>特征工程和模型优化是耗费时间最多的两个环节，模型筛选和模型评估两个环节需要有多次的重复试验，以在不同的训练集、验证集和测试集上建模和评估，确保模型性能测度具有统计置信度，而不能只是一次试验的结果。此外，在模型筛选环节中，必然包含模型评估的步骤。</p>
</section>
<section id="mlr3机器学习建模基础" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="mlr3机器学习建模基础"><span class="header-section-number">5.3</span> mlr3机器学习建模基础</h2>
<p>mlr3是目前R语言中功能全面、接口统一、面向对象且具有高扩展性的通用机器学习框架，支持data.table数据类型和R6范式的面向对象编程(OOP)，能够针对分类、回归、聚类、生存分析以及密度估计等多种类型的任务开展机器学习。此外，从caret发展而来的tidymodels也是一个正在不断完善的具有tidy规范的R语言通用机器学习框架。h2o是一个基于Java语言开发的分布式、可扩展开源机器学习框架，支持全自动机器学习(AutoML)。</p>
<p>考虑到mlr3框架更加完善，且支持更广泛的机器学习算法，因此本书选择基于mlr3框架来介绍R语言有监督的机器学习建模。</p>
<section id="mlr3verse的安装" class="level3" data-number="5.3.1">
<h3 data-number="5.3.1" class="anchored" data-anchor-id="mlr3verse的安装"><span class="header-section-number">5.3.1</span> mlr3verse的安装</h3>
<p>mlr3只包含了机器学习的基本功能，为了使用更丰富的功能，建议安装mlr3verse套件，因为加载该套件可一次性导入mlr3、mlr3learners、mlr3tuning、mlr3pipelines、mlr3tuningspaces、mlr3data、mlr3filters、mlr3fselect、mlr3cluster、mlr3viz、bbotk、paradox等工具包，实现更高级的机器学习功能。<br>
从CRAN网站安装mlr3verse套件：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"mlr3verse"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>如果需要安装最新的开发版，可以通过remotes或devtools包的<code>install_github()</code>函数来安装：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"mlr-org/mlr3verse"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("mlr-org/mlr3verse")</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在mlr-org的github仓库中还有很多扩展包，如mlr3extralearners(提供更多额外的学习器)、mlr3proba(概率有监督学习)、mlr3temporal(时间序列预测)等，亦可利用上述方法安装。</p>
<p>需要注意的是，mlr3只是一个具有统一接口的通用机器学习框架，其中各个算法的实现仍然依赖其他R包，只有安装了相应的R包，才能在mlr3中正常调用这些机器学习算法进行建模。</p>
<p>mlr3的生态系统如 <a href="#fig-5.6" class="quarto-xref">图&nbsp;<span>5.6</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.6" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.6.png" class="img-fluid figure-img" width="814">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.6: mlr3的生态系统(源自https://mlr-org.com/ecosystem.html)
</figcaption>
</figure>
</div>
</div>
</div>
<p>mlr3建模的基本步骤：</p>
<p>(1)创建任务；<br>
(2)分割数据；<br>
(3)创建学习器；<br>
(4)训练模型；<br>
(5)模型预测；<br>
(6)模型性能评价。</p>
<p>但实际建模步骤是相对复杂的，因为针对特定任务通常需要比较多个学习器，在比较的过程中需要采用交叉验证等重抽样(也称重采样)策略并开展性能评价。此外，对模型超参数进行调节或优化是一个非常重要的环节，其中涉及优化算法、重抽样策略等重要知识与经验。</p>
</section>
<section id="创建任务" class="level3" data-number="5.3.2">
<h3 data-number="5.3.2" class="anchored" data-anchor-id="创建任务"><span class="header-section-number">5.3.2</span> 创建任务</h3>
<p>开展机器学习建模，首先要根据整理好的数据来创建任务，明确任务类型以及输入特征与输出标签。</p>
<section id="创建分类任务" class="level4" data-number="5.3.2.1">
<h4 data-number="5.3.2.1" class="anchored" data-anchor-id="创建分类任务"><span class="header-section-number">5.3.2.1</span> 创建分类任务</h4>
<p>mlr3中分类任务的类名为T<strong>askClassif</strong>，创建方法是<code>$new()</code>：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> TaskClassif<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"iris"</span>, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">backend =</span> iris, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">target =</span> <span class="st">"Species"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>参数id是必需的，参数backend指定数据来源，参数target指定目标变量，即标签。上述代码通过<code>$new()</code>方法创建了TaskClassif类的一个实例，即task对象。</p>
<p><code>as_task_classif()</code>函数可将符合要求的数据对象(如数据框等)转换为分类任务对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>task1 <span class="ot">=</span> <span class="fu">as_task_classif</span>(iris, <span class="at">target =</span> <span class="st">"Species"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>as_task_classif()</code>函数需要先指定数据来源，参数id自动由数据来源的名称生成，不再要求显式指定。</p>
<p>在控制台输入task和task1，就会显示任务的信息。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>task</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskClassif:iris&gt; (150 x 5)
* Target: Species
* Properties: multiclass
* Features (4):
  - dbl (4): Petal.Length, Petal.Width, Sepal.Length, Sepal.Width</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>task1</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskClassif:iris&gt; (150 x 5)
* Target: Species
* Properties: multiclass
* Features (4):
  - dbl (4): Petal.Length, Petal.Width, Sepal.Length, Sepal.Width</code></pre>
</div>
</div>
<p>两个任务的信息完全一致，第一行给出任务对象的类、id和数据维度，接下来三行分别给出该任务对象的目标变量名称、任务性质和输入特征，输入特征根据变量类型分类排列。</p>
</section>
<section id="创建回归任务" class="level4" data-number="5.3.2.2">
<h4 data-number="5.3.2.2" class="anchored" data-anchor-id="创建回归任务"><span class="header-section-number">5.3.2.2</span> 创建回归任务</h4>
<p>mlr3中回归任务的类名为<strong>TaskRegr</strong>，创建方法也是<code>$new()</code>：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> TaskRegr<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"aq"</span>,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">backend =</span> airquality,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">target =</span> <span class="st">"Ozone"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>同样，<code>as_task_regr()</code>函数能够将符合要求的数据对象转换为回归任务对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>task1 <span class="ot">=</span> <span class="fu">as_task_regr</span>(airquality, <span class="at">target =</span> <span class="st">"Ozone"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在控制台输入task和task1，同样会显示任务的信息。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>task</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskRegr:aq&gt; (153 x 6)
* Target: Ozone
* Properties: -
* Features (5):
  - int (4): Day, Month, Solar.R, Temp
  - dbl (1): Wind</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>task1</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskRegr:airquality&gt; (153 x 6)
* Target: Ozone
* Properties: -
* Features (5):
  - int (4): Day, Month, Solar.R, Temp
  - dbl (1): Wind</code></pre>
</div>
</div>
<p>除了任务的id不同以外，两个任务的其他信息保持一致。</p>
<p>此外，mlr3verse还支持聚类分析(<strong>TaskClust</strong>)、密度估计(<strong>TaskDens</strong>)和生存分析(<strong>TaskSurv</strong>)，前者需要安装mlr3cluster包，后二者需要安装mlr3proba包。</p>
</section>
<section id="任务对象的属性和方法" class="level4" data-number="5.3.2.3">
<h4 data-number="5.3.2.3" class="anchored" data-anchor-id="任务对象的属性和方法"><span class="header-section-number">5.3.2.3</span> 任务对象的属性和方法</h4>
<p>创建任务对象后，可以采用形如<code>task$xxx</code>(task是任务对象的名称，而<code>$xxx</code>为指定的属性名称)的方式查询任务对象的各种属性信息。例如查询任务数据的行数和列数：<code>$ncol</code>、<code>$nrow</code>；查询输入特征类型和名称：<code>$feature_types</code>、<code>$feature_names</code>；查询输出标签的名称：<code>$target_names</code>；查询任务数据中列变量的角色：<code>$col_roles</code>；查询任务数据的行标识：<code>$row_ids</code>，注意行标识与行序号的区别。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> TaskRegr<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"aq"</span>,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">backend =</span> airquality,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">target =</span> <span class="st">"Ozone"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span>ncol</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span>nrow</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 153</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span>feature_names</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Day"     "Month"   "Solar.R" "Temp"    "Wind"   </code></pre>
</div>
</div>
<p>同样可以采用形如<code>task$xxx()</code>的方式调用任务对象的各种方法，此处的<code>$xxx()</code>为指定的方法名称，本质上是执行特定操作的函数。例如获取创建任务的数据：<code>$data()</code>；获取任务数据中的实际输出标签：<code>$truth()</code>；复制任务对象：<code>$clone()</code>；获取任务数据的子集：<code>$select()</code>就地改变任务的输入特征，<code>$filter()</code>就地改变任务数据的样例(观测)；新增任务数据：<code>$rbind()</code>就地增加新的样例(行)，<code>$cbind()</code>就地增加新的输入特征。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>task </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskRegr:aq&gt; (153 x 6)
* Target: Ozone
* Properties: -
* Features (5):
  - int (4): Day, Month, Solar.R, Temp
  - dbl (1): Wind</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>task_copy <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>() </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>task_copy</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskRegr:aq&gt; (153 x 6)
* Target: Ozone
* Properties: -
* Features (5):
  - int (4): Day, Month, Solar.R, Temp
  - dbl (1): Wind</code></pre>
</div>
</div>
<p>注意，mlr3中对象的方法会就地(in-place)改变对象，如果不采用<code>$clone()</code>复制任务对象，而是直接赋值，则task会随task_copy的改变而改变。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>task_copy<span class="sc">$</span><span class="fu">filter</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">30</span>, <span class="dv">60</span>, <span class="dv">100</span>))  <span class="co"># 这里是行标识符号，而不是行序号</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>task_copy</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskRegr:aq&gt; (5 x 6)
* Target: Ozone
* Properties: -
* Features (5):
  - int (4): Day, Month, Solar.R, Temp
  - dbl (1): Wind</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 就地改变了对象的数据</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>task_copy<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Ozone   Day Month Solar.R  Temp  Wind
   &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt; &lt;num&gt;
1:    41     1     5     190    67   7.4
2:    NA    10     5     194    69   8.6
3:   115    30     5     223    79   5.7
4:    NA    29     6      31    77  14.9
5:    89     8     8     229    90  10.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 任务数据row_id仍然保留</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>task_copy<span class="sc">$</span>row_ids  </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   1  10  30  60 100</code></pre>
</div>
</div>
<p>mlr3中已经内置了一些封装好的任务，在控制台执行<code>mlr_tasks</code>即可查询内置任务的关键字(或名称字典)。传入关键字，<code>tsk()</code>和<code>tsks()</code>函数就可以直接加载内置任务对象，<code>tsk()</code>用于加载单个任务对象，例如<code>task = tsk("iris")</code>，而<code>tsks()</code>则用于同时加载多个任务对象。内置任务对象的关键字可用<code>mlr_tasks</code>查询，了解详细信息可用<code>as.data.table(mlr_tasks)</code>查询。</p>
</section>
<section id="任务对象的可视化" class="level4" data-number="5.3.2.4">
<h4 data-number="5.3.2.4" class="anchored" data-anchor-id="任务对象的可视化"><span class="header-section-number">5.3.2.4</span> 任务对象的可视化</h4>
<p>mlr3viz包提供了<code>autoplot()</code>泛型函数(实际调用ggplot2包中的<code>autoplot()</code>函数)，可根据对象类型自动调用对应可视化函数进行可视化，可用于任务对象<strong>Task</strong>、学习器对象<strong>Learner</strong>、预测对象<strong>Prediction</strong>、特征过滤器对象<strong>Filter</strong>、基准测试结果对象<strong>BenchmarkResult</strong>、重抽样结果对象<strong>ResampleResult</strong>、单一准则调优实例对象<strong>TuningInstanceSingleCrit</strong>以及单一准则优化实例对象<strong>OptimInstanceSingleCrit</strong>等。</p>
<p>对于不同类型的Task对象，如TaskClassif、TaskRegr、TaskClust等，泛型函数<code>autoplot()</code>可以自动判断任务类型来绘制图形，并可通过设置type参数的取值来指定可视化类型。对于分类任务对象TaskClassif，参数type可选”target”(默认值)、“duo”和”pairs”。选择”target”，则绘制目标变量的条形图；选择”duo”，则将任务数据传给<code>GGally::ggduo()</code>绘制预测变量与目标变量的箱线图；选择”pairs”，则将任务数据传给<code>GGally::ggpairs()</code>绘制复杂的变量矩阵图，并将颜色标度映射到目标变量。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>task_c <span class="ot">=</span> <span class="fu">as_task_classif</span>(iris, <span class="at">target =</span> <span class="st">"Species"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>绘制目标变量条形图，结果如 <a href="#fig-5.7" class="quarto-xref">图&nbsp;<span>5.7</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(task_c)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-5.7" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH5_files/figure-html/fig-5.7-1.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.7: 分类任务可视化-目标变量条形图
</figcaption>
</figure>
</div>
</div>
</div>
<p>绘制预测变量与目标变量箱线图，结果如 <a href="#fig-5.8" class="quarto-xref">图&nbsp;<span>5.8</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(task_c, <span class="at">type =</span> <span class="st">"duo"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-5.8" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH5_files/figure-html/fig-5.8-1.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.8: 分类任务可视化-特征变量箱线图
</figcaption>
</figure>
</div>
</div>
</div>
<p>绘制变量矩阵图，结果如 <a href="#fig-5.8" class="quarto-xref">图&nbsp;<span>5.8</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(task_c, <span class="at">type =</span> <span class="st">"pairs"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-5.9" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH5_files/figure-html/fig-5.9-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.9: 分类任务可视化-矩阵图
</figcaption>
</figure>
</div>
</div>
</div>
<p>对于回归任务对象TaskRegr，参数type可选”target”(默认值)和”pairs”。选择”target”，则绘制目标变量的箱线图；选择”pairs”，则将任务数据传给<code>GGally::ggpairs()</code>绘制变量矩阵图。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>task_r <span class="ot">=</span> <span class="fu">as_task_regr</span>(airquality, <span class="at">target =</span> <span class="st">"Ozone"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>绘制目标变量箱线图，结果如 <a href="#fig-5.10" class="quarto-xref">图&nbsp;<span>5.10</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(task_r)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-5.10" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH5_files/figure-html/fig-5.10-1.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.10: 回归任务可视化-箱线图
</figcaption>
</figure>
</div>
</div>
</div>
<p>绘制变量矩阵图，结果如图5-11所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(task_r, <span class="at">type =</span> <span class="st">"pairs"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-5.11" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH5_files/figure-html/fig-5.11-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.11: 回归任务可视化-矩阵图
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="划分数据" class="level3" data-number="5.3.3">
<h3 data-number="5.3.3" class="anchored" data-anchor-id="划分数据"><span class="header-section-number">5.3.3</span> 划分数据</h3>
<p>创建任务后，需要将任务数据分割为训练集和测试集。简单的随机分割可采用<code>partition()</code>函数，该函数形式为：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">partition</span>(task, <span class="at">ratio =</span> <span class="fl">0.67</span>, <span class="at">stratify =</span> <span class="cn">TRUE</span>, <span class="at">bins =</span> <span class="dv">3</span>L)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>参数task是任务对象；ratio是分配给训练集的样例比例(默认是0.67，余下样例为测试集)，采用随机不回置抽样方法；stratify = TRUE表示按目标变量分层抽样，对于回归任务，则是先将目标变量分箱(binning，即分组，默认分成3组：bins = 3L)，然后按目标变量分组抽样。这里的划分是对行标识符号进行分配，而不是数据样例的分配，这可以减少对内存资源的占用。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>split <span class="ot">=</span> <span class="fu">partition</span>(task)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>split<span class="sc">$</span>train</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1]   1   2   3   4   5   6   7   8   9  12  14  15  16  17  18  20  21  23
 [19]  24  25  26  29  30  32  34  38  40  41  44  45  47  48  49  50  53  54
 [37]  56  57  59  60  61  62  63  65  66  67  68  69  71  73  74  75  76  78
 [55]  80  82  83  84  85  87  90  91  92  93  95  97  98 100 102 103 105 106
 [73] 108 109 110 112 116 117 118 119 120 121 123 124 127 128 129 130 131 132
 [91] 133 135 136 138 139 140 143 144 146 147 148 149</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>split<span class="sc">$</span>test</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  10  11  13  19  22  27  28  31  33  35  36  37  39  42  43  46  51  52  55
[20]  58  64  70  72  77  79  81  86  88  89  94  96  99 101 104 107 111 113 114
[39] 115 122 125 126 134 137 141 142 145 150</code></pre>
</div>
</div>
<p>也可以手动或使用其他方法来划分训练集和测试集：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">34</span>, <span class="dv">51</span><span class="sc">:</span><span class="dv">84</span>, <span class="dv">101</span><span class="sc">:</span><span class="dv">134</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>task<span class="sc">$</span>nrow, train)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>划分数据必须满足训练集和测试集对数据总体具有良好的代表性，特别是一些不平衡的数据。<br>
在模型筛选和优化环节，为了获得对模型泛化性能的良好估计，通常需要采用合理的重抽样策略进行足够次数的数据划分，以让选定算法在不同分割的数据上训练和预测，以对模型性能进行无偏估计。</p>
</section>
<section id="创建学习器" class="level3" data-number="5.3.4">
<h3 data-number="5.3.4" class="anchored" data-anchor-id="创建学习器"><span class="header-section-number">5.3.4</span> 创建学习器</h3>
<p>在mlr3中，Learner是学习器的基类，是机器学习算法及其超参数的封装。机器学习算法的实现与封装由相关的工具包完成，因此，应用算法必须安装相关工具包。在控制台输入<code>mlr_learners</code>可以查询mlr3支持的学习器关键字，输入<code>as.data.table(mlr_learners)</code>可以查询更详细的学习器信息，包括算法名称、算法能够处理的特征数据类型、算法依赖工具包、算法能够处理的特殊属性(如缺失值、变量重要性等)、算法支持的预测输出类型等。</p>
<p>创建学习器对象，最简单的方式是将学习器关键字传入<code>lrn()</code>和<code>lrns()</code>，前者一次只能创建单个学习器，后者一次可创建多个学习器：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>lr_rpart <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>lr_rpart  <span class="co"># 查看学习器的元数据(metadata)</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;LearnerClassifRpart:classif.rpart&gt;: Classification Tree
* Model: -
* Parameters: xval=0
* Packages: mlr3, rpart
* Predict Types:  [response], prob
* Feature Types: logical, integer, numeric, factor, ordered
* Properties: importance, missings, multiclass, selected_features,
  twoclass, weights</code></pre>
</div>
</div>
<p>通过<code>$feature_types</code>可查询学习器能够处理的特征数据类型；<code>$packages</code>可查询学习器依赖的工具包；<code>$properties</code>可查看学习器能够处理的特殊属性，如“missings”意味着学习器能够处理缺失值，“importance”意味着学习器能够计算每个特征的相对重要性；<code>$predict_types</code>可查询学习器创建的模型能够给出的预测类型；<code>$param_set</code>可查看学习器的超参数集合。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>lr_rpart<span class="sc">$</span>param_set</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet&gt;
                id    class lower upper nlevels
            &lt;char&gt;   &lt;char&gt; &lt;num&gt; &lt;num&gt;   &lt;num&gt;
 1:             cp ParamDbl     0     1     Inf
 2:     keep_model ParamLgl    NA    NA       2
 3:     maxcompete ParamInt     0   Inf     Inf
 4:       maxdepth ParamInt     1    30      30
 5:   maxsurrogate ParamInt     0   Inf     Inf
 6:      minbucket ParamInt     1   Inf     Inf
 7:       minsplit ParamInt     1   Inf     Inf
 8: surrogatestyle ParamInt     0     1       2
 9:   usesurrogate ParamInt     0     2       3
10:           xval ParamInt     0   Inf     Inf
                                                                                      default
                                                                                       &lt;list&gt;
 1:                                                                                      0.01
 2:                                                                                     FALSE
 3:                                                                                         4
 4:                                                                                        30
 5:                                                                                         5
 6: &lt;NoDefault&gt;\n  Public:\n    clone: function (deep = FALSE) \n    initialize: function () 
 7:                                                                                        20
 8:                                                                                         0
 9:                                                                                         2
10:                                                                                        10
     value
    &lt;list&gt;
 1:       
 2:       
 3:       
 4:       
 5:       
 6:       
 7:       
 8:       
 9:       
10:      0</code></pre>
</div>
</div>
<p>该分类决策树的超参数有10个，id给出超参数的名称，class给出各个超参数的数据类型(包括浮点型ParamDbl、整数型ParamInt、逻辑型ParamLgl、因子型ParamFct以及无类型ParamUty)，lower和upper分别给出各超参数的下限值和上限值，default给出超参数的默认值，value给出各参数的设定值。</p>
<p>学习器的超参数可以在学习器创建时来设置，也可在学习器创建后来设置。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>lr_rpart <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">cp =</span> <span class="fl">0.02</span>, </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">maxdepth =</span> <span class="dv">3</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>lr_rpart<span class="sc">$</span>param_set<span class="sc">$</span>values</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$xval
[1] 0

$cp
[1] 0.02

$maxdepth
[1] 3</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>lr_rpart <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>lr_rpart<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>cp <span class="ot">=</span> <span class="fl">0.03</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>lr_rpart<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>maxdepth <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>lr_rpart<span class="sc">$</span>param_set<span class="sc">$</span>values</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$xval
[1] 0

$cp
[1] 0.03

$maxdepth
[1] 4</code></pre>
</div>
</div>
<p>学习器的某些超参数的设置依赖于其他超参数，查看超参数的依赖项用<code>$deps</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>lr_svm <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.svm"</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>lr_svm<span class="sc">$</span>param_set<span class="sc">$</span>deps</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       id     on              cond
   &lt;char&gt; &lt;char&gt;            &lt;list&gt;
1:  coef0 kernel &lt;CondAnyOf:anyof&gt;
2:   cost   type &lt;CondEqual:equal&gt;
3: degree kernel &lt;CondEqual:equal&gt;
4:  gamma kernel &lt;CondAnyOf:anyof&gt;
5:     nu   type &lt;CondEqual:equal&gt;</code></pre>
</div>
</div>
<p>查询结果表明建立的支持向量机分类学习器有5个超参数存在依赖项，通过以下形式的代码可以继续查询超参数具体的依赖项：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>lr_svm<span class="sc">$</span>param_set<span class="sc">$</span>deps[[<span class="dv">3</span>, <span class="st">"cond"</span>]]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CondEqual: x = polynomial</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>lr_svm<span class="sc">$</span>param_set<span class="sc">$</span>deps[[<span class="dv">5</span>, <span class="st">"cond"</span>]]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CondEqual: x = nu-classification</code></pre>
</div>
</div>
<p>以上查询结果表明第三个超参数degree只有在超参数kernel设置为polynomial时可用，第五超参数gamma在超参数kernel设置为polynomial、radial或sigmoid时均可用。</p>
</section>
<section id="训练模型" class="level3" data-number="5.3.5">
<h3 data-number="5.3.5" class="anchored" data-anchor-id="训练模型"><span class="header-section-number">5.3.5</span> 训练模型</h3>
<p>完成任务和学习器的创建以及任务数据划分后，就可以将学习器置于训练集上进行训练，这是学习器在训练集上学习或拟合的过程，目的是提取训练集数据中的经验规则，得到机器学习模型。</p>
<p>mlr3通过调用学习器对象的<code>$train()</code>方法来训练学习器已获得模型：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>lr_rpart<span class="sc">$</span><span class="fu">train</span>(task, <span class="at">row_ids =</span> split<span class="sc">$</span>train) </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>通过<code>$model</code>可以查看结果模型：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>lr_rpart<span class="sc">$</span>model</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 102 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

1) root 102 68 setosa (0.33333333 0.33333333 0.33333333)  
  2) Petal.Length&lt; 2.7 34  0 setosa (1.00000000 0.00000000 0.00000000) *
  3) Petal.Length&gt;=2.7 68 34 versicolor (0.00000000 0.50000000 0.50000000)  
    6) Petal.Width&lt; 1.75 36  3 versicolor (0.00000000 0.91666667 0.08333333) *
    7) Petal.Width&gt;=1.75 32  1 virginica (0.00000000 0.03125000 0.96875000) *</code></pre>
</div>
</div>
<p>上面的示例中，classif.raprt学习器从102个训练样例中学习，得到一个深度为2(超参数maxdepth的设置值是3)的决策树模型，第一层分裂建树利用的特征是Petal.Length，第二层分裂建树利用的特征是Petal.Width。训练集102个样例中，34个setosa样例全部正确分类，versicolor和virginica样例中均有少数被错误分类。</p>
<p>rpart.plot包中的<code>rpart.plot()</code>函数可以对分类树模型进行可视化(如 <a href="#fig-5.12" class="quarto-xref">图&nbsp;<span>5.12</span></a> 所示)：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>rpart.plot<span class="sc">::</span><span class="fu">rpart.plot</span>(lr_rpart<span class="sc">$</span>model)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.12" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.12.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.12: 分类决策树模型可视化
</figcaption>
</figure>
</div>
</div>
</div>
<p>基于决策树的模型，可以计算特征重要性，在模型训练完成后，可通过<code>$importance()</code>方法提取特征重要性计算结果：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>lr_rpart<span class="sc">$</span><span class="fu">importance</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Petal.Width Petal.Length Sepal.Length  Sepal.Width </span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="do">##    60.56250     54.75195     40.45117     27.64063</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>计算结果表明，Petal.Width特征分值最高，其次是Petal.Length特征。由 <a href="#fig-5.12" class="quarto-xref">图&nbsp;<span>5.12</span></a> 可知，该模型第一层分裂建树特征采用的是Petal.Length，第二层分类建树特征采用的是Petal.Width。</p>
</section>
<section id="模型预测与预测性能" class="level3" data-number="5.3.6">
<h3 data-number="5.3.6" class="anchored" data-anchor-id="模型预测与预测性能"><span class="header-section-number">5.3.6</span> 模型预测与预测性能</h3>
<p>模型建立后即可在测试集上进行预测并计算预测性能。调用<code>$predict()</code>方法进行预测：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> lr_rpart<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> split<span class="sc">$</span>test)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>$predict()</code>方法返回的是Prediction对象，也拥有相应的方法和属性。通过<code>$response</code>和<code>$truth</code>可查询模型对测试集样例的预测标签及其真实标签：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>pred<span class="sc">$</span>response</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1] setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa    </span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [10] setosa     setosa     setosa     setosa     setosa     setosa     setosa     versicolor versicolor</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [19] versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [28] versicolor versicolor versicolor versicolor versicolor virginica  virginica  versicolor virginica </span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="do">## [37] virginica  virginica  virginica  virginica  virginica  virginica  versicolor virginica  virginica </span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [46] virginica  virginica  virginica </span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Levels: setosa versicolor virginica</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>pred<span class="sc">$</span>truth</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1] setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa     setosa    </span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [10] setosa     setosa     setosa     setosa     setosa     setosa     setosa     versicolor versicolor</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [19] versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor versicolor</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [28] versicolor versicolor versicolor versicolor versicolor virginica  virginica  virginica  virginica </span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="do">## [37] virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica  virginica </span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [46] virginica  virginica  virginica </span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Levels: setosa versicolor virginica</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>利用<code>$confusion</code>可查看混淆矩阵：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>pred<span class="sc">$</span>confusion</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="do">##             truth</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="do">## response     setosa versicolor virginica</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   setosa         16          0         0</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   versicolor      0         16         2</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   virginica       0          0        14</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>每列之和为测试集中每个类别的实际样例数，每行之和为模型预测的每个类别中的样例数。显然，setosa和versicolor两个类别中的预测样例都全部正确分类，但virginica中有2个样例错分到versicolor。</p>
<p>混淆矩阵用于总结分类模型的预测结果，给出简明的频数分析表，二分类的混淆矩阵形式如 <a href="#tbl-5.1" class="quarto-xref">表&nbsp;<span>5.1</span></a> 所示，多分类的混淆矩阵可据此扩展。</p>
<div class="center">
<div class="cell">
<div id="tbl-5.1" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-5.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;5.1: 二分类混淆矩阵
</figcaption>
<div aria-describedby="tbl-5.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./images/tbl5.1.png" class="img-fluid figure-img" style="width:65.0%"></p>
</figure>
</div>
</div>
</div>
</figure>
</div>
</div>
</div>
<p>显然，TP和TN越大、FP和FN越小，分类结果越好。基于混淆矩阵可以计算以下分类模型常用的性能评价指标：</p>
<ul>
<li><p>准确率：表示全部样例中被模型准确预测为正例和负例的比例。<br>
<span id="eq-5.1"><span class="math display">
\text{Accuracy(准确率)} = \frac{TP+TN}{TP+TN+FP+FN}
\tag{5.1}</span></span><br>
</p></li>
<li><p>精确率：表示被模型预测为正例的样例中实际为正例的比例，也称为查准率。<br>
<span id="eq-5.2"><span class="math display">
\text{Precision(精确率)} = \frac{TP}{TP+FP}
\tag{5.2}</span></span><br>
</p></li>
<li><p>灵敏度：表示样本全部正例中被模型准确预测为正例的比例，也称为真正率(TPR)、召回率(Recall)。<br>
<span id="eq-5.3"><span class="math display">
\text{Sensitivity(灵敏度)}=\text{TPR}=\text{Recall(召回率)}=\frac{TP}{TP+FN}
\tag{5.3}</span></span><br>
</p></li>
<li><p>特异度：表示样本全部负例中被模型准确预测为负例的比例，也称为真负率(TNR)。<br>
<span id="eq-5.4"><span class="math display">
\text{Specificity(特异度)} = \text{TNR}=\frac{TP}{TP+FN}
\tag{5.4}</span></span><br>
</p></li>
<li><p>F1-Score：是精确率和召回率(灵敏度、真正率)的调和平均，取值范围为0~1，越接近1表示模型预测性能越好。<br>
<span id="eq-5.5"><span class="math display">
\text{F1-Score} =\frac{2}{1/\text{Precision}+1/\text{Recall}}=\frac{2TP}{2TP+FN+FP}
\tag{5.5}</span></span></p></li>
</ul>
<p>准确率是评价分类模型性能的常用指标，但在不平衡数据的分类任务上并非最佳指标。例如，在100条污染物排放数据中污染超标样例只有5个，分类模型对全部未超标样例和3个超标样例做出了准确预测，那么该分类模型的整体预测准确率高达98%，可是更受关注的5个污染超标样例只有60%的预测准确率。而精确率和灵敏度(召回率)都是专门评价正例分类准确率的指标，特异度则是用于评价分类模型对负例分类准确率的指标。F1-Score既可用于平衡数据集，亦可用于不平衡数据集。</p>
<p>mlr3将评价模型性能的各种指标封装为相应的Measures对象，即测度对象，在控制台输入<code>mlr_measures</code>可查看所有测度的关键字，输入<code>as.data.table(mlr_measures)</code>可查询所有测度的详细信息。不同类型的任务和不同类型的预测输出，需要采用不同的测度来计算，其中评价分类模型性能的测度如 <a href="#tbl-5.2" class="quarto-xref">表&nbsp;<span>5.2</span></a> 所示，评价回归模型性能的测度如 <a href="#tbl-5.3" class="quarto-xref">表&nbsp;<span>5.3</span></a> 所示。</p>
<div class="cell">
<div id="tbl-5.2" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-5.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;5.2: 分类任务测度
</figcaption>
<div aria-describedby="tbl-5.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<colgroup>
<col style="width: 26%">
<col style="width: 56%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">key</th>
<th style="text-align: left;">label</th>
<th style="text-align: left;">predict_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">classif.acc</td>
<td style="text-align: left;">Classification Accuracy</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.auc</td>
<td style="text-align: left;">Area Under the ROC Curve</td>
<td style="text-align: left;">prob</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.bacc</td>
<td style="text-align: left;">Balanced Accuracy</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.bbrier</td>
<td style="text-align: left;">Binary Brier Score</td>
<td style="text-align: left;">prob</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.ce</td>
<td style="text-align: left;">Classification Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.costs</td>
<td style="text-align: left;">Cost-sensitive Classification</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.dor</td>
<td style="text-align: left;">Diagnostic Odds Ratio</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.fbeta</td>
<td style="text-align: left;">F-beta score</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.fdr</td>
<td style="text-align: left;">False Discovery Rate</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.fn</td>
<td style="text-align: left;">False Negatives</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.fnr</td>
<td style="text-align: left;">False Negative Rate</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.fomr</td>
<td style="text-align: left;">False Omission Rate</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.fp</td>
<td style="text-align: left;">False Positives</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.fpr</td>
<td style="text-align: left;">False Positive Rate</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.logloss</td>
<td style="text-align: left;">Log Loss</td>
<td style="text-align: left;">prob</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.mauc_au1p</td>
<td style="text-align: left;">Weighted average 1 vs.&nbsp;1 multiclass AUC</td>
<td style="text-align: left;">prob</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.mauc_au1u</td>
<td style="text-align: left;">Average 1 vs.&nbsp;1 multiclass AUC</td>
<td style="text-align: left;">prob</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.mauc_aunp</td>
<td style="text-align: left;">Weighted average 1 vs.&nbsp;rest multiclass AUC</td>
<td style="text-align: left;">prob</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.mauc_aunu</td>
<td style="text-align: left;">Average 1 vs.&nbsp;rest multiclass AUC</td>
<td style="text-align: left;">prob</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.mbrier</td>
<td style="text-align: left;">Multiclass Brier Score</td>
<td style="text-align: left;">prob</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.mcc</td>
<td style="text-align: left;">Matthews Correlation Coefficient</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.npv</td>
<td style="text-align: left;">Negative Predictive Value</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.ppv</td>
<td style="text-align: left;">Positive Predictive Value</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.prauc</td>
<td style="text-align: left;">Precision-Recall Curve</td>
<td style="text-align: left;">prob</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.precision</td>
<td style="text-align: left;">Precision</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.recall</td>
<td style="text-align: left;">Recall</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.sensitivity</td>
<td style="text-align: left;">Sensitivity</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.specificity</td>
<td style="text-align: left;">Specificity</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.tn</td>
<td style="text-align: left;">True Negatives</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.tnr</td>
<td style="text-align: left;">True Negative Rate</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">classif.tp</td>
<td style="text-align: left;">True Positives</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">classif.tpr</td>
<td style="text-align: left;">True Positive Rate</td>
<td style="text-align: left;">response</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<div class="cell">
<div id="tbl-5.3" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-5.3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;5.3: 回归任务测度
</figcaption>
<div aria-describedby="tbl-5.3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">key</th>
<th style="text-align: left;">label</th>
<th style="text-align: left;">predict_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">regr.bias</td>
<td style="text-align: left;">Bias</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">regr.ktau</td>
<td style="text-align: left;">Kendall’s tau</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">regr.mae</td>
<td style="text-align: left;">Mean Absolute Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">regr.mape</td>
<td style="text-align: left;">Mean Absolute Percent Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">regr.maxae</td>
<td style="text-align: left;">Max Absolute Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">regr.medae</td>
<td style="text-align: left;">Median Absolute Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">regr.medse</td>
<td style="text-align: left;">Median Squared Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">regr.mse</td>
<td style="text-align: left;">Mean Squared Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">regr.msle</td>
<td style="text-align: left;">Mean Squared Log Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">regr.pbias</td>
<td style="text-align: left;">Percent Bias</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">regr.rae</td>
<td style="text-align: left;">Relative Absolute Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">regr.rmse</td>
<td style="text-align: left;">Root Mean Squared Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">regr.rmsle</td>
<td style="text-align: left;">Root Mean Squared Log Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">regr.rrse</td>
<td style="text-align: left;">Root Relative Squared Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">regr.rse</td>
<td style="text-align: left;">Relative Squared Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">regr.rsq</td>
<td style="text-align: left;">R Squared</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">regr.sae</td>
<td style="text-align: left;">Sum of Absolute Errors</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">regr.smape</td>
<td style="text-align: left;">Symmetric Mean Absolute Percent Error</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="odd">
<td style="text-align: left;">regr.srho</td>
<td style="text-align: left;">Spearman’s rho</td>
<td style="text-align: left;">response</td>
</tr>
<tr class="even">
<td style="text-align: left;">regr.sse</td>
<td style="text-align: left;">Sum of Squared Errors</td>
<td style="text-align: left;">response</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>调用Prediction对象的<code>$score()</code>方法即可根据默认的测度计算测度值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>pred<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="do">## classif.ce </span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 0.04166667 </span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>结果显示，默认测度是classif.ce(分类错误率)，其值为0.04166667，亦即约4.2%的样例被错误分类。显然，分类准确度(classif.acc)是100% - 分类错误率。</p>
<p>可以通过<code>msr()</code>或<code>msrs()</code>函数传入一个或多个测度来计算指定的性能测度值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>pred<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"classif.acc"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="do">## classif.acc </span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   0.9583333 </span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>pred<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msrs</span>(<span class="fu">c</span>(<span class="st">"classif.acc"</span>,<span class="st">"classif.ce"</span>)))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="do">## classif.acc  classif.ce </span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  0.95833333  0.04166667 </span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>如果需要计算模型在训练集上的拟合误差，可调用<code>$predict()</code>方法对训练集进行预测，然后对返回的预测对象调用<code>$score()</code>方法计算性能测度值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>fitted <span class="ot">=</span> lr_rpart<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> split<span class="sc">$</span>train)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>fitted<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="do">## classif.ce </span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 0.03921569 </span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>ms <span class="ot">=</span> <span class="fu">msrs</span>(<span class="fu">c</span>(<span class="st">"classif.acc"</span>,<span class="st">"classif.ce"</span>))</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>fitted<span class="sc">$</span><span class="fu">score</span>(ms)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="do">## classif.acc  classif.ce </span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  0.96078431  0.03921569 </span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>对于多分类任务，可以通过混淆矩阵信息来计算每个分类的真正率、真负率等指标。</p>
<p>除此以外，还可以绘制<strong>ROC曲线</strong>和<strong>PR曲线</strong>对分类模型性能进行可视化比较。ROC曲线称为受试者操作特征曲线(Receiver Operating Characteristic Curve)，最早用于评价雷达信号的可靠性，后广泛用于医学和机器学习领域。该曲线的横坐标为1 - 特异度(FPR, 假正率)，纵坐标为灵敏度(TPR, 真正率)。显然，好的分类模型应该是TPR越大越好，同时FPR越小越好)。PR曲线(Precision-Recall Curve)的横坐标为灵敏度，纵坐标为精确度，这两个指标计算公式中的分子都为TP，但灵敏度公式中分母为TP＋FN，是样本中所有实际分类标签为正例的样例总数，而精确度公式中分母为TP＋FP，是样本中被模型预测为正例的样例总数。显然，PR曲线对不平衡数据集更敏感，而ROC曲线不敏感。简言之，就是PR曲线在数据集中正负两类样例相差悬殊时，能够比ROC曲线更好地甄别分类模型的优劣。</p>
<div id="exm-5.1" class="theorem example">
<p><span class="theorem-title"><strong>例 5.1</strong></span> ROC和PR曲线应用案例。</p>
</div>
<p>mlr3内置的声呐分类任务(sonar)有60个输入特征(V1~V60)，输出标签为Class(二分类，R为岩石，M为金属矿石)，共208个样例。比较四个分类模型(超参数均为默认配置)的性能：无特征classif.featureless(基线模型，随机猜测分类)、支持向量机classif.svm、决策树classif.rpart和K最近邻classif.kknn。</p>
<p>要保证比较的公平性，必须确保所有模型在相同的训练集上训练和在相同的测试集上预测，为此需要采用<code>benchmark_grid()</code>函数设计基准测试方案：封装任务、学习器和重抽样策略，并用<code>benchmark()</code>函数执行基准测试方案，返回的结果是BenchmarkResult对象。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3verse"</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>, <span class="at">positive =</span> <span class="st">"M"</span>) </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>split <span class="ot">=</span> <span class="fu">partition</span>(task)</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>lrs <span class="ot">=</span> <span class="fu">lrns</span>(<span class="fu">c</span>(<span class="st">"classif.featureless"</span>,<span class="st">"classif.svm"</span>, </span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>             <span class="st">"classif.rpart"</span>, <span class="st">"classif.kknn"</span>),</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">predict_type =</span> <span class="st">"prob"</span>, <span class="at">predict_sets =</span> <span class="fu">c</span>(<span class="st">"train"</span>,<span class="st">"test"</span>))</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>rss <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> lrs,</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> rss</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>四个模型的预测输出类型(predict_type)均设置为概率(prob)，并在训练集和测试集上都执行预测，重抽样策略为”cv”(5折交叉验证)，然后开始进行基准测试。调用BenchmarkResult对象的<code>$score()</code>方法可返回四个模型所有迭代的分类错误率，调用<code>$aggregate()</code>方法即返回四个模型的平均分类错误率：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       nr task_id          learner_id resampling_id iteration classif.ce
    &lt;int&gt;  &lt;char&gt;              &lt;char&gt;        &lt;char&gt;     &lt;int&gt;      &lt;num&gt;
 1:     1   sonar classif.featureless            cv         1 0.40476190
 2:     1   sonar classif.featureless            cv         2 0.52380952
 3:     1   sonar classif.featureless            cv         3 0.42857143
 4:     1   sonar classif.featureless            cv         4 0.58536585
 5:     1   sonar classif.featureless            cv         5 0.39024390
 6:     2   sonar         classif.svm            cv         1 0.26190476
 7:     2   sonar         classif.svm            cv         2 0.14285714
 8:     2   sonar         classif.svm            cv         3 0.11904762
 9:     2   sonar         classif.svm            cv         4 0.14634146
10:     2   sonar         classif.svm            cv         5 0.17073171
11:     3   sonar       classif.rpart            cv         1 0.35714286
12:     3   sonar       classif.rpart            cv         2 0.23809524
13:     3   sonar       classif.rpart            cv         3 0.42857143
14:     3   sonar       classif.rpart            cv         4 0.31707317
15:     3   sonar       classif.rpart            cv         5 0.21951220
16:     4   sonar        classif.kknn            cv         1 0.14285714
17:     4   sonar        classif.kknn            cv         2 0.19047619
18:     4   sonar        classif.kknn            cv         3 0.11904762
19:     4   sonar        classif.kknn            cv         4 0.19512195
20:     4   sonar        classif.kknn            cv         5 0.04878049
       nr task_id          learner_id resampling_id iteration classif.ce
Hidden columns: uhash, task, learner, resampling, prediction</code></pre>
</div>
</div>
<p>显然，在不同分割的交叉验证集上，同一模型的分类错误率都存在差异。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      nr task_id          learner_id resampling_id iters classif.ce
   &lt;int&gt;  &lt;char&gt;              &lt;char&gt;        &lt;char&gt; &lt;int&gt;      &lt;num&gt;
1:     1   sonar classif.featureless            cv     5  0.4665505
2:     2   sonar         classif.svm            cv     5  0.1681765
3:     3   sonar       classif.rpart            cv     5  0.3120790
4:     4   sonar        classif.kknn            cv     5  0.1392567
Hidden columns: resample_result</code></pre>
</div>
</div>
<p>从平均分类错误率来看，kknn模型最好，svm模型次之，rpart模型第三，featureless模型最差。<br>
再来比较四个模型对正类M和负类R的分类准确率以及综合分类准确率，分别将classif.tpr、classif.tnr和classif.fbeta测度传入<code>$aggregate()</code>：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.tpr"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      nr task_id          learner_id resampling_id iters classif.tpr
   &lt;int&gt;  &lt;char&gt;              &lt;char&gt;        &lt;char&gt; &lt;int&gt;       &lt;num&gt;
1:     1   sonar classif.featureless            cv     5   1.0000000
2:     2   sonar         classif.svm            cv     5   0.8626078
3:     3   sonar       classif.rpart            cv     5   0.7536078
4:     4   sonar        classif.kknn            cv     5   0.9341373
Hidden columns: resample_result</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.tnr"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      nr task_id          learner_id resampling_id iters classif.tnr
   &lt;int&gt;  &lt;char&gt;              &lt;char&gt;        &lt;char&gt; &lt;int&gt;       &lt;num&gt;
1:     1   sonar classif.featureless            cv     5   0.0000000
2:     2   sonar         classif.svm            cv     5   0.7853461
3:     3   sonar       classif.rpart            cv     5   0.6177956
4:     4   sonar        classif.kknn            cv     5   0.7823604
Hidden columns: resample_result</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.fbeta"</span>, <span class="at">beta =</span> <span class="dv">1</span>))  <span class="co"># beta默认值为1</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      nr task_id          learner_id resampling_id iters classif.fbeta
   &lt;int&gt;  &lt;char&gt;              &lt;char&gt;        &lt;char&gt; &lt;int&gt;         &lt;num&gt;
1:     1   sonar classif.featureless            cv     5     0.6924971
2:     2   sonar         classif.svm            cv     5     0.8439107
3:     3   sonar       classif.rpart            cv     5     0.7138022
4:     4   sonar        classif.kknn            cv     5     0.8724274
Hidden columns: resample_result</code></pre>
</div>
</div>
<p>比较这三个测度的结果可以发现，featureless模型的TPR为1，排名第一，但TNR为0，排名第四；kknn模型的TPR排名第二，TNR排名第二；svm模型的TPR排名第三，TNR排名第一；rpart模型TPR排名第四，TNR排名第三；F1分值，kknn模型排名第一，svm模型排名第二，rpart模型排名第三，featureless模型排名第四。综合考虑，可以选择kknn模型和svm模型继续开展超参数优化后再比较泛化性能。</p>
<p>下面再来计算四个模型在测试集和预测集上的ROC曲线下面积(classif.auc测度)：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>ms <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">msr</span>(<span class="st">"classif.auc"</span>, <span class="at">predict_sets =</span> <span class="st">"train"</span>, <span class="at">id =</span> <span class="st">"auc_train"</span>),</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">msr</span>(<span class="st">"classif.auc"</span>, <span class="at">id =</span> <span class="st">"auc_test"</span>)</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">=</span> bmr<span class="sc">$</span><span class="fu">aggregate</span>(ms)</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tab[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="dv">7</span><span class="sc">:</span><span class="dv">8</span>)])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      nr task_id          learner_id auc_train  auc_test
   &lt;int&gt;  &lt;char&gt;              &lt;char&gt;     &lt;num&gt;     &lt;num&gt;
1:     1   sonar classif.featureless 0.5000000 0.5000000
2:     2   sonar         classif.svm 0.9994480 0.9349302
3:     3   sonar       classif.rpart 0.9110997 0.7284968
4:     4   sonar        classif.kknn 0.9987746 0.9384684
Hidden columns: resample_result</code></pre>
</div>
</div>
<p>从计算结果来看，训练集上，svm模型AUC最大，其次是kknn模型，rpart模型排名第三；而在测试集上，kknn模型最大，svm模型其次，rpart模型仍然第三。下面用autoplot()函数来绘制ROC曲线，结果如 <a href="#fig-5.13" class="quarto-xref">图&nbsp;<span>5.13</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>bmr_plot <span class="ot">=</span> bmr<span class="sc">$</span><span class="fu">clone</span>()</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bmr_plot, <span class="at">type =</span> <span class="st">"roc"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-5.13" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH5_files/figure-html/fig-5.13-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.13: 不同学习器的ROC曲线
</figcaption>
</figure>
</div>
</div>
</div>
<p>ROC曲线越靠近左上角表示泛化性能越好。显然，featureless模型最差，svm模型和kknn模型很接近，都比较好，均显著优于决策树模型rpart。</p>
<p>继续用<code>autoplot()</code>绘制PR曲线，结果如 <a href="#fig-5.14" class="quarto-xref">图&nbsp;<span>5.14</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bmr_plot, <span class="at">type =</span> <span class="st">"prc"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-5.14" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH5_files/figure-html/fig-5.14-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.14: 不同学习器的PR曲线
</figcaption>
</figure>
</div>
</div>
</div>
<p>PR曲线越靠近右上角越好，四个模型的性能比较结果与ROC曲线一致。</p>
<p><code>autoplot()</code>还可以绘制基准测试结果性能测度的箱线图(type = “boxplot”，默认值)，结果如 <a href="#fig-5.14" class="quarto-xref">图&nbsp;<span>5.14</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bmr_plot) <span class="sc">+</span> </span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-5.15" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.15-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH5_files/figure-html/fig-5.15-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.15-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.15: 不同学习器的性能测度箱线图
</figcaption>
</figure>
</div>
</div>
</div>
<p>从 <a href="#fig-5.15" class="quarto-xref">图&nbsp;<span>5.15</span></a> 可见，svm模型和kknn模型的分类错误率中位数很接近，都比较小，但前者相对更稳定，而后者在分类错误率降低方面有较大的潜力。</p>
<div id="exr-5.1" class="theorem exercise">
<p><span class="theorem-title"><strong>练习 5.1</strong></span> <br>
(1)安装mlr3verse套件。<br>
(2)基于mlr3内置任务iris，参照 <a href="#exm-5.1" class="quarto-xref">例&nbsp;<span>5.1</span></a> 的全部内容进行练习。</p>
</div>
</section>
</section>
<section id="超参数优化" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="超参数优化"><span class="header-section-number">5.4</span> 超参数优化</h2>
<p>机器学习算法的超参数对算法的学习过程以及最终模型的泛化性能具有重要影响。机器学习建模过程中，超参数优化(HPO，亦称模型调优)是一个极其重要但开销(时间和算力成本)很大的步骤，其本质是黑盒优化问题，其根本目的是提高模型的泛化性能。mlr3提供了寻找最佳超参数配置的功能，这些功能依赖于bbotk、paradox、mlr3tuning、mlr3hyperban、mlr3mbo等工具包。mlr3tuningspace工具包为许多流行的机器学习算法提供了随时可用的搜索空间配置。</p>
<p>对于给定的有监督学习任务，无论是回归还是分类，都需要基于具体且有限的学习数据，在选定的机器学习算法的超参数空间中找到使最终模型泛化性能最佳的参数配置。寻找最佳超参数配置需要调用寻优算法，在控制台输入<code>mlr_tuners</code>可查询mlr3tuning包内置的寻优算法(调优器)的关键字，输入<code>as.data.table(mlr_tuners)</code>可查看寻优算法更详细的信息，包括寻优算法支持寻优参数的类型、支持寻优规则的类型(单规则、多规则以及依赖规则)以及必需安装的工具包等。</p>
<p>mlr3tuning目前支持”cmaes”(协方差矩阵自适应进化策略)、“gensa”(模拟退火算法)、“grid_search”(网格搜索法)、“hyperband”(超频带法)、“irace”(迭代竞赛法)、“mbo”(基于模型的贝叶斯优化法)、“nloptr”(非线性优化法)、“random_search”(随机搜索法)、“successive_halving”(连续减半法)等多种寻优算法。其中”grid_search”是一种遍历式的搜索方法，可以找到全局最佳超参数配置，但计算开销极大；“random_search”容易陷入局部最优；“hyperband”和”successive_halving”可以显著减少超参数优化的时间和算力成本；“mbo”是一种基于贝叶斯优化原理的全局黑箱优化算法，通常能够发现良好泛化性能的超参数配置。</p>
<p>HPO的一般步骤：</p>
<p>(1)创建学习任务、学习器、设置超参数搜索空间、创建重抽样策略(<code>rsmp()</code>或<code>rsmps()</code>函数)、指定性能测度和寻优终止条件(<code>trm()</code>或<code>trms()</code>函数)；<br>
(2)利用<code>ti()</code>函数封装以上对象形成调优实例；<br>
(3)利用<code>tnr()</code>或<code>tnrs()</code>函数创建调优器对象(Tuner)；<br>
(4)将调优实例传递给调优器对象的<code>$tune()</code>方法进行寻优；<br>
(5)将调优实例中保存的最佳超参数配置传给学习器，学习器根据最优超参数配置进行训练和预测。</p>
<p>其中设置超参数搜索空间，可以在学习器创建时利用<code>to_tune()</code>函数进行设置，也可在学习器创建后利用paradox工具包的<code>ps()</code>函数创建更高级更复杂的超参数搜索空间，或者利用<code>lts()</code>、<code>ltss()</code>函数直接加载mlr3tuningspace包中预置的超参数配置搜索空间。</p>
<section id="创建调优实例" class="level3" data-number="5.4.1">
<h3 data-number="5.4.1" class="anchored" data-anchor-id="创建调优实例"><span class="header-section-number">5.4.1</span> 创建调优实例</h3>
<div id="exm-5.2" class="theorem example">
<p><span class="theorem-title"><strong>例 5.2</strong></span> 基于 <a href="#exm-5.1" class="quarto-xref">例&nbsp;<span>5.1</span></a> 基准测试的结果，选择支持向量机算法对其正则化参数cost和核函数(非线性核函数)参数gamma进行调优。</p>
</div>
<p>(1)加载相关工具包。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(2)创建任务。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>, <span class="at">positive =</span> <span class="st">"M"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(3)创建学习器，并用<code>to_tune()</code>函数设置超参数配置搜索空间。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>lr <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.svm"</span>,</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">cost  =</span> <span class="fu">to_tune</span>(<span class="fl">1e-5</span>, <span class="fl">1e5</span>, <span class="at">logscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">gamma =</span> <span class="fu">to_tune</span>(<span class="fl">1e-5</span>, <span class="fl">1e5</span>, <span class="at">logscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">kernel =</span> <span class="st">"radial"</span>,</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">type =</span> <span class="st">"C-classification"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(4)创建重抽样策略。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>rs <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>重抽样策略对于估计模型的泛化性能或误差非常重要。mlr3提供的重抽样策略可以通过<code>mlr_resamplings</code>查询其关键字，在控制台执行以下代码<code>as.data.table(mlr_resamplings)</code>可查询抽抽样策略的详细信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(mlr_resamplings)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;key&gt;
           key                         label        params iters
        &lt;char&gt;                        &lt;char&gt;        &lt;list&gt; &lt;int&gt;
1:   bootstrap                     Bootstrap ratio,repeats    30
2:      custom                 Custom Splits                  NA
3:   custom_cv Custom Split Cross-Validation                  NA
4:          cv              Cross-Validation         folds    10
5:     holdout                       Holdout         ratio     1
6:    insample           Insample Resampling                   1
7:         loo                 Leave-One-Out                  NA
8: repeated_cv     Repeated Cross-Validation folds,repeats   100
9: subsampling                   Subsampling ratio,repeats    30</code></pre>
</div>
</div>
<p>key字段给出重抽样策略的关键字，label字段给出关键字对应的重抽样策略，params字段给出该重抽样策略的参数，iters字段为默认迭代次数。最常用的重抽样策略有交叉验证”cv”、重复交叉验证”repeated_cv”、自举抽样”bootstrap”等，对于特殊的任务，可以选用”custom”来自定义重抽样策略。</p>
<p>如果随机划分的训练集和测试集对整体数据集有很好的代表性，那么可以考虑采用”holdout”策略，因为该策略计算成本最低；“subsampling”策略是”holdout”策略的多次重复，能够减小泛化性能或误差的估计偏差。“cv”策略尤其是”loo”策略是被实践证明估计偏差最小的策略，针对不平衡数据集可以采用分层交叉验证策略，“repeated_cv”策略可以克服分割子集对整体数据集代表性差的问题。“bootstrap”策略利用回置抽样方法分割子集并重复多次，“custom_cv”策略是根据指定的因子变量分割交叉验证子集，“insample”策略是将整体数据集同时作为训练集和测试集。mlr3spatiotempcv扩展包为时空数据提供了特殊的交叉验证策略。</p>
<p>在创建重抽样策略后，可在控制台查询该策略的信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>rs</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ResamplingCV&gt;: Cross-Validation
* Iterations: 5
* Instantiated: FALSE
* Parameters: folds=5</code></pre>
</div>
</div>
<p>第一行说明重抽样策略类型，第二行给出该策略的迭代次数，迭代次数越多，时间和算力成本越高；第三行表明该策略尚未实例化(即该策略尚未应用于具体学习任务数据)；第四行给出该策略的参数设置。</p>
<p>(5)指定性能测度。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>ms <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>同样可以在控制台查看性能测度对象的信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>ms</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;MeasureClassifSimple:classif.ce&gt;: Classification Error
* Packages: mlr3, mlr3measures
* Range: [0, 1]
* Minimize: TRUE
* Average: macro
* Parameters: list()
* Properties: -
* Predict type: response</code></pre>
</div>
</div>
<p>第一行说明该测度的类型；第二行给出该测度的依赖工具包；第三行是该测度的取值范围是[0, 1]；第四行表明该测度是越小越好；第五行表明该测度的平均方式，macro表示宏平均，亦即计算分组平均值的平均值，而micro表示微平均，亦即对所有分组中个体的标志值求总体平均值；第六行给出该测度的参数列表；第七行给出该测度的属性；第八行给出该测度的支持的预测输出类型。不同的测度对象给出的信息有所差异，如果是<code>msrs()</code>函数创建的包含多个测度的对象，则按测度关键字给出各个测度的信息。</p>
<p>(6)指定寻优终止条件。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>tm <span class="ot">=</span> <span class="fu">trm</span>(<span class="st">"none"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>mlr3提供的终止条件(终止器对象)可以通过<code>mlr_terminators</code>查询关键字，在控制台执行以下代码来查询终止条件的具体信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(mlr_terminators)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;key&gt;
                key                label             properties        unit
             &lt;char&gt;               &lt;char&gt;                 &lt;list&gt;      &lt;char&gt;
1:       clock_time           Clock Time single-crit,multi-crit     seconds
2:            combo          Combination single-crit,multi-crit     percent
3:            evals Number of Evaluation single-crit,multi-crit evaluations
4:             none                 None single-crit,multi-crit     percent
5:     perf_reached    Performance Level            single-crit     percent
6:         run_time             Run Time single-crit,multi-crit     seconds
7:       stagnation           Stagnation            single-crit     percent
8: stagnation_batch     Stagnation Batch            single-crit     percent</code></pre>
</div>
</div>
<p>key字段给出终止条件的关键字，label字段给出对应的终止条件名称，properties字段给出对应的应用范围(单准则和多准则)，unit字段给出终止条件的单位/量纲。“evals”表示评估次数超过设定值时终止，“stagnation”和”stagnation_batch”表示性能在过去n次迭代(前者)或过去n批次中不再改善时终止，“perf_reached”表示性能测度达到目标值时终止，“clcok_time”表示在固定时间点终止，“run_time”表示在运行一段时间后终止，“none”表示没有终止条件(主要用于遍历式的寻优算法)。如果需要采用多个终止条件，则需要采用”combo”来建立组合终止条件。有些超参数寻优算法必须指定终止条件，但有些寻优算法如”gird_search”是在有限的超参数配置空间中进行遍历，无需设置终止条件(故对应终止条件采用”none”)。同样可以在控制台输入终止器对象的名称来查看其信息。</p>
<p>(7)创建调优实例。</p>
<p><code>ti()</code>函数用于封装任务、学习器、重抽样策略、测度、终止器以及超参数搜索空间，以创建调优实例对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>ins <span class="ot">=</span> <span class="fu">ti</span>(<span class="at">task =</span> task,</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">learner =</span> lr,</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">resampling =</span> rs,</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">measures =</span> ms,</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">terminator =</span> tm)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在控制台查看调优实例对象的基本信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>ins</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TuningInstanceSingleCrit&gt;
* State:  Not optimized
* Objective: &lt;ObjectiveTuning:classif.svm_on_sonar&gt;
* Search Space:
       id    class     lower    upper nlevels
   &lt;char&gt;   &lt;char&gt;     &lt;num&gt;    &lt;num&gt;   &lt;num&gt;
1:   cost ParamDbl -11.51293 11.51293     Inf
2:  gamma ParamDbl -11.51293 11.51293     Inf
* Terminator: &lt;TerminatorNone&gt;</code></pre>
</div>
</div>
<p>第一行描述表明该调优实例是一个单准则调优实例；第二行表明该实例处于未优化状态；第三条说明调优目标是在sonar任务上调优classif.svm模型；第四行到第七行给出超参数搜索空间；最后一行给出设定的寻优终止条件。</p>
</section>
<section id="创建调优器并运行调优" class="level3" data-number="5.4.2">
<h3 data-number="5.4.2" class="anchored" data-anchor-id="创建调优器并运行调优"><span class="header-section-number">5.4.2</span> 创建调优器并运行调优</h3>
<p>(1)创建调优器。</p>
<p>通过mlr3tuning包中的<code>tnr()</code>或<code>tnrs()</code>指定寻优算法并配置相应参数，以创建调优器对象。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>tu <span class="ot">=</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>, <span class="at">resolution =</span> <span class="dv">11</span>, <span class="at">batch_size =</span> <span class="dv">10</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>上述代码指定优化算法为网格搜索法，resolution参数指定超参数均匀分割点数，所有超参数的分割点组合成超参数搜索空间。本例中优化2个超参数，因此将对<span class="math inline">11^2=121</span>个超参数配置进行性能评估。batch_size参数指定一次输入模型的样例数(默认值为1)，模型按批学习和计算损失，因此，该参数越大，运算量越少。</p>
<p>在控制台查看调优器的信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>tu</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TunerGridSearch&gt;: Grid Search
* Parameters: resolution=11, batch_size=10
* Parameter classes: ParamLgl, ParamInt, ParamDbl, ParamFct
* Properties: dependencies, single-crit, multi-crit
* Packages: mlr3tuning</code></pre>
</div>
</div>
<p>第一行说明寻优算法类型；第二行给出该寻优算法的参数及其设置值；第三行为该寻优算法支持寻优的参数类型，第四行为该寻优算法的性质，即可优化的目标类型；第五行为该寻优算法所依赖的工具包。</p>
<p>(2)运行调优器。</p>
<p>接下来，将调优实例传递给调优器对象的<code>$optimize()</code>方法，这将在每个重抽样子集上评估所有超参数配置，如果重抽样子集过多、超参数配置过多，则寻优过程极为耗时并极大地占用计算机硬件资源，尤其是遍历式的寻优算法，如”grid_search”。</p>
<p>调优结束后返回最优超参数配置：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 运行需要一定时间，并产生较多信息</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>tu<span class="sc">$</span><span class="fu">optimize</span>(ins)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>调优结果保存在调优实例中，在控制台再次查看调优实例的信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>ins</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="do">## &lt;TuningInstanceSingleCrit&gt;</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="do">## * State:  Optimized</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="do">## * Objective: &lt;ObjectiveTuning:classif.svm_on_sonar&gt;</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="do">## * Search Space:</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="do">##        id    class     lower    upper nlevels</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a><span class="do">##    &lt;char&gt;   &lt;char&gt;     &lt;num&gt;    &lt;num&gt;   &lt;num&gt;</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 1:   cost ParamDbl -11.51293 11.51293     Inf</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 2:  gamma ParamDbl -11.51293 11.51293     Inf</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a><span class="do">## * Terminator: &lt;TerminatorNone&gt;</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a><span class="do">## * Result:</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a><span class="do">##       cost    gamma classif.ce</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a><span class="do">##      &lt;num&gt;    &lt;num&gt;      &lt;num&gt;</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 1: 9.21034 -4.60517  0.1297329</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a><span class="do">## * Archive:</span></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a><span class="do">##            cost      gamma classif.ce</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a><span class="do">##           &lt;num&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a><span class="do">##   1: -11.512925  -6.907755  0.4667828</span></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a><span class="do">##   2: -11.512925  11.512925  0.4667828</span></span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a><span class="do">##   3:  -6.907755   2.302585  0.4667828</span></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a><span class="do">##   4:   0.000000  -6.907755  0.2643438</span></span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a><span class="do">##   5:   2.302585 -11.512925  0.4667828</span></span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a><span class="do">##  ---                                 </span></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a><span class="do">## 117:  -4.605170  -9.210340  0.4667828</span></span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 118:   2.302585  -6.907755  0.2349593</span></span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a><span class="do">## 119:   9.210340 -11.512925  0.2686411</span></span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 120:   9.210340   6.907755  0.4667828</span></span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a><span class="do">## 121:  11.512925   6.907755  0.4667828</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>与未优化前相比，调优实例ins的State属性已经改变为Optimized，同时增加了Result和Archive内容，其中Result为寻优结果，即最优超参数配置与相应的性能测度，Archive保存了所有超参数配置及其性能测度。</p>
<p>通过以下代码可查看实际最优超参数配置：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>ins<span class="sc">$</span>result<span class="sc">$</span>learner_param_vals</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]$kernel</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "radial"</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]$type</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "C-classification"</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]$cost</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 10000</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]$gamma</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.01</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>这里显示的超参数cost和gamma的值之所以不同于调优实例Result中保存的值，是因为后者保存的超参数值通过<code>log()</code>函数进行了变换，通过<code>exp()</code>函数即可将其还原。</p>
<p>通过<code>autoplot()</code>对调优结果进行可视化，结果如图 <a href="#fig-5.16" class="quarto-xref">图&nbsp;<span>5.16</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(ins, <span class="at">type =</span> <span class="st">"surface"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.16" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.16-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.16.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.16-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.16: 超参数寻优结果热力图
</figcaption>
</figure>
</div>
</div>
</div>
<p>使用网格搜索法的技巧：先在粗粒度的超参数配置网格上搜索，然后在性能测度最优区域建立细粒度的超参数配置网格再次搜索，从而找到更接近全局最优的超参数配置。</p>
</section>
<section id="训练最优模型" class="level3" data-number="5.4.3">
<h3 data-number="5.4.3" class="anchored" data-anchor-id="训练最优模型"><span class="header-section-number">5.4.3</span> 训练最优模型</h3>
<p>(1)创建学习器。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>svm_opt <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.svm"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(2)将最优超参数配置传给学习器。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>svm_opt<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> ins<span class="sc">$</span>result_learner_param_vals</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(3)在训练集上训练模型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>svm_opt<span class="sc">$</span><span class="fu">train</span>(task, <span class="at">row_ids =</span> split<span class="sc">$</span>train)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(4)计算模型的拟合误差和预测误差。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>svm_opt<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> split<span class="sc">$</span>train)<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="do">## classif.ce </span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="do">##          0</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>svm_opt<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> split<span class="sc">$</span>test)<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="do">## classif.ce </span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 0.05797101</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>从结果看，模型在训练集上的分类错误率为0，而在测试集上分类错误率约5.80%。</p>
</section>
<section id="简化超参数优化操作" class="level3" data-number="5.4.4">
<h3 data-number="5.4.4" class="anchored" data-anchor-id="简化超参数优化操作"><span class="header-section-number">5.4.4</span> 简化超参数优化操作</h3>
<p>mlr3提供了两种无需预先创建调优实例的超参数优化途径。</p>
<p>(1)使用<strong><code>tune()</code></strong>函数。</p>
<p>将创建调优实例的组件传给<code>tune()</code>，可直进行超参数优化，并返回调优实例对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 运行需要一定时间，并产生较多信息</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>ins <span class="ot">=</span> <span class="fu">tune</span>(<span class="at">tuner =</span> tu,</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">task =</span> task,</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">learner =</span> lr,</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">resampling =</span> rs,</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">measures =</span> ms,</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">terminator =</span> tm)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>然后通过<code>$result_learner_param_vals</code>查询该调优实例对象保存的最优超参数配置。</p>
<p>(2)使用<strong><code>auto_tuner()</code></strong>函数。</p>
<p>将创建调优实例的组件传给<code>auto_tuner()</code>，该函数将创建一个AutoTuner对象。AutoTuner对象继承了类Learner的属性和方法，并封装了所有调优信息，这意味着可以像操作Learner对象一样操作该对象。AutoTuner对象在调用<code>$train()</code>方法时，先在底层对任务数据执行<code>tune()</code>函数，然后将学习器超参数设置为最优配置，再在训练集上训练模型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>at <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> tu,</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> lr,</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> rs,</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> ms,</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> tm</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>查看该对象的元信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>at</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="do">## &lt;AutoTuner:classif.svm.tuned&gt;</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="do">## * Model: list</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="do">## * Search Space:</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="do">## &lt;ParamSet&gt;</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="do">##        id    class     lower    upper nlevels</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a><span class="do">##    &lt;char&gt;   &lt;char&gt;     &lt;num&gt;    &lt;num&gt;   &lt;num&gt;</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 1:   cost ParamDbl -11.51293 11.51293     Inf</span></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 2:  gamma ParamDbl -11.51293 11.51293     Inf</span></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a><span class="do">##                                                                                      default</span></span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a><span class="do">##                                                                                       &lt;list&gt;</span></span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 1: &lt;NoDefault&gt;\n  Public:\n    clone: function (deep = FALSE) \n    initialize: function () </span></span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 2: &lt;NoDefault&gt;\n  Public:\n    clone: function (deep = FALSE) \n    initialize: function () </span></span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a><span class="do">##     value</span></span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a><span class="do">##    &lt;list&gt;</span></span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 1:       </span></span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 2:       </span></span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a><span class="do">## Trafo is set.</span></span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a><span class="do">## * Packages: mlr3, mlr3tuning, mlr3learners, e1071</span></span>
<span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a><span class="do">## * Predict Type: response</span></span>
<span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a><span class="do">## * Feature Types: logical, integer, numeric</span></span>
<span id="cb134-21"><a href="#cb134-21" aria-hidden="true" tabindex="-1"></a><span class="do">## * Properties: multiclass, twoclass</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>像Learner对象一样调用<code>$train()</code>方法，HPO过程融入模型训练过程：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 运行需要一定时间，并产生较多信息</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>at<span class="sc">$</span><span class="fu">train</span>(task, <span class="at">row_ids =</span> train)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>计算训练集拟合性能：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>at<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> train)<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="do">## classif.ce </span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="do">##          0 </span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>计算预测集预测性能：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>at<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> test)<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="do">## classif.ce </span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  0.3958333 </span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="设置超参数配置搜索空间的其他方法" class="level3" data-number="5.4.5">
<h3 data-number="5.4.5" class="anchored" data-anchor-id="设置超参数配置搜索空间的其他方法"><span class="header-section-number">5.4.5</span> 设置超参数配置搜索空间的其他方法</h3>
<section id="利用ps函数" class="level4" data-number="5.4.5.1">
<h4 data-number="5.4.5.1" class="anchored" data-anchor-id="利用ps函数"><span class="header-section-number">5.4.5.1</span> 利用<strong><code>ps()</code></strong>函数</h4>
<p>paradox包中的<code>ps()</code>可以更灵活地设置机器学习算法的超参数配置搜索空间。对于 <a href="#exm-5.2" class="quarto-xref">例&nbsp;<span>5.2</span></a> 中的classif.svm算法的超参数配置搜索空间，通过<code>ps()</code>进行配置，代码如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>, <span class="at">positive =</span> <span class="st">"M"</span>)</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>split <span class="ot">=</span> <span class="fu">partition</span>(task)</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>lr <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.svm"</span>, <span class="at">kernel =</span> <span class="st">"radial"</span>, <span class="at">type =</span> <span class="st">"C-classification"</span>)</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">=</span> <span class="fu">ps</span>(<span class="at">cost  =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fu">log</span>(<span class="fl">1e-1</span>), <span class="at">upper =</span> <span class="fu">log</span>(<span class="fl">1e5</span>),</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">trafo =</span> <span class="cf">function</span>(x) <span class="fu">exp</span>(x)),</span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">gamma =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fu">log</span>(<span class="fl">1e-5</span>), <span class="at">upper =</span> <span class="fu">log</span>(<span class="fl">1e5</span>),</span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">trafo =</span> <span class="cf">function</span>(x) <span class="fu">exp</span>(x)))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>paradox包中函数<code>p_dbl()</code>、<code>p_int()``、p_fct()</code>、<code>p_lgl()</code>和<code>p_uty()</code>分别创建对应于mlr3包中基础类ParamDbl、Param_Int、Param_Fct、Param_Lgl和Param_Uty的超参数对象。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 配置重抽样策略、性能测度、寻优终止条件、寻优算法</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>rs <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>ms <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>)</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>tm <span class="ot">=</span> <span class="fu">trm</span>(<span class="st">"none"</span>)</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>tu <span class="ot">=</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>, <span class="at">resolution =</span> <span class="dv">11</span>, <span class="at">batch_size =</span> <span class="dv">10</span>)</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建自动调优器</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>at <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> tu,</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> lr,</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> ss,</span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> rs,</span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> ms,</span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> tm)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 训练</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 运行需要一定时间，并产生较多信息 </span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>at<span class="sc">$</span><span class="fu">train</span>(task, <span class="at">row_ids =</span> split<span class="sc">$</span>train)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 预测</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>at<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> split<span class="sc">$</span>train)<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="do">## classif.ce </span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="do">##          0 </span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算预测集性能测度</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>at<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> split<span class="sc">$</span>test)<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="do">## classif.ce </span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 0.07246377</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>ps()</code>对超参数配置搜索空间的设置，比<code>to_tune()</code>相对复杂一些，但功能更强，特别是能够通过.extra_trafo参数对超参数配置搜索空间提供更灵活和更复杂的设置。例如，可以建立“伪超参数”与超参数之间的关系，将超参数寻优转换为对“伪超参数”的寻优。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>ss1 <span class="ot">=</span> <span class="fu">ps</span>(</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">p_int</span>(<span class="dv">1</span>,  <span class="dv">10</span>),</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">p_int</span>(<span class="dv">4</span>,<span class="dv">36</span>),</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">.extra_trafo =</span> <span class="cf">function</span>(x, param_set){</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>rhp <span class="ot">=</span> <span class="fu">rep</span>(x<span class="sc">$</span>b, x<span class="sc">$</span>a)</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>a <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>b <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>    x</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>上面的代码在<code>ps()</code>中，利用<code>p_int()</code>建立了两个伪超参数a和b，通过.eatra_trafo建立了实际超参数rhp与a和b之间的关系，本例中rhp是由a和b构成的向量，a是向量的长度，b是向量的元素；然后删除a和b，返回实际超参数rhp。可以将a和b的值传给<code>$trafo()</code>方法来查询输出结果：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>ss1<span class="sc">$</span><span class="fu">trafo</span>(<span class="fu">list</span>(<span class="at">a =</span> <span class="dv">5</span>, <span class="at">b =</span> <span class="dv">6</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="do">## $rhp</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 6 6 6 6 6</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>这对向量型超参数的寻优极为有用，因为<code>to_tune()</code>只能对标量型超参数设置搜索空间。<br>
此外，用<code>ps()</code>设置超参数搜索空间，还可以解决超参数依赖问题。所谓超参数依赖，是指一个超参数在另一个超参数被设置为特定值时才允许被设置。例如，在支持向量机算法中，超参数degree只有在超参数kernel的值为polynomial时，才允许被设置。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>ss2 <span class="ot">=</span> <span class="fu">ps</span>(</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">cost =</span> <span class="fu">p_dbl</span>(<span class="fl">1e-3</span>, <span class="fl">1e3</span>),</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">kernel =</span> <span class="fu">p_fct</span>(<span class="fu">c</span>(<span class="st">"radial"</span>, <span class="st">"polynomial"</span>)),</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">degree =</span> <span class="fu">p_int</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="at">depends =</span> (kernel <span class="sc">==</span> <span class="st">"polynomial"</span>)),</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma =</span> <span class="fu">p_dbl</span>(<span class="fl">1e-3</span>, <span class="fl">1e3</span>, <span class="at">depends =</span> (kernel <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"radial"</span>, <span class="st">"polynomial"</span>)))</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>以上代码解决了超参数degree和gamma对超参数kernel的依赖问题。可在控制台输入ss2来查看以上代码创建的ParamSet对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>ss2</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet&gt;</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Unknown argument 'on' has been passed.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;id&gt;
       id    class lower upper nlevels
   &lt;char&gt;   &lt;char&gt; &lt;num&gt; &lt;num&gt;   &lt;num&gt;
1:   cost ParamDbl 0.001  1000     Inf
2: degree ParamInt 1.000     3       3
3:  gamma ParamDbl 0.001  1000     Inf
4: kernel ParamFct    NA    NA       2
                                                                                     default
                                                                                      &lt;list&gt;
1: &lt;NoDefault&gt;\n  Public:\n    clone: function (deep = FALSE) \n    initialize: function () 
2: &lt;NoDefault&gt;\n  Public:\n    clone: function (deep = FALSE) \n    initialize: function () 
3: &lt;NoDefault&gt;\n  Public:\n    clone: function (deep = FALSE) \n    initialize: function () 
4: &lt;NoDefault&gt;\n  Public:\n    clone: function (deep = FALSE) \n    initialize: function () 
   parents  value
    &lt;list&gt; &lt;list&gt;
1:               
2:  kernel       
3:  kernel       
4:               </code></pre>
</div>
</div>
<p>第一行表明ss2是基于ParamSet类创建的对象，其余内容为超参数的信息表，其中parents列为各个超参数的依赖项。</p>
<p>在创建Learner对象后，利用<code>$param_set$deps</code>查询该学习器存在依赖项的超参数：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>lr1 <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.svm"</span>)</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>lr1<span class="sc">$</span>param_set<span class="sc">$</span>deps</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        id     on              cond
    &lt;char&gt; &lt;char&gt;            &lt;list&gt;
1:   coef0 kernel &lt;CondAnyOf:anyof&gt;
2:    cost   type &lt;CondAnyOf:anyof&gt;
3:  degree kernel &lt;CondEqual:equal&gt;
4: epsilon   type &lt;CondEqual:equal&gt;
5:   gamma kernel &lt;CondAnyOf:anyof&gt;
6:      nu   type &lt;CondEqual:equal&gt;</code></pre>
</div>
</div>
<p>结果表明，regr.svm学习器存在6个有依赖项的超参数。再通过<code>$param_set$deps$cond</code>查看具体的依赖项：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>lr1<span class="sc">$</span>param_set<span class="sc">$</span>deps<span class="sc">$</span>cond</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
CondAnyOf: x ∈ {polynomial, sigmoid}

[[2]]
CondAnyOf: x ∈ {eps-regression, nu-regression}

[[3]]
CondEqual: x = polynomial

[[4]]
CondEqual: x = eps-regression

[[5]]
CondAnyOf: x ∈ {polynomial, radial, sigmoid}

[[6]]
CondEqual: x = nu-regression</code></pre>
</div>
</div>
</section>
<section id="利用mlr3tuningspaces工具包" class="level4" data-number="5.4.5.2">
<h4 data-number="5.4.5.2" class="anchored" data-anchor-id="利用mlr3tuningspaces工具包"><span class="header-section-number">5.4.5.2</span> 利用mlr3tuningspaces工具包</h4>
<p>设置超参数配置的搜索空间往往需要大量专业知识。mlr3扩展包mlr3tuningspaces为很多流行的机器学习算法提供了预先设定的搜索空间，这些超参数配置搜索空间的关键字可在加载mlr3tuningspaces包后，通过<code>mlr_tuning_spaces</code>查询，查询指定学习器超参数配置搜索空间的具体方法如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(mlr_tuning_spaces)[learner <span class="sc">==</span> <span class="st">"classif.svm"</span>, ]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;key&gt;
                   key                             label     learner n_values
                &lt;char&gt;                            &lt;char&gt;      &lt;char&gt;    &lt;int&gt;
1: classif.svm.default   Classification SVM with Default classif.svm        4
2:    classif.svm.rbv1 Classification SVM with RandomBot classif.svm        4
3:    classif.svm.rbv2 Classification SVM with RandomBot classif.svm        5</code></pre>
</div>
</div>
<p>以上代码查询mlr3tuningspaces包中对classif.svm学习器预先设定的超参数配置搜索空间。</p>
<p>将key列中的值传递给<code>lts()</code>或<code>ltss()</code>得相应搜索空间的具体信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lts</span>(<span class="st">"classif.svm.rbv2"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TuningSpace:classif.svm.rbv2&gt;: Classification SVM with RandomBot
          id lower upper                   levels logscale
      &lt;char&gt; &lt;num&gt; &lt;num&gt;                   &lt;list&gt;   &lt;lgcl&gt;
1:    kernel    NA    NA linear,polynomial,radial    FALSE
2:      cost 1e-04  1000                              TRUE
3:     gamma 1e-04  1000                              TRUE
4: tolerance 1e-04     2                              TRUE
5:    degree 2e+00     5                             FALSE</code></pre>
</div>
</div>
<p><code>lts()</code>函数获取的搜索空间可以直接传递给<code>ti()</code>函数中的search_space参数：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>ins <span class="ot">=</span> <span class="fu">ti</span>(</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>),</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.svm"</span>),</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>),</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">measures =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>),</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">20</span>),</span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> <span class="fu">lts</span>(<span class="st">"classif.svm.rbv2"</span>)</span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>也可以间接传给学习器对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>lr <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.svm"</span>)</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">=</span> <span class="fu">lts</span>(<span class="st">"classif.svm.rbv2"</span>)</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>lr<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">set_values</span>(<span class="at">.values =</span> ss<span class="sc">$</span>values)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="基于嵌套重抽样的泛化性能评估" class="level3" data-number="5.4.6">
<h3 data-number="5.4.6" class="anchored" data-anchor-id="基于嵌套重抽样的泛化性能评估"><span class="header-section-number">5.4.6</span> 基于嵌套重抽样的泛化性能评估</h3>
<p>当用于超参数优化和优化后模型性能评估的数据相同时，模型性能的估计可能过于乐观。为了减少模型性能估计的偏差，有必要将超参数优化和模型性能评估的过程分离，亦即用于超参数优化的数据与模型性能评估的数据保持独立。嵌套抽样技术包括外部抽样和内部抽样，外部抽样的训练集用于超参数优化，测试集用于评估最佳超参数配置模型的性能， <a href="#fig-5.17" class="quarto-xref">图&nbsp;<span>5.17</span></a> 演示了外部3折交叉验证与内部4折交叉验证的嵌套重抽样方案。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.17" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.17-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.17.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.17-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.17: 嵌套重抽样估计泛化性能
</figcaption>
</figure>
</div>
</div>
</div>
<p>嵌套重抽样并非选择最佳超参数配置的方法，而是一种减小模型泛化性能估计偏差的策略。外部交叉验证重抽样的每一折都会选出一个对应的最佳超参数配置的模型，因此该策略会得到多个不同超参数配置的最优模型的性能，而不是单个配置的最优模型的性能。</p>
<div id="exm-5.3" class="theorem example">
<p><span class="theorem-title"><strong>例 5.3</strong></span> 应用嵌套重抽样策略估计支持向量机算法在构造在friedman1数据集上的泛化性能。</p>
</div>
<p>利用<code>tgen()</code>函数生成基于Friedman1回归任务：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>tk <span class="ot">=</span> <span class="fu">tgen</span>(<span class="st">"friedman1"</span>)</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>tk_train <span class="ot">=</span> tk<span class="sc">$</span><span class="fu">generate</span>(<span class="dv">1000</span>)</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>tk_test <span class="ot">=</span> tk<span class="sc">$</span><span class="fu">generate</span>(<span class="dv">100000</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>该任务有10个特征变量(均匀分布于区间[0, 1])，前5个为有用特征(x1~x5)，后5个为无用特征，标签变量<span class="math inline">y</span>根据以下数学表达式由前五个特征变量生成：</p>
<p><span class="math display"> y=10 sin⁡(π x_1 x_2 )+20(x_3-0.5)^2+10x_4+5x_5+e</span> 式中<span class="math inline">e \sim N(0,\sigma)</span>。</p>
<p>接着创建学习器、超参数配置搜索空间、性能测度、寻优算法、终止条件、内部重抽样策略和外部重抽样策略：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>lr <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.svm"</span>, <span class="at">type =</span> <span class="st">"nu-regression"</span>)</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">=</span> <span class="fu">lts</span>(<span class="st">"regr.svm.rbv2"</span>)</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>ms <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"regr.mse"</span>)</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>tu <span class="ot">=</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>)</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>tr <span class="ot">=</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">100</span>)</span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>rs_inner <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>)</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>rs_outer <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>然后根据内部重抽样策略调优并返回泛化性能估计：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 运行需要一定时间，并产生较多的信息</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"multisession"</span>)  <span class="co"># 利用future执行多线程并行运算</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>ins <span class="ot">=</span> <span class="fu">tune</span>(</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> tu,</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> tk_train,</span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> lr,</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> rs_inner,</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">measures =</span> ms,</span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> tr,</span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> ss</span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"sequential"</span>)    <span class="co"># 恢复单线程</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>计算非嵌套重抽样的泛化性能测度估计值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>insample <span class="ot">=</span> ins<span class="sc">$</span>result_y</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>配置基于嵌套重抽样策略的自动调优器对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>at <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> tu,</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> lr,</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> ms,</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> rs_inner,</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> tr,</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> ss</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>计算嵌套重抽样的泛化性能测度估计值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"multisession"</span>)    <span class="co"># 执行多线程并行运算</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 运行需要一定时间，并产生较多的信息</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>outsample <span class="ot">=</span> <span class="fu">resample</span>(tk_train, at, rs_outer, <span class="at">store_models =</span> F)<span class="sc">$</span><span class="fu">aggregate</span>()</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"sequential"</span>)    <span class="co"># 恢复单线程</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>根据最优超参数配置训练模型并计算该模型在测试集tk_test上的实际泛化性能：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>lr_tuned <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.svm"</span>, <span class="at">type =</span> <span class="st">"nu-regression"</span>)</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>lr_tuned<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">set_values</span>(<span class="at">.values =</span> ins<span class="sc">$</span>result_learner_param_vals)</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>gp <span class="ot">=</span> lr_tuned<span class="sc">$</span><span class="fu">train</span>(tk_train)<span class="sc">$</span><span class="fu">predict</span>(tk_test)<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>输出并比较非嵌套重抽样和嵌套重抽样估计的泛化性能与实际泛化性能的大小：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" 实际泛化性能 ="</span>, <span class="fu">as.numeric</span>(gp),</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"非嵌套重抽样的估计值 = "</span>, <span class="fu">as.numeric</span>(insample),</span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a><span class="st">"嵌套重抽样的估计值 ="</span>, <span class="fu">as.numeric</span>(outsample))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 实际泛化性能 = 7.770473 </span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 非嵌套重抽样的估计值 =  5.442172 </span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 嵌套重抽样的估计值 = 8.188057</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>显然，非嵌套重抽样的泛化性能估计过于乐观了，而嵌套重抽样的估计值更接近实际泛化性能，甚至更保守。</p>
<div id="exr-5.2" class="theorem exercise">
<p><span class="theorem-title"><strong>练习 5.2</strong></span> <br>
基于mlr3内置任务iris和 <a href="#exr-5.1" class="quarto-xref">练习&nbsp;<span>5.1</span></a> 的结果，参照 <a href="#exm-5.2" class="quarto-xref">例&nbsp;<span>5.2</span></a> 的全部内容进行练习。</p>
</div>
</section>
</section>
<section id="特征选择" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="特征选择"><span class="header-section-number">5.5</span> 特征选择</h2>
<p>高维大数据中往往包括太多冗余变量，一般通过特征工程来解决，以克服此类问题对机器学习建模的不利影响。特征提取和特征选择是最常用的特征工程方法，前者通过特定算法从原始特征提取一组精简的新特征来替代原始特征，如主成分分析方法；后者是利用特定算法从原始特征中选择一个精简的特征子集来替代原始特征。特征提取的缺陷在于改变了原始特征，降低了机器学习模型的可解释性。通过特征工程可以为机器学习建模带来诸多好处，例如：因减少模型对不相关特征的过拟合而提升预测性能，因不依赖于噪声特征而让模型更稳健，因特征数减少而使模型更简单和更易于解释，模型训练和预测时间成本更低，以及无需收集成本更高的潜在特征等。</p>
<section id="特征过滤器" class="level3" data-number="5.5.1">
<h3 data-number="5.5.1" class="anchored" data-anchor-id="特征过滤器"><span class="header-section-number">5.5.1</span> 特征过滤器</h3>
<p>mlr3filters工具包提供了多种特征选择算法的封装对象，称为特征过滤器，即Filter对象。在控制台输入<code>mlr_filters</code>可查看特征过滤器的关键字：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>mlr_filters</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;DictionaryFilter&gt; with 21 stored values
Keys: anova, auc, carscore, carsurvscore, cmim, correlation, disr,
  find_correlation, importance, information_gain, jmi, jmim,
  kruskal_test, mim, mrmr, njmim, performance, permutation, relief,
  selected_features, variance</code></pre>
</div>
</div>
<p>查询关键字为importance的特征过滤器的详细信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(mlr_filters)[key <span class="sc">==</span> <span class="st">"importance"</span>]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;key&gt;
          key            label task_types task_properties params
       &lt;char&gt;           &lt;char&gt;     &lt;list&gt;          &lt;list&gt; &lt;list&gt;
1: importance Importance Score    classif                 method
                                          feature_types packages
                                                 &lt;list&gt;   &lt;list&gt;
1: logical,integer,numeric,character,factor,ordered,...     mlr3</code></pre>
</div>
</div>
<p><code>flt()</code>和<code>flts()</code>函数用于创建单个和多个Filter对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">fs_cor =</span> <span class="fu">flt</span>(<span class="st">"correlation"</span>, <span class="at">method =</span> <span class="st">"kendall"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;FilterCorrelation:correlation&gt;: Correlation
Task Types: regr
Properties: missings
Task Properties: -
Packages: stats
Feature types: integer, numeric</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">fs_mj =</span> <span class="fu">flts</span>(<span class="fu">c</span>(<span class="st">"mrmr"</span>, <span class="st">"jmim"</span>)))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$mrmr
&lt;FilterMRMR:mrmr&gt;: Minimum Redundancy Maximal Relevancy
Task Types: classif, regr
Properties: -
Task Properties: -
Packages: praznik
Feature types: integer, numeric, factor, ordered

$jmim
&lt;FilterJMIM:jmim&gt;: Minimal Joint Mutual Information Maximization
Task Types: classif, regr
Properties: -
Task Properties: -
Packages: praznik
Feature types: integer, numeric, factor, ordered</code></pre>
</div>
</div>
<p>将创建好的Task对象传入Filter对象的<code>$calculate()</code>方法，即可计算任务数据中各特征的得分，然后再根据得分来选择或丢弃特征。例如：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>fs_cor<span class="sc">$</span><span class="fu">calculate</span>(<span class="fu">tsk</span>(<span class="st">"mtcars"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>再来查看fs_cor的信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>fs_cor</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;FilterCorrelation:correlation&gt;: Correlation
Task Types: regr
Properties: missings
Task Properties: -
Packages: stats
Feature types: integer, numeric
    feature     score
 1:     cyl 0.7953134
 2:    disp 0.7681311
 3:      hp 0.7428125
 4:      wt 0.7278321
 5:      vs 0.5896790
 6:    carb 0.5043945
 7:      am 0.4690128
 8:    drat 0.4645488
 9:    gear 0.4331509
10:    qsec 0.3153652</code></pre>
</div>
</div>
<p>还可以利用具有<code>$importance()</code>和<code>$selected_features()</code>方法的学习器来筛选特征：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>lr <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>fs_imp <span class="ot">=</span> <span class="fu">flt</span>(<span class="st">"importance"</span>, lr)</span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>(fs_imp<span class="sc">$</span><span class="fu">calculate</span>(task))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;FilterImportance:importance&gt;: Importance Score
Task Types: classif
Properties: missings
Task Properties: -
Packages: mlr3, rpart
Feature types: logical, integer, numeric, factor, ordered
        feature    score
1:  Petal.Width 88.96940
2: Petal.Length 81.34496
3: Sepal.Length 54.09606
4:  Sepal.Width 36.01309</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>keep <span class="ot">=</span> <span class="fu">names</span>(<span class="fu">which</span>(fs_imp<span class="sc">$</span>scores <span class="sc">&gt;=</span> <span class="dv">50</span>))    <span class="co"># 根据得分选择特征</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">select</span>(keep)</span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span>feature_names</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Petal.Length" "Petal.Width"  "Sepal.Length"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>fs_sf <span class="ot">=</span> <span class="fu">flt</span>(<span class="st">"selected_features"</span>, lr)</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>(fs_sf<span class="sc">$</span><span class="fu">calculate</span>(task))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;FilterSelectedFeatures:selected_features&gt;: Embedded Feature Selection
Task Types: classif
Properties: missings
Task Properties: -
Packages: mlr3, rpart
Feature types: logical, integer, numeric, factor, ordered
        feature score
1:  Petal.Width     1
2: Petal.Length     1
3: Sepal.Length     0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>keep <span class="ot">=</span> <span class="fu">names</span>(<span class="fu">which</span>(fs_sf<span class="sc">$</span>scores <span class="sc">==</span> <span class="dv">1</span>))    <span class="co"># 根据得分选择特征</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">select</span>(keep)</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span>feature_names</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Petal.Length" "Petal.Width" </code></pre>
</div>
</div>
</section>
<section id="特征选择封装方法" class="level3" data-number="5.5.2">
<h3 data-number="5.5.2" class="anchored" data-anchor-id="特征选择封装方法"><span class="header-section-number">5.5.2</span> 特征选择封装方法</h3>
<p>特征选择是服务于模型泛化性能的提升，因此，应考虑将学习器与特征选择封装在一起来筛选确保学习器性能最优的特征子集。这种方法与HPO方法类似，即搜索让学习器性能最优的特征子集，这需要让学习器在不同的特征子集上迭代训练和预测，因此也需要配置重抽样策略、测度和终止条件，再将其与任务对象和学习器封装在一起，创建显式的特征选择实例(FSelectInstance对象)，然后传入指定的特征选择器(FSelector对象)的<code>$optimize()</code>方法，或者采用<code>fselect()</code>函数封装FSelector对象和特征选择实例的各个组件，创建自动运行的隐式特征选择实例。为了无偏估计泛化性能，可以将特征选择器与学习器、测度、重抽样策略及终止条件一起封装为AutoFSelector对象，然后传给<code>benchmark()</code>函数或<code>resample()</code>函数，从而通过嵌套重抽样策略来无偏估计不同特征子集上的泛化性能。</p>
<p>mlr3fselct工具包提供了封装方法，通过<code>fsi()</code>函数创建特征选择实例，通过<code>fs()</code>函数指定特征选择算法，也称特征选择器。查询特征选择器的关键字可在控制输入<code>mlr_fselectors</code>，查询详细信息只需将<code>mlr_fselectors</code>传<code>入as.data.table()</code>函数。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>mlr3fselect<span class="sc">::</span>mlr_fselectors</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;DictionaryFSelector&gt; with 8 stored values
Keys: design_points, exhaustive_search, genetic_search, random_search,
  rfe, rfecv, sequential, shadow_variable_search</code></pre>
</div>
</div>
<p>查询具体特征选择器的帮助信息，可在控制台输入<code>?mlr_fselectors_key</code>(key为特征选择器的关键字)，例如输入<code>?mlr_fselectors_rfe</code>即可打开关键字为rfe的特征选择器的帮助信息页面。<br>
下面演示用<code>fsi()</code>函数创建特征选择实例，并通过<code>fs()</code>函数创建的特征选择器来执行特征子集选择：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"penguins"</span>)</span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>ins <span class="ot">=</span> <span class="fu">fsi</span>(</span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>),</span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>),</span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">measures =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>),    <span class="co"># 可通过msrs传入多个测度</span></span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">50</span>)</span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>fsel <span class="ot">=</span> <span class="fu">fs</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> <span class="dv">5</span>)</span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>fsel<span class="sc">$</span><span class="fu">optimize</span>(ins)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass flipper_length island    sex   year
       &lt;lgcl&gt;      &lt;lgcl&gt;    &lt;lgcl&gt;         &lt;lgcl&gt; &lt;lgcl&gt; &lt;lgcl&gt; &lt;lgcl&gt;
1:       TRUE        TRUE      TRUE          FALSE  FALSE   TRUE   TRUE
                                    features n_features classif.acc
                                      &lt;list&gt;      &lt;int&gt;       &lt;num&gt;
1: bill_depth,bill_length,body_mass,sex,year          5    0.941688</code></pre>
</div>
</div>
<p>运行的所有结果都保存在<code>$archive</code>属性中，可将转换为data.table对象，然后过滤查询：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(ins<span class="sc">$</span>archive)[batch_nr<span class="sc">==</span><span class="dv">1</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">8</span>)]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass flipper_length island classif.acc
       &lt;lgcl&gt;      &lt;lgcl&gt;    &lt;lgcl&gt;         &lt;lgcl&gt; &lt;lgcl&gt;       &lt;num&gt;
1:       TRUE       FALSE      TRUE           TRUE  FALSE   0.7817136
2:       TRUE        TRUE      TRUE          FALSE  FALSE   0.9387894
3:       TRUE        TRUE     FALSE           TRUE   TRUE   0.9389173
4:       TRUE       FALSE      TRUE           TRUE   TRUE   0.8487212
5:       TRUE        TRUE      TRUE          FALSE  FALSE   0.9416880</code></pre>
</div>
</div>
<p>利用<code>autoplot()</code>进行可视化：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(ins, <span class="at">type =</span> <span class="st">"performance"</span>)  </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-5.18" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.18-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH5_files/figure-html/fig-5.18-1.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.18-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.18: 特征选择迭代中的模型性能
</figcaption>
</figure>
</div>
</div>
</div>
<p>type参数的设置选项参考mlr3viz工具包中的autoplot.OptimInstanceSingleCrit。</p>
<p>最优特征子集保存在<code>$result_features_set</code>属性中：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>ins<span class="sc">$</span>result_feature_set</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "bill_depth"  "bill_length" "body_mass"   "sex"         "year"       </code></pre>
</div>
</div>
<p><code>$result</code>属性保存了最优特征选择子集和对应性能测度值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>ins<span class="sc">$</span>result</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass flipper_length island    sex   year
       &lt;lgcl&gt;      &lt;lgcl&gt;    &lt;lgcl&gt;         &lt;lgcl&gt; &lt;lgcl&gt; &lt;lgcl&gt; &lt;lgcl&gt;
1:       TRUE        TRUE      TRUE          FALSE  FALSE   TRUE   TRUE
                                    features n_features classif.acc
                                      &lt;list&gt;      &lt;int&gt;       &lt;num&gt;
1: bill_depth,bill_length,body_mass,sex,year          5    0.941688</code></pre>
</div>
</div>
<p>函数<code>fselect()</code>能将特征选择实例的组件和特征选择器封装在一起并自动运行，返回的结果为特征选择实例对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>ins1 <span class="ot">=</span> <span class="fu">fselect</span>(</span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">fselector =</span> <span class="fu">fs</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> <span class="dv">5</span>),</span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>),</span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>),</span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">measures =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>),</span>
<span id="cb204-10"><a href="#cb204-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>,<span class="at">n_evals =</span> <span class="dv">50</span>)</span>
<span id="cb204-11"><a href="#cb204-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>同样可以查看特征选择结果和进一步的信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>ins1<span class="sc">$</span>result_feature_set</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "bill_depth"     "bill_length"    "flipper_length" "sex"           
[5] "year"          </code></pre>
</div>
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>ins1<span class="sc">$</span>result</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass flipper_length island    sex   year
       &lt;lgcl&gt;      &lt;lgcl&gt;    &lt;lgcl&gt;         &lt;lgcl&gt; &lt;lgcl&gt; &lt;lgcl&gt; &lt;lgcl&gt;
1:       TRUE        TRUE     FALSE           TRUE  FALSE   TRUE   TRUE
                                         features n_features classif.acc
                                           &lt;list&gt;      &lt;int&gt;       &lt;num&gt;
1: bill_depth,bill_length,flipper_length,sex,year          5   0.9474851</code></pre>
</div>
</div>
<p>为了无偏估计特征子集上学习器的泛化性能，需要创建AutoFSelector对象并传给<code>benchmark()</code>或<code>resample()</code>函数，利用嵌套重抽样策略来评估性能。</p>
<p><code>auto_fselector()</code>函数用来创建AutoFSelector对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>afs <span class="ot">=</span> <span class="fu">auto_fselector</span>(</span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">fselector =</span> <span class="fu">fs</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> <span class="dv">5</span>),</span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>),</span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>),</span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>),</span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>,<span class="at">n_evals =</span> <span class="dv">50</span>)</span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>创建基准测试方案：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">=</span> <span class="fu">benchmark_grid</span>(<span class="fu">tsk</span>(<span class="st">"sonar"</span>), </span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">list</span>(afs, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)),</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>采用多线程并行方案运行基准测试：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"multisession"</span>, <span class="at">workers =</span> <span class="dv">12</span>)    <span class="co"># 采用多线程并行运算</span></span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(grid)</span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"sequential"</span>)    <span class="co"># 恢复单线程</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>比较两个学习器的平均预测准确率：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.acc"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="do">##    nr task_id              learner_id resampling_id iters classif.acc</span></span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 1:  1   sonar classif.rpart.fselector            cv     5   0.7013937</span></span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 2:  2   sonar           classif.rpart            cv     5   0.6587689</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>结果表明，开展特征选择提升了决策树模型的性能。 与HPO一样，也可以将AutoFSelector对象传入<code>resample()</code>函数，利用嵌套重抽样策略来无偏估计泛化性能。</p>
</section>
</section>
<section id="管道与图学习器" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="管道与图学习器"><span class="header-section-number">5.6</span> 管道与图学习器</h2>
<p>mlr3通过模块化的统一接口(如Task、Learner、Measure等对象)为机器学习应用者提供了非常简单、且无需底层专家知识就能快速开展机器学习建模，即使复杂的基准测试和HPO，也只需要几行代码就能实现。工具包mlr3pipelines将mlr3的模块化功能扩展到数据预处理、集成学习(ensemble learning)以及更复杂模型的构建。mlr3pipelines使用从PipeOp类继承的模块对象构建Graph对象(一种有向图)来表示操作的数据流或建模流程。在模型训练过程中，图中的管道操作转换给定的任务，随后的管道操作接收转换后的任务作为输入。Graph对象能够转换为GraphLearner(图学习器)对象，该对象和Learner对象一样，可以进行训练、调优和预测。因此，图学习器可以将数据的预处理和学习器的调优、训练整合成在一起，形成一个能够可视化的完整流程。</p>
<section id="管道操作与图对象" class="level3" data-number="5.6.1">
<h3 data-number="5.6.1" class="anchored" data-anchor-id="管道操作与图对象"><span class="header-section-number">5.6.1</span> 管道操作与图对象</h3>
<p>加载mlr3pipelines包后，在控制台输入<code>mlr_pipeops</code>可以查看各种管道操作(即基类PipeOp的子类)的关键字，查询管道操作的详细信息可输入<code>as.data.table(mlr_pipeops)</code>。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>mlr3pipelines<span class="sc">::</span>mlr_pipeops</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;DictionaryPipeOp&gt; with 64 stored values
Keys: boxcox, branch, chunk, classbalancing, classifavg, classweights,
  colapply, collapsefactors, colroles, copy, datefeatures, encode,
  encodeimpact, encodelmer, featureunion, filter, fixfactors, histbin,
  ica, imputeconstant, imputehist, imputelearner, imputemean,
  imputemedian, imputemode, imputeoor, imputesample, kernelpca,
  learner, learner_cv, missind, modelmatrix, multiplicityexply,
  multiplicityimply, mutate, nmf, nop, ovrsplit, ovrunite, pca, proxy,
  quantilebin, randomprojection, randomresponse, regravg,
  removeconstants, renamecolumns, replicate, scale, scalemaxabs,
  scalerange, select, smote, spatialsign, subsample, targetinvert,
  targetmutate, targettrafoscalerange, textvectorizer, threshold,
  tunethreshold, unbranch, vtreat, yeojohnson</code></pre>
</div>
</div>
<p>这些管道操作大多数是数据预处理的操作，如缺失值处理、数据转换、特征选择与提取、特征编码等。查询具体的管道操作的帮助信息，使用<code>?mlr_pipeops_key</code>的格式(key为对应的关键字)，例如查询encode管道操作的帮助信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>?mlr_pipeops_encode</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>PipeOp对象具有<code>$train()</code>和<code>$predict()</code>方法，也拥有相应的超参数，同样通过<code>$param_set</code>属性查询和设置超参数。将管道操作的关键字传给<code>po()</code>或<code>pos()</code>函数即可创建一个或多个管道操作：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>(<span class="at">po_pca =</span> <span class="fu">po</span>(<span class="st">"pca"</span>))    <span class="co"># 引用R中prcomp函数进行主成分分析</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PipeOp: &lt;pca&gt; (not trained)
values: &lt;list()&gt;
Input channels &lt;name [train type, predict type]&gt;:
  input [Task,Task]
Output channels &lt;name [train type, predict type]&gt;:
  output [Task,Task]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">po_pca_nop =</span> <span class="fu">pos</span>(<span class="fu">c</span>(<span class="st">"pca"</span>, <span class="at">original =</span> <span class="st">"nop"</span>)))    <span class="co"># 主成分分析和无操作</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pca
PipeOp: &lt;pca&gt; (not trained)
values: &lt;list()&gt;
Input channels &lt;name [train type, predict type]&gt;:
  input [Task,Task]
Output channels &lt;name [train type, predict type]&gt;:
  output [Task,Task]

$original
PipeOp: &lt;original&gt; (not trained)
values: &lt;list()&gt;
Input channels &lt;name [train type, predict type]&gt;:
  input [*,*]
Output channels &lt;name [train type, predict type]&gt;:
  output [*,*]</code></pre>
</div>
</div>
<p><code>po()</code>和<code>pos()</code>函数还能将Learner对象和Filter对象(特征过滤器)封装成管道操作对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>po_dt <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">cp =</span> <span class="fl">0.2</span>))</span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a>po_imp <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"filter"</span>, <span class="fu">flt</span>(<span class="st">"importance"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>也可以利用<code>as_pipeop()</code>函数转换：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a>po_svm <span class="ot">=</span> <span class="fu">as_pipeop</span>(<span class="fu">lrn</span>(<span class="st">"regr.svm"</span>, <span class="at">id =</span> <span class="st">"svm"</span>, <span class="at">type =</span> <span class="st">"nu-regression"</span>))</span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>po_cor <span class="ot">=</span> <span class="fu">as_pipeop</span>(<span class="fu">flt</span>(<span class="st">"correlation"</span>, <span class="at">id =</span> <span class="st">"cor"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>下面演示管道操作的训练和预测：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>)</span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a>split <span class="ot">=</span> <span class="fu">partition</span>(task)</span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a>po_sc <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>注意，传给管道操作训练的任务必须用<code>list()</code>函数转换为列表类型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>po_out <span class="ot">=</span> po_sc<span class="sc">$</span><span class="fu">train</span>(<span class="fu">list</span>(task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">filter</span>(split<span class="sc">$</span>train)))</span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>po_out</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$output
&lt;TaskClassif:sonar&gt; (139 x 61): Sonar: Mines vs. Rocks
* Target: Class
* Properties: twoclass
* Features (60):
  - dbl (60): V1, V10, V11, V12, V13, V14, V15, V16, V17, V18, V19, V2,
    V20, V21, V22, V23, V24, V25, V26, V27, V28, V29, V3, V30, V31,
    V32, V33, V34, V35, V36, V37, V38, V39, V4, V40, V41, V42, V43,
    V44, V45, V46, V47, V48, V49, V5, V50, V51, V52, V53, V54, V55,
    V56, V57, V58, V59, V6, V60, V7, V8, V9</code></pre>
</div>
</div>
<p>管道操作对象训练后的状态保存在<code>$state</code>属性中，一些管道操作对象的预测需要利用这些状态参数：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>po_pred <span class="ot">=</span> po_sc<span class="sc">$</span><span class="fu">predict</span>(<span class="fu">list</span>(task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">filter</span>(split<span class="sc">$</span>test)))</span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>po_pred<span class="sc">$</span>output</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskClassif:sonar&gt; (69 x 61): Sonar: Mines vs. Rocks
* Target: Class
* Properties: twoclass
* Features (60):
  - dbl (60): V1, V10, V11, V12, V13, V14, V15, V16, V17, V18, V19, V2,
    V20, V21, V22, V23, V24, V25, V26, V27, V28, V29, V3, V30, V31,
    V32, V33, V34, V35, V36, V37, V38, V39, V4, V40, V41, V42, V43,
    V44, V45, V46, V47, V48, V49, V5, V50, V51, V52, V53, V54, V55,
    V56, V57, V58, V59, V6, V60, V7, V8, V9</code></pre>
</div>
</div>
<p>调用训练和预测返回对象的<code>$output$data()</code>方法，即可查看训练和预测的结果。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a>po_out<span class="sc">$</span>output<span class="sc">$</span><span class="fu">data</span>()[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Class          V1        V10        V11        V12
   &lt;fctr&gt;       &lt;num&gt;      &lt;num&gt;      &lt;num&gt;      &lt;num&gt;
1:      R -0.13257495  2.9584957  3.0091724  3.4536107
2:      R -0.81415548 -0.5738126 -1.1215268 -0.3634980
3:      R  1.97106865  1.7153811  1.3567412  1.1127319
4:      R  0.09882585  1.0375792 -0.4358550 -1.3682382
5:      R -0.29665915 -0.4140348 -0.9131735 -0.6180724</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>po_pred<span class="sc">$</span>output<span class="sc">$</span><span class="fu">data</span>()[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Class          V1        V10        V11        V12
   &lt;fctr&gt;       &lt;num&gt;      &lt;num&gt;      &lt;num&gt;      &lt;num&gt;
1:      R -0.39342676  0.0330566 -0.5699587 -0.6723012
2:      R  0.67101691  0.5783074  1.9370999  3.0709960
3:      R -0.03160006  0.6979617  0.4748384  1.3371791
4:      R  0.94869786  0.5539467  0.3339158  0.4604793
5:      R -0.54488909 -1.2996196 -1.1821387 -1.0684731</code></pre>
</div>
</div>
<p>在数据预处理阶段，往往需要针对特定类型的特征或选定的特征子集进行特定的管道操作，这可以借助工具包mlr3pipelines提供的<code>selector_*()</code>系列函数(见 <a href="#tbl-5.4" class="quarto-xref">表&nbsp;<span>5.4</span></a> )来执行特征选择，然后将其传给<code>po()</code>函数中的affect_columns参数，或利用<code>po()</code>函数直接将其封装为PipeOp对象，作为后续管道操作对象的前置对象。<br>
</p>
<div class="cell">
<div id="tbl-5.4" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-5.4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;5.4: selector系列函数及其功能
</figcaption>
<div aria-describedby="tbl-5.4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<colgroup>
<col style="width: 49%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">selector函数</th>
<th style="text-align: left;">功能</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">selector_all()</td>
<td style="text-align: left;">选择所有特征</td>
</tr>
<tr class="even">
<td style="text-align: left;">selector_none()</td>
<td style="text-align: left;">不选择特征</td>
</tr>
<tr class="odd">
<td style="text-align: left;">selector_type()</td>
<td style="text-align: left;">根据特征类型选择特征</td>
</tr>
<tr class="even">
<td style="text-align: left;">selector_name()</td>
<td style="text-align: left;">根据特征名称选择特征</td>
</tr>
<tr class="odd">
<td style="text-align: left;">selector_grep()</td>
<td style="text-align: left;">根据模式(如正则化表达式)匹配选择特征</td>
</tr>
<tr class="even">
<td style="text-align: left;">selector_invert()</td>
<td style="text-align: left;">针对给定的特征选择集反向选择特征</td>
</tr>
<tr class="odd">
<td style="text-align: left;">selector_intersect()</td>
<td style="text-align: left;">取两个特征选择集的交集</td>
</tr>
<tr class="even">
<td style="text-align: left;">selector_union()</td>
<td style="text-align: left;">取两个特征选择集的并集</td>
</tr>
<tr class="odd">
<td style="text-align: left;">selector_setdiff()</td>
<td style="text-align: left;">取两个特征选择集的差集</td>
</tr>
<tr class="even">
<td style="text-align: left;">selector_missing()</td>
<td style="text-align: left;">选择具有缺失值的特征</td>
</tr>
<tr class="odd">
<td style="text-align: left;">selector_cardinality_greater_than()</td>
<td style="text-align: left;">选择基数大于阈值的分类特征</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>以mlr3内置的penguins任务为例：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"penguins"</span>)</span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>keep <span class="ot">=</span> <span class="fu">which</span>(<span class="fu">complete.cases</span>(task<span class="sc">$</span><span class="fu">data</span>()))</span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> task<span class="sc">$</span><span class="fu">filter</span>(keep)</span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span>feature_types</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;id&gt;
               id    type
           &lt;char&gt;  &lt;char&gt;
1:     bill_depth numeric
2:    bill_length numeric
3:      body_mass integer
4: flipper_length integer
5:         island  factor
6:            sex  factor
7:           year integer</code></pre>
</div>
</div>
<p>该任务有7个特征，先选择factor类型特征：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a>sel_fct <span class="ot">=</span> <span class="fu">selector_type</span>(<span class="st">"factor"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>然后选择余下的特征：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>sel_rest <span class="ot">=</span> <span class="fu">selector_invert</span>(sel_fct)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在<code>po()</code>函数中通过<code>affect_columns</code>参数指定特征：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a>po_pca <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">affect_columns =</span> sel_rest, <span class="at">rank. =</span> <span class="dv">2</span>)</span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a>po_enc <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"encode"</span>, <span class="at">affect_columns =</span> sel_fct)</span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a>po_lr <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>), <span class="at">id =</span> <span class="st">"rpart"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>PipeOp、Graph对象以及可转换为PipeOp对象的其他对象可以通过管道操作符<code>%&gt;&gt;%</code>和<code>%&gt;&gt;!%</code>连接为一个Graph对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>gr1 <span class="ot">=</span>  po_pca <span class="sc">%&gt;&gt;%</span> po_enc <span class="sc">%&gt;&gt;%</span> po_lr </span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a>gr2 <span class="ot">=</span>  po_pca <span class="sc">%&gt;&gt;!%</span> po_enc <span class="sc">%&gt;&gt;!%</span> po_lr </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>%&gt;&gt;%</code>操作符(等同于<code>concat_graph(g1, g2, in_place = F)</code>)总是创建其连接对象的深层副本，此后不能通过引用对其连接对象进行修改。<code>%&gt;&gt;!%</code>操作符(等同于<code>concat_graph(g1, g2, in_place = T)</code>)在其第一个连接对象为Graph对象时，不会对其执行<code>clone()</code>操作，并对其就地(in_place)修改。通常情况下都建议使用<code>%&gt;&gt;%</code>操作符，当图中管道操作过多时(长图对象)，使用<code>%&gt;&gt;!%</code>操作符将带来显著的性能优势，因为<code>%&gt;&gt;%</code>操作符会产生很多次的<code>clone()</code>调用，增加内存资源占用。</p>
<p>Graph对象的<code>$plot()</code>方法可默认借助igraph包进行可视化，如果传入参数html = TRUE，则借助visNetwork包执行可视化。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>gr1<span class="sc">$</span><span class="fu">plot</span>(<span class="at">horizontal =</span> T)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CH5_files/figure-html/unnamed-chunk-174-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>上面这种结构的图很容易让人误解，下面将特征选择和特征处理分开，借助<code>gunion()</code>函数和featureunion管道操作对象，建立结构更容易理解的Graph对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>pofs_fct <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"select"</span>, <span class="at">selector =</span> sel_fct, <span class="at">id =</span> <span class="st">"feat_fct"</span>)</span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>pofs_num <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"select"</span>, <span class="at">selector =</span> sel_rest, <span class="at">id =</span> <span class="st">"feat_num"</span>)</span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a>path_enc <span class="ot">=</span> pofs_fct <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"encode"</span>)</span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a>path_pca <span class="ot">=</span> pofs_num <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">rank. =</span> <span class="dv">2</span>)</span>
<span id="cb239-5"><a href="#cb239-5" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> <span class="fu">gunion</span>(<span class="fu">list</span>(path_enc, path_pca)) <span class="sc">%&gt;&gt;%</span> </span>
<span id="cb239-6"><a href="#cb239-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="at">id =</span> <span class="st">"feat_union"</span>) <span class="sc">%&gt;&gt;%</span> po_lr</span>
<span id="cb239-7"><a href="#cb239-7" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> T)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="htmlwidget-2c441b3a0d3cf7e889d9" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-2c441b3a0d3cf7e889d9">{"x":{"nodes":{"id":["feat_fct","feat_num","encode","pca","feat_union","<INPUT>","rpart","<OUTPUT>"],"label":["feat_fct","feat_num","encode","pca","feat_union","<INPUT>","rpart","<OUTPUT>"],"shape":["box","box","box","box","box","database","box","ellipse"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","rgba(255,51,51,0.2)"],"value":[1,1,1,1,1,0.8,1,0.8],"title":["<p>PipeOp: <b>feat_fct<\/b> (not trained)<br>values: <b>selector=<Selector><\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [Task,Task]<\/p>","<p>PipeOp: <b>feat_num<\/b> (not trained)<br>values: <b>selector=<Selector><\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [Task,Task]<\/p>","<p>PipeOp: <b>encode<\/b> (not trained)<br>values: <b>method=one-hot<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [Task,Task]<\/p>","<p>PipeOp: <b>pca<\/b> (not trained)<br>values: <b>rank.=2<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [Task,Task]<\/p>","<p>PipeOp: <b>feat_union<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  ... [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [Task,Task]<\/p>","<p>Input:<br>Name: feat_fct.input<br>Train: Task<br>Predict: Task<br>Input:<br>Name: feat_num.input<br>Train: Task<br>Predict: Task<\/p>","<p>PipeOp: <b>rpart<\/b> (not trained)<br>values: <b>xval=0<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [TaskClassif,TaskClassif]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [NULL,PredictionClassif]<\/p>","<p>Output:<br>Name: rpart.output<br>Train: NULL<br>Predict: PredictionClassif<\/p>"],"x":[-1,1,-1,1,0,0,0,0],"y":[-0.6,-0.6,-0.2,-0.2,0.2,-1,0.6000000000000001,1]},"edges":{"from":["feat_fct","feat_num","encode","pca","feat_union","<INPUT>","<INPUT>","rpart"],"to":["encode","pca","feat_union","feat_union","rpart","feat_fct","feat_num","<OUTPUT>"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Graph对象与PipeOp对象一样，具有<code>$train()</code>和<code>$predict()</code>以及<code>$state</code>等方法和属性，传入任务对象即可进行训练和预测。默认情况下，Graph对象只保留最后一个管道操作的输出，如果保留其中所有管道操作的结果，需要设置Graph对象的属性<code>$keep_results = T</code>，然后就可在训练后通过<code>$pipeops$xxx$.result$output$data()</code>来查看id为<code>xxx</code>的管道操作的结果。</p>
<p>mlr3pipelines包预置了7分常用的Graph集合对象，在控制台输入<code>mlr_graphs</code>可查询关键字，查询帮助信息可按以下形式输入代码<code>：?mlr_graphs_key</code>，key为<code>mlr_graphs</code>中储存的关键字。</p>
<div class="cell">
<div id="tbl-5.5" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-5.5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;5.5: Graph集合对象、功能及其调用方法
</figcaption>
<div aria-describedby="tbl-5.5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<colgroup>
<col style="width: 18%">
<col style="width: 44%">
<col style="width: 36%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Graph集合对象</th>
<th style="text-align: left;">功能</th>
<th style="text-align: left;">调用方法</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">mlr_graphs_branch</td>
<td style="text-align: left;">创建多个分支路径的Graph</td>
<td style="text-align: left;">ppl(“branch”, …)或pipeline_branch(…)</td>
</tr>
<tr class="even">
<td style="text-align: left;">mlr_graphs_bagging</td>
<td style="text-align: left;">创建执行bagging集成学习的Graph</td>
<td style="text-align: left;">ppl(“bagging”, …)或pipeline_bagging(…)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mlr_graphs_greplicate</td>
<td style="text-align: left;">创建由输入对象(Graph或PipeOp)的n个副本组成的新的Graph</td>
<td style="text-align: left;">ppl(“greplicate”, …)或pipeline_greplicate(…)</td>
</tr>
<tr class="even">
<td style="text-align: left;">mlr_graphs_ovr</td>
<td style="text-align: left;">为分类任务创建执行“One vs Rest”分类的Graph</td>
<td style="text-align: left;">ppl(“ovr”, …)或pipeline_ovr(…)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mlr_graphs_robustify</td>
<td style="text-align: left;">为后续学习器创建一个稳定的数据预处理的Graph</td>
<td style="text-align: left;">ppl(“robustify”, …)或pipeline_robustify(…)</td>
</tr>
<tr class="even">
<td style="text-align: left;">mlr_graphs_stacking</td>
<td style="text-align: left;">创建执行stacking集成学习的Graph</td>
<td style="text-align: left;">ppl(“stacking”, …)或pipeline_stacking(…)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mlr_graphs_targettrafo</td>
<td style="text-align: left;">创建在训练时变换目标变量并在预测时反转变换的Graph</td>
<td style="text-align: left;">ppl(“robustify”, …)或pipeline_robustify(…)</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>将关键字或关键字列表传入<code>ppl()</code>或<code>ppls()</code>函数即可快速创建关键字对应的Graph，也可以利用<code>pipeline_key()</code>函数来创建相应的Graph：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"branch"</span>, <span class="fu">pos</span>(<span class="fu">c</span>(<span class="st">"pca"</span>,<span class="st">"encode"</span>)))</span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">=</span> g1 <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.svm"</span>), <span class="at">id =</span> <span class="st">"svm"</span>)</span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a>g1<span class="sc">$</span><span class="fu">plot</span>(<span class="at">horizontal =</span> T)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CH5_files/figure-html/unnamed-chunk-177-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>同样可以用<code>pipeline_branch()</code>函数来构建：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">=</span> <span class="fu">pipeline_branch</span>(<span class="fu">list</span>(<span class="fu">po</span>(<span class="st">"pca"</span>), <span class="fu">po</span>(<span class="st">"encode"</span>)))</span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">=</span> g2 <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="fu">lrn</span>(<span class="st">"classif.svm"</span>), <span class="at">id =</span> <span class="st">"svm"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>注意，此时不能使用<code>g2 = pipeline_branch(pos(c("pca","encode")))</code>。</p>
<p><code>mlr_graphs_robustify</code>图对象包含了常用的数据预处理方法(PipeOp对象)，包括恒定特征删除、特征类型转换、缺失值填补、特征编码等。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"robustify"</span>)</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>g2<span class="sc">$</span><span class="fu">plot</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CH5_files/figure-html/unnamed-chunk-179-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="图学习器" class="level3" data-number="5.6.2">
<h3 data-number="5.6.2" class="anchored" data-anchor-id="图学习器"><span class="header-section-number">5.6.2</span> 图学习器</h3>
<p>Graph对象可以非常简单地通过<code>as_learner()</code>函数转换为GraphLearner对象，也可将Graph对象作为参数传给GraphLearner对象的<code>$new()</code>方法来转换成图学习器，然后就可以如Learner对象一样来调优、训练和预测。</p>
<div id="exm-5.4" class="theorem example">
<p><span class="theorem-title"><strong>例 5.4</strong></span> 基于mlr3内置任务penguins和classif.rpart学习器，比较增加robustify预处理流程对预测性能的影响。</p>
</div>
<p>创建学习器、任务及分割数据集：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a>lr <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">id =</span> <span class="st">"rpart"</span>)  <span class="co"># 普通学习器模型</span></span>
<span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"robustify"</span>) <span class="sc">%&gt;&gt;%</span> lr  <span class="co"># 图学习器</span></span>
<span id="cb243-6"><a href="#cb243-6" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span>keep_results <span class="ot">=</span> T</span>
<span id="cb243-7"><a href="#cb243-7" aria-hidden="true" tabindex="-1"></a>glr <span class="ot">=</span> <span class="fu">as_learner</span>(gr)</span>
<span id="cb243-8"><a href="#cb243-8" aria-hidden="true" tabindex="-1"></a><span class="co"># glr = GraphLearner$new(gr)</span></span>
<span id="cb243-9"><a href="#cb243-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-10"><a href="#cb243-10" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"penguins"</span>)</span>
<span id="cb243-11"><a href="#cb243-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-12"><a href="#cb243-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb243-13"><a href="#cb243-13" aria-hidden="true" tabindex="-1"></a>split <span class="ot">=</span> <span class="fu">partition</span>(task)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>训练图学习器和普通学习器模型：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>glr<span class="sc">$</span><span class="fu">train</span>(task, <span class="at">row_ids =</span> split<span class="sc">$</span>train)</span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>lr<span class="sc">$</span><span class="fu">train</span>(task, <span class="at">row_ids =</span> split<span class="sc">$</span>train)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>计算图学习器模型预测集性能：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>glr<span class="sc">$</span><span class="fu">predict</span>(task, split<span class="sc">$</span>test)<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"classif.acc"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.acc 
  0.9646018 </code></pre>
</div>
</div>
<p>计算普通学习器模型预测集性能：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>lr<span class="sc">$</span><span class="fu">predict</span>(task, split<span class="sc">$</span>test)<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"classif.acc"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.acc 
  0.9557522 </code></pre>
</div>
</div>
<p>图学习器的超参数优化和普通学习器对象一样，可以利用<code>tune()</code>生成调优实例对象，也可以利用<code>auto_tuner()</code>封装成AutoTuner对象。需要注意的是，图学习器的超参数不仅仅包括其中学习器对象的超参数，还包括封装在其内的管道操作对象的超参数。与学习器的超参数id相比，图学习器的超参数id增加了超参数所属对象的前缀，例如id为pca的PipeOp对象的超参数rank.，其在图学习器中的id为pca.rank.。图学习器中各对象的超参数调优范围可在创建各对象时设置(此时超参数id无需添加对象id作为前缀)，也可在封装为图学习器后设置(此时超参数id需要添加对象id作为前缀)，建议在创建各组件对象时设置超参数的调优范围。</p>
<div id="exm-5.5" class="theorem example">
<p><span class="theorem-title"><strong>例 5.5</strong></span> 基于mlr3内置任务sonar，创建封装pca管道操作和classif.kknn学习器的图学习器，比较执行HPO对其泛化性能的影响。</p>
</div>
<p>创建图学习器：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb249"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a>po_pca <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">rank. =</span> <span class="fu">to_tune</span>(<span class="dv">2</span>, <span class="dv">30</span>))</span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a>lr_kknn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.kknn"</span>, <span class="at">k =</span> <span class="fu">to_tune</span>(<span class="dv">1</span>, <span class="dv">35</span>))</span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a>glr <span class="ot">=</span> <span class="fu">as_learner</span>(po_pca <span class="sc">%&gt;&gt;%</span> lr_kknn)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>查看图学习器的所有超参数：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>glr<span class="sc">$</span>param_set</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSetCollection&gt;
                          id    class lower upper nlevels       default
                      &lt;char&gt;   &lt;char&gt; &lt;num&gt; &lt;num&gt;   &lt;num&gt;        &lt;list&gt;
 1:               pca.center ParamLgl    NA    NA       2          TRUE
 2:               pca.scale. ParamLgl    NA    NA       2         FALSE
 3:                pca.rank. ParamInt     1   Inf     Inf              
 4:       pca.affect_columns ParamUty    NA    NA     Inf &lt;Selector[1]&gt;
 5:           classif.kknn.k ParamInt     1   Inf     Inf             7
 6:    classif.kknn.distance ParamDbl     0   Inf     Inf             2
 7:      classif.kknn.kernel ParamFct    NA    NA      10       optimal
 8:       classif.kknn.scale ParamLgl    NA    NA       2          TRUE
 9:     classif.kknn.ykernel ParamUty    NA    NA     Inf              
10: classif.kknn.store_model ParamLgl    NA    NA       2         FALSE
                  value
                 &lt;list&gt;
 1:                    
 2:                    
 3: &lt;RangeTuneToken[2]&gt;
 4:                    
 5: &lt;RangeTuneToken[2]&gt;
 6:                    
 7:                    
 8:                    
 9:                    
10:                    </code></pre>
</div>
</div>
<p>查看图学习器的超参数调优范围：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>glr<span class="sc">$</span>param_set<span class="sc">$</span>values</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pca.rank.
Tuning over:
range [2, 30]


$classif.kknn.k
Tuning over:
range [1, 35]</code></pre>
</div>
</div>
<p>创建自动调优图学习器和非调优图学习器：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>glr_tu <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>), </span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> glr,</span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>), </span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">20</span>))</span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a>glr_untu <span class="ot">=</span> <span class="fu">as_learner</span>(<span class="fu">po</span>(<span class="st">"pca"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">lrn</span>(<span class="st">"classif.kknn"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>创建基准测试方案：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(<span class="fu">tsk</span>(<span class="st">"sonar"</span>), <span class="fu">c</span>(glr_tu, glr_untu),</span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>并行执行基准测试：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"multisession"</span>, <span class="at">workers =</span> <span class="dv">8</span>)</span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a><span class="fu">benchmark</span>(design)<span class="sc">$</span><span class="fu">aggregate</span>()[, .(learner_id, classif.ce)]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               learner_id classif.ce
                   &lt;char&gt;      &lt;num&gt;
1: pca.classif.kknn.tuned  0.1734030
2:       pca.classif.kknn  0.2304297</code></pre>
</div>
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"sequential"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>结果表明，采取HPO后，分类错误率降低，泛化性能提高。</p>
</section>
</section>
<section id="常用有监督机器学习算法" class="level2" data-number="5.7">
<h2 data-number="5.7" class="anchored" data-anchor-id="常用有监督机器学习算法"><span class="header-section-number">5.7</span> 常用有监督机器学习算法</h2>
<p>传统的有监督机器学习算法包括线性回归、逻辑回归、K最近邻(K-Nearest Neighbor，KNN)、朴素贝叶斯(Naive Bayes，NB)、支持向量机(Support Vector Machine，SVM)、浅层神经网络(Shallow Neural Networks，SNN)、决策树(Decision Tree，DT)以及基于决策树的集成学习(Ensemble Learning)算法，如随机森林(Random Forest，RF)、梯度提升决策树(Gradient Boosting Decision Tree，GBDT)、极致梯度提升机(eXtreme Gradient Boosting Machine，XGBoost)、轻量级梯度提升机(Light Gradient Boosting Machine，lightGBM)等。下面简介KNN、NB、SVM和基于决策树的分类回归树(CART)算法，重点介绍集成学习方法及其R语言实现。</p>
<section id="knn算法" class="level3" data-number="5.7.1">
<h3 data-number="5.7.1" class="anchored" data-anchor-id="knn算法"><span class="header-section-number">5.7.1</span> KNN算法</h3>
<p>KNN是一种简单但实用的算法，能用于分类和回归问题，也可用于缺失值填补。KNN算法原理很基于距离测度，将所有训练集数据储存到内存中，对输入的预测样例，根据某种距离测度(常用欧氏距离)从训练集数据中找出该预测样例最近的k个“邻居”，对分类问题，该预测样例的对应类别由k个“邻居”的类别按“少数服从多数”的原则来确定，对回归问题，则该预测样例的输出值是k个“邻居”输出值的平均值或加权平均值。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.19" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.19-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.19.png" class="img-fluid figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.19-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.19: KNN算法原理图
</figcaption>
</figure>
</div>
</div>
</div>
<p>KNN基于示例学习，是一个“懒惰”的算法，因为该算法严格意义上没有训练模型的过程，计算都发生在预测阶段。该算法的重要参数是k，其次是距离算法的选择。其中k越小，模型复杂度越高，偏差越小，方差越大；k越大，模型复杂度越低，偏差越大，方差越小。距离可以选择欧氏距离(Euclidean distance)、闵氏距离(Minkowski Distance)、曼哈顿距离(Manhattan distance)、切比雪夫距离(Chebyshev Distance)等。<br>
KNN算法的优点是原理简单，非常有效，易于理解和实现。KNN算法的缺点是效率低下，大规模数据的预测计算量和存储空间占用都非常大；高度依赖数据，容错性差，如果某些训练数据误差较大，则预测误差很大；存在“维数灾难”问题，随着数据维数的增加，所有距离都集中在很小的范围内，算法就可能失效。</p>
<p>R中实现KNN算法的包有很多，mlr3支持kknn包实现的KNN算法。在mlr3中创建kknn学习器：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"classif.kknn"</span>)  <span class="co"># 创建kknn分类学习器</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"regr.kknn"</span>)     <span class="co"># 创建kknn回归学习器</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="svm算法" class="level3" data-number="5.7.2">
<h3 data-number="5.7.2" class="anchored" data-anchor-id="svm算法"><span class="header-section-number">5.7.2</span> SVM算法</h3>
<p>SVM是基于统计学习理论的经典机器学习算法，理论体系完备，在上世纪90年代中后期至本世纪初，曾经占据了机器学习的半壁江山。SVM可以解决分类和回归问题。用于分类问题时，其学习策略是分类间隔最大化，从而在经验风险最小化和结构风险最小化之间取得权衡，对于非线性分类问题，SVM通过核函数将特征投影到高维空间，在核空间利用超平面实现分类；构建超平面用到的数据点称为支持向量。对于回归问题，通过引入<span class="math inline">\epsilon</span>-不敏感损失函数，尽可能将更多的训练数据样例拟合到间隔(间隔的宽度由<span class="math inline">\epsilon</span>决定)中，减少远离间隔的数据样例。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.20" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.20-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.20.png" class="img-fluid figure-img" style="width:85.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.20-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.20: SVM算法原理图
</figcaption>
</figure>
</div>
</div>
</div>
<p>SVM的优点是原理简单，性能稳定，特别适合于小样本学习问题，理论上能够收敛到全局最小，没有陷入局部最小陷阱的风险。SVM的缺点是大样本学习的时空成本都很大，且性能在新的算法面前没有优势；对缺失数据敏感；对超参数的选择非常敏感。</p>
<p>mlr3支持e1071、kernlab和LiblineaR三个R包装封装的SVM算法，但在对数据类型的支持上有所差异。</p>
<p>在mlr3中创建基于e1071包的SVM学习器：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"classif.svm"</span>)    <span class="co"># SVM分类学习器</span></span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"regr.svm"</span>)       <span class="co"># SVM回归学习器</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在mlr3中创建基于kernlab包的SVM学习器：<br>
</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"classif.ksvm"</span>)     <span class="co"># KSVM分类学习器</span></span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"classif.lssvm"</span>)    <span class="co"># LSSVM(最小二乘SVM)分类学习器</span></span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"regr.ksvm"</span>)        <span class="co"># KSVM回归学习器</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在mlr3中创建基于LiblineaR包的SVM学习器：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"classif.liblinear"</span>)    <span class="co"># 分类学习器</span></span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"regr.liblinear"</span>)       <span class="co"># 分类学习器</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cart算法" class="level3" data-number="5.7.3">
<h3 data-number="5.7.3" class="anchored" data-anchor-id="cart算法"><span class="header-section-number">5.7.3</span> CART算法</h3>
<p>分类与回归树算法CART属于决策树(Decision Tree)中的二叉树(Binary Tree)，是一种应用广泛的决策树算法，主要用于各种分类和回归任务，也能用于特征选择。 通过节点分裂来建树是所有决策树算法的关键步骤。对于分类任务，CART算法从根节点开始根据基尼指数(Gini Index)最小化原则选择某个特征向下分裂成两个子节点，如此递归迭代，每个节点不断向下二分，直至触发预先设定的分裂终止条件，最终形成一棵庞大的二叉树。树中不能向下分裂的节点称为叶节点。基尼指数的计算公式如下：</p>
<p><span id="eq-5.6"><span class="math display">
  Gini=\sum_{k=1}^{K} p_k (1-p_k )=1-\sum_{k=1}^{K} p_k^2  
\tag{5.6}</span></span></p>
<p>上式中<span class="math inline">p_k</span>为类<span class="math inline">k(k \in [1, K])</span>的概率。基尼指数越大说明数据集中包含的类别越多，纯度越低，越小说明数据集中包含的类别越少，纯度越高，这与熵(Entropy)的概念有类似之处。</p>
<p>对于回归任务，CART算法从根节点开始根据方差(或其他拟合误差的测度)最小化原则选择某个特征进行递归二叉分裂。如果不对分裂进行控制，CART会建立一个庞大的树，对每一个样例都进行精细分类或拟合，这就会造成过拟合问题。因此，决策树算法一般都有一个超参数来设定剪枝(Pruning)操作，以修剪冗余的节点，以避免过拟合现象。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.21" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.21-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.21.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.21-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.21: CART算法原理图
</figcaption>
</figure>
</div>
</div>
</div>
<p>CART的优点是能直接处理连续型变量，能够用于回归任务；可解释性强；对缺失值不敏感等。CART的缺点是容易过拟合(通过剪枝可以一定程度克服)。</p>
<p>rpart是R中实现CART等经典决策树算法的包。R包C50、RWeka、partykit和dbarts提供了其他的基于决策树的算法。mlr3对以上R包都提供了部分和全部的支持。</p>
<p>在mlr3中创建基于rpart包的CART学习器：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)    <span class="co"># 分类树学习器</span></span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"regr.rpart"</span>)       <span class="co"># 回归树学习器</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="nb算法" class="level3" data-number="5.7.4">
<h3 data-number="5.7.4" class="anchored" data-anchor-id="nb算法"><span class="header-section-number">5.7.4</span> NB算法</h3>
<p>NB算法基于贝叶斯定理，是一种易于实现且非常高效的分类算法，具有坚实的理论基础。NB算法假定类别中的特定特征彼此独立，这一点违背很多常识，但并不影响该算法的分类准确性。</p>
<p>贝叶斯公式如下所示：</p>
<p><span id="eq-5.7"><span class="math display">
  P(B│A)=\frac{P(A│B)P(B)}{P(A)}  
\tag{5.7}</span></span></p>
<p>该公式涉及到联合概率、条件概率、先验概率、后验概率等知识。将贝叶斯公式换一个表达形式，就是朴素贝叶斯分类算法的原理：</p>
<p><span id="eq-5.8"><span class="math display">
  P(类别│特征)=\frac{P(特征│类别)P(类别)} {P(特征)}
\tag{5.8}</span></span> 对于一个二分类问题，假设X是特征空间，标签<span class="math inline">y</span> = +1或-1，对于给定的一个特征样例<span class="math inline">x_0(x_0 \in X)</span>，预测其对应的类别，NB算法只需计算两个概率：<span class="math inline">P(y=+1│X=x_0 )</span>和<span class="math inline">P(y=-1│X=x_0 )</span>，然后将<span class="math inline">x_0</span>的类别判定为其中概率最大的那一类。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.22" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.22-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.22.png" class="img-fluid figure-img" style="width:65.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.22-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.22: NB分类算法步骤
</figcaption>
</figure>
</div>
</div>
</div>
<p>NB算法的优点是具有坚实的理论基础，算法简单，易于实现，计算速度快，存储资源占用少，在分类变量上的表现特别好，在满足特征独立条件下，对小样本的分类性能优于其他分类算法。NB算法的缺点可能是其特征独立的假设在现实世界中很难满足，当样本特征时间存在关联性时，预测效果不佳；对输入数据的表达形式敏感，对数值型变量不友好等。</p>
<p>R包e1071中的<code>naiveBayes()</code>函数和klaR中的<code>NaiveBayes()</code>函数都封装了NB算法，但mlr3目前只支持e1071包中的算法。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"classif.naive_bayes"</span>)    <span class="co"># 创建朴素贝叶斯分类学习器</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>贝叶斯回归树(BART)模型是贝叶斯理论与回归树的结合，R包dbarts封装了该算法。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"regr.dbart"</span>)   <span class="co"># 创建贝叶斯回归学习器</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="集成学习方法" class="level3" data-number="5.7.5">
<h3 data-number="5.7.5" class="anchored" data-anchor-id="集成学习方法"><span class="header-section-number">5.7.5</span> 集成学习方法</h3>
<p><strong>集成学习</strong>(Ensemble Learning)是一类旨在整合多个学习器(称为个体学习器或基学习器)来提高预测性能的机器学习建模技巧。如果基学习器类型相同，则称为<strong>同质集成</strong>，反之则称为<strong>异质集成</strong>。集成学习方法的类型主要分为<strong>Bagging</strong>、<strong>Boosting</strong>和<strong>Stacking</strong>。</p>
<section id="bagging集成学习方法" class="level4" data-number="5.7.5.1">
<h4 data-number="5.7.5.1" class="anchored" data-anchor-id="bagging集成学习方法"><span class="header-section-number">5.7.5.1</span> Bagging集成学习方法</h4>
<p>Bagging方法<strong>通过并行方式生成同质的基学习器</strong>，每个基学习器的训练数据都是训练集的一个自举抽样子集，即采用不同分布的训练子集来训练基学习器，基学习器之间彼此独立，没有强依赖关系，最终预测结果由所有基学习器共同决定：对于分类，通常采用少数服从多数的投票方法；对于回归，通常采用平均方法或加权平均方法。<strong>随机森林算法</strong>是bagging方法的典型代表，在为基学习器随机抽取等量自举样本的同时，对特征也进行随机抽样。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.23" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.23-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.23.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.23-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.23: Bagging集成学习示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>随机森林算法是应用极为广泛、性能优异且稳健的机器学习方法，可以解决回归、分类等诸多类型的任务，同时还能计算特征重要性。学习数据量较小的有监督机器学习建模均可以从随机森林算法开始或以此为基准算法。</p>
<p>mlr3支持R包randomForest、randomForestSRC和ranger封装的随机森林算法，其中前者不支持缺失值，后者计算速度更快。在mlr3中创建随机森林学习器：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 基于randomForest包</span></span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"classif.randomForest"</span>)</span>
<span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"regr.randomForest"</span>)</span>
<span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-5"><a href="#cb266-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 基于randomForestSRC包</span></span>
<span id="cb266-6"><a href="#cb266-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"classif.rfsrc"</span>)</span>
<span id="cb266-7"><a href="#cb266-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"regr.rfsrc"</span>)</span>
<span id="cb266-8"><a href="#cb266-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-9"><a href="#cb266-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 基于ranger包</span></span>
<span id="cb266-10"><a href="#cb266-10" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>)</span>
<span id="cb266-11"><a href="#cb266-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="exm-5.6" class="theorem example">
<p><span class="theorem-title"><strong>例 5.6</strong></span> 基于mlr3内置的sonar分类任务，比较单一决策树模型rpart和基于Bagging集成学习方法的随机森林模型ranger的预测性能差异。</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3tuningspaces)</span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-4"><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>)</span>
<span id="cb267-5"><a href="#cb267-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-6"><a href="#cb267-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb267-7"><a href="#cb267-7" aria-hidden="true" tabindex="-1"></a>split <span class="ot">=</span> <span class="fu">partition</span>(task)</span>
<span id="cb267-8"><a href="#cb267-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-9"><a href="#cb267-9" aria-hidden="true" tabindex="-1"></a>at1 <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb267-10"><a href="#cb267-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>),</span>
<span id="cb267-11"><a href="#cb267-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>),</span>
<span id="cb267-12"><a href="#cb267-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>),</span>
<span id="cb267-13"><a href="#cb267-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">20</span>),</span>
<span id="cb267-14"><a href="#cb267-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> <span class="fu">lts</span>(<span class="st">"classif.rpart.rbv2"</span>),</span>
<span id="cb267-15"><a href="#cb267-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">store_models =</span> T)</span>
<span id="cb267-16"><a href="#cb267-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-17"><a href="#cb267-17" aria-hidden="true" tabindex="-1"></a>at2 <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb267-18"><a href="#cb267-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>),</span>
<span id="cb267-19"><a href="#cb267-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>),</span>
<span id="cb267-20"><a href="#cb267-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>),</span>
<span id="cb267-21"><a href="#cb267-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">20</span>),</span>
<span id="cb267-22"><a href="#cb267-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> <span class="fu">lts</span>(<span class="st">"classif.ranger.rbv2"</span>),</span>
<span id="cb267-23"><a href="#cb267-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">store_models =</span> T)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb268-3"><a href="#cb268-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-4"><a href="#cb268-4" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"multisession"</span>)</span>
<span id="cb268-5"><a href="#cb268-5" aria-hidden="true" tabindex="-1"></a>pred1 <span class="ot">=</span> at1<span class="sc">$</span><span class="fu">train</span>(task,<span class="at">row_ids =</span> split<span class="sc">$</span>train)<span class="sc">$</span><span class="fu">predict</span>(task,<span class="at">row_ids =</span> split<span class="sc">$</span>test)</span>
<span id="cb268-6"><a href="#cb268-6" aria-hidden="true" tabindex="-1"></a>pred2 <span class="ot">=</span> at2<span class="sc">$</span><span class="fu">train</span>(task,<span class="at">row_ids =</span> split<span class="sc">$</span>train)<span class="sc">$</span><span class="fu">predict</span>(task,<span class="at">row_ids =</span> split<span class="sc">$</span>test)</span>
<span id="cb268-7"><a href="#cb268-7" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"sequential"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>pred1<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
 0.3043478 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>pred2<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
  0.173913 </code></pre>
</div>
</div>
<p>结果表明，在训练集和测试集一致的情况下，基于Bagging集成学习方法的ranger模型的分类错误率远小于单一决策树模型rpart。如果需要比较二者的泛化性能，可通过<code>benchmark()</code>函数执行嵌套重抽样策略来估计和比较。</p>
</section>
<section id="boosting集成学习方法" class="level4" data-number="5.7.5.2">
<h4 data-number="5.7.5.2" class="anchored" data-anchor-id="boosting集成学习方法"><span class="header-section-number">5.7.5.2</span> Boosting集成学习方法</h4>
<p>Boosting方法<strong>通过串行迭代的方式生成同质的基学习器</strong>，第一个基学习器之后生产的每个基学习器都针对前一个基学习器的预测误差进行学习，从而有效的降低模型的偏差，基学习器之间存在强依赖关系，模型最终预测结果是所有基学习器输出结果的汇总(如求和或加权求和)。目前流行的基于Boosting方法的典型算法有<strong>XGBoost</strong>、<strong>lightGBM</strong>和<strong>CatBoost</strong>算法，此三者都是基于GBDT改进而来，其中lightGBM和CatBoost支持GPU训练，lightGBM训练速度最快、内存消耗最小，CatBoost其次，XGBoost最差。lightGBM和XGBoost能够自动处理缺失值，但CatBoost不支持自动处理缺失值。CatBoost支持类别特征，而前二者需要转换为数值特征或独热编码。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.24" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.24-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.24.png" class="img-fluid figure-img" style="width:65.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.24-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.24: Boosting集成学习示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>mlr3支持R包catboost、lightgbm和xgboost分别封装的CatBoost、lightGBM和XGBoost算法，其中catboost包需要从github安装，而lightgbm和xgboost均可从CRAN安装。</p>
<p>继续对 <a href="#exm-5.6" class="quarto-xref">例&nbsp;<span>5.6</span></a> 建立一个xgboost自动调优模型：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a>at3 <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.xgboost"</span>),</span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>),</span>
<span id="cb273-4"><a href="#cb273-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>),</span>
<span id="cb273-5"><a href="#cb273-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">20</span>),</span>
<span id="cb273-6"><a href="#cb273-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> <span class="fu">lts</span>(<span class="st">"classif.xgboost.rbv2"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-4"><a href="#cb274-4" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"multisession"</span>)</span>
<span id="cb274-5"><a href="#cb274-5" aria-hidden="true" tabindex="-1"></a>pred3 <span class="ot">=</span> at3<span class="sc">$</span><span class="fu">train</span>(task,<span class="at">row_ids =</span> split<span class="sc">$</span>train)<span class="sc">$</span><span class="fu">predict</span>(task,<span class="at">row_ids =</span> split<span class="sc">$</span>test)</span>
<span id="cb274-6"><a href="#cb274-6" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"sequential"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>pred3<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb276"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="do">## classif.ce </span></span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  0.1449275 </span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>结果表明xgboost模型的分类错误率低于随机森林模型。</p>
</section>
<section id="stacking集成学习方法" class="level4" data-number="5.7.5.3">
<h4 data-number="5.7.5.3" class="anchored" data-anchor-id="stacking集成学习方法"><span class="header-section-number">5.7.5.3</span> Stacking集成学习方法</h4>
<p>Stacking方法<strong>通过并行方式生成异质的基学习器</strong>构成<strong>一级学习器</strong>，基学习器的输出组合为<strong>元学习器</strong>(<strong>二级学习器</strong>)的输入特征，元学习器做出最终的预测结果。通常，不同算法从训练数据中可能学习到不同的特征，从而得出的预测结果存在较大偏差，再经过元学习器的学习就可以得到稳健的预测结果。为了避免过拟合，一级学习器一般选择复杂的算法，而二级学习器一般选择简单的算法。对一级学习器的训练集采用自举抽样子集或分配交叉验证子集可以更好地克服过拟合现象。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-5.25" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5.25-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig5.25.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5.25-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;5.25: Stacking集成学习示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>mlr3中快速搭建Stacking集成学习架构的方式是通过<code>ppl()</code>或<code>pipeline_stacking()</code>函数调用<code>mlr_graphs_stacking</code>，也可以利用<code>gunion()</code>与<code>po("featureunion")</code>手动搭建Stacking集成学习架构。</p>
<p>对 <a href="#exm-5.6" class="quarto-xref">例&nbsp;<span>5.6</span></a> 手动建立一个基于Stacking方法的自动调优模型：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a>lr_kknn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.kknn"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>, <span class="at">id =</span> <span class="st">"kknn"</span>)</span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a>lr_kknn<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">set_values</span>(<span class="at">.values =</span> <span class="fu">lts</span>(<span class="st">"classif.kknn.rbv2"</span>)<span class="sc">$</span>values)</span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a>po_kknn <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, <span class="at">learner =</span> lr_kknn, </span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">resampling.folds =</span> <span class="dv">3</span>, <span class="at">id =</span> <span class="st">"blr_kknn"</span>)</span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a>lr_svm <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.svm"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>, <span class="at">id =</span> <span class="st">"svm"</span>, <span class="at">type =</span> <span class="st">"C-classification"</span>)</span>
<span id="cb277-7"><a href="#cb277-7" aria-hidden="true" tabindex="-1"></a>lr_svm<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">set_values</span>(<span class="at">.values =</span> <span class="fu">lts</span>(<span class="st">"classif.svm.rbv2"</span>)<span class="sc">$</span>values)</span>
<span id="cb277-8"><a href="#cb277-8" aria-hidden="true" tabindex="-1"></a>po_svm <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, <span class="at">learner =</span> lr_svm, </span>
<span id="cb277-9"><a href="#cb277-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">resampling.folds =</span> <span class="dv">3</span>, <span class="at">id =</span> <span class="st">"blr_svm"</span>)</span>
<span id="cb277-10"><a href="#cb277-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-11"><a href="#cb277-11" aria-hidden="true" tabindex="-1"></a>lr_rpart <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>, <span class="at">id =</span> <span class="st">"rpart"</span>)</span>
<span id="cb277-12"><a href="#cb277-12" aria-hidden="true" tabindex="-1"></a>lr_rpart<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">set_values</span>(<span class="at">.values =</span> <span class="fu">lts</span>(<span class="st">"classif.rpart.rbv2"</span>)<span class="sc">$</span>values)</span>
<span id="cb277-13"><a href="#cb277-13" aria-hidden="true" tabindex="-1"></a>po_rpart <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, <span class="at">learner =</span> lr_rpart, </span>
<span id="cb277-14"><a href="#cb277-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">resampling.folds =</span> <span class="dv">3</span>, <span class="at">id =</span> <span class="st">"blr_rpart"</span>)</span>
<span id="cb277-15"><a href="#cb277-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-16"><a href="#cb277-16" aria-hidden="true" tabindex="-1"></a>lr_glm <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.glmnet"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>, <span class="at">id =</span> <span class="st">"glmnet"</span>)</span>
<span id="cb277-17"><a href="#cb277-17" aria-hidden="true" tabindex="-1"></a>lr_glm<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">set_values</span>(<span class="at">.values =</span> <span class="fu">lts</span>(<span class="st">"classif.glmnet.rbv2"</span>)<span class="sc">$</span>values)</span>
<span id="cb277-18"><a href="#cb277-18" aria-hidden="true" tabindex="-1"></a>po_glm <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="at">learner =</span> lr_glm, <span class="at">id =</span> <span class="st">"slr_glm"</span>)</span>
<span id="cb277-19"><a href="#cb277-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-20"><a href="#cb277-20" aria-hidden="true" tabindex="-1"></a>gr_base <span class="ot">=</span> <span class="fu">gunion</span>(<span class="fu">list</span>(po_kknn, po_svm, po_rpart))</span>
<span id="cb277-21"><a href="#cb277-21" aria-hidden="true" tabindex="-1"></a>gr_stack <span class="ot">=</span> gr_base <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"featureunion"</span>) <span class="sc">%&gt;&gt;%</span> po_glm </span>
<span id="cb277-22"><a href="#cb277-22" aria-hidden="true" tabindex="-1"></a>gr_stack<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> T)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="htmlwidget-c7e9c457b0f793a18227" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-c7e9c457b0f793a18227">{"x":{"nodes":{"id":["blr_kknn","blr_svm","blr_rpart","featureunion","<INPUT>","slr_glm","<OUTPUT>"],"label":["blr_kknn","blr_svm","blr_rpart","featureunion","<INPUT>","slr_glm","<OUTPUT>"],"shape":["box","box","box","box","database","box","ellipse"],"color":["lightblue","lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","rgba(255,51,51,0.2)"],"value":[1,1,1,1,0.8,1,0.8],"title":["<p>PipeOp: <b>blr_kknn<\/b> (not trained)<br>values: <b>resampling.method=cv, resampling.folds=3, resampling.keep_response=FALSE, k=<RangeTuneToken><\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [TaskClassif,TaskClassif]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [TaskClassif,TaskClassif]<\/p>","<p>PipeOp: <b>blr_svm<\/b> (not trained)<br>values: <b>resampling.method=cv, resampling.folds=3, resampling.keep_response=FALSE, cost=<RangeTuneToken>, degree=<RangeTuneToken>, gamma=<RangeTuneToken>, kernel=<ObjectTuneToken>, tolerance=<RangeTuneToken>, type=C-classification<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [TaskClassif,TaskClassif]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [TaskClassif,TaskClassif]<\/p>","<p>PipeOp: <b>blr_rpart<\/b> (not trained)<br>values: <b>resampling.method=cv, resampling.folds=3, resampling.keep_response=FALSE, cp=<RangeTuneToken>, maxdepth=<RangeTuneToken>, minbucket=<RangeTuneToken>, minsplit=<RangeTuneToken>, xval=0<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [TaskClassif,TaskClassif]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [TaskClassif,TaskClassif]<\/p>","<p>PipeOp: <b>featureunion<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  ... [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [Task,Task]<\/p>","<p>Input:<br>Name: blr_kknn.input<br>Train: TaskClassif<br>Predict: TaskClassif<br>Input:<br>Name: blr_svm.input<br>Train: TaskClassif<br>Predict: TaskClassif<br>Input:<br>Name: blr_rpart.input<br>Train: TaskClassif<br>Predict: TaskClassif<\/p>","<p>PipeOp: <b>slr_glm<\/b> (not trained)<br>values: <b>alpha=<RangeTuneToken>, s=<RangeTuneToken><\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [TaskClassif,TaskClassif]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [NULL,PredictionClassif]<\/p>","<p>Output:<br>Name: slr_glm.output<br>Train: NULL<br>Predict: PredictionClassif<\/p>"],"x":[-1,0,1,0,0,0,0],"y":[-0.5,-0.5,-0.5,0,-1,0.5,1]},"edges":{"from":["blr_kknn","blr_svm","blr_rpart","featureunion","<INPUT>","<INPUT>","<INPUT>","slr_glm"],"to":["featureunion","featureunion","featureunion","slr_glm","blr_kknn","blr_svm","blr_rpart","<OUTPUT>"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>glr_stack <span class="ot">=</span> <span class="fu">as_learner</span>(gr_stack)</span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a>at4 <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> glr_stack,</span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>),</span>
<span id="cb278-5"><a href="#cb278-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>),</span>
<span id="cb278-6"><a href="#cb278-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">20</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb279-3"><a href="#cb279-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-4"><a href="#cb279-4" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"multisession"</span>)</span>
<span id="cb279-5"><a href="#cb279-5" aria-hidden="true" tabindex="-1"></a>pred4 <span class="ot">=</span> at4<span class="sc">$</span><span class="fu">train</span>(task,<span class="at">row_ids =</span> split<span class="sc">$</span>train)<span class="sc">$</span><span class="fu">predict</span>(task,<span class="at">row_ids =</span> split<span class="sc">$</span>test)</span>
<span id="cb279-6"><a href="#cb279-6" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"sequential"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>pred4<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
0.05288462 </code></pre>
</div>
</div>
<p>手动构建的以kknn、svm和rpart为一级学习器、glmnet为二级学习器的Stacking集成学习模型，在同样的训练集和预测集情况下，分类错误率进一步降低。</p>
<p>下面以<code>ppl()</code>函数调用<code>mlr_graphs_stacking</code>来构建Stacking模型，并设置将原始数据传给二级学习器：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>grppl_stack <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"stacking"</span>, </span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">base_learners =</span> <span class="fu">list</span>(lr_kknn, lr_svm, lr_rpart),</span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">super_learner =</span> lr_glm,</span>
<span id="cb282-4"><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"cv"</span>,</span>
<span id="cb282-5"><a href="#cb282-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">folds =</span> <span class="dv">3</span>,</span>
<span id="cb282-6"><a href="#cb282-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">use_features =</span> T)</span>
<span id="cb282-7"><a href="#cb282-7" aria-hidden="true" tabindex="-1"></a>grppl_stack<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> T)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="htmlwidget-f47979b570932adb3470" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-f47979b570932adb3470">{"x":{"nodes":{"id":["kknn","svm","rpart","nop","featureunion_stacking","<INPUT>","glmnet","<OUTPUT>"],"label":["kknn","svm","rpart","nop","featureunion_stacking","<INPUT>","glmnet","<OUTPUT>"],"shape":["box","box","box","box","box","database","box","ellipse"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","rgba(255,51,51,0.2)"],"value":[1,1,1,1,1,0.8,1,0.8],"title":["<p>PipeOp: <b>kknn<\/b> (not trained)<br>values: <b>resampling.method=cv, resampling.folds=3, resampling.keep_response=FALSE, k=<RangeTuneToken><\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [TaskClassif,TaskClassif]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [TaskClassif,TaskClassif]<\/p>","<p>PipeOp: <b>svm<\/b> (not trained)<br>values: <b>resampling.method=cv, resampling.folds=3, resampling.keep_response=FALSE, cost=<RangeTuneToken>, degree=<RangeTuneToken>, gamma=<RangeTuneToken>, kernel=<ObjectTuneToken>, tolerance=<RangeTuneToken>, type=C-classification<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [TaskClassif,TaskClassif]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [TaskClassif,TaskClassif]<\/p>","<p>PipeOp: <b>rpart<\/b> (not trained)<br>values: <b>resampling.method=cv, resampling.folds=3, resampling.keep_response=FALSE, cp=<RangeTuneToken>, maxdepth=<RangeTuneToken>, minbucket=<RangeTuneToken>, minsplit=<RangeTuneToken>, xval=0<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [TaskClassif,TaskClassif]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [TaskClassif,TaskClassif]<\/p>","<p>PipeOp: <b>nop<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [*,*]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [*,*]<\/p>","<p>PipeOp: <b>featureunion_stacking<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  ... [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [Task,Task]<\/p>","<p>Input:<br>Name: kknn.input<br>Train: TaskClassif<br>Predict: TaskClassif<br>Input:<br>Name: svm.input<br>Train: TaskClassif<br>Predict: TaskClassif<br>Input:<br>Name: rpart.input<br>Train: TaskClassif<br>Predict: TaskClassif<br>Input:<br>Name: nop.input<br>Train: *<br>Predict: *<\/p>","<p>PipeOp: <b>glmnet<\/b> (not trained)<br>values: <b>alpha=<RangeTuneToken>, s=<RangeTuneToken><\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [TaskClassif,TaskClassif]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [NULL,PredictionClassif]<\/p>","<p>Output:<br>Name: glmnet.output<br>Train: NULL<br>Predict: PredictionClassif<\/p>"],"x":[-1,-0.3333333333333334,0.3333333333333333,1,0,0,0,0],"y":[-0.5,-0.5,-0.5,-0.5,0,-1,0.5,1]},"edges":{"from":["kknn","svm","rpart","nop","featureunion_stacking","<INPUT>","<INPUT>","<INPUT>","<INPUT>","glmnet"],"to":["featureunion_stacking","featureunion_stacking","featureunion_stacking","featureunion_stacking","glmnet","kknn","svm","rpart","nop","<OUTPUT>"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a>glrppl_stack <span class="ot">=</span> <span class="fu">as_learner</span>(grppl_stack)</span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a>at5 <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> glrppl_stack,</span>
<span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>),</span>
<span id="cb283-5"><a href="#cb283-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>),</span>
<span id="cb283-6"><a href="#cb283-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">20</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb284-3"><a href="#cb284-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-4"><a href="#cb284-4" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"multisession"</span>)</span>
<span id="cb284-5"><a href="#cb284-5" aria-hidden="true" tabindex="-1"></a>pred5 <span class="ot">=</span> at5<span class="sc">$</span><span class="fu">train</span>(task,<span class="at">row_ids =</span> split<span class="sc">$</span>train)<span class="sc">$</span><span class="fu">predict</span>(task,<span class="at">row_ids =</span> split<span class="sc">$</span>test)</span>
<span id="cb284-6"><a href="#cb284-6" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"sequential"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb285"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a>pred5<span class="sc">$</span><span class="fu">score</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> classif.ce 
0.009615385 </code></pre>
</div>
</div>
<p>在采用<code>ppl()</code>函数构建的Stacking模型时，设置了参数use_features = T，目的是将原始特征数据传给二级学习器，这与手动搭建的Stacking模型有所区别。结果表明，这种变化带来了更低的分类错误率。</p>
<p>比较以上建立的单个决策树模型和不同类型的集成学习模型，可以发现集成学习在提高预测性能上具有极大的潜力。在解决各种机器学习任务时，应积极考虑采用集成学习方法。</p>
<div id="exr-5.3" class="theorem exercise">
<p><span class="theorem-title"><strong>练习 5.3</strong></span> 从https://archive.ics.uci.edu/dataset/733/water+quality+prediction-1下载水质数据，基于mlr3框架，从RF、XGBoost和lightGBM三个模型筛选最优模型，并对最优模型进行关键超参数的优化，最后给出最优模型的性能评估。在Markdown或Quarto文档中完成整个建模过程，包括建模文档和代码。</p>
</div>
<div id="exr-5.4" class="theorem exercise">
<p><span class="theorem-title"><strong>练习 5.4</strong></span> 基于 <a href="#exr-5.3" class="quarto-xref">练习&nbsp;<span>5.3</span></a> 的数据集和模型比选结果，采用图学习器建立最优模型，要考虑采用特征预处理方法以及超参数优化。在Markdown或Quarto文档中完成整个建模过程，包括建模文档和代码。</p>
</div>
<div id="exr-5.5" class="theorem exercise">
<p><span class="theorem-title"><strong>练习 5.5</strong></span> 5-3：基于 <a href="#exr-5.3" class="quarto-xref">练习&nbsp;<span>5.3</span></a> 的数据集并参考 <a href="#exm-5.6" class="quarto-xref">例&nbsp;<span>5.6</span></a> ，尝试采用Stacking集成学习方法建立不少于3个不同基模型的集成模型。在Markdown或Quarto文档中完成整个建模过程，包括建模文档和代码。</p>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "已复制");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "已复制");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./CH4.html" class="pagination-link" aria-label="环境数据统计分析">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">环境数据统计分析</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./CH6.html" class="pagination-link" aria-label="R语言深度学习建模">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R语言深度学习建模</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>环境数据分析与机器学习，邓大鹏 编著.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>本书采用<a href="https://quarto.org/">Quarto</a>构建.</p>
</div>
  </div>
</footer>




</body></html>
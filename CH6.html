<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>环境数据分析与机器学习 - 6&nbsp; R语言深度学习建模</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./CH5.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "没有结果",
    "search-matching-documents-text": "匹配的文档",
    "search-copy-link-title": "复制搜索链接",
    "search-hide-matches-text": "隐藏其它匹配结果",
    "search-more-match-text": "更多匹配结果",
    "search-more-matches-text": "更多匹配结果",
    "search-clear-button-title": "清除",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "提交",
    "search-label": "搜索"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="edaml.scss">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="展开或折叠侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./CH6.html">高阶知识</a></li><li class="breadcrumb-item"><a href="./CH6.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R语言深度学习建模</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="展开或折叠侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">环境数据分析与机器学习</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="搜索"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">前言</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">基础知识</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">绪论</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">R语言编程基础</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">环境数据整理与可视化</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">进阶知识</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">环境数据统计分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">R语言机器学习建模</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">高阶知识</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH6.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R语言深度学习建模</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">参考文献</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目录</h2>
   
  <ul>
  <li><a href="#深度学习概述" id="toc-深度学习概述" class="nav-link active" data-scroll-target="#深度学习概述"><span class="header-section-number">6.1</span> 深度学习概述</a>
  <ul>
  <li><a href="#深度学习概念及其特点" id="toc-深度学习概念及其特点" class="nav-link" data-scroll-target="#深度学习概念及其特点"><span class="header-section-number">6.1.1</span> 深度学习概念及其特点</a></li>
  <li><a href="#人工神经网络基础" id="toc-人工神经网络基础" class="nav-link" data-scroll-target="#人工神经网络基础"><span class="header-section-number">6.1.2</span> 人工神经网络基础</a>
  <ul class="collapse">
  <li><a href="#神经元数学模型和神经元层" id="toc-神经元数学模型和神经元层" class="nav-link" data-scroll-target="#神经元数学模型和神经元层"><span class="header-section-number">6.1.2.1</span> 神经元数学模型和神经元层</a></li>
  <li><a href="#激活函数" id="toc-激活函数" class="nav-link" data-scroll-target="#激活函数"><span class="header-section-number">6.1.2.2</span> 激活函数</a></li>
  <li><a href="#权重更新与梯度下降法" id="toc-权重更新与梯度下降法" class="nav-link" data-scroll-target="#权重更新与梯度下降法"><span class="header-section-number">6.1.2.3</span> 权重更新与梯度下降法</a></li>
  <li><a href="#随机失活和批归一化" id="toc-随机失活和批归一化" class="nav-link" data-scroll-target="#随机失活和批归一化"><span class="header-section-number">6.1.2.4</span> 随机失活和批归一化</a></li>
  </ul></li>
  <li><a href="#经典神经网络模型简介" id="toc-经典神经网络模型简介" class="nav-link" data-scroll-target="#经典神经网络模型简介"><span class="header-section-number">6.1.3</span> 经典神经网络模型简介</a>
  <ul class="collapse">
  <li><a href="#全连接神经网络fcnn" id="toc-全连接神经网络fcnn" class="nav-link" data-scroll-target="#全连接神经网络fcnn"><span class="header-section-number">6.1.3.1</span> 全连接神经网络FCNN</a></li>
  <li><a href="#卷积神经网络cnn" id="toc-卷积神经网络cnn" class="nav-link" data-scroll-target="#卷积神经网络cnn"><span class="header-section-number">6.1.3.2</span> 卷积神经网络CNN</a></li>
  <li><a href="#循环神经网络rnn及变体" id="toc-循环神经网络rnn及变体" class="nav-link" data-scroll-target="#循环神经网络rnn及变体"><span class="header-section-number">6.1.3.3</span> 循环神经网络RNN及变体</a></li>
  <li><a href="#自注意力神经网络transformer" id="toc-自注意力神经网络transformer" class="nav-link" data-scroll-target="#自注意力神经网络transformer"><span class="header-section-number">6.1.3.4</span> 自注意力神经网络Transformer</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#基于torch的深度学习建模" id="toc-基于torch的深度学习建模" class="nav-link" data-scroll-target="#基于torch的深度学习建模"><span class="header-section-number">6.2</span> 基于torch的深度学习建模</a>
  <ul>
  <li><a href="#torch包的简介与安装" id="toc-torch包的简介与安装" class="nav-link" data-scroll-target="#torch包的简介与安装"><span class="header-section-number">6.2.1</span> torch包的简介与安装</a></li>
  <li><a href="#创建dataset和dataloader" id="toc-创建dataset和dataloader" class="nav-link" data-scroll-target="#创建dataset和dataloader"><span class="header-section-number">6.2.2</span> 创建Dataset和Dataloader</a>
  <ul class="collapse">
  <li><a href="#创建dataset" id="toc-创建dataset" class="nav-link" data-scroll-target="#创建dataset"><span class="header-section-number">6.2.2.1</span> 创建Dataset</a></li>
  <li><a href="#创建dataloader" id="toc-创建dataloader" class="nav-link" data-scroll-target="#创建dataloader"><span class="header-section-number">6.2.2.2</span> 创建Dataloader</a></li>
  </ul></li>
  <li><a href="#搭建模型" id="toc-搭建模型" class="nav-link" data-scroll-target="#搭建模型"><span class="header-section-number">6.2.3</span> 搭建模型</a></li>
  <li><a href="#模型训练" id="toc-模型训练" class="nav-link" data-scroll-target="#模型训练"><span class="header-section-number">6.2.4</span> 模型训练</a></li>
  <li><a href="#模型预测与性能评价" id="toc-模型预测与性能评价" class="nav-link" data-scroll-target="#模型预测与性能评价"><span class="header-section-number">6.2.5</span> 模型预测与性能评价</a></li>
  </ul></li>
  <li><a href="#sec-dl-example" id="toc-sec-dl-example" class="nav-link" data-scroll-target="#sec-dl-example"><span class="header-section-number">6.3</span> 深度学习建模案例</a>
  <ul>
  <li><a href="#表格数据案例" id="toc-表格数据案例" class="nav-link" data-scroll-target="#表格数据案例"><span class="header-section-number">6.3.1</span> 表格数据案例</a></li>
  <li><a href="#时间序列数据案例" id="toc-时间序列数据案例" class="nav-link" data-scroll-target="#时间序列数据案例"><span class="header-section-number">6.3.2</span> 时间序列数据案例</a></li>
  <li><a href="#图像数据案例" id="toc-图像数据案例" class="nav-link" data-scroll-target="#图像数据案例"><span class="header-section-number">6.3.3</span> 图像数据案例</a>
  <ul class="collapse">
  <li><a href="#加载工具包" id="toc-加载工具包" class="nav-link" data-scroll-target="#加载工具包"><span class="header-section-number">6.3.3.1</span> 加载工具包</a></li>
  <li><a href="#图片预处理" id="toc-图片预处理" class="nav-link" data-scroll-target="#图片预处理"><span class="header-section-number">6.3.3.2</span> 图片预处理</a></li>
  <li><a href="#下载数据并创建dataset" id="toc-下载数据并创建dataset" class="nav-link" data-scroll-target="#下载数据并创建dataset"><span class="header-section-number">6.3.3.3</span> 下载数据并创建Dataset</a></li>
  <li><a href="#创建dataloader-1" id="toc-创建dataloader-1" class="nav-link" data-scroll-target="#创建dataloader-1"><span class="header-section-number">6.3.3.4</span> 创建Dataloader</a></li>
  <li><a href="#数据可视化" id="toc-数据可视化" class="nav-link" data-scroll-target="#数据可视化"><span class="header-section-number">6.3.3.5</span> 数据可视化</a></li>
  <li><a href="#搭建模型-1" id="toc-搭建模型-1" class="nav-link" data-scroll-target="#搭建模型-1"><span class="header-section-number">6.3.3.6</span> 搭建模型</a></li>
  <li><a href="#训练模型" id="toc-训练模型" class="nav-link" data-scroll-target="#训练模型"><span class="header-section-number">6.3.3.7</span> 训练模型</a></li>
  <li><a href="#预测并计算预测性能" id="toc-预测并计算预测性能" class="nav-link" data-scroll-target="#预测并计算预测性能"><span class="header-section-number">6.3.3.8</span> 预测并计算预测性能</a></li>
  <li><a href="#保存模型" id="toc-保存模型" class="nav-link" data-scroll-target="#保存模型"><span class="header-section-number">6.3.3.9</span> 保存模型</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./CH6.html">高阶知识</a></li><li class="breadcrumb-item"><a href="./CH6.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R语言深度学习建模</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R语言深度学习建模</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>迄今为止，深度学习是人工智能中最热门的领域，也是目前商业应用最广泛的AI技术。深度学习能够成功的重要因素可以归结为三点：一是<strong>大数据的积累</strong>，二是<strong>算力的提高</strong>，三是<strong>自动化的深层次特征提取和表示</strong>。复杂高维数据让手动特征工程成为不可能的任务，但没有大数据的积累和计算机硬件（特别是基于GPU的高性能计算）的进步，深度学习的自动化深层次特征提取与表示就英雄无用武之地。</p>
<p>目前的深度学习技术几乎都基于神经网络，而神经网络的研究可以追溯到20世纪40年代，经历了三次高潮和两次低谷，大致可以划分为三个周期：</p>
<p>（1）第一个周期为感知器时代（1943~1986）<br>
以1943年Warren McCulloch和Walter Pitts提出MP（McCulloch-Pitts）神经元模型为开端，以1957年Frank Rosenblatt提出作为二元分类器的简单前馈神经网络——感知器（Perceptron）模型为高潮起点，到1969年Marvin Minsky与Seymour Papert合著的《Perceptrons》一书对感知器提出批判而进入低谷。</p>
<p>（2）第二个周期为BP算法时代（1986~2006）<br>
以1986年David Rumelhart、Geoffrey Hinton和Ronald Williams提出误差反向传播（BP）算法为高潮起点，随后数以百计的神经网络模型被提出，并发明了神经网络计算硬件，但在1995年以后进入低谷，主要原因是当时有限的计算机硬件无法支持大规模神经网络的训练。上世纪90年代末到本世纪初，基于核函数在高维空间实现线性可分的支持向量机（SVM）成为机器学习领域的引领者。在这个周期的低谷阶段，涌现了很多为后来深度学习发展奠定坚实基础的研究成果，如1997年Sepp Hochreiter等提出的LSTM模型，1998年Yann LeCun等提出的第一个卷积神经网络LeNet-5等。</p>
<p>（3）第三个周期为深度学习时代（2006年至今）<br>
以2006年Geoffrey Hinton等人提出深度信念网络（DBN）和深度学习概念为开端，以Geoffrey Hinton团队设计的卷积神经网络模型AlexNet在ImageNet竞赛中夺冠为高潮起点，随后循环神经网络RNN及其变种LSTM（长短期记忆网络）、生成对抗网络GAN等更多类型的深度神经网络纷纷涌现。2017年谷歌的研究团队提出了基于自注意力（Self-Attention）机制的Transfomer架构，为后来自然语言处理大模型如BERT、GPT等的蓬勃发展铺平了道路。</p>
<p>本章基于R包torch介绍深度学习建模技术，聚焦应用，基于案例来学习和掌握R语言和torch包构建典型的深度神经网络模型。</p>
<section id="深度学习概述" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="深度学习概述"><span class="header-section-number">6.1</span> 深度学习概述</h2>
<section id="深度学习概念及其特点" class="level3" data-number="6.1.1">
<h3 data-number="6.1.1" class="anchored" data-anchor-id="深度学习概念及其特点"><span class="header-section-number">6.1.1</span> 深度学习概念及其特点</h3>
<p>深度学习是一种基于人工神经网络（ANN）架构对数据进行<strong>表征学习</strong>（Representation Learning）的算法，是机器学习的一个重要分支。传统机器学习实现了特征到输出的映射，但深度学习则从原始数据自动学习特征表示，构建层次化的概念体系，让计算机从简单概念来学习复杂概念。这不仅仅是简单的特征工程自动化，因为深度学习模型自动提取的特征往往比手动提取的特征表现更好。与传统机器学习相比，深度学习具有如下特点：<br>
（1）<strong>特征工程自动化</strong>。深度学习直接利用不同架构的神经网络从原始数据提取深层次的特征表示，不再需要手动特征工程。这个特点对于大数据特别是影像、音频、文本等非结构性数据的特征工程而言，其进步是不言而喻的。<br>
（2）<strong>应用可扩展</strong>。深度学习模型能够通过增量学习转换到同一领域的不同应用，而传统机器学习模型则具有很大的局限性。例如，预训练的宠物识别深度神经网络模型可以非常容易地应用于野生动物的识别。<br>
（3）<strong>成本昂贵</strong>。深度学习是大数据和高算力驱动发展的，大数据的获取成本很高，高算力的专用硬件（高级GPU）也非常昂贵，而且深度学习模型的训练往往需要很长的时间，LLM的训练时间动辄数月时间，期间的能耗也极为惊人。据研究测算，大语言模型GPT-3（1750亿个参数）一次训练的电力消耗近19万kW·h，同时产生与汽车行驶70万公里相当的二氧化碳排放量。</p>
<p>抽象和形式化的任务对人类来而言往往具有较高的难度，例如可以用公式表达的数学问题，但计算机很容易解决。那些难以形式化描述但人类可以凭直觉轻松执行的任务，如图像分类、语音识别、语言沟通等，计算机却难以解决，但深度学习在这方面正在赶超人类。</p>
</section>
<section id="人工神经网络基础" class="level3" data-number="6.1.2">
<h3 data-number="6.1.2" class="anchored" data-anchor-id="人工神经网络基础"><span class="header-section-number">6.1.2</span> 人工神经网络基础</h3>
<section id="神经元数学模型和神经元层" class="level4" data-number="6.1.2.1">
<h4 data-number="6.1.2.1" class="anchored" data-anchor-id="神经元数学模型和神经元层"><span class="header-section-number">6.1.2.1</span> 神经元数学模型和神经元层</h4>
<p>人工神经网络是一种模仿生物神经元（ <a href="#fig-6.1" class="quarto-xref">图&nbsp;<span>6.1</span></a> 左图）运行机制的仿生智能算法，其构成的基础单元是人工神经元（Neuron，也称节点，示意图见 <a href="#fig-6.1" class="quarto-xref">图&nbsp;<span>6.1</span></a> 右图）。人工神经元是对生物神经元功能的模仿，其输入相当于生物神经元的树突，输出相当于生物神经元的轴突（轴突的信号可以通过突触或称轴突末梢传递给后续连接的神经元），对输入的处理（包括<strong>激活函数</strong>，Activation Function）相当于生物神经元的细胞核。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.1: 生物神经元和人工神经元模型
</figcaption>
</figure>
</div>
</div>
</div>
<p>神经元是神经网络中的基础计算节点，对每一个输入特征都对应一个<strong>权重</strong>（weights），表示连接强度，控制信息的流动。每个神经元一般还设置一个小的常数项，即<strong>偏置</strong>（bias），相当于是输入特征恒定为1的权重。偏置的意义在于避免神经元的加权和为0的情况。所有输入特征的加权和与偏置的总和作为激活函数的输入，激活函数的输出即为神经元的输出。正是权重和偏置让神经网络拥有了强大的表达能力和学习能力。</p>
<p>Frank Rosenblatt发明的基于人工神经元（MP模型）的感知器是世界上第一个人工神经网络，其激活函数是一个阶跃函数，能够实现简单的线性二分类。在二维平面上，感知器是一条直线，不能划分异或区间，因此无法解决异或问题。让神经网络具有强大的功能，就需要采用更多神经元。在复杂神经网络中，神经元按层组织，即<strong>神经元层</strong>（Layer），层内所有神经元具有相同的激活函数。最典型的神经网络是前馈式全连接网络（ <a href="#fig-6.2" class="quarto-xref">图&nbsp;<span>6.2</span></a> ），即数据流从输入层（输入层不是由神经元构成，只是第一个隐层的输入）到隐层（可以有多个）再到输出层。神经网络由神经元层逐层搭建而成，通常将隐层数≤2的神经网络归为浅层神经网络，而将隐层数≥3的神经网络归为深度神经网络（ <a href="#fig-6.2" class="quarto-xref">图&nbsp;<span>6.2</span></a> 右图）。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.2.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.2: 典型前馈式全连接网络结构示意图
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="激活函数" class="level4" data-number="6.1.2.2">
<h4 data-number="6.1.2.2" class="anchored" data-anchor-id="激活函数"><span class="header-section-number">6.1.2.2</span> 激活函数</h4>
<p>在多层神经网络中，激活函数非常重要，如果没有激活函数，整个多层网络本质上就是一个单层网络。激活函数将神经元的所有输入加权之和（包括偏置）作为输入，经过激活函数的计算转换为神经元的最终输出。激活函数通常要求可导、单调且其导函数值域在较小区间内，大多数激活函数是非线性的。常用的激活函数有Sigmoid、Tanh、ReLU等类型，这三种激活函数及其导函数的图像如 <a href="#fig-6.3" class="quarto-xref">图&nbsp;<span>6.3</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.3.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.3: Sigmoid、Tanh和ReLU激活函数及其导函数的图像
</figcaption>
</figure>
</div>
</div>
</div>
<p>Sigmoid和Tanh函数的缺陷是存在值域饱和区，从 <a href="#fig-6.3" class="quarto-xref">图&nbsp;<span>6.3</span></a> 可见，二者将较大的输入转换为接近1的输出，将较小的输入转换为接近 -1或0的输出，而对0附近狭窄区间的输入变化最敏感。这意味着，当输入值在二者的饱和区时，相应导数接近于0，这对基于梯度下降法进行训练的神经网络而言，导致了梯度消失问题。ReLU函数则能有效缓解梯度消失问题，且计算成本更低。但ReLU函数将小于0的输入转换为0，降低了神经网络恰当拟合数据或训练的能力，为此提出了一种改进的ReLU函数——Leaky ReLU函数，该函数和导函数的图像见 <a href="#fig-6.4" class="quarto-xref">图&nbsp;<span>6.4</span></a> 。Leaky ReLU函数对小于0的输入，引入了一个小斜率的线性函数作为激活函数，从而有效克服了ReLU函数的缺陷。ReLU具有稀疏性，只能用于隐层。相比Sigmoid和Tanh激活函数，ReLU能够更积极的打开或关闭神经元。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.4" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.4.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.4: Leaky_ReLU激活函数及其导函数的图像
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="权重更新与梯度下降法" class="level4" data-number="6.1.2.3">
<h4 data-number="6.1.2.3" class="anchored" data-anchor-id="权重更新与梯度下降法"><span class="header-section-number">6.1.2.3</span> 权重更新与梯度下降法</h4>
<p>在前馈神经网络中，数据流从输入层开始逐层处理并传向输出层的过程称为正向传播，然后将网络输出标签与实际标签的损失函数构造为目标函数（一般都是凸函数），反向逐层求出目标函数对各神经元权重的偏导数（链式法则），构成目标函数对权重的梯度，并根据梯度逐层更新权重，这是网络训练过程中最重要的步骤，即反向传播（Back Propagation）。当网络输出标签与实际标签的偏差达到期望值时，结束网络训练。</p>
<p>神经网络反向传播的过程，是利用梯度更新网络权重的过程，本质上是对目标函数的优化，捕获全局最优（通常都是寻找目标函数的最小值）。在深度神经网络的训练中，最常用的优化算法是梯度下降法( <a href="#fig-6.5" class="quarto-xref">图&nbsp;<span>6.5</span></a> )。梯度是一个向量，表示函数在某点处的方向导数沿着该方向取得最大值，即函数在该点处沿着该方向（即该梯度的方向）变化率（即该梯度的模）最大。对于一元线性函数，梯度就是斜率，对于多元函数，梯度由各个自变量的偏导数组成。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.5" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.5.png" class="img-fluid figure-img" style="width:40.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.5: 梯度下降法示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>显然，沿着梯度负方向减小函数值，不断迭代，就能找到或接近目标函数的最小值。距离最优解越远，梯度越大，距离最优解越近，梯度越小。初始位置、下降方向、下降步长是梯度下降法的三要素。在步长的计算中有一个学习率的参数，学习率太小，每次步长更新太小，迭代次数显著增多；学习率太大，则无法保证收敛到最优解。因此，选择合适的学习率极为重要，很多基于梯度下降的优化算法都聚焦于学习率的调整，例如AdaGrad算法、RMSProp算法、Adam算法等，以加快网络训练的收敛速度。每次迭代中输入的样例数量显著影响梯度下降法的收敛：每次迭代输入一个样例的随机梯度下降法（SGD），收敛速度快，但波动性大，不能保证每次迭代都朝正确方向前进；每次迭代输入全部样例的全量随机梯度下降法（Batch SGD）能保证每次迭代都朝正确方向前进，但迭代时间长，内存消耗大；而每次迭代输入多个样例的小批量随机梯度下降法（Minibatch SGD）是一个折中的算法，选择合理的Batch大小，可以让收敛速度比SGD更快、更稳定，在最优解附近跳跃小，甚至能够得到比全量随机梯度下降法更好的解。</p>
</section>
<section id="随机失活和批归一化" class="level4" data-number="6.1.2.4">
<h4 data-number="6.1.2.4" class="anchored" data-anchor-id="随机失活和批归一化"><span class="header-section-number">6.1.2.4</span> 随机失活和批归一化</h4>
<p>深度神经网络容易出现过拟合和训练收敛速度慢等问题，随机失活（Dropout）和批归一化（Batch Normalization）等正则化方法可以克服这类问题。</p>
<p>随机失活方法( <a href="#fig-6.6" class="quarto-xref">图&nbsp;<span>6.6</span></a> )是在网络训练阶段的前向传播过程中，以一定概率让某些神经元失活，从而克服过拟合并提高泛化性能。Dropout与传统剪枝（Prunning）方法不同，剪枝方法是按设定规则永远丢弃神经元，而Dropout只是在训练阶段暂时地随机丢弃神经元。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.6" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.6.png" class="img-fluid figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.6: Dropout方法示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>此外，随着网络训练中权重的更新，除了第一层的输入数据外，后面每层输入数据的分布都会随之变化，因为在训练的时候，前层训练参数的更新将导致后层输入数据分布的变化，产生所谓的“内部协变量偏移（Internal Covariate Shift）”问题，导致训练的不稳定性，如果数据分布偏移到激活函数的饱和区，网络训练就会非常慢，难以收敛。由于深度神经网络广泛采用小批量随机梯度下降法，批归一化与数据预处理中的归一化相似，但转换公式中增加了尺度参数<span class="math inline">\gamma</span>、平移参数<span class="math inline">\beta</span>和一个常数项<span class="math inline">\varepsilon</span>（微小正数），二者的区别如 <a href="#fig-6.7" class="quarto-xref">图&nbsp;<span>6.7</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.7" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.7.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.7: 归一化与批归一化示意图
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="经典神经网络模型简介" class="level3" data-number="6.1.3">
<h3 data-number="6.1.3" class="anchored" data-anchor-id="经典神经网络模型简介"><span class="header-section-number">6.1.3</span> 经典神经网络模型简介</h3>
<p>神经网络的基本结构根据数据流向可分为前馈神经网络（Feed Forward NN）和反馈神经网络（Feed Back NN）。在前馈神经网络中，数据从输入层开始，每层神经元接收上一层神经元的输出，并输出给下一层的神经元。在反馈神经网络中，除了与前馈神经网络一样的数据流向外，隐层神经元还能接收自己的上一次输出，具有记忆性，在不同时刻具有不同的状态。</p>
<section id="全连接神经网络fcnn" class="level4" data-number="6.1.3.1">
<h4 data-number="6.1.3.1" class="anchored" data-anchor-id="全连接神经网络fcnn"><span class="header-section-number">6.1.3.1</span> 全连接神经网络FCNN</h4>
<p>FCNN是一种典型的前馈神经网络（ <a href="#fig-6.2" class="quarto-xref">图&nbsp;<span>6.2</span></a> ），MLP是FCNN的一个代表。在FCNN中，层内神经元互不连接，相邻层的神经元完全互相连接。FCNN的优点是具有很强的灵活性和表达能力，但也存在参数量大和容易过拟合的缺点。</p>
</section>
<section id="卷积神经网络cnn" class="level4" data-number="6.1.3.2">
<h4 data-number="6.1.3.2" class="anchored" data-anchor-id="卷积神经网络cnn"><span class="header-section-number">6.1.3.2</span> 卷积神经网络CNN</h4>
<p>CNN利用多个卷积层来提取图像的各种局部特征。卷积层利用卷积核（本质上是一种滤波器）执行卷积运算( <a href="#fig-6.8" class="quarto-xref">图&nbsp;<span>6.8</span></a> )，不同的卷积核能够提取出不同的特征，特别是对象的边缘。CNN中的卷积和数学中的卷积是两种不同的运算。数学卷积的卷积核是预先设定的，运算前先将卷积核绕中心旋转180度，然后与矩阵对应位置相乘并求和；而CNN中的卷积核是随机初始化再经过训练或学习而得到的，运算时卷积核无需旋转，卷积核与图像（矩阵）局部区域对应位置相乘并求和，亦即以卷积核为权重对图像局部区域像素值加权求和，本质上是一种互相关（cross-correlation）运算。卷积运算根据CNN的输入维度，可以是一维，也可以是二维、三维。</p>
<p>卷积核的大小（kernel size）决定其感受野。例如一个3×3的二维卷积核，一次扫描的感受野是9个像素，而一个5×5的二维卷积核，其感受野是25个像素。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.8" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.8.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.8: CNN卷积运算示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>原始图像经过卷积核运算后，图像边缘被修剪，生成的新图像变小，导致信息部分损失。为了解决这个问题，需要对原始图像边缘进行填充（填充值一般为0）操作( <span class="citation" data-cites="fig">(<a href="#ref-fig" role="doc-biblioref"><strong>fig?</strong></a>)</span>=6.9 )，此即所谓的“padding”。图像高和宽两个维度的填充数根据卷积核的高和宽进行调整，以使输出和输入的图像具有相同的高度和宽度。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.9" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.9.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.9: padding操作及卷积运算可视化示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>当原始图像过大，可通过调整卷积核移动的步长（stride）来压缩部分信息。步长包括水平和垂直两个方向， <a href="#fig-6.10" class="quarto-xref">图&nbsp;<span>6.10</span></a> 演示了步长在水平和垂直两个方向都为2的卷积运算示例。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.10" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.10.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.10: 卷积核移动步长为2的卷积运算示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>对卷积核进行扩张（dilation）来增大感受野，可以克服因卷积核移动步长过大而导致的图像失真问题。一个3×3的卷积核，当扩张系数为2时，其感受野会扩大为5×5，扩张后的空洞用0值填充，实际计算量并没有增加，如 <a href="#fig-6.11" class="quarto-xref">图&nbsp;<span>6.11</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.11" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.11.png" class="img-fluid figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.11: 扩张系数为2时的卷积核大小变化示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>输入CNN的图像还有一个通道（channel）的概念。灰度图像只有一个通道，而标准彩色图像有红绿蓝（即RGB）3个通道。同时，还要设定输入图像的批量大小（batch size）。因此，CNN的初始输入是一个四维数组，例如1×3×64×64，表示输入是批量大小为1的3通道64（高）×64（宽）像素的彩色图像。</p>
<p>卷积运算后的结果经过激活函数的处理，维度保持不变。但一个图像采用多个卷积核执行卷积运算后，维度急剧上升，导致模型参数“爆炸”，因此需要进行降维操作。池化（pooling）运算是一种在CNN中广泛使用的降维操作。在卷积操作后进行池化，不仅能够降低卷积结果的维度，减少参数和计算量，而且能够突出最具代表性的特征，降低像素的重复性，让后续的卷积层操作更有意义。池化本质上是一种聚合运算，包括最大池化（maximum pooling）和平均池化（average pooling），如 <a href="#fig-6.12" class="quarto-xref">图&nbsp;<span>6.12</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.12" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.12.png" class="img-fluid figure-img" style="width:40.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.12: 池化运算示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>通常，一个完整的卷积层包括卷积运算和池化运算。CNN一般利用很多个卷积层来提取不同的特征，然后将高维输出展平（flatten）为低维结果，传给后面的全连接层或其他类型的神经元层，进行分类或回归。 <a href="#fig-6.13" class="quarto-xref">图&nbsp;<span>6.13</span></a> 是第一个CNN架构——LeNet-5，由Yann LeCun等于1988年发表。LeNet-5包括2个卷积层和3个全连接层，使用平均池化。2012年在ImageNet竞赛中一骑绝尘的AlexNet只是在LeNet-5的基础上堆叠了更多卷积层，由5个卷积层和3个全连接层构成，拥有6千万个参数。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.13" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.13.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.13: LeNet-5架构示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>CNN不仅仅应用于图像分类、目标检测等有影像数据，还可以拓展用于序列数据等。</p>
</section>
<section id="循环神经网络rnn及变体" class="level4" data-number="6.1.3.3">
<h4 data-number="6.1.3.3" class="anchored" data-anchor-id="循环神经网络rnn及变体"><span class="header-section-number">6.1.3.3</span> 循环神经网络RNN及变体</h4>
<p>RNN及其变体的隐层神经元的输出能够传递给自身，从而具备处理序列数据的天赋，这特别适用于语音、视频、自然语言处理、时间序列建模等，因为序列数据的前后元素（深度学习中通常称为token，即构成序列的最小单位，也称词元）之间存在密切联系。 RNN的雏形是1982年提出的单层反馈神经网络 Hopfield Network，是，用来解决组合优化问题。此后的发展中因“梯度消失”和“梯度爆炸”问题，RNN的训练非常困难，应用十分受限。1997年出现了两个RNN的改进版本，一个是Sepp Hochreiter等提出的长短期记忆（LSTM）网络，使用门控单元及记忆机制来解决RNN的训练问题，另一个是Mike Schuster等提出的双向RNN模型（Bidirectional RNN），神经元当前输出同时考虑“上下文”，即同时利用过去和未来的信息。这两种模型拓宽了RNN的应用范围，推动了深度学习在文本、语音、视频、时间序列等法方面的应用。</p>
<p>传统RNN的结构如 <a href="#fig-6.14" class="quarto-xref">图&nbsp;<span>6.14</span></a> 所示，其计算核心是一个采用tanh激活函数的全连接网络，但每一时刻的输入是由上一时刻自身的输出<span class="math inline">h_{t-1}</span>与当前时刻的输入<span class="math inline">x_t</span>合并组成。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.14" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.14.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.14: RNN的Cell结构和RNN展开示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>LSTM是一个结构更复杂的RNN变体，其结构与计算如 <a href="#fig-6.15" class="quarto-xref">图&nbsp;<span>6.15</span></a> 所示。LSTM计算核心包括5个FCNN，其中3个激活函数为sigmoid，2个为tanh，分别构成三个门控单元：遗忘门、输入门和输出门。此外，LSTM还增加了Cell状态，每一时刻的输入除了上一时刻自身的输出ht-1与当前时刻的输入xt的组合，还有上一时刻的Cell状态Ct-1。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.15" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.15-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.15.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.15-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.15: LSTM的Cell结构示意图(σ表示Sigmoid激活函数，下同)
</figcaption>
</figure>
</div>
</div>
</div>
<p>GRU（门控循环单元）由重置门和更新门组成，是对LSTM的一种计算简化，其结构与计算如 <a href="#fig-6.16" class="quarto-xref">图&nbsp;<span>6.16</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.16" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.16-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.16.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.16-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.16: GRU的Cell结构示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>双向RNN模型的隐层采用2个RNN单元（一般采用LSTM），一个正向处理输入，一个反向处理输入，二者的输出拼接后传递给输出层。<a href="#fig-6.17" class="quarto-xref">图&nbsp;<span>6.17</span></a> 演示了一个双向LSTM网络的结构示意图。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.17" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.17-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.17.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.17-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.17: 双向LSTM网络结构示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>RNN和双向RNN网络的隐层都可以堆叠多个RNN单元来构造更深度的网络，但通常建议不要超过3个单元，因为RNN单元在时间维度上是连接的，这意味着每增加一个时序，RNN网络随之增加一个自我拷贝，网络就会变得越来越大，对算力要求急剧增加。</p>
</section>
<section id="自注意力神经网络transformer" class="level4" data-number="6.1.3.4">
<h4 data-number="6.1.3.4" class="anchored" data-anchor-id="自注意力神经网络transformer"><span class="header-section-number">6.1.3.4</span> 自注意力神经网络Transformer</h4>
<p>2017年谷歌研究团队在《Attention is all you need》一文中提出了颠覆性的Transformer模型。该模型基于自注意力（Self-attention）机制，实现了捕获长序列中的时间依赖关系与距离无关，克服了RNN和CNN在处理长序列方面的弱点，突破了RNN不能并行计算的限制。基于Transformer的预训练模型（PTM）在语言、语音、视觉和强化学习等各种任务上取得了最高水平的性能，并在大语言模型（如GPT、BERT、LLaMA、ChatGLM等）的发展中发挥了重要作用。</p>
<p>Transformer模型主要由编码器（Encoder）堆栈和解码器（Decoder）堆栈组成，编码器的输入是原始输入序列通过嵌入层（Enbedding）的输出与序列元素位置编码（Position Encoding）的和，解码器的输入包括与原始输入序列对应的目标输出序列通过嵌入层的输出与序列元素位置编码的和，还包括来自编码器的输出。解码器的输出经过Linear层和Softmax层，输出目标序列。其结构示意图如 <a href="#fig-6.18" class="quarto-xref">图&nbsp;<span>6.18</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.18" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.18-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.18.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.18-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.18: Transformer结构示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>（1）嵌入</p>
<p>在深度学习中，嵌入是用一个低维稠密向量来表示一个对象，使得这个向量能够表达相应对象的某些特征，同时向量之间的距离能反应对象之间的相似性。因此，嵌入的数学本质是以独热编码为输入的单层全连接神经网络的权重，是一种表征学习（representative learning）。嵌入能够根据需要进行降维嵌入或升维嵌入，且信息不丢失。采用相应的嵌入方法，文字、图片、语音、视频、网络图、日期时间等就可以转化为神经网络能识别、能使用的信息。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.19" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.19-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.19.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.19-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.19: 嵌入原理示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>（2）位置编码</p>
<p>序列数据中词元的位置是非常重要的信息。CNN和RNN都具有捕获序列中词元位置信息的能力，但都是局部的位置关系，不能获得全局位置信息。Transformer通过位置编码来获得序列中词元的位置信息。位置编码也是一种嵌入方法，是位置信息的表示学习。位置编码可分为绝对位置编码、相对位置编码和旋转位置编码。绝对位置编码是将位置信息转换为向量，在与嵌入向量合并（相加或拼接）。相对位置编码在计算注意力分数时加入可学习的位置参数。旋转位置编码通过在注意力计算中引入一个旋转操作来实现位置编码，即将词元向量在复数空间中进行旋转，旋转的角度由位置决定，从而直接编码了位置信息的方向。与传统的绝对位置编码和相对位置编码相比，旋转位置编码具有更好的外推性，并在大语言模型中得到广泛应用。</p>
<p>根据位置向量是否随网络训练而改变，可分为固定位置编码和可学习位置编码。固定位置编码可以视为一种数据预处理方法，其中最经典的方法是采用正弦和余弦函数对词元绝对位置进行固定编码，生成与词元嵌入向量大小维度相同的位置编码向量，即对于输入矩阵中第i行、第2j列和2j+1列上的词元，用下列公式分别计算位置编码：</p>
<p><span id="eq-6.1"><span class="math display">
  PE_{pos,2i} = \text{sin}\frac{pos}{10000^{2i/d}}\\
  PE_{pos,2i+1} = \text{cos}\frac{pos}{10000^{2i/d}}\\
\tag{6.1}</span></span></p>
<p>上式中<span class="math inline">PE</span>是位置编码向量，<span class="math inline">pos</span>是词元在序列中的位置序号，<span class="math inline">d</span>是<span class="math inline">PE</span>的维度，与嵌入向量一致；<span class="math inline">i \in [0,d/2-1]</span>。</p>
<p>（3）编码器与自注意力</p>
<p>编码器采用自注意力（self-attention）机制计算输入序列的注意力分数，编码器的计算结构如 <a href="#fig-6.20" class="quarto-xref">图&nbsp;<span>6.20</span></a> 所示，其中最关键的是多头自注意力（MHA）模块。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.20" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.20-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.20.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.20-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.20: 编码器结构示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>在对人类注意力的研究中发现，影响注意力的因素包括自主性提示和非自主性提示，前者代表人的主观意志，而后者是对象本身的特征（如颜色、大小等）对注意力的影响。Transformer中的缩放点积注意力算法借鉴了人类注意力的研究结果，用<span class="math inline">Q</span>（<span class="math inline">Query</span>，查询）代表自主性提示强弱，用<span class="math inline">K</span>（<span class="math inline">Key</span>，键）代表非自主性提示的强弱，而<span class="math inline">V</span>（<span class="math inline">Vlaue</span>，值）则是与K对应的注意力，而<span class="math inline">Q</span>的介入会影响与<span class="math inline">K</span>对应的<span class="math inline">V</span>。为了获得更多子空间的信息，采用多个并行的自注意力计算模块，这就是所谓的“多头自注意力”，其计算流程如 <a href="#fig-6.21" class="quarto-xref">图&nbsp;<span>6.21</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.21" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.21-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.21.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.21-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.21: 多头自注意力模块的计算示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>在深度学习的研究中，已经有多种注意力机制被提出，其中点积自注意力是最初版本的Transformer中所采用的注意力机制。</p>
<p>（4）解码器与掩码自注意力</p>
<p>解码器与编码器略有不同。解码器模块包含2个多头自注意力模块，掩码多头自注意力（MMHA）模块和编码-解码多头自注意力（EDMHA）模块，其结构如图 <a href="#fig-6.22" class="quarto-xref">图&nbsp;<span>6.22</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.22" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.22-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.22.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.22-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.22: 解码器结构示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>为了避免解码器看到未来的输出，需要将目标序列“右移”（right shift）一位，再进行嵌入、位置编码并相加，作为解码器中MHA模块的输入，如 <a href="#fig-6.23" class="quarto-xref">图&nbsp;<span>6.23</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.23" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.23-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.23.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.23-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.23: 目标序列与解码器输入序列的右移关系
</figcaption>
</figure>
</div>
</div>
</div>
<p>MMHA模块计算<span class="math inline">Q</span>、<span class="math inline">K</span>、<span class="math inline">V</span>与编码器中MHA模块基本相同，区别是增加了对<span class="math inline">Q</span> 与<span class="math inline">K^T</span> 的乘积进行掩码操作，即与掩码算子按位相乘，如 <a href="#fig-6.24" class="quarto-xref">图&nbsp;<span>6.24</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.24" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.24-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.24.png" class="img-fluid figure-img" style="width:65.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.24-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.24: 掩码操作示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>掩码操作完成后，在进行缩放和Softmax运算，然后与<span class="math inline">V</span>相乘，得到掩码自注意力分数矩阵。将多个并联的掩码自注意力模块输出的注意力分数矩阵进行拼接，然后经过一个线性神经元层，就得到MMHA模块的最终输出。整个计算过程如 <a href="#fig-6.25" class="quarto-xref">图&nbsp;<span>6.25</span></a> 所示。</p>
<p>MMHA模块的输出经过求和与归一化层（LayerNorm，与BatchNorm不同）后，传给模块。完成矩阵输入掩码自注意力模块计算注意力分数，经过求和与归一化后，输入EDMHA模块，以计算<span class="math inline">Q</span>。同时，编EDMHA模块接收来自编码器的输出，以计算<span class="math inline">K</span>和<span class="math inline">V</span>，后续的计算流程与编码器中MHA模块相同。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.25" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.25-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.25.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.25-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.25: 掩码多头自注意力模块的计算流程示意图
</figcaption>
</figure>
</div>
</div>
</div>
<p>深度学习仍在快速发展，创新的深度神经网络模型不断被提出并得到日益完善，极大地推动着人工智能应用到人类生产、生活的各个领域。</p>
</section>
</section>
</section>
<section id="基于torch的深度学习建模" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="基于torch的深度学习建模"><span class="header-section-number">6.2</span> 基于torch的深度学习建模</h2>
<section id="torch包的简介与安装" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="torch包的简介与安装"><span class="header-section-number">6.2.1</span> torch包的简介与安装</h3>
<p>先安装torch包：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"torch"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>安装完成后，加载torch包：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(torch)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>第一次加载torch包，会自动执行<code>install_torch()</code>函数，该函数会从网上下载两个zip文件（libtorch和lantern）并安装。如果出现无法下载情况时，可以在将错误提示中的两个zip文件的网址复制到浏览器地址栏或下载软件来下载，然后用<code>Sys.setenv()</code>来分别设置TORCH_URL和LANTERN_URL两个环境变量，最后再运行<code>install_torch()</code>，即可完成torch的安装。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sys.setenv(TORCH_URL = "path/to/libtorch压缩包文件")</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 例如</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">TORCH_URL =</span> <span class="st">"F:/libtorch-win-shared-with-deps-2.0.1+cu117.zip"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Sys.setenv(LANTERN_URL = "path/to/lantern压缩包文件")</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 例如</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">LANTERN_URL =</span> <span class="st">"F:/lantern-0.12.0+cu117-win64.zip"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">install_torch</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>如果计算机上安装了支持CUDA的NVIDIA公司的显卡，且安装了相应的CUDA驱动，将提示安装GPU版本的torch，否则将安装CPU版本的torch。具体安装可参考https://torch.mlverse.org/docs/articles/installation。 安装好torch后，再继续安装torchvision、torchaudio和luz包。torch包采用了基于R6的面向对象编程系统，使用<code>$</code>符号调用对象的方法和属性。</p>
<p>torch包是基于Python中的机器学习框架——PyTorch移植而来，不依赖Python环境。大量PyTorch的Python代码可以很容易地改写为R代码在R中独立运行，同时支持GPU加速。torch包是一个完整的深度学习框架，包括张量及各种运算、自动求导、GPU加速支持、学习数据构造和加载以及各种深度神经网络模型搭建、训练、预测和评价。torchvision包提供了与计算机视觉相关的数据集、变换方法和若干预训练的模型（如AlexNet、ResNet、VGG、Inception、MobileNet等）。torchaudio包提供了与语音相关的数据集、处理工具和若干预训练的模型。luz包提供了类似Python中keras工具包的给你，是torch的高级接口，能够显著减少深度学习建模的代码量。</p>
</section>
<section id="创建dataset和dataloader" class="level3" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="创建dataset和dataloader"><span class="header-section-number">6.2.2</span> 创建Dataset和Dataloader</h3>
<p>深度学习建模首先要解决数据的构造和加载问题。在torch中，<code>dataset()</code>函数用于灵活地创建数据对象（Dataset），可以加载本地数据，也可以下载网络数据，还可以对数据进行预处理，重要的是，它能够将数据一项接一项（一项数据通常是列表结构，由一个输入张量和一个目标张量组成，类似于数据框对象中由特征变量和标签变量组成的一行数据）地传递给它的调用者——数据加载器对象（Dataloader），这是由<code>dataloader()</code>函数创建的。除了<code>dataset()</code>外，<code>tensor_dataset()</code>函数可以直接将张量对象快速转换为Dataset，而torchvision包中的<code>image_folder_dataset()</code>可以将分类存储在文件夹中的图片转换为Dataset。</p>
<p>深度学习中的张量（Tensor）是一种为快速计算而优化的多维数组，不同于数学和物理意义上的张量。torch包提供了完备的张量构造、运算及操作的各种函数。torch创建的张量也是对象，可以通过$来调用其方法和属性。<code>torch_tensor()</code>是最常用的构造张量的函数，<code>torch_ones()</code>、<code>torch_ones_like()</code>、<code>torch_zeros()</code>、<code>torch_rand()</code>、<code>torch_range()</code>等函数用于构造一些特殊的张量。张量运算和操作的函数如<code>torch_matmul()</code>、<code>torch_dot()</code>、<code>torch_cat()</code>等。</p>
<section id="创建dataset" class="level4" data-number="6.2.2.1">
<h4 data-number="6.2.2.1" class="anchored" data-anchor-id="创建dataset"><span class="header-section-number">6.2.2.1</span> 创建Dataset</h4>
<p>除了直接引用已经创建好的Dataset对象外，<code>dataset()</code>函数还可以从头开始定制Dataset对象。创建过程很简单，只需要实现三个方法：</p>
<p>（1）<code>initialize()</code>：包括但不限于对数据框对象、文件路径、网络下载链接URL等的引用，以及对数据的各种预处理。<br>
（2）<code>.getitem(i)</code>：逐项获取数据，传递给数据加载器对象。参数i通常都是用于确定底层数据结构中的起始位置。<br>
（3）<code>.length()</code>：通常只有一行代码，唯一目的是获取数据集中的数据项数。</p>
<p>根据需要，还可以包括自定义函数，如用来在<code>initialize()</code>中对数据进行预处理的自定义函数等。</p>
<p>通常，<code>dataset()</code>的使用模式如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ds <span class="ot">=</span> <span class="fu">dataset</span>()(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">initialize =</span> <span class="cf">function</span>(...) {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">.getitem =</span> <span class="cf">function</span>(index) {</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">.length =</span> <span class="cf">function</span>() {</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>要注意区分上面代码中的<code>()</code>和<code>{}</code>。 下面的代码将R包palmerpenguins中的penguins数据框转换为torch的Dataset对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(torch)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(palmerpenguins)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>penguins <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 344
Columns: 8
$ species           &lt;fct&gt; Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adel…
$ island            &lt;fct&gt; Torgersen, Torgersen, Torgersen, Torgersen, Torgerse…
$ bill_length_mm    &lt;dbl&gt; 39.1, 39.5, 40.3, NA, 36.7, 39.3, 38.9, 39.2, 34.1, …
$ bill_depth_mm     &lt;dbl&gt; 18.7, 17.4, 18.0, NA, 19.3, 20.6, 17.8, 19.6, 18.1, …
$ flipper_length_mm &lt;int&gt; 181, 186, 195, NA, 193, 190, 181, 195, 193, 190, 186…
$ body_mass_g       &lt;int&gt; 3750, 3800, 3250, NA, 3450, 3650, 3625, 4675, 3475, …
$ sex               &lt;fct&gt; male, female, female, NA, female, male, female, male…
$ year              &lt;int&gt; 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007…</code></pre>
</div>
</div>
<p>该数据集中有8个变量，第一列species是分类的标签变量（模型输出），其他列为特征变量（模型输入）。下面通过<code>dataset()</code>函数来选择bill_length_mm、bill_depth_mm、flipper_length_mm和body_mass_g四个特征变量来创建Dataset对象：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pgds <span class="ot">=</span> <span class="fu">dataset</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"pgds()"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">initialize =</span> <span class="cf">function</span>(df) {</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">=</span> <span class="fu">na.omit</span>(df)    <span class="co"># 删除包含缺失值的行</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>x <span class="ot">=</span> <span class="fu">torch_tensor</span>(<span class="fu">as.matrix</span>(df[, <span class="dv">3</span><span class="sc">:</span><span class="dv">6</span>]) )    <span class="co"># 选择特征变量并转换为张量</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>y <span class="ot">=</span> <span class="fu">torch_tensor</span>(    <span class="co"># 设定标签变量，先将因子变量转为数值变量，然后转换为张量</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.numeric</span>(df<span class="sc">$</span>species)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">$</span><span class="fu">to</span>(<span class="fu">torch_long</span>())    <span class="co"># 指定张量类型</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">.getitem =</span> <span class="cf">function</span>(i) {    <span class="co"># 获取参数i指定的数据项</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">x =</span> self<span class="sc">$</span>x[i, ], <span class="at">y =</span> self<span class="sc">$</span>y[i])</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">.length =</span> <span class="cf">function</span>() {    <span class="co"># 返回数据的项数</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dim</span>(self<span class="sc">$</span>x)[<span class="dv">1</span>]</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>实例化:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ds <span class="ot">=</span> <span class="fu">pgds</span>(penguins)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>ds<span class="sc">$</span><span class="fu">.length</span>()    <span class="co"># 等同于length(ds)</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 333</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ds<span class="sc">$</span><span class="fu">.getitem</span>(<span class="dv">2</span>)     <span class="co"># 等同于ds[2]</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$x
torch_tensor
   39.5000
   17.4000
  186.0000
 3800.0000
[ CPUFloatType{4} ]

$y
torch_tensor
1
[ CPULongType{} ]</code></pre>
</div>
</div>
<p>查看原始的数据：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>penguins[<span class="dv">2</span>, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span><span class="sc">:</span><span class="dv">6</span>)]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
  species bill_length_mm bill_depth_mm flipper_length_mm body_mass_g
  &lt;fct&gt;            &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt;
1 Adelie            39.5          17.4               186        3800</code></pre>
</div>
</div>
<p>比较发现，<code>dataset()</code>对penguins数据框进行了预处理（删除包含NA的行，将因子变量转换为数值变量），然后转换成张量，最后输出的形式为一个列表，包含一组特征张量和一列标签张量。<code>dataset_subset()</code>函数可以根据指定的索引从Dataset对象中获取子集，可用于创建训练集、验证集和测试集。</p>
<p>下面构造一个人工数据集，用于演示torch深度学习建模的步骤。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dim_in <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成n × dim_in的随机张量x，作为输入特征</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">torch_randn</span>(n, dim_in)    </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">1.3</span>, <span class="sc">-</span><span class="fl">2.2</span>, <span class="sc">-</span><span class="fl">0.7</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 根据x生成输出标签y</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> x<span class="sc">$</span><span class="fu">matmul</span>(coefs)<span class="sc">$</span><span class="fu">unsqueeze</span>(<span class="dv">2</span>) <span class="sc">+</span> <span class="fu">torch_randn</span>(n,<span class="dv">1</span>)    </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 转换为Dataset对象</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>ds <span class="ot">=</span> <span class="fu">tensor_dataset</span>(x, y)    </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 分割为训练集、验证集和测试集</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>tr_ids <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ds), <span class="at">size =</span> <span class="fu">floor</span>(<span class="fl">0.7</span> <span class="sc">*</span> <span class="fu">length</span>(ds)))</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>te_ids <span class="ot">=</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ds), tr_ids)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>va_ids <span class="ot">=</span> tr_ids[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(tr_ids), <span class="at">size =</span> <span class="fu">floor</span>(<span class="fl">0.3</span><span class="sc">*</span><span class="fu">length</span>(tr_ids)))]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>tr_ids <span class="ot">=</span> <span class="fu">setdiff</span>(tr_ids, va_ids)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 利用dataset_subset()函数从Dataset对象中获取子集</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>tr_ds <span class="ot">=</span> <span class="fu">dataset_subset</span>(ds, tr_ids)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>va_ds <span class="ot">=</span> <span class="fu">dataset_subset</span>(ds, va_ids)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>te_ds <span class="ot">=</span> <span class="fu">dataset_subset</span>(ds, te_ids)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="创建dataloader" class="level4" data-number="6.2.2.2">
<h4 data-number="6.2.2.2" class="anchored" data-anchor-id="创建dataloader"><span class="header-section-number">6.2.2.2</span> 创建Dataloader</h4>
<p>Dataloader负责按规定策略迭代加载Dataset中的数据项，包括按指定批大小（batch_size）、是否随机打乱数据排序再取batch（<code>shuffle</code>）等。<code>dataloader()</code>函数可以根据Dataset轻松创建Dataloader对象。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>tr_dl <span class="ot">=</span> tr_ds <span class="sc">%&gt;%</span> <span class="fu">dataloader</span>(<span class="at">batch_size =</span> <span class="dv">50</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>va_dl <span class="ot">=</span> va_ds <span class="sc">%&gt;%</span> <span class="fu">dataloader</span>(<span class="at">batch_size =</span> <span class="dv">50</span>, <span class="at">shuffle =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>te_dl <span class="ot">=</span> te_ds <span class="sc">%&gt;%</span> <span class="fu">dataloader</span>(<span class="at">batch_size =</span> <span class="dv">50</span>, <span class="at">shuffle =</span> <span class="cn">FALSE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>查看tr_dl的长度：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>tr_dl<span class="sc">$</span><span class="fu">.length</span>()    <span class="co"># 等同于length(tr_dl)</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 49</code></pre>
</div>
</div>
<p>Dataloader的长度是相应Dataset的长度与batch_size的商，不能整除时，结果加1。</p>
<p>获取第一批数据并查看输入特征与输出标签的维度：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>first_batch <span class="ot">=</span> tr_dl <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataloader_make_iter</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataloader_next</span>()</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(first_batch[[<span class="dv">1</span>]])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 50  4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(first_batch[[<span class="dv">2</span>]])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 50  1</code></pre>
</div>
</div>
</section>
</section>
<section id="搭建模型" class="level3" data-number="6.2.3">
<h3 data-number="6.2.3" class="anchored" data-anchor-id="搭建模型"><span class="header-section-number">6.2.3</span> 搭建模型</h3>
<p>torch支持定制开发深度学习模型，但这需要专业的知识和复杂的编程。深度学习应用者可以利用torch提供的构建模型的基本单位——以<code>nn_*</code>开头的各种模块（module），如同搭积木一样来搭建模型。这些模块包括各种神经元层（如<code>nn_linear()</code>、<code>nn_lstm()</code>、<code>nn_conv2d()</code>等）、各种激活函数（如<code>nn_relu()</code>、<code>nn_tanh()</code>等20多种）以及其他操作模块（如<code>nn_layer_norm()</code>、<code>nn_batch_norm2d()</code>、<code>nn_dropout()</code>、<code>nn_max_pool2d()</code>等），都是R6对象。此外，还有相应的一系列非对象的<code>nnf_*</code>函数，主要用于定制开发深度学习模型。</p>
<p>搭建模型主要有两种方式，使用<code>nn_module()</code>和使<code>用nn_sequential()</code>，前者用于构建复杂的模型，后者用于构建相对简单的模型。<code>nn_module()</code>通常包括<code>initialize</code>和<code>forward</code>两个自定义函数部分，前者用于定义模型中的模块及参数（其中可使用容器函数<code>nn_module_dict()</code>和<code>nn_module_list()</code>以及<code>nn_sequential()</code>）,后者用于定义计算流程。<code>nn_sequential()</code>是按计算流程顺序地列出模块，无需<code>initialize</code>和<code>forward</code>自定义函数。这里只介绍<code>nn_module()</code>搭建模型的方法。</p>
<p>针对前面构造的人工数据集，建立一个全连接神经网络，其中隐层包括2个线性神经元层nn_linear，激活函数采用<code>nn_relu</code>，输出层是1个没有激活函数的<code>nn_linear</code>。为了预防过拟合，在隐层的2个线性层后分别添加随机失活层<code>nn_dropout</code>。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>dim_fc1 <span class="ot">=</span> <span class="dv">32</span>    <span class="co"># 指定第一个线性层的神经元数</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>dim_fc2 <span class="ot">=</span> <span class="dv">32</span>    <span class="co"># 指定第二个线性层的神经元数</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>net <span class="ot">=</span> <span class="fu">nn_module</span>(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">initialize =</span> <span class="cf">function</span>(dim_in, dim_fc1, dim_fc2) {</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>fc1 <span class="ot">=</span> <span class="fu">nn_linear</span>(dim_in, dim_fc1)    <span class="co"># 输入维度和输出维度</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>drop1 <span class="ot">=</span> <span class="fu">nn_dropout</span>(<span class="at">p =</span> <span class="fl">0.7</span>)    <span class="co"># p为失活概率</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>fc2 <span class="ot">=</span> <span class="fu">nn_linear</span>(dim_fc1, dim_fc2)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>drop2 <span class="ot">=</span> <span class="fu">nn_dropout</span>(<span class="at">p =</span> <span class="fl">0.7</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>output <span class="ot">=</span> <span class="fu">nn_linear</span>(dim_fc2, <span class="dv">1</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">forward =</span> <span class="cf">function</span>(x) {</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">%&gt;%</span> </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span><span class="fu">fc1</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nnf_relu</span>() <span class="sc">%&gt;%</span>    <span class="co">#在forward中，激活函数一般用nnf_*</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span><span class="fu">drop1</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span><span class="fu">fc2</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nnf_relu</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span><span class="fu">drop2</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span><span class="fu">output</span>() </span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="模型训练" class="level3" data-number="6.2.4">
<h3 data-number="6.2.4" class="anchored" data-anchor-id="模型训练"><span class="header-section-number">6.2.4</span> 模型训练</h3>
<p>深度神经网络模型的训练是一个反复迭代的过程，包括以下四个步骤：</p>
<ul>
<li>网络正向计算输出；</li>
<li>根据损失函数计算网络输出的损失；</li>
<li>根据损失求导计算网络权重的梯度；</li>
<li>优化器根据梯度和相应策略反向传播来更新网络权重（即模型参数）。</li>
</ul>
<p>因此，模型训练前必须预先设置超参数：<strong>损失函数</strong>和<strong>优化器</strong>。torch预置了满足不同类型任务需要的<strong>损失函数</strong>，如 <a href="#tbl-6.1" class="quarto-xref">表&nbsp;<span>6.1</span></a> 所示。</p>
<div class="cell">
<div id="tbl-6.1" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-6.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;6.1: torch预置的损失函数
</figcaption>
<div aria-describedby="tbl-6.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<colgroup>
<col style="width: 51%">
<col style="width: 48%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">损失函数</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">nn_l1_loss()</td>
<td style="text-align: left;">计算平均绝对误差</td>
</tr>
<tr class="even">
<td style="text-align: left;">nn_mse_loss()</td>
<td style="text-align: left;">计算均方误差</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nn_smooth_l1_loss()</td>
<td style="text-align: left;">计算huber损失</td>
</tr>
<tr class="even">
<td style="text-align: left;">nn_soft_margin_loss()</td>
<td style="text-align: left;">计算二分类逻辑损失</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nn_nll_loss()</td>
<td style="text-align: left;">计算负对数似然损失</td>
</tr>
<tr class="even">
<td style="text-align: left;">nn_poisson_nll_loss()</td>
<td style="text-align: left;">计算输出服从泊松分布的负对数似然损失</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nn_kl_div_loss()</td>
<td style="text-align: left;">计算KL散度损失</td>
</tr>
<tr class="even">
<td style="text-align: left;">nn_cross_entropy_loss()</td>
<td style="text-align: left;">计算交叉熵损失</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nn_bce_with_logits_loss()</td>
<td style="text-align: left;">计算结合sigmoid层的二分类交叉熵损失</td>
</tr>
<tr class="even">
<td style="text-align: left;">nn_margin_ranking_loss()</td>
<td style="text-align: left;">计算边界排序损失</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nn_hinge_embedding_loss()</td>
<td style="text-align: left;">根据向量距离计算损失</td>
</tr>
<tr class="even">
<td style="text-align: left;">nn_multi_margin_loss()</td>
<td style="text-align: left;">计算多分类合页损失</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nn_multilabel_margin_loss()</td>
<td style="text-align: left;">计算多类多分类合页损失</td>
</tr>
<tr class="even">
<td style="text-align: left;">nn_ctc_loss()</td>
<td style="text-align: left;">计算连结主义时间损失</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nn_bce_loss()</td>
<td style="text-align: left;">计算二分类交叉熵损失</td>
</tr>
<tr class="even">
<td style="text-align: left;">nn_multilabel_soft_margin_loss()</td>
<td style="text-align: left;">基于最大熵计算多标签一对多损失</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nn_cosine_embedding_loss()</td>
<td style="text-align: left;">基于余弦距离计算损失</td>
</tr>
<tr class="even">
<td style="text-align: left;">nn_triplet_margin_loss()</td>
<td style="text-align: left;">计算三元边界损失</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nn_triplet_margin_with_distance_loss()</td>
<td style="text-align: left;">基于距离计算三元边界损失</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p><strong>优化器</strong>是用来更新神经网络权重（模型参数）以实现损失最小化的算法，其性能直接影响网络训练的收敛速度，<a href="#tbl-6.2" class="quarto-xref">表&nbsp;<span>6.2</span></a> 列出了torch预置的优化算法。torch还允许用户自定义损失函数和优化算法。</p>
<div class="cell">
<div id="tbl-6.2" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-6.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;6.2: torch预置的优化算法
</figcaption>
<div aria-describedby="tbl-6.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">优化算法</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">optim_adadelta()</td>
<td style="text-align: left;">学习率平滑更新的adagrad算法</td>
</tr>
<tr class="even">
<td style="text-align: left;">optim_adagrad()</td>
<td style="text-align: left;">学习率适自应梯度算法</td>
</tr>
<tr class="odd">
<td style="text-align: left;">optim_adam()</td>
<td style="text-align: left;">自适应动量估计算法</td>
</tr>
<tr class="even">
<td style="text-align: left;">optim_adamw()</td>
<td style="text-align: left;">引入权重衰减的adam算法</td>
</tr>
<tr class="odd">
<td style="text-align: left;">optim_asgd()</td>
<td style="text-align: left;">平均梯度随机下降算法</td>
</tr>
<tr class="even">
<td style="text-align: left;">optim_lbfgs()</td>
<td style="text-align: left;">有限内存BFGS算法</td>
</tr>
<tr class="odd">
<td style="text-align: left;">optim_rmsprop()</td>
<td style="text-align: left;">均方根传播算法</td>
</tr>
<tr class="even">
<td style="text-align: left;">optim_rprop()</td>
<td style="text-align: left;">弹性反向传播算法</td>
</tr>
<tr class="odd">
<td style="text-align: left;">optim_sgd()</td>
<td style="text-align: left;">随机梯度下降算法</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>在网络训练过程中，为了预防过拟合，也如传统机器学习建模一样，通常会采用提前停止技术（Early stopping）。在luz包中提供了很多形如<code>luz_callback_*()</code>的回调（call back）函数，用于动态地改变训练过程，其中<code>luz_callback_early_stopping()</code>用于在满足条件是提前停止训练以避免过拟合。<code>luz_callback_lr_scheduler()</code>是另一个有用的回调，可以在训练过程中动态地调整学习率。</p>
<p>使用luz来训练网络，可以让用户避免编写繁琐的基于coro包的循环程序，也无需考虑cpu和cuda计算设备的切换，只需利用<code>setup()</code>函数设置训练所需的超参数，如损失函数和优化器等。如果网络是可配置的，可通过<code>set_hparams()</code>函数设置网络配置超参数，如各神经元层的维度。如果需要设置优化器的超参数，可利用<code>set_opt_hparams()</code>函数来设置。最后，luz通过泛型函数<code>fit()</code>传递训练数据和指定迭代轮数（epochs）即开始网络训练。一个迭代轮次是指训练样本中全部数据按Dataloader规定的策略都输入网络参与一次训练，即完成前述的四个计算步骤。干预训练过程的回调也必须在<code>fit()</code>中传入，同时还可以通过参数verbose设置是否将训练过程中的信息输出到控制台。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(luz)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>fitted <span class="ot">&lt;-</span> net <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setup</span>(    <span class="co"># 设置网络训练超参数</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimizer =</span> optim_rmsprop,    <span class="co"># 设置优化器</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">loss =</span> <span class="fu">nn_mse_loss</span>(),    <span class="co"># 设置损失函数</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">luz_metric_mae</span>()    <span class="co"># 指定额外的损失测度</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_hparams</span>(    <span class="co"># 设置网络配置超参数</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">dim_in =</span> dim_in, </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">dim_fc1 =</span> dim_fc1, </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">dim_fc2 =</span> dim_fc2</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_opt_hparams</span>(<span class="at">lr =</span> <span class="fl">0.001</span>) <span class="sc">%&gt;%</span>    <span class="co"># 设置优化器超参数</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(tr_dl,    <span class="co"># 传递训练数据</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">valid_data =</span> va_dl,    <span class="co"># 传递验证数据</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">epochs =</span> <span class="dv">200</span>,    <span class="co"># 设置迭代轮次</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">callbacks =</span> <span class="fu">list</span>(    <span class="co"># 设置回调函数</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">luz_callback_early_stopping</span>(<span class="at">patience =</span> <span class="dv">10</span>)),    <span class="co"># 提前停止回调</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> F    <span class="co"># 禁止信息输出到控制台</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>fit()</code>返回的对象可以用<code>luz_save()</code>保存（保存后的模型文件可以通过<code>luz_load()</code>函数加载），可以用泛型函数<code>print()</code>输出信息，可以用泛型函数<code>plot()</code>可视化。</p>
<p>保存模型：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 保存训练好的模型</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">luz_save</span>(fitted, <span class="st">"./model/fitted-model.model"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>打印模型信息：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看模型信息</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fitted)    <span class="co"># 也可以直接输入fitted</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A `luz_module_fitted`
── Time ────────────────────────────────────────────────────────────────────────
• Total time: 29.6s
• Avg time per training epoch: 427ms

── Results ─────────────────────────────────────────────────────────────────────
Metrics observed in the last epoch.

ℹ Training:
loss: 2.3379
mae: 1.1666

── Model ───────────────────────────────────────────────────────────────────────
An `nn_module` containing 1,249 parameters.

── Modules ─────────────────────────────────────────────────────────────────────
• fc1: &lt;nn_linear&gt; #160 parameters
• drop1: &lt;nn_dropout&gt; #0 parameters
• fc2: &lt;nn_linear&gt; #1,056 parameters
• drop2: &lt;nn_dropout&gt; #0 parameters
• output: &lt;nn_linear&gt; #33 parameters</code></pre>
</div>
</div>
<p>可视化模型训练过程中拟合误差和验证误差：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 可视化训练过程</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fitted)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-6.26" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.26-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH6_files/figure-html/fig-6.26-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.26-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.26: 深度学习模型训练过程中拟合误差和验证误差的可视化
</figcaption>
</figure>
</div>
</div>
</div>
<p>本例中提前停止回调设置了patience = 10，意味着验证误差连续10次迭代没有下降，则提前停止训练。</p>
</section>
<section id="模型预测与性能评价" class="level3" data-number="6.2.5">
<h3 data-number="6.2.5" class="anchored" data-anchor-id="模型预测与性能评价"><span class="header-section-number">6.2.5</span> 模型预测与性能评价</h3>
<p>利用训练好的深度学习模型对新的输入特征进行预测，给出输出标签，即推理（inference）。推理阶段不允许更新网络权重，luz包通过泛型函数<code>predict()</code>函数自动处理这个问题，无需用户处理。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> fitted <span class="sc">%&gt;%</span> <span class="fu">predict</span>(te_dl) </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>需要注意，返回的结果是tensor对象，如果要在R中进行处理，需要考虑将tensor从”cuda”设备上转移到”cpu”（可通过函数<code>cuda_is_available()</code>来判断cuda是否可用），然后用<code>as.numeric()</code>函数进行转换：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> <span class="fu">as.numeric</span>(pred<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> <span class="st">"cpu"</span>))  </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>利用张量对象<code>$to()</code>方法更改device参数值即可改变张量存储的设备。</p>
<p>下面利用ggplot2来可视化测试集上的预测标签和实际标签：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">truth =</span> <span class="fu">as.numeric</span>(te_ds<span class="sc">$</span>dataset<span class="sc">$</span>tensors[[<span class="dv">2</span>]][te_ids]),</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">prediction =</span> <span class="fu">as.numeric</span>(pred<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> <span class="st">"cpu"</span>)),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(truth)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>测试集te_ds中保存了全部数据，而非只是测试集数据，因此需要用索引te_ids来指定测试集数据。本例中pred保存在”cuda”设备上，因此需要转移到”cpu”设备，然后再转换数据类型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 可视化前100个数据点</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df[<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,]) <span class="sc">+</span>  </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> id, <span class="at">y =</span> truth, <span class="at">color =</span> <span class="st">"blue"</span>)) <span class="sc">+</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> id, <span class="at">y =</span> prediction, <span class="at">color =</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"values"</span>) <span class="sc">+</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="cn">NULL</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>),</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"truth"</span>, <span class="st">"prediction"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-6.27" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.27-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH6_files/figure-html/fig-6.27-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.27-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.27: 测试集预测结果的可视化
</figcaption>
</figure>
</div>
</div>
</div>
<p>luz提供的<code>evaluate()</code>函数可以定量计算训练好的模型在测试集上的性能指标：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>fitted <span class="sc">%&gt;%</span> <span class="fu">evaluate</span>(te_dl)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A `luz_module_evaluation`
── Results ─────────────────────────────────────────────────────────────────────
loss: 1.3815
mae: 0.9274</code></pre>
</div>
</div>
<p>其中loss是<code>setup()</code>函数中参数loss指定的损失函数计算的，而mae则是<code>setup()</code>函数中参数metrics指定的性能测度函数<code>luz_metric_mae()</code>计算的。</p>
<p>模型经过严谨的性能评估并确认符合要求后，即可部署应用。关于模型部署的知识，可参考学习网址<a href="https://dataxujing.github.io/R_online/index.html">徐静, 2018. R语言模型部署实战</a>和<a href="https://cosx.org/2018/12/model-deployment-in-action-with-r/">周震宇, 2018. R 语言实战之模型部署</a>提供的相关内容。</p>
</section>
</section>
<section id="sec-dl-example" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="sec-dl-example"><span class="header-section-number">6.3</span> 深度学习建模案例</h2>
<section id="表格数据案例" class="level3" data-number="6.3.1">
<h3 data-number="6.3.1" class="anchored" data-anchor-id="表格数据案例"><span class="header-section-number">6.3.1</span> 表格数据案例</h3>
<p>本案例数据集来自UCI机器学习数据库(https://archive.ics.uci.edu/dataset/45/heart+disease)，下载heart+disease.zip压缩包文件，解压后，将其中processed.cleveland.data文件改名为heart.csv，保存于项目文件夹的data目录中。该数据集包含303个样例和14个变量，前13个变量为输入特征，最后1个变量为输出标签，即以0到4的整数来区分心脏病，其中0表示没有心脏病。13个输入特征中有两个存在缺失值，缺失数量较少。该数据集属于分类任务，输入特征分为分类变量和数值变量两类。</p>
<p>本案例模型先采用嵌入层学习分类变量的表示，然后与数值变量一起输入由三个线性层构成的FCNN，前两个线性层的激活函数采用ReLU，最后一个线性层无激活函数。训练时，前两个线性层引入dropout机制。</p>
<p>先加载需要的工具包：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(torch)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(luz)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>读取数据并添加列名：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>heart_df <span class="ot">=</span> <span class="fu">read_csv</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"./data/heart.csv"</span>,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="fu">c</span>(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>,  <span class="co"># 年龄</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sex"</span>,  <span class="co"># 性别，1为男性，0为女性</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 胸痛类型，1为典型心绞痛，2为不典型心绞痛，3为非绞痛疼痛，4为无症状</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pain_type"</span>, </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"resting_blood_pressure"</span>,  <span class="co"># 静息血压，mm Hg</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"chol"</span>,  <span class="co"># 血清胆固醇，mg/dl</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fasting_blood_sugar"</span>,   <span class="co"># 空腹血糖，&gt;120mg/dl为1，否则为0</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rest_ecg"</span>,   <span class="co"># 静息心电图，0为正常，1为ST-T波异常，2为可能或明确的左心室肥厚</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_heart_rate"</span>,   <span class="co"># 运动时最大心率</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ex_induced_angina"</span>,  <span class="co"># 运动诱发心绞痛，1为是，0不是</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"old_peak"</span>,   <span class="co"># 运动相对于休息引起的ST压低</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"slope"</span>,   <span class="co"># 峰值运动ST段的斜率，1为向上倾斜，2为平坦，3为向下倾斜</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ca"</span>,   <span class="co"># 主要血管数目，0~3</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3 = normal; 6 = fixed defect; 7 = reversible defect</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"thal"</span>,   <span class="co"># 地中海贫血，0为正常，6为固定缺陷，7为可逆转缺陷</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1-4 = yes; 0 = no</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"heart_disease"</span>   <span class="co"># 心脏病诊断，0不是，1~4为是</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="st">"?"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 303 Columns: 14
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (14): age, sex, pain_type, resting_blood_pressure, chol, fasting_blood_s...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>查询缺失值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span>(<span class="fu">is.na</span>(heart_df), <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     row col
[1,] 167  12
[2,] 193  12
[3,] 288  12
[4,] 303  12
[5,]  88  13
[6,] 267  13</code></pre>
</div>
</div>
<p>结果表明第12（ca）和第13列（thal）分别有4个和2个缺失值。考虑缺失值较少，将其作为一个额外是因子水平。</p>
<p>NA很少，可转化为一个额外的因子水平。因子变量可以采用独热编码转换为数值变量：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(heart_df<span class="sc">$</span>slope)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3 2 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nnf_one_hot</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">torch_tensor</span>(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    heart_df<span class="sc">$</span>slope,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtype =</span> <span class="fu">torch_long</span>()</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">5</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch_tensor
 0  0  1
 0  1  0
 0  1  0
 0  0  1
 1  0  0
... [the output was truncated (use n=-1 to disable)]
[ CPULongType{303,3} ]</code></pre>
</div>
</div>
<p>创建Dataset：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建Dataset</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>heart_dataset <span class="ot">&lt;-</span> <span class="fu">dataset</span>(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">initialize =</span> <span class="cf">function</span>(df) {</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>x_cat <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">get_categorical</span>(df)  <span class="co"># 获取分类变量</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>x_num <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">get_numerical</span>(df)    <span class="co"># 获取数值变量</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>y <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">get_target</span>(df)           <span class="co"># 获取目标变量</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">.getitem =</span> <span class="cf">function</span>(i) {</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    x_cat <span class="ot">&lt;-</span> self<span class="sc">$</span>x_cat[i, ]</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    x_num <span class="ot">&lt;-</span> self<span class="sc">$</span>x_num[i, ]</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> self<span class="sc">$</span>y[i]</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">list</span>(x_cat, x_num), <span class="at">y =</span> y)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">.length =</span> <span class="cf">function</span>() {</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dim</span>(self<span class="sc">$</span>y)[<span class="dv">1</span>]</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">get_target =</span> <span class="cf">function</span>(df) {</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    heart_disease <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df<span class="sc">$</span>heart_disease <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    heart_disease</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">get_numerical =</span> <span class="cf">function</span>(df) {</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">%&gt;%</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>(<span class="fu">c</span>(heart_disease, pain_type,</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>                 rest_ecg, slope, ca, thal))) <span class="sc">%&gt;%</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), </span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>                    <span class="at">.fns =</span> scale)) <span class="sc">%&gt;%</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.matrix</span>()</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">get_categorical =</span> <span class="cf">function</span>(df) {</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>ca <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(df<span class="sc">$</span>ca), <span class="dv">999</span>, df<span class="sc">$</span>ca)  <span class="co"># 将NA转换为数值999</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>thal <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(df<span class="sc">$</span>thal), <span class="dv">999</span>, df<span class="sc">$</span>thal)</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">%&gt;%</span></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(pain_type, rest_ecg, slope, ca, thal) <span class="sc">%&gt;%</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), </span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>                    <span class="at">.fns =</span> <span class="fu">compose</span>(as.integer, as.factor))) <span class="sc">%&gt;%</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.matrix</span>()</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>实例化Dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>ds <span class="ot">=</span> <span class="fu">heart_dataset</span>(heart_df)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>创建DataLoader:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(heart_df), <span class="at">size =</span> <span class="fu">floor</span>(<span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(heart_df)))</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>valid_indices <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(heart_df), train_indices)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>train_ds <span class="ot">&lt;-</span> <span class="fu">dataset_subset</span>(ds, train_indices)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>train_dl <span class="ot">&lt;-</span> train_ds <span class="sc">%&gt;%</span> </span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataloader</span>(<span class="at">batch_size =</span> <span class="dv">256</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>valid_ds <span class="ot">&lt;-</span> <span class="fu">dataset_subset</span>(ds, valid_indices)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>valid_dl <span class="ot">&lt;-</span> valid_ds <span class="sc">%&gt;%</span> </span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataloader</span>(<span class="at">batch_size =</span> <span class="dv">256</span>, <span class="at">shuffle =</span> <span class="cn">FALSE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>构建分类变量的嵌入层：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>ebd_mod <span class="ot">&lt;-</span> <span class="fu">nn_module</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">initialize =</span> <span class="cf">function</span>(cardinalities, embedding_dim) {</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>embeddings <span class="ot">&lt;-</span> <span class="fu">nn_module_list</span>(</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lapply</span>(                            <span class="co"># 对每个分类变量分别进行嵌入表示</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>        cardinalities,                   <span class="co"># 分类变量的因子水平数</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x) {</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>          <span class="fu">nn_embedding</span>(</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">num_embeddings =</span> x, <span class="at">embedding_dim =</span> embedding_dim</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">forward =</span> <span class="cf">function</span>(x) {</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    embedded <span class="ot">&lt;-</span> <span class="fu">vector</span>(</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">mode =</span> <span class="st">"list"</span>,</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">length =</span> <span class="fu">length</span>(self<span class="sc">$</span>embeddings)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(self<span class="sc">$</span>embeddings)) {</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>      embedded[[i]] <span class="ot">&lt;-</span> self<span class="sc">$</span>embeddings[[i]](x[, i])</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">torch_cat</span>(embedded, <span class="at">dim =</span> <span class="dv">2</span>)         <span class="co"># 按第二个维度（列）拼接嵌入向量</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>搭建模型：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">nn_module</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">initialize =</span> <span class="cf">function</span>(cardinalities,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                        num_numerical,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                        embedding_dim,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                        fc1_dim,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                        fc2_dim) {</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>embedder <span class="ot">&lt;-</span> <span class="fu">ebd_mod</span>(</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>      cardinalities,  <span class="co"># 分类变量的因子水平数</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>      embedding_dim   <span class="co"># 嵌入向量的维数</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>fc1 <span class="ot">&lt;-</span> <span class="fu">nn_linear</span>(</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>      embedding_dim <span class="sc">*</span> <span class="fu">length</span>(cardinalities) <span class="sc">+</span> num_numerical,  <span class="co"># 输入特征数</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>      fc1_dim         <span class="co"># 输出特征数</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>drop1 <span class="ot">&lt;-</span> <span class="fu">nn_dropout</span>(<span class="at">p =</span> <span class="fl">0.7</span>)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>fc2 <span class="ot">&lt;-</span> <span class="fu">nn_linear</span>(fc1_dim, fc2_dim)</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>drop2 <span class="ot">&lt;-</span> <span class="fu">nn_dropout</span>(<span class="at">p =</span> <span class="fl">0.7</span>)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>output <span class="ot">&lt;-</span> <span class="fu">nn_linear</span>(fc2_dim, <span class="dv">1</span>)</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">forward =</span> <span class="cf">function</span>(x) {</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    embedded <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">embedder</span>(x[[<span class="dv">1</span>]])</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    all <span class="ot">&lt;-</span> <span class="fu">torch_cat</span>(<span class="fu">list</span>(embedded, x[[<span class="dv">2</span>]]), <span class="at">dim =</span> <span class="dv">2</span>)</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>    score <span class="ot">&lt;-</span> all <span class="sc">%&gt;%</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span><span class="fu">fc1</span>() <span class="sc">%&gt;%</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nnf_relu</span>() <span class="sc">%&gt;%</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span><span class="fu">drop1</span>() <span class="sc">%&gt;%</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span><span class="fu">fc2</span>() <span class="sc">%&gt;%</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nnf_relu</span>() <span class="sc">%&gt;%</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span><span class="fu">drop2</span>() <span class="sc">%&gt;%</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span><span class="fu">output</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nnf_hardsigmoid</span>()</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>    score[, <span class="dv">1</span>]</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>计算和设定必需的参数值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 获得所有分类变量的因子水平数</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>cardinalities <span class="ot">&lt;-</span> heart_df <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pain_type, rest_ecg, slope, ca, thal) <span class="sc">%&gt;%</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="at">.fns =</span> as.factor)) <span class="sc">%&gt;%</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="at">.fns =</span> nlevels))</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ca和thal中因子水平数因NA而增加1</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>cardinalities <span class="ot">&lt;-</span> cardinalities <span class="sc">+</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>) </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 数值变量的数量</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>num_numerical <span class="ot">&lt;-</span> <span class="fu">ncol</span>(heart_df) <span class="sc">-</span> <span class="fu">length</span>(cardinalities) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>embedding_dim <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>fc1_dim <span class="ot">&lt;-</span> <span class="dv">64</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>fc2_dim <span class="ot">&lt;-</span> <span class="dv">64</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>训练模型：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>fitted <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setup</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimizer =</span> optim_adam,                              <span class="co"># 设置优化器</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">loss =</span> <span class="fu">nn_bce_with_logits_loss</span>(),                    <span class="co"># 设置损失函数</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">luz_metric_binary_accuracy_with_logits</span>()   <span class="co"># 设置额外测度</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_hparams</span>(                                    <span class="co"># 设置超参数</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cardinalities =</span> cardinalities,</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">num_numerical =</span> num_numerical,</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">embedding_dim =</span> embedding_dim,</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">fc1_dim =</span> fc1_dim, fc2_dim</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_opt_hparams</span>(<span class="at">lr =</span> <span class="fl">0.001</span>) <span class="sc">%&gt;%</span>                 <span class="co"># 设置优化器超参数</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(train_dl,</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">epochs =</span> <span class="dv">300</span>,</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">valid_data =</span> valid_dl,</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">callbacks =</span> <span class="fu">list</span>(</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">luz_callback_early_stopping</span>(<span class="at">patience =</span> <span class="dv">5</span>)   <span class="co"># 设置提前停止</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>对模型训练过程中的拟合性能和验证性能指标进行可视化，结果见 <a href="#fig-6.28" class="quarto-xref">图&nbsp;<span>6.28</span></a>。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>fitted <span class="sc">%&gt;%</span> <span class="fu">plot</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-6.28" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.28-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH6_files/figure-html/fig-6.28-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.28-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.28: 训练过程拟合误差与验证误差的可视化
</figcaption>
</figure>
</div>
</div>
</div>
<p>由于没有划分预测集，只能在验证集上评估模型性能：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 用模型对验证集进行预测</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> fitted <span class="sc">%&gt;%</span> <span class="fu">predict</span>(valid_dl) <span class="sc">%&gt;%</span> <span class="fu">nnf_sigmoid</span>() <span class="sc">%&gt;%</span> <span class="fu">torch_round</span>()</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 对实际标签和预测标签建立混淆矩阵并计算相关性能指标</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>truth <span class="ot">=</span> <span class="fu">as.factor</span>(ds<span class="sc">$</span>y[valid_ds<span class="sc">$</span>indices])</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> <span class="fu">as.integer</span>(pred<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> <span class="st">"cpu"</span>)) <span class="sc">%&gt;%</span> <span class="fu">as.factor</span>()</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>mlr3measures<span class="sc">::</span><span class="fu">confusion_matrix</span>(<span class="at">truth =</span> truth, </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">response =</span> prediction, <span class="at">positive =</span> <span class="st">"1"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="do">##         truth</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="do">## response  1  0</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="do">##        1 23  8</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="do">##        0  2 28</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="do">## acc :  0.8361; ce  :  0.1639; dor :  40.2500; f1  :  0.8214 </span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="do">## fdr :  0.2581; fnr :  0.0800; fomr:  0.0667; fpr :  0.2222 </span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="do">## mcc :  0.6864; npv :  0.9333; ppv :  0.7419; tnr :  0.7778 </span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="do">## tpr :  0.9200 </span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>结果表明，验证集上25个心脏病病例有2个预测错误，36个非心脏病病例有8个预测错误，预测准确率为85.25%，TPR为92.00%，TNR为77.78%，F1-Score约为0.82。</p>
</section>
<section id="时间序列数据案例" class="level3" data-number="6.3.2">
<h3 data-number="6.3.2" class="anchored" data-anchor-id="时间序列数据案例"><span class="header-section-number">6.3.2</span> 时间序列数据案例</h3>
<p>本案例数据集为tsibble工具包预置的澳大利亚维多利亚半小时电力需求数据（vic_elec），时间跨度为2012年1月1日0:00时至2014年12月31日23:30时，每30分钟一个数据点。变量包括Time、Demand、Temperature、Date和Holiday。为了减少冗余信息，按小时合并Demand数据。</p>
<p>本案例采用LSTM模型，根据过去168个时点的Demand数据（7天×24小时）预测下一个时点Demand数据。</p>
<p>加载必需的工具包：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tsibble) </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(feasts) </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tsibbledata) </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(torch)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(luz)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>读取数据并选择部分数据进行可视化：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">=</span> vic_elec</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co">#选择2014年1月和2月的数据进行可视化：</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>ts <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">year</span>(Time) <span class="sc">==</span> <span class="dv">2014</span> <span class="sc">&amp;</span> (<span class="fu">month</span>(Time) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(<span class="at">.vars =</span> Demand) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-6.29" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.29-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH6_files/figure-html/fig-6.29-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.29-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.29: 2014年1-2月的Demand数据
</figcaption>
</figure>
</div>
</div>
</div>
<p>创建Dataset：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>demand_ds <span class="ot">&lt;-</span> <span class="fu">dataset</span>(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">initialize =</span> <span class="cf">function</span>(x, n_timesteps, <span class="at">sample_frac =</span> <span class="dv">1</span>) {</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>n_timesteps <span class="ot">&lt;-</span> n_timesteps</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">torch_tensor</span>((x <span class="sc">-</span> train_mean) <span class="sc">/</span> train_sd)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">length</span>(self<span class="sc">$</span>x) <span class="sc">-</span> self<span class="sc">$</span>n_timesteps</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>starts <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample.int</span>(</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> n,</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> n <span class="sc">*</span> sample_frac</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">.getitem =</span> <span class="cf">function</span>(i) {</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    start <span class="ot">&lt;-</span> self<span class="sc">$</span>starts[i]</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    end <span class="ot">&lt;-</span> start <span class="sc">+</span> self<span class="sc">$</span>n_timesteps <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> self<span class="sc">$</span>x[start<span class="sc">:</span>end],</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> self<span class="sc">$</span>x[end <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">.length =</span> <span class="cf">function</span>() {</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(self<span class="sc">$</span>starts)</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>按小时汇总数据（即将半小时数据汇总为小时数据）:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>demand_hourly <span class="ot">&lt;-</span> ts <span class="sc">%&gt;%</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">index_by</span>(<span class="at">Hour =</span> <span class="fu">floor_date</span>(Time, <span class="st">"hour"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Demand =</span> <span class="fu">sum</span>(Demand))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>分别建立训练集、验证集和测试集：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>demand_train <span class="ot">&lt;-</span> demand_hourly <span class="sc">%&gt;%</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(Hour) <span class="sc">==</span> <span class="dv">2012</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Demand) <span class="sc">%&gt;%</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>demand_valid <span class="ot">&lt;-</span> demand_hourly <span class="sc">%&gt;%</span> </span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(Hour) <span class="sc">==</span> <span class="dv">2013</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Demand) <span class="sc">%&gt;%</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>demand_test <span class="ot">&lt;-</span> demand_hourly <span class="sc">%&gt;%</span> </span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(Hour) <span class="sc">==</span> <span class="dv">2014</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Demand) <span class="sc">%&gt;%</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>计算训练集均值和标准差，用于输入数据的标准化：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>train_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(demand_train)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>train_sd <span class="ot">&lt;-</span> <span class="fu">sd</span>(demand_train)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>指定输入时间步：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>n_timesteps <span class="ot">&lt;-</span> <span class="dv">7</span> <span class="sc">*</span> <span class="dv">24</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>将训练集、验证集和预测集数据实例化为Dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>train_ds <span class="ot">&lt;-</span> <span class="fu">demand_ds</span>(demand_train, n_timesteps)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>valid_ds <span class="ot">&lt;-</span> <span class="fu">demand_ds</span>(demand_valid, n_timesteps)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>test_ds <span class="ot">&lt;-</span> <span class="fu">demand_ds</span>(demand_test, n_timesteps)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>查看输入与输出的维度：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(train_ds[<span class="dv">1</span>]<span class="sc">$</span>x)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 168   1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(train_ds[<span class="dv">1</span>]<span class="sc">$</span>y)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>创建DataLoader：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">&lt;-</span> <span class="dv">128</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>train_dl <span class="ot">&lt;-</span> train_ds <span class="sc">%&gt;%</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataloader</span>(<span class="at">batch_size =</span> batch_size, <span class="at">shuffle =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>valid_dl <span class="ot">&lt;-</span> valid_ds <span class="sc">%&gt;%</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataloader</span>(<span class="at">batch_size =</span> batch_size)</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>test_dl <span class="ot">&lt;-</span> test_ds <span class="sc">%&gt;%</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataloader</span>(<span class="at">batch_size =</span> <span class="fu">length</span>(test_ds))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>查看DataLoader的维度：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> train_dl <span class="sc">%&gt;%</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataloader_make_iter</span>() <span class="sc">%&gt;%</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataloader_next</span>()</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(b<span class="sc">$</span>x)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 128 168   1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(b<span class="sc">$</span>y)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 128   1</code></pre>
</div>
</div>
<p>搭建模型：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">nn_module</span>(</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">initialize =</span> <span class="cf">function</span>(input_size,</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>                        hidden_size,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">dropout =</span> <span class="fl">0.2</span>,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">num_layers =</span> <span class="dv">1</span>,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">rec_dropout =</span> <span class="dv">0</span>) {</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>num_layers <span class="ot">&lt;-</span> num_layers</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>rnn <span class="ot">&lt;-</span> <span class="fu">nn_lstm</span>(</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">input_size =</span> input_size,</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">hidden_size =</span> hidden_size,</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">num_layers =</span> num_layers,</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">dropout =</span> rec_dropout,</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">batch_first =</span> <span class="cn">TRUE</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>dropout <span class="ot">&lt;-</span> <span class="fu">nn_dropout</span>(dropout)</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>    self<span class="sc">$</span>output <span class="ot">&lt;-</span> <span class="fu">nn_linear</span>(hidden_size, <span class="dv">1</span>)</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">forward =</span> <span class="cf">function</span>(x) {</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>    (x <span class="sc">%&gt;%</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span><span class="fu">rnn</span>())[[<span class="dv">1</span>]][, <span class="fu">dim</span>(x)[<span class="dv">2</span>], ] <span class="sc">%&gt;%</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span><span class="fu">dropout</span>() <span class="sc">%&gt;%</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span><span class="fu">output</span>()</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>设定模型超参数：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>input_size <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>hidden_size <span class="ot">&lt;-</span> <span class="dv">32</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>num_layers <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>rec_dropout <span class="ot">&lt;-</span> <span class="fl">0.2</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>设定模型超参数：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setup</span>(<span class="at">optimizer =</span> optim_adam, <span class="at">loss =</span> <span class="fu">nn_mse_loss</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_hparams</span>(</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">input_size =</span> input_size,</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">hidden_size =</span> hidden_size,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">num_layers =</span> num_layers,</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">rec_dropout =</span> rec_dropout</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>学习速率是更新神经网络权重中的一个重要超参数，其大小直接影响权重更新，从而影响训练速度。在训练过程中动态地更新学习速率是一个加速训练的重要的技巧，而这可以通过绘制学习速率-损失曲线来确定学习速率的动态调整范围。下面的代码利用luz包中<code>lr_finder()</code>函数来收集学习速率与损失数据并绘制图形.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>rates_and_losses <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lr_finder</span>(train_dl, <span class="at">start_lr =</span> <span class="fl">1e-3</span>, <span class="at">end_lr =</span> <span class="dv">1</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>rates_and_losses <span class="sc">%&gt;%</span> <span class="fu">plot</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-6.30" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.30-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH6_files/figure-html/fig-6.30-1.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.30-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.30: 损失随学习速率递增的变化曲线（蓝色曲线为指数平滑线）
</figcaption>
</figure>
</div>
</div>
</div>
<p>最佳学习速率不是损失最小时所对应的学习速率值，而应取稍小一些的数值，一般可取小一个数量级的值。由 <a href="#fig-6.30" class="quarto-xref">图&nbsp;<span>6.30</span></a> 可见，本案例最佳学习速率取0.1比较合适。将最佳学习速率传给学习速率调度器（亦即学习速率在训练中的调整策略），如单周期调度器<code>lr_one_cycle()</code>，该策略将传入的最佳学习速率作为学习速率最大值，在训练中，学习速率从很小的初始值开始，逐渐增大到最大值，然后学习速率将缓慢地减小，直到减小到略小于初始值。</p>
<p>配置训练超参数，然后执行训练。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>fitted <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(train_dl, <span class="at">epochs =</span> <span class="dv">50</span>, <span class="at">valid_data =</span> valid_dl,</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">callbacks =</span> <span class="fu">list</span>(</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">luz_callback_early_stopping</span>(<span class="at">patience =</span> <span class="dv">3</span>),</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">luz_callback_lr_scheduler</span>(</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>          lr_one_cycle,</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">max_lr =</span> <span class="fl">0.1</span>,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">epochs =</span> <span class="dv">50</span>,</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">steps_per_epoch =</span> <span class="fu">length</span>(train_dl),</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">call_on =</span> <span class="st">"on_batch_end"</span>)</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>对训练过程中的拟合损失和验证损失进行可视化，结果如 <a href="#fig-6.31" class="quarto-xref">图&nbsp;<span>6.31</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fitted) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-6.31" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.31-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH6_files/figure-html/fig-6.31-1.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.31-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.31: 训练和验证损失曲线
</figcaption>
</figure>
</div>
</div>
</div>
<p>在测试集上评估模型性能：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">evaluate</span>(fitted, test_dl)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A `luz_module_evaluation`
── Results ─────────────────────────────────────────────────────────────────────
loss: 0.0378</code></pre>
</div>
</div>
<p>为了更好地可视化预测结果，选择2014年12月的数据进行预测，对预测结果进行可视化：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>demand_viz <span class="ot">&lt;-</span> demand_hourly <span class="sc">%&gt;%</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(Hour) <span class="sc">==</span> <span class="dv">2014</span>, <span class="fu">month</span>(Hour) <span class="sc">==</span> <span class="dv">12</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>demand_viz_matrix <span class="ot">&lt;-</span> demand_viz <span class="sc">%&gt;%</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Demand) <span class="sc">%&gt;%</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>viz_ds <span class="ot">&lt;-</span> <span class="fu">demand_ds</span>(demand_viz_matrix, n_timesteps)</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>viz_dl <span class="ot">&lt;-</span> viz_ds <span class="sc">%&gt;%</span> <span class="fu">dataloader</span>(<span class="at">batch_size =</span> <span class="fu">length</span>(viz_ds))</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted, viz_dl)</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> preds<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> <span class="st">"cpu"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, n_timesteps), preds)</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>pred_ts <span class="ot">&lt;-</span> demand_viz <span class="sc">%&gt;%</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(<span class="at">forecast =</span> preds <span class="sc">*</span> train_sd <span class="sc">+</span> train_mean) <span class="sc">%&gt;%</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>Hour) <span class="sc">%&gt;%</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_tsibble</span>(<span class="at">key =</span> name)</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>pred_ts <span class="sc">%&gt;%</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(<span class="at">.vars =</span> value) <span class="sc">+</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"lightblue"</span>, <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"None"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.32" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.32-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.32.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.32-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.32: 预测结果可视化
</figcaption>
</figure>
</div>
</div>
</div>
<p>从 <a href="#fig-6.32" class="quarto-xref">图&nbsp;<span>6.32</span></a> 可见，预测结果与实际值吻合较好。</p>
<p>下面计算均方根误差、平均绝对误差和平均绝对百分比误差：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取实际标签值</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>truth <span class="ot">=</span> demand_viz<span class="sc">$</span>Demand[(n_timesteps <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(demand_viz)]</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 标签预测值反归一化</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>forecast <span class="ot">=</span> preds <span class="sc">*</span> train_sd <span class="sc">+</span> train_mean</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>forecast <span class="ot">=</span> forecast[(n_timesteps <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">length</span>(forecast)]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算均方根误差</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>yardstick<span class="sc">::</span><span class="fu">rmse_vec</span>(truth, forecast)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 274.007</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算平均绝对误差</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>yardstick<span class="sc">::</span><span class="fu">mae_vec</span>(truth, forecast)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 202.6</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算平均绝对百分比误差</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>yardstick<span class="sc">::</span><span class="fu">mape_vec</span>(truth, forecast)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 2.491471</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>计算实际残差并可视化其频数分布，结果如 <a href="#fig-6.33" class="quarto-xref">图&nbsp;<span>6.33</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(truth),</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">val =</span> truth <span class="sc">-</span> forecast)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 散点图</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res, <span class="fu">aes</span>(<span class="at">x =</span> id, <span class="at">y =</span> val)) <span class="sc">+</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 频数分布图</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res, <span class="fu">aes</span>(<span class="at">x =</span> val, <span class="at">y =</span> <span class="fu">after_stat</span>(density))) <span class="sc">+</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span>   </span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-6.33" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.33-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-6.33" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-6.33-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-6.33-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.33-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-6.33">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-6.33-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 残差散点图
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-6.33" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-6.33-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-6.33-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.33-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-6.33">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-6.33-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 残差频数分布图
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.33-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.33: 预测残差的可视化
</figcaption>
</figure>
</div>
</section>
<section id="图像数据案例" class="level3" data-number="6.3.3">
<h3 data-number="6.3.3" class="anchored" data-anchor-id="图像数据案例"><span class="header-section-number">6.3.3</span> 图像数据案例</h3>
<p>本案例数据集自https://storage.googleapis.com/torch-datasets/bird-species.zip下载，包含450种鸟类图片，图片均为244×244×3的彩色jpg格式，每张图片仅有一种鸟。该数据集子集已划分，分别保存在train、valid和test目录中，其中train包含70626张图片（不平衡数据集，但每种鸟至少有130张图片），valid和test均包含2250张图片。在这三个目录中，每种鸟的图片分别保存在以种名（即分类标签）命名的子目录中。需要注意的是，尽管该数据集质量很高，但在每种鸟的雌雄比例上很不平衡，雄性约占80%。因此，基于本数据集建立的分类模型对于雌鸟分类可能表现不佳。</p>
<p>本案例采用ResNet18预训练模型。ResNet（残差网络）由微软研究院的何恺明等人提出，在2015年的ILSVRC（ImageNet Large Scale Visual Recognition Challenge）中取得了冠军。ResNet的主要贡献是发现了深度神经网络的“退化现象（Degradation）”，并提出了“快捷连接（Shortcut connection）”的解决方法，让神经网络的“深度”首次突破100层，最大的神经网络甚至超过1000层。</p>
<p>ResNet18包含18个权重层，其结构如 <a href="#fig-6.34" class="quarto-xref">图&nbsp;<span>6.34</span></a> 所示，其中Basic_block的细节见 <a href="#fig-6.35" class="quarto-xref">图&nbsp;<span>6.35</span></a> 。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.34" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.34-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.34.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.34-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.34: ResNet18结构示意图
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.35" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.35-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.35.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.35-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.35: Basic_block的结构与残差连接
</figcaption>
</figure>
</div>
</div>
</div>
<section id="加载工具包" class="level4" data-number="6.3.3.1">
<h4 data-number="6.3.3.1" class="anchored" data-anchor-id="加载工具包"><span class="header-section-number">6.3.3.1</span> 加载工具包</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 利用CPU训练时的内存管理</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">torch.threshold_call_gc =</span> <span class="dv">4000</span>)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载工具包</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(torch)</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(torchvision)</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(torchdatasets)</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>本案例可以利用CPU来训练，但耗时较长。如果有配置正确的支持CUDA的GPU计算环境，建议使用GPU进行训练。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置计算设备</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co"># device = if (cuda_is_available()) torch_device("cuda:0") else "cpu"</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>device <span class="ot">=</span> <span class="st">"cpu"</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="图片预处理" class="level4" data-number="6.3.3.2">
<h4 data-number="6.3.3.2" class="anchored" data-anchor-id="图片预处理"><span class="header-section-number">6.3.3.2</span> 图片预处理</h4>
<p>对加载的图片进行张量化、数据增强和标准化处理：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 对训练集图片的预处理</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>train_transforms <span class="ot">&lt;-</span> <span class="cf">function</span>(img) {</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  img <span class="sc">%&gt;%</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 图片张量化</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transform_to_tensor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 转移至指定设备(GPU或CPU)</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    (<span class="cf">function</span>(x) x<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> device)) <span class="sc">%&gt;%</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 数据增强：随机剪裁</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transform_random_resized_crop</span>(<span class="at">size =</span> <span class="fu">c</span>(<span class="dv">224</span>, <span class="dv">224</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 数据增强：色彩（亮度、对比度、饱和度）随机改变</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transform_color_jitter</span>() <span class="sc">%&gt;%</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 数据增强：随机水平翻转</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transform_random_horizontal_flip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 根据resnet要求执行标准化</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transform_normalize</span>(<span class="at">mean =</span> <span class="fu">c</span>(<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>), </span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>                        <span class="at">std =</span> <span class="fu">c</span>(<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>))</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 对验证集图片的预处理</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>valid_transforms <span class="ot">&lt;-</span> <span class="cf">function</span>(img) {</span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>  img <span class="sc">%&gt;%</span></span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transform_to_tensor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>    (<span class="cf">function</span>(x) x<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> device)) <span class="sc">%&gt;%</span></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transform_resize</span>(<span class="dv">256</span>) <span class="sc">%&gt;%</span></span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transform_center_crop</span>(<span class="dv">224</span>) <span class="sc">%&gt;%</span></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transform_normalize</span>(<span class="at">mean =</span> <span class="fu">c</span>(<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>), </span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>                        <span class="at">std =</span> <span class="fu">c</span>(<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>))</span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 对测试集图片的预处理与验证集相同</span></span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a>test_transforms <span class="ot">&lt;-</span> valid_transforms</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="下载数据并创建dataset" class="level4" data-number="6.3.3.3">
<h4 data-number="6.3.3.3" class="anchored" data-anchor-id="下载数据并创建dataset"><span class="header-section-number">6.3.3.3</span> 下载数据并创建Dataset</h4>
<p>从<a href="https://storage.googleapis.com/torch-datasets/bird-species.zip" class="uri">https://storage.googleapis.com/torch-datasets/bird-species.zip</a>下载鸟类图片数据集，解压到项目根目录下data子目录中，解压后确保数据集目录名为bird_species，其下有train、valid和test三个目录，分别对应训练集、验证集和测试集鸟类图片。为了缩短训练时间，减轻计算硬件压力，本案例数据仅保留了首字母为A的鸟类图片（注意，需要同时删除train、valid和test三个目录中的首字母非A的鸟类图片）。</p>
<p>该数据集目录结构完全符合torchvision包中<code>image_folder_dataset()</code>的要求，直接利用该函数创建Dataset：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>train_ds <span class="ot">&lt;-</span> <span class="fu">image_folder_dataset</span>(<span class="st">"./data/bird_species/train/"</span>, </span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">transform =</span> train_transforms)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>valid_ds <span class="ot">&lt;-</span> <span class="fu">image_folder_dataset</span>(<span class="st">"./data/bird_species/valid/"</span>, </span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">transform =</span> valid_transforms)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>test_ds <span class="ot">&lt;-</span> <span class="fu">image_folder_dataset</span>(<span class="st">"./data/bird_species/test/"</span>, </span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>                                <span class="at">transform =</span> test_transforms)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>查看三个数据子集中图片数量：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>train_ds<span class="sc">$</span><span class="fu">.length</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 7383</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>valid_ds<span class="sc">$</span><span class="fu">.length</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 235</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>test_ds<span class="sc">$</span><span class="fu">.length</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 235</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="创建dataloader-1" class="level4" data-number="6.3.3.4">
<h4 data-number="6.3.3.4" class="anchored" data-anchor-id="创建dataloader-1"><span class="header-section-number">6.3.3.4</span> 创建Dataloader</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">&lt;-</span> <span class="dv">64</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>train_dl <span class="ot">&lt;-</span> <span class="fu">dataloader</span>(train_ds, <span class="at">batch_size =</span> batch_size, <span class="at">shuffle =</span> <span class="cn">TRUE</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>valid_dl <span class="ot">&lt;-</span> <span class="fu">dataloader</span>(valid_ds, <span class="at">batch_size =</span> batch_size)</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>test_dl <span class="ot">&lt;-</span> <span class="fu">dataloader</span>(test_ds, <span class="at">batch_size =</span> batch_size)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="数据可视化" class="level4" data-number="6.3.3.5">
<h4 data-number="6.3.3.5" class="anchored" data-anchor-id="数据可视化"><span class="header-section-number">6.3.3.5</span> 数据可视化</h4>
<p>显示部分鸟类图片：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>class_names <span class="ot">&lt;-</span> test_ds<span class="sc">$</span>classes</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>batch <span class="ot">&lt;-</span> train_dl<span class="sc">$</span><span class="fu">.iter</span>()<span class="sc">$</span><span class="fu">.next</span>()</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>classes <span class="ot">&lt;-</span> batch[[<span class="dv">2</span>]]</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>images <span class="ot">&lt;-</span> <span class="fu">as_array</span>(batch[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> <span class="st">"cpu"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aperm</span>(<span class="at">perm =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">2</span>))</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>mean <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>)</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>std <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>)</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>images <span class="ot">&lt;-</span> std <span class="sc">*</span> images <span class="sc">+</span> mean</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>images <span class="ot">&lt;-</span> images <span class="sc">*</span> <span class="dv">255</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>images[images <span class="sc">&gt;</span> <span class="dv">255</span>] <span class="ot">&lt;-</span> <span class="dv">255</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>images[images <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>), <span class="at">mar =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.5</span>)</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>images <span class="sc">%&gt;%</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">array_tree</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">set_names</span>(class_names[<span class="fu">as_array</span>(classes)]) <span class="sc">%&gt;%</span></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(as.raster, <span class="at">max =</span> <span class="dv">255</span>) <span class="sc">%&gt;%</span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">iwalk</span>(<span class="sc">~</span>{<span class="fu">plot</span>(.x); <span class="fu">title</span>(.y)})</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-6.36" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.36-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig6.36.png" class="img-fluid figure-img" width="350">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.36-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;6.36: 部分鸟类图片
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="搭建模型-1" class="level4" data-number="6.3.3.6">
<h4 data-number="6.3.3.6" class="anchored" data-anchor-id="搭建模型-1"><span class="header-section-number">6.3.3.6</span> 搭建模型</h4>
<p>本案例直接借用预训练的resnet18模型，下载链接为<a href="https://storage.googleapis.com/torchvision-models/v1/models/resnet18.pth" class="uri">https://storage.googleapis.com/torchvision-models/v1/models/resnet18.pth</a>，下载后保存至项目根目录中model子目录中。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 引用resnet18模型结构</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">model_resnet18</span>(<span class="at">pretrained =</span> <span class="cn">FALSE</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 为模型加载预训练的参数</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>pretrained_state_dict <span class="ot">&lt;-</span> <span class="fu">load_state_dict</span>(<span class="st">"./model/resnet18.pth"</span>)</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span><span class="fu">load_state_dict</span>(pretrained_state_dict)</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 锁定模型参数，确保在后面的训练中不被更新</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>parameters <span class="sc">%&gt;%</span> purrr<span class="sc">::</span><span class="fu">walk</span>(<span class="cf">function</span>(param) param<span class="sc">$</span><span class="fu">requires_grad_</span>(<span class="cn">FALSE</span>))</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 修改模型最后的输出层（全连接神经元层）参数，确保输出特征与本案例数据相符</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>num_features <span class="ot">&lt;-</span> model<span class="sc">$</span>fc<span class="sc">$</span>in_features</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>fc <span class="ot">&lt;-</span> <span class="fu">nn_linear</span>(<span class="at">in_features =</span> num_features, </span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">out_features =</span> <span class="fu">length</span>(class_names))</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 将模型载入计算设备</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> device)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="训练模型" class="level4" data-number="6.3.3.7">
<h4 data-number="6.3.3.7" class="anchored" data-anchor-id="训练模型"><span class="header-section-number">6.3.3.7</span> 训练模型</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置损失函数</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>criterion <span class="ot">&lt;-</span> <span class="fu">nn_cross_entropy_loss</span>()</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置优化算法</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>optimizer <span class="ot">&lt;-</span> <span class="fu">optim_sgd</span>(model<span class="sc">$</span>parameters, <span class="at">lr =</span> <span class="fl">0.003</span>, <span class="at">momentum =</span> <span class="fl">0.9</span>)</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置训练回合</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>num_epochs <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置优化算法中学习率的动态调整策略</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>scheduler <span class="ot">&lt;-</span> optimizer <span class="sc">%&gt;%</span> </span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lr_one_cycle</span>(<span class="at">max_lr =</span> <span class="fl">0.003</span>, <span class="at">epochs =</span> num_epochs, </span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">steps_per_epoch =</span> train_dl<span class="sc">$</span><span class="fu">.length</span>())</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义训练计算过程（函数）</span></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>train_batch <span class="ot">&lt;-</span> <span class="cf">function</span>(b) {</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>  optimizer<span class="sc">$</span><span class="fu">zero_grad</span>()</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">model</span>(b[[<span class="dv">1</span>]])</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>  loss <span class="ot">&lt;-</span> <span class="fu">criterion</span>(output, b[[<span class="dv">2</span>]]<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> device))</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>  loss<span class="sc">$</span><span class="fu">backward</span>()</span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>  optimizer<span class="sc">$</span><span class="fu">step</span>()</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>  scheduler<span class="sc">$</span><span class="fu">step</span>()</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>  loss<span class="sc">$</span><span class="fu">item</span>()</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义验证计算过程（函数）</span></span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>valid_batch <span class="ot">&lt;-</span> <span class="cf">function</span>(b) {</span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">model</span>(b[[<span class="dv">1</span>]])</span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a>  loss <span class="ot">&lt;-</span> <span class="fu">criterion</span>(output, b[[<span class="dv">2</span>]]<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> device))</span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a>  loss<span class="sc">$</span><span class="fu">item</span>()</span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 训练模型</span></span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (epoch <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_epochs) {</span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span><span class="fu">train</span>()</span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a>  train_losses <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 在训练集上执行计算</span></span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">loop</span>(<span class="cf">for</span> (b <span class="cf">in</span> train_dl) {</span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a>    loss <span class="ot">&lt;-</span> <span class="fu">train_batch</span>(b)</span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a>    train_losses <span class="ot">&lt;-</span> <span class="fu">c</span>(train_losses, loss)</span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span><span class="fu">eval</span>()</span>
<span id="cb100-43"><a href="#cb100-43" aria-hidden="true" tabindex="-1"></a>  valid_losses <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb100-44"><a href="#cb100-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 在验证集上执行计算</span></span>
<span id="cb100-45"><a href="#cb100-45" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">loop</span>(<span class="cf">for</span> (b <span class="cf">in</span> valid_dl) {</span>
<span id="cb100-46"><a href="#cb100-46" aria-hidden="true" tabindex="-1"></a>    loss <span class="ot">&lt;-</span> <span class="fu">valid_batch</span>(b)</span>
<span id="cb100-47"><a href="#cb100-47" aria-hidden="true" tabindex="-1"></a>    valid_losses <span class="ot">&lt;-</span> <span class="fu">c</span>(valid_losses, loss)</span>
<span id="cb100-48"><a href="#cb100-48" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb100-49"><a href="#cb100-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 输出该回合的训练集平均损失和验证集平均损失</span></span>
<span id="cb100-50"><a href="#cb100-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Loss at epoch %d: training: %3f, </span></span>
<span id="cb100-51"><a href="#cb100-51" aria-hidden="true" tabindex="-1"></a><span class="st">              validation: %3f</span><span class="sc">\n</span><span class="st">"</span>, epoch, <span class="fu">mean</span>(train_losses), </span>
<span id="cb100-52"><a href="#cb100-52" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mean</span>(valid_losses)))</span>
<span id="cb100-53"><a href="#cb100-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-54"><a href="#cb100-54" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Loss at epoch 1: training: 3.354151, </span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="do">##               validation: 0.765348</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Loss at epoch 2: training: 1.403915, </span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="do">##               validation: 0.494243</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Loss at epoch 3: training: 1.179917, </span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="do">##               validation: 0.344438</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Loss at epoch 4: training: 0.983393, </span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a><span class="do">##               validation: 0.326341</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Loss at epoch 5: training: 0.833348, </span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a><span class="do">##               validation: 0.193428</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Loss at epoch 6: training: 0.714266, </span></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a><span class="do">##               validation: 0.151117</span></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a><span class="do">## Loss at epoch 7: training: 0.618413, </span></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a><span class="do">##               validation: 0.090056</span></span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a><span class="do">## Loss at epoch 8: training: 0.512669, </span></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a><span class="do">##               validation: 0.073891</span></span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a><span class="do">## Loss at epoch 9: training: 0.397235, </span></span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a><span class="do">##               validation: 0.042033</span></span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a><span class="do">## Loss at epoch 10: training: 0.379246, </span></span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a><span class="do">##               validation: 0.046510</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="预测并计算预测性能" class="level4" data-number="6.3.3.8">
<h4 data-number="6.3.3.8" class="anchored" data-anchor-id="预测并计算预测性能"><span class="header-section-number">6.3.3.8</span> 预测并计算预测性能</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 将模型设置为评估状态，即不更新模型参数</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span><span class="fu">eval</span>()</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义模型评估计算过程</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>test_batch <span class="ot">&lt;-</span> <span class="cf">function</span>(b) {</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">model</span>(b[[<span class="dv">1</span>]])</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  labels <span class="ot">&lt;-</span> b[[<span class="dv">2</span>]]<span class="sc">$</span><span class="fu">to</span>(<span class="at">device =</span> device)</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>  loss <span class="ot">&lt;-</span> <span class="fu">criterion</span>(output, labels)</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  test_losses <span class="ot">&lt;&lt;-</span> <span class="fu">c</span>(test_losses, loss<span class="sc">$</span><span class="fu">item</span>())</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  predicted <span class="ot">&lt;-</span> <span class="fu">torch_max</span>(output<span class="sc">$</span><span class="fu">data</span>(), <span class="at">dim =</span> <span class="dv">2</span>)[[<span class="dv">2</span>]]</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>  total <span class="ot">&lt;&lt;-</span> total <span class="sc">+</span> labels<span class="sc">$</span><span class="fu">size</span>(<span class="dv">1</span>)</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>  correct <span class="ot">&lt;&lt;-</span> correct <span class="sc">+</span> (predicted <span class="sc">==</span> labels)<span class="sc">$</span><span class="fu">sum</span>()<span class="sc">$</span><span class="fu">item</span>()</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义计算变量</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>test_losses <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>total <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>correct <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 在训练集上执行计算</span></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>coro<span class="sc">::</span><span class="fu">loop</span>(<span class="cf">for</span> (b <span class="cf">in</span> test_dl) {</span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_batch</span>(b)</span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算预测集上平均损失</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(test_losses)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.07427256</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算预测准确率</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>test_accuracy <span class="ot">&lt;-</span> correct<span class="sc">/</span>total</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>test_accuracy</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.9829787</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>由结果可见，10个回合的训练，预测集准确率接近98.30%。</p>
</section>
<section id="保存模型" class="level4" data-number="6.3.3.9">
<h4 data-number="6.3.3.9" class="anchored" data-anchor-id="保存模型"><span class="header-section-number">6.3.3.9</span> 保存模型</h4>
<p>用<code>troch_save()</code>函数保存已经训练好的模型：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">torch_save</span>(model, <span class="st">"./model/brid_res18_model.rt"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>加载该模型时，直接使用<code>torch_load()</code>函数：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>bird_classif_model <span class="ot">=</span> <span class="fu">torch_load</span>(<span class="st">"./model/brid_res18_model.rt"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="exr-6.1" class="theorem exercise">
<p><span class="theorem-title"><strong>练习 6.1</strong></span> <br>
练习 <a href="#sec-dl-example" class="quarto-xref"><span>小节 6.3</span></a> 中的三个例题，确保能够正确无误的运行，并得到较为理想的结果。</p>
</div>
<div id="exr-6.2" class="theorem exercise">
<p><span class="theorem-title"><strong>练习 6.2</strong></span> <br>
安装tabnet工具包：<code>install.packages("tabnet")</code>，或<code>remotes::install_github("mlverse/tabnet")</code>；在<a href="https://mlverse.github.io/tabnet/" class="uri">https://mlverse.github.io/tabnet/</a>网站学习该工具包的使用；安装modeldata工具包：<code>install.packages("modeldata")</code>。然后基于modeldata中的biomass数据集，利用tabnet建立深度学习模型，建模流程参考tabnet网站的案例。</p>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "已复制");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "已复制");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./CH5.html" class="pagination-link" aria-label="R语言机器学习建模">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">R语言机器学习建模</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="参考文献">
        <span class="nav-page-text">参考文献</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>环境数据分析与机器学习，邓大鹏 编著.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>本书采用<a href="https://quarto.org/">Quarto</a>构建.</p>
</div>
  </div>
</footer>




</body></html>
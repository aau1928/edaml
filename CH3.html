<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>环境数据分析与机器学习 - 3&nbsp; 环境数据整理与可视化</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./CH4.html" rel="next">
<link href="./CH2.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "没有结果",
    "search-matching-documents-text": "匹配的文档",
    "search-copy-link-title": "复制搜索链接",
    "search-hide-matches-text": "隐藏其它匹配结果",
    "search-more-match-text": "更多匹配结果",
    "search-more-matches-text": "更多匹配结果",
    "search-clear-button-title": "清除",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "提交",
    "search-label": "搜索"
  }
}</script>
<link href="site_libs/table1-1.0/table1_defaults.css" rel="stylesheet">

<link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">

<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>

<link href="site_libs/wordcloud2-0.0.1/wordcloud.css" rel="stylesheet">

<script src="site_libs/wordcloud2-0.0.1/wordcloud2-all.js"></script>

<script src="site_libs/wordcloud2-0.0.1/hover.js"></script>

<script src="site_libs/wordcloud2-binding-0.2.1/wordcloud2.js"></script>


  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="edaml.scss">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="展开或折叠侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./CH1.html">基础知识</a></li><li class="breadcrumb-item"><a href="./CH3.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">环境数据整理与可视化</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="展开或折叠侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">环境数据分析与机器学习</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="搜索"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">前言</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">基础知识</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">绪论</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">R语言编程基础</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH3.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">环境数据整理与可视化</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">进阶知识</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">环境数据统计分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">R语言机器学习建模</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">高阶知识</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CH6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R语言深度学习建模</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">参考文献</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目录</h2>
   
  <ul>
  <li><a href="#环境数据整理" id="toc-环境数据整理" class="nav-link active" data-scroll-target="#环境数据整理"><span class="header-section-number">3.1</span> 环境数据整理</a>
  <ul>
  <li><a href="#tidyr工具包主要函数" id="toc-tidyr工具包主要函数" class="nav-link" data-scroll-target="#tidyr工具包主要函数"><span class="header-section-number">3.1.1</span> tidyr工具包主要函数</a>
  <ul class="collapse">
  <li><a href="#长宽表转换" id="toc-长宽表转换" class="nav-link" data-scroll-target="#长宽表转换"><span class="header-section-number">3.1.1.1</span> 长宽表转换</a></li>
  <li><a href="#列值合并与分割" id="toc-列值合并与分割" class="nav-link" data-scroll-target="#列值合并与分割"><span class="header-section-number">3.1.1.2</span> 列值合并与分割</a></li>
  <li><a href="#其他操作" id="toc-其他操作" class="nav-link" data-scroll-target="#其他操作"><span class="header-section-number">3.1.1.3</span> 其他操作</a></li>
  </ul></li>
  <li><a href="#dplyr工具包主要函数" id="toc-dplyr工具包主要函数" class="nav-link" data-scroll-target="#dplyr工具包主要函数"><span class="header-section-number">3.1.2</span> dplyr工具包主要函数</a>
  <ul class="collapse">
  <li><a href="#选择列" id="toc-选择列" class="nav-link" data-scroll-target="#选择列"><span class="header-section-number">3.1.2.1</span> 选择列</a></li>
  <li><a href="#行选择" id="toc-行选择" class="nav-link" data-scroll-target="#行选择"><span class="header-section-number">3.1.2.2</span> 行选择</a></li>
  <li><a href="#列操作" id="toc-列操作" class="nav-link" data-scroll-target="#列操作"><span class="header-section-number">3.1.2.3</span> 列操作</a></li>
  <li><a href="#数据集拼接" id="toc-数据集拼接" class="nav-link" data-scroll-target="#数据集拼接"><span class="header-section-number">3.1.2.4</span> 数据集拼接</a></li>
  <li><a href="#分组汇总统计" id="toc-分组汇总统计" class="nav-link" data-scroll-target="#分组汇总统计"><span class="header-section-number">3.1.2.5</span> 分组汇总统计</a></li>
  <li><a href="#其他操作-1" id="toc-其他操作-1" class="nav-link" data-scroll-target="#其他操作-1"><span class="header-section-number">3.1.2.6</span> 其他操作</a></li>
  </ul></li>
  <li><a href="#错误和重复数据的处理" id="toc-错误和重复数据的处理" class="nav-link" data-scroll-target="#错误和重复数据的处理"><span class="header-section-number">3.1.3</span> 错误和重复数据的处理</a></li>
  <li><a href="#缺失值的识别与处理" id="toc-缺失值的识别与处理" class="nav-link" data-scroll-target="#缺失值的识别与处理"><span class="header-section-number">3.1.4</span> 缺失值的识别与处理</a>
  <ul class="collapse">
  <li><a href="#缺失值的识别" id="toc-缺失值的识别" class="nav-link" data-scroll-target="#缺失值的识别"><span class="header-section-number">3.1.4.1</span> 缺失值的识别</a></li>
  <li><a href="#缺失值的处理" id="toc-缺失值的处理" class="nav-link" data-scroll-target="#缺失值的处理"><span class="header-section-number">3.1.4.2</span> 缺失值的处理</a></li>
  </ul></li>
  <li><a href="#异常值的识别与处理" id="toc-异常值的识别与处理" class="nav-link" data-scroll-target="#异常值的识别与处理"><span class="header-section-number">3.1.5</span> 异常值的识别与处理</a>
  <ul class="collapse">
  <li><a href="#异常值的识别" id="toc-异常值的识别" class="nav-link" data-scroll-target="#异常值的识别"><span class="header-section-number">3.1.5.1</span> 异常值的识别</a></li>
  <li><a href="#异常值的处理" id="toc-异常值的处理" class="nav-link" data-scroll-target="#异常值的处理"><span class="header-section-number">3.1.5.2</span> 异常值的处理</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#制作数据表格" id="toc-制作数据表格" class="nav-link" data-scroll-target="#制作数据表格"><span class="header-section-number">3.2</span> 制作数据表格</a>
  <ul>
  <li><a href="#htmltable包制作三线表" id="toc-htmltable包制作三线表" class="nav-link" data-scroll-target="#htmltable包制作三线表"><span class="header-section-number">3.2.1</span> htmlTable包制作三线表</a></li>
  <li><a href="#table1包制作分组统计三线表" id="toc-table1包制作分组统计三线表" class="nav-link" data-scroll-target="#table1包制作分组统计三线表"><span class="header-section-number">3.2.2</span> table1包制作分组统计三线表</a></li>
  <li><a href="#ggpubr包制作三线表" id="toc-ggpubr包制作三线表" class="nav-link" data-scroll-target="#ggpubr包制作三线表"><span class="header-section-number">3.2.3</span> ggpubr包制作三线表</a></li>
  </ul></li>
  <li><a href="#r绘图基础" id="toc-r绘图基础" class="nav-link" data-scroll-target="#r绘图基础"><span class="header-section-number">3.3</span> R绘图基础</a>
  <ul>
  <li><a href="#r的图形设备" id="toc-r的图形设备" class="nav-link" data-scroll-target="#r的图形设备"><span class="header-section-number">3.3.1</span> R的图形设备</a>
  <ul class="collapse">
  <li><a href="#窗口显示设备" id="toc-窗口显示设备" class="nav-link" data-scroll-target="#窗口显示设备"><span class="header-section-number">3.3.1.1</span> 窗口显示设备</a></li>
  <li><a href="#文件打印设备" id="toc-文件打印设备" class="nav-link" data-scroll-target="#文件打印设备"><span class="header-section-number">3.3.1.2</span> 文件打印设备</a></li>
  </ul></li>
  <li><a href="#r基础绘图系统" id="toc-r基础绘图系统" class="nav-link" data-scroll-target="#r基础绘图系统"><span class="header-section-number">3.3.2</span> R基础绘图系统</a>
  <ul class="collapse">
  <li><a href="#高级绘图函数" id="toc-高级绘图函数" class="nav-link" data-scroll-target="#高级绘图函数"><span class="header-section-number">3.3.2.1</span> 高级绘图函数</a></li>
  <li><a href="#低级绘图函数" id="toc-低级绘图函数" class="nav-link" data-scroll-target="#低级绘图函数"><span class="header-section-number">3.3.2.2</span> 低级绘图函数</a></li>
  <li><a href="#绘图全局参数配置" id="toc-绘图全局参数配置" class="nav-link" data-scroll-target="#绘图全局参数配置"><span class="header-section-number">3.3.2.3</span> 绘图全局参数配置</a></li>
  </ul></li>
  <li><a href="#lattice绘图系统" id="toc-lattice绘图系统" class="nav-link" data-scroll-target="#lattice绘图系统"><span class="header-section-number">3.3.3</span> lattice绘图系统</a></li>
  <li><a href="#ggplot2绘图系统" id="toc-ggplot2绘图系统" class="nav-link" data-scroll-target="#ggplot2绘图系统"><span class="header-section-number">3.3.4</span> ggplot2绘图系统</a>
  <ul class="collapse">
  <li><a href="#ggplot2图形元素" id="toc-ggplot2图形元素" class="nav-link" data-scroll-target="#ggplot2图形元素"><span class="header-section-number">3.3.4.1</span> ggplot2图形元素</a></li>
  <li><a href="#ggplot2绘图流程" id="toc-ggplot2绘图流程" class="nav-link" data-scroll-target="#ggplot2绘图流程"><span class="header-section-number">3.3.4.2</span> ggplot2绘图流程</a></li>
  <li><a href="#ggplot2图形保存" id="toc-ggplot2图形保存" class="nav-link" data-scroll-target="#ggplot2图形保存"><span class="header-section-number">3.3.4.3</span> ggplot2图形保存</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#r数据可视化实践" id="toc-r数据可视化实践" class="nav-link" data-scroll-target="#r数据可视化实践"><span class="header-section-number">3.4</span> R数据可视化实践</a>
  <ul>
  <li><a href="#数据关系与可视化类型" id="toc-数据关系与可视化类型" class="nav-link" data-scroll-target="#数据关系与可视化类型"><span class="header-section-number">3.4.1</span> 数据关系与可视化类型</a></li>
  <li><a href="#可视化整体局部关系" id="toc-可视化整体局部关系" class="nav-link" data-scroll-target="#可视化整体局部关系"><span class="header-section-number">3.4.2</span> 可视化整体局部关系</a>
  <ul class="collapse">
  <li><a href="#饼图" id="toc-饼图" class="nav-link" data-scroll-target="#饼图"><span class="header-section-number">3.4.2.1</span> 饼图</a></li>
  <li><a href="#圆环图" id="toc-圆环图" class="nav-link" data-scroll-target="#圆环图"><span class="header-section-number">3.4.2.2</span> 圆环图</a></li>
  <li><a href="#矩形树状图" id="toc-矩形树状图" class="nav-link" data-scroll-target="#矩形树状图"><span class="header-section-number">3.4.2.3</span> 矩形树状图</a></li>
  </ul></li>
  <li><a href="#可视化类别比较关系" id="toc-可视化类别比较关系" class="nav-link" data-scroll-target="#可视化类别比较关系"><span class="header-section-number">3.4.3</span> 可视化类别比较关系</a>
  <ul class="collapse">
  <li><a href="#条形图" id="toc-条形图" class="nav-link" data-scroll-target="#条形图"><span class="header-section-number">3.4.3.1</span> 条形图</a></li>
  <li><a href="#克利夫兰点图" id="toc-克利夫兰点图" class="nav-link" data-scroll-target="#克利夫兰点图"><span class="header-section-number">3.4.3.2</span> 克利夫兰点图</a></li>
  <li><a href="#坡度图" id="toc-坡度图" class="nav-link" data-scroll-target="#坡度图"><span class="header-section-number">3.4.3.3</span> 坡度图</a></li>
  <li><a href="#玫瑰图" id="toc-玫瑰图" class="nav-link" data-scroll-target="#玫瑰图"><span class="header-section-number">3.4.3.4</span> 玫瑰图</a></li>
  <li><a href="#雷达图" id="toc-雷达图" class="nav-link" data-scroll-target="#雷达图"><span class="header-section-number">3.4.3.5</span> 雷达图</a></li>
  <li><a href="#词云图" id="toc-词云图" class="nav-link" data-scroll-target="#词云图"><span class="header-section-number">3.4.3.6</span> 词云图</a></li>
  </ul></li>
  <li><a href="#可视化趋势发展变化" id="toc-可视化趋势发展变化" class="nav-link" data-scroll-target="#可视化趋势发展变化"><span class="header-section-number">3.4.4</span> 可视化趋势发展变化</a>
  <ul class="collapse">
  <li><a href="#折线图" id="toc-折线图" class="nav-link" data-scroll-target="#折线图"><span class="header-section-number">3.4.4.1</span> 折线图</a></li>
  <li><a href="#面积图" id="toc-面积图" class="nav-link" data-scroll-target="#面积图"><span class="header-section-number">3.4.4.2</span> 面积图</a></li>
  <li><a href="#日历热图" id="toc-日历热图" class="nav-link" data-scroll-target="#日历热图"><span class="header-section-number">3.4.4.3</span> 日历热图</a></li>
  </ul></li>
  <li><a href="#可视化变量频数分布" id="toc-可视化变量频数分布" class="nav-link" data-scroll-target="#可视化变量频数分布"><span class="header-section-number">3.4.5</span> 可视化变量频数分布</a>
  <ul class="collapse">
  <li><a href="#统计直方图和核密度估计图" id="toc-统计直方图和核密度估计图" class="nav-link" data-scroll-target="#统计直方图和核密度估计图"><span class="header-section-number">3.4.5.1</span> 统计直方图和核密度估计图</a></li>
  <li><a href="#箱线图与小提琴图" id="toc-箱线图与小提琴图" class="nav-link" data-scroll-target="#箱线图与小提琴图"><span class="header-section-number">3.4.5.2</span> 箱线图与小提琴图</a></li>
  </ul></li>
  <li><a href="#可视化变量相关关系" id="toc-可视化变量相关关系" class="nav-link" data-scroll-target="#可视化变量相关关系"><span class="header-section-number">3.4.6</span> 可视化变量相关关系</a>
  <ul class="collapse">
  <li><a href="#二维散点图" id="toc-二维散点图" class="nav-link" data-scroll-target="#二维散点图"><span class="header-section-number">3.4.6.1</span> 二维散点图</a></li>
  <li><a href="#sec-cormatvis" id="toc-sec-cormatvis" class="nav-link" data-scroll-target="#sec-cormatvis"><span class="header-section-number">3.4.6.2</span> 相关矩阵图</a></li>
  </ul></li>
  <li><a href="#其他可视化类型" id="toc-其他可视化类型" class="nav-link" data-scroll-target="#其他可视化类型"><span class="header-section-number">3.4.7</span> 其他可视化类型</a>
  <ul class="collapse">
  <li><a href="#地理空间数据可视化" id="toc-地理空间数据可视化" class="nav-link" data-scroll-target="#地理空间数据可视化"><span class="header-section-number">3.4.7.1</span> 地理空间数据可视化</a></li>
  <li><a href="#标量与向量场可视化" id="toc-标量与向量场可视化" class="nav-link" data-scroll-target="#标量与向量场可视化"><span class="header-section-number">3.4.7.2</span> 标量与向量场可视化</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./CH1.html">基础知识</a></li><li class="breadcrumb-item"><a href="./CH3.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">环境数据整理与可视化</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">环境数据整理与可视化</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>在环境数据收集以后，需要对其进行整理或清理，特别是要对其中的缺失值、异常值、错误和重复数据等进行检查，并采取相应的处理措施，以保障数据的质量。数据质量存在问题，则后续分析和建模的结果将不再可靠。此外，一些分析和建模方法对缺失值、异常值敏感，如果不进行处理，将会影响分析和建模的结果，甚至不能分析和建模。</p>
<p>原始数据以及整理和分析后的数据往往需要通过<strong>表</strong>特别是<strong>图</strong>进行可视化，从而直观生动地展现数据内在的信息。用不同类型的图形展示数据中不同变量之间的关系，有利于对数据的直观理解，并为分析和建模提供必要信息。特别是高维大数据，噪声和冗余信息过多，不仅增加分析和建模的时间和算力成本，也会影响结果的准确性和可靠性。</p>
<p>本章将学习利用tidyr和dplyr工具包对数据进行整理，并利用ggplot2与其扩展工具包实现数据的可视化。</p>
<section id="环境数据整理" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="环境数据整理"><span class="header-section-number">3.1</span> 环境数据整理</h2>
<section id="tidyr工具包主要函数" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="tidyr工具包主要函数"><span class="header-section-number">3.1.1</span> tidyr工具包主要函数</h3>
<p>tidyr工具包的主要功能是清洗数据集，确保每一列对应一个变量(特征或属性)，每一行对应一个观测(样例或数据点)，每一个单元格对应一个值或元素，即形成整洁(tidy)的数据表。</p>
<section id="长宽表转换" class="level4" data-number="3.1.1.1">
<h4 data-number="3.1.1.1" class="anchored" data-anchor-id="长宽表转换"><span class="header-section-number">3.1.1.1</span> 长宽表转换</h4>
<p><code>pivot_longer()</code>函数的作用在于将分散在不同列的同一个变量的值合并为一列。</p>
<div id="exm-3.1" class="theorem example">
<p><span class="theorem-title"><strong>例 3.1</strong></span> 如 <a href="#tbl-3.1" class="quarto-xref">表&nbsp;<span>3.1</span></a> 所示的数据表(随机生成的伪数据)，是最常见的非tidy数据表，因为PM<sub>10</sub>的浓度数据分散在四个列变量中。为此，需要将四个列变量转换为一列名为Season的字符变量，将所有的数值转换为一列为PM<sub>10</sub>的数值变量，这样清理以后的数据表才是整洁数据表，如 <a href="#tbl-3.2" class="quarto-xref">表&nbsp;<span>3.2</span></a> 所示。</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>pm10 <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">spring =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">6</span>, <span class="dv">50</span>, <span class="dv">10</span>) <span class="sc">*</span> <span class="dv">10</span>),</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">summer =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">6</span>, <span class="dv">25</span>, <span class="dv">5</span>) <span class="sc">*</span> <span class="dv">10</span>),</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">autumn =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">6</span>, <span class="dv">45</span>, <span class="dv">10</span>) <span class="sc">*</span> <span class="dv">10</span>),</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">winter =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">6</span>, <span class="dv">75</span>, <span class="dv">20</span>) <span class="sc">*</span> <span class="dv">10</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div id="tbl-3.1" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-3.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3.1: 一个宽表示例
</figcaption>
<div aria-describedby="tbl-3.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">ID</th>
<th style="text-align: center;">spring</th>
<th style="text-align: center;">summer</th>
<th style="text-align: center;">autumn</th>
<th style="text-align: center;">winter</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">492</td>
<td style="text-align: center;">204</td>
<td style="text-align: center;">506</td>
<td style="text-align: center;">929</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">402</td>
<td style="text-align: center;">300</td>
<td style="text-align: center;">516</td>
<td style="text-align: center;">864</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">312</td>
<td style="text-align: center;">230</td>
<td style="text-align: center;">390</td>
<td style="text-align: center;">668</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">481</td>
<td style="text-align: center;">227</td>
<td style="text-align: center;">520</td>
<td style="text-align: center;">691</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">437</td>
<td style="text-align: center;">266</td>
<td style="text-align: center;">510</td>
<td style="text-align: center;">994</td>
</tr>
<tr class="even">
<td style="text-align: center;">6</td>
<td style="text-align: center;">609</td>
<td style="text-align: center;">229</td>
<td style="text-align: center;">495</td>
<td style="text-align: center;">799</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>利用<code>pivot_long()</code>函数将宽表转换为tidy格式的长表：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>pm10_long <span class="ot">=</span> <span class="fu">pivot_longer</span>(pm10, <span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">names_to =</span> <span class="st">"Season"</span>, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">values_to =</span> <span class="st">"PM10"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div id="tbl-3.2" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-3.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3.2: 转换后的tidy格式长表
</figcaption>
<div aria-describedby="tbl-3.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">ID</th>
<th style="text-align: center;">Season</th>
<th style="text-align: center;">PM10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">spring</td>
<td style="text-align: center;">492</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">summer</td>
<td style="text-align: center;">204</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">autumn</td>
<td style="text-align: center;">506</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">winter</td>
<td style="text-align: center;">929</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">spring</td>
<td style="text-align: center;">402</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">summer</td>
<td style="text-align: center;">300</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">autumn</td>
<td style="text-align: center;">516</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">winter</td>
<td style="text-align: center;">864</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">spring</td>
<td style="text-align: center;">312</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">summer</td>
<td style="text-align: center;">230</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">autumn</td>
<td style="text-align: center;">390</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">winter</td>
<td style="text-align: center;">668</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">spring</td>
<td style="text-align: center;">481</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">summer</td>
<td style="text-align: center;">227</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">autumn</td>
<td style="text-align: center;">520</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">winter</td>
<td style="text-align: center;">691</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">spring</td>
<td style="text-align: center;">437</td>
</tr>
<tr class="even">
<td style="text-align: center;">5</td>
<td style="text-align: center;">summer</td>
<td style="text-align: center;">266</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">autumn</td>
<td style="text-align: center;">510</td>
</tr>
<tr class="even">
<td style="text-align: center;">5</td>
<td style="text-align: center;">winter</td>
<td style="text-align: center;">994</td>
</tr>
<tr class="odd">
<td style="text-align: center;">6</td>
<td style="text-align: center;">spring</td>
<td style="text-align: center;">609</td>
</tr>
<tr class="even">
<td style="text-align: center;">6</td>
<td style="text-align: center;">summer</td>
<td style="text-align: center;">229</td>
</tr>
<tr class="odd">
<td style="text-align: center;">6</td>
<td style="text-align: center;">autumn</td>
<td style="text-align: center;">495</td>
</tr>
<tr class="even">
<td style="text-align: center;">6</td>
<td style="text-align: center;">winter</td>
<td style="text-align: center;">799</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p><code>pivot_wider()</code>函数与<code>pivot_longer()</code>函数功能相反，是将长数据表转换为宽数据表。 以下代码将pm10_long转换为宽表pm10_wide，结果与 <a href="#tbl-3.1" class="quarto-xref">表&nbsp;<span>3.1</span></a> 完全一致：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pm10_wide <span class="ot">=</span> <span class="fu">pivot_wider</span>(pm10_long,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">id_cols =</span> ID,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">names_from =</span> <span class="st">"Season"</span>, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">values_from =</span> <span class="st">"PM10"</span>) </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="列值合并与分割" class="level4" data-number="3.1.1.2">
<h4 data-number="3.1.1.2" class="anchored" data-anchor-id="列值合并与分割"><span class="header-section-number">3.1.1.2</span> 列值合并与分割</h4>
<p>对于 <a href="#tbl-3.3-1" class="quarto-xref">表&nbsp;<span>3.3 (a)</span></a> 所示的数据表中century和year两列，可以通过<code>unite()</code>函数将其合并为一列，合并后的结果如 <a href="#tbl-3.3-2" class="quarto-xref">表&nbsp;<span>3.3 (b)</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>tb <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">country  =</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>],</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">century =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"19"</span>, <span class="st">"20"</span>), <span class="dv">2</span>),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">year =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"99"</span>, <span class="st">"00"</span>), <span class="dv">2</span>))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>tb1 <span class="ot">=</span> <span class="fu">unite</span>(tb, <span class="st">"year"</span>, <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tbl-3.3" class="quarto-layout-panel anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-3.3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3.3: 列值合并操作
</figcaption>
<div aria-describedby="tbl-3.3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.3" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.3-1" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.3-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 合并前数据表
</figcaption>
<div aria-describedby="tbl-3.3-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.3-1" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">country</th>
<th style="text-align: center;">century</th>
<th style="text-align: center;">year</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">A</td>
<td style="text-align: center;">19</td>
<td style="text-align: center;">99</td>
</tr>
<tr class="even">
<td style="text-align: center;">B</td>
<td style="text-align: center;">20</td>
<td style="text-align: center;">00</td>
</tr>
<tr class="odd">
<td style="text-align: center;">C</td>
<td style="text-align: center;">19</td>
<td style="text-align: center;">99</td>
</tr>
<tr class="even">
<td style="text-align: center;">D</td>
<td style="text-align: center;">20</td>
<td style="text-align: center;">00</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.3" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.3-2" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.3-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 合并后数据表
</figcaption>
<div aria-describedby="tbl-3.3-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.3-2" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">country</th>
<th style="text-align: center;">year</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">A</td>
<td style="text-align: center;">1999</td>
</tr>
<tr class="even">
<td style="text-align: center;">B</td>
<td style="text-align: center;">2000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">C</td>
<td style="text-align: center;">1999</td>
</tr>
<tr class="even">
<td style="text-align: center;">D</td>
<td style="text-align: center;">2000</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</div>
</div>
</figure>
</div>
<p><code>separate_wider_*()</code>函数(<code>*</code>为<code>dilim</code>、<code>position</code>或<code>regex</code>)能够将一列中的字符分割为多列。如 <a href="#tbl-3.4-1" class="quarto-xref">表&nbsp;<span>3.4 (a)</span></a> 所示的数据表中，如果需要将x列的数据从下划线处分割：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>tb <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="st">"o3_1h"</span>, <span class="st">"o3_8h"</span>, <span class="st">"co_1h"</span>, <span class="st">"co_8h"</span>))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 以下三个函数操作结果相同</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>tb1 <span class="ot">=</span> tb <span class="sc">%&gt;%</span> <span class="fu">separate_wider_delim</span>(x, <span class="at">delim =</span> <span class="st">"_"</span>, <span class="at">names =</span> <span class="fu">c</span>(<span class="st">"pollutant"</span>, <span class="st">"hour"</span>))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># tb1 = tb %&gt;% separate_wider_position(x, c("pollutant" = 2, 1, "hour" = 2))</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># tb1 = tb %&gt;% separate_wider_regex(x, c("pollutant" = ".*", "_", "hour" = ".*"))</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>分割后的数据表见 <a href="#tbl-3.4-2" class="quarto-xref">表&nbsp;<span>3.4 (b)</span></a> 。</p>
<div id="tbl-3.4" class="quarto-layout-panel anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-3.4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3.4: 列值分割操作
</figcaption>
<div aria-describedby="tbl-3.4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.4" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.4-1" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.4-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 分割前数据表
</figcaption>
<div aria-describedby="tbl-3.4-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.4-1" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">id</th>
<th style="text-align: center;">x</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">o3_1h</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">o3_8h</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">co_1h</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">co_8h</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.4" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.4-2" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.4-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 分割后数据表
</figcaption>
<div aria-describedby="tbl-3.4-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.4-2" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">id</th>
<th style="text-align: center;">pollutant</th>
<th style="text-align: center;">hour</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">o3</td>
<td style="text-align: center;">1h</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">o3</td>
<td style="text-align: center;">8h</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">co</td>
<td style="text-align: center;">1h</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">co</td>
<td style="text-align: center;">8h</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</div>
</div>
</figure>
</div>
<p>如果将x变量中的“co_8h”改为“co_24h”，<code>separate_wider_position()</code>函数就会报错，因为该值的宽度与前面三个值的宽度不同。<code>separate_wider_regex()</code>可以应对更复杂的字符串分割问题，但需要用户掌握正则表达式的语法。学习正则表达式可参阅<a href="https://%20www.runoob.%20com/regexp/regexp-tutorial.html">菜鸟教程网站正则表达式教程</a>。</p>
<p>当数据集中的列值需要分割为多行而不是多列时，可以利用函数<code>separate_longer_dilim()</code>和<code>separate_longer_position()</code>。如 <a href="#tbl-3.5" class="quarto-xref">表&nbsp;<span>3.5</span></a> 所示的两个数据表，变量x的值需要分割为多行。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>tb1 <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"x y"</span>, <span class="st">"x y z"</span>, <span class="cn">NA</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>tb2 <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="st">"ab"</span>, <span class="st">"def"</span>, <span class="st">"bf"</span>,<span class="st">""</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tbl-3.5" class="quarto-layout-panel anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-3.5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3.5: 列值需要分割为多列的数据表
</figcaption>
<div aria-describedby="tbl-3.5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.5" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.5-1" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.5-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 包含空格
</figcaption>
<div aria-describedby="tbl-3.5-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.5-1" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">id</th>
<th style="text-align: center;">x</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">x</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">x y</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">x y z</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">NA</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.5" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.5-2" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.5-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 不含空格
</figcaption>
<div aria-describedby="tbl-3.5-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.5-2" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">id</th>
<th style="text-align: center;">x</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">ab</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">def</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">bf</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</div>
</div>
</figure>
</div>
<p>分别利用<code>separate_longer_delim()</code>和<code>separate_longer_position()</code>对 <a href="#tbl-3.5" class="quarto-xref">表&nbsp;<span>3.5</span></a> 中的两个表进行分割，结果如 <a href="#tbl-3.6" class="quarto-xref">表&nbsp;<span>3.6</span></a> 所示。</p>
<div id="tbl-3.6" class="quarto-layout-panel anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-3.6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3.6: 列值分割为多列后的数据表
</figcaption>
<div aria-describedby="tbl-3.6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.6" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.6-1" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.6-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 包含空格
</figcaption>
<div aria-describedby="tbl-3.6-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.6-1" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">id</th>
<th style="text-align: center;">x</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">x</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">x</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">y</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">x</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">y</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">z</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">NA</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.6" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.6-2" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.6-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 不含空格
</figcaption>
<div aria-describedby="tbl-3.6-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.6-2" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">id</th>
<th style="text-align: center;">x</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">a</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">b</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">d</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">e</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">f</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">b</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">f</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">NA</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</div>
</div>
</figure>
</div>
</section>
<section id="其他操作" class="level4" data-number="3.1.1.3">
<h4 data-number="3.1.1.3" class="anchored" data-anchor-id="其他操作"><span class="header-section-number">3.1.1.3</span> 其他操作</h4>
<p><code>expand()</code>函数可以根据数据表提供的变量生成所有可能的组合。如表 <a href="#tbl-3.7" class="quarto-xref">表&nbsp;<span>3.7</span></a> (a)所示的数据表，并没有显示所有因子与水平的组合。利用<code>expand()</code>进行处理后，结果见 <a href="#tbl-3.7" class="quarto-xref">表&nbsp;<span>3.7</span></a> (b)所示。</p>
<div id="tbl-3.7" class="quarto-layout-panel anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-3.7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3.7: expand()函数的操作
</figcaption>
<div aria-describedby="tbl-3.7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.7" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.7-1" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.7-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 操作前的数据表
</figcaption>
<div aria-describedby="tbl-3.7-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.7-1" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">trt</th>
<th style="text-align: center;">lvl</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">A</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">A</td>
<td style="text-align: center;">2</td>
</tr>
<tr class="odd">
<td style="text-align: center;">B</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">C</td>
<td style="text-align: center;">2</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.7" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.7-2" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.7-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 操作后的数据表
</figcaption>
<div aria-describedby="tbl-3.7-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.7-2" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">trt</th>
<th style="text-align: center;">lvl</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">A</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">A</td>
<td style="text-align: center;">2</td>
</tr>
<tr class="odd">
<td style="text-align: center;">B</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">B</td>
<td style="text-align: center;">2</td>
</tr>
<tr class="odd">
<td style="text-align: center;">C</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">C</td>
<td style="text-align: center;">2</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</div>
</div>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>tb</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  trt     lvl
  &lt;chr&gt; &lt;dbl&gt;
1 A         1
2 A         2
3 B         1
4 C         2</code></pre>
</div>
</div>
<p><code>complete()</code>函数将隐式的缺失值显式化。如 <a href="#tbl-3.8-1" class="quarto-xref">表&nbsp;<span>3.8 (a)</span></a> 所示的数据表，存在隐式的缺失值。通过<code>complete()</code>可以将其显式地呈现出来，结果如 <a href="#tbl-3.8-2" class="quarto-xref">表&nbsp;<span>3.8 (b)</span></a> 所示。</p>
<div id="tbl-3.8" class="quarto-layout-panel anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-3.8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3.8: complete()函数的操作
</figcaption>
<div aria-describedby="tbl-3.8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.8" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.8-1" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.8-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 操作前的数据表
</figcaption>
<div aria-describedby="tbl-3.8-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.8-1" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">grp</th>
<th style="text-align: center;">sam_id</th>
<th style="text-align: center;">sam_name</th>
<th style="text-align: center;">conc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;">5</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">B</td>
<td style="text-align: center;">8</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">B</td>
<td style="text-align: center;">10</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.8" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.8-2" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.8-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 操作后的数据表
</figcaption>
<div aria-describedby="tbl-3.8-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.8-2" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">grp</th>
<th style="text-align: center;">sam_id</th>
<th style="text-align: center;">sam_name</th>
<th style="text-align: center;">conc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;">5</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">B</td>
<td style="text-align: center;">8</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">B</td>
<td style="text-align: center;">10</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</div>
</div>
</figure>
</div>
<p><code>drop_na()</code>函数提供了最简单的处理缺失值的方式：删除包含缺失值的行。而<code>fill()</code>函数则提供了利用前值和/或后值填补缺失值的方法。以下代码分别利用<code>drop_na()</code>和<code>fill()</code>删除和填补airquality数据集中的NA值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 删除NA值前</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>airquality[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Ozone           Solar.R     
 Min.   :  1.00   Min.   :  7.0  
 1st Qu.: 18.00   1st Qu.:115.8  
 Median : 31.50   Median :205.0  
 Mean   : 42.13   Mean   :185.9  
 3rd Qu.: 63.25   3rd Qu.:258.8  
 Max.   :168.00   Max.   :334.0  
 NA's   :37       NA's   :7      </code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 删除NA值</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>airquality[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(Ozone, Solar.R) <span class="sc">%&gt;%</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Ozone          Solar.R     
 Min.   :  1.0   Min.   :  7.0  
 1st Qu.: 18.0   1st Qu.:113.5  
 Median : 31.0   Median :207.0  
 Mean   : 42.1   Mean   :184.8  
 3rd Qu.: 62.0   3rd Qu.:255.5  
 Max.   :168.0   Max.   :334.0  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 填补NA值</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>airquality[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(Ozone, Solar.R, <span class="at">.direction =</span> <span class="st">"up"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Ozone          Solar.R     
 Min.   :  1.0   Min.   :  7.0  
 1st Qu.: 20.0   1st Qu.:118.0  
 Median : 31.0   Median :213.0  
 Mean   : 46.8   Mean   :188.1  
 3rd Qu.: 71.0   3rd Qu.:259.0  
 Max.   :168.0   Max.   :334.0  </code></pre>
</div>
</div>
<p>R用<code>NA</code>表示缺失值，但其他数据处理软件可能采用不同的缺失值符号，<code>replace_na()</code>函数提供了修改缺失值符号的功能。下面的代码将airquality数据集中Ozone的缺失值修改为-99999。在修改缺失值符号时需要注意变量的数据类型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace_na</span>(<span class="fu">list</span>(<span class="at">Ozone =</span> <span class="sc">-</span><span class="dv">99999</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Ozone           Solar.R           Wind             Temp      
 Min.   :-99999   Min.   :  7.0   Min.   : 1.700   Min.   :56.00  
 1st Qu.:     4   1st Qu.:115.8   1st Qu.: 7.400   1st Qu.:72.00  
 Median :    21   Median :205.0   Median : 9.700   Median :79.00  
 Mean   :-24151   Mean   :185.9   Mean   : 9.958   Mean   :77.88  
 3rd Qu.:    46   3rd Qu.:258.8   3rd Qu.:11.500   3rd Qu.:85.00  
 Max.   :   168   Max.   :334.0   Max.   :20.700   Max.   :97.00  
                  NA's   :7                                       
     Month            Day      
 Min.   :5.000   Min.   : 1.0  
 1st Qu.:6.000   1st Qu.: 8.0  
 Median :7.000   Median :16.0  
 Mean   :6.993   Mean   :15.8  
 3rd Qu.:8.000   3rd Qu.:23.0  
 Max.   :9.000   Max.   :31.0  
                               </code></pre>
</div>
</div>
</section>
</section>
<section id="dplyr工具包主要函数" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="dplyr工具包主要函数"><span class="header-section-number">3.1.2</span> dplyr工具包主要函数</h3>
<p>dplyr为数据框类型数据的整理提供了统一且高效的操作函数，提供了包括行列选择、行列合并、排序、列操作(创建、修改和删除)、分组汇总统计等。</p>
<section id="选择列" class="level4" data-number="3.1.2.1">
<h4 data-number="3.1.2.1" class="anchored" data-anchor-id="选择列"><span class="header-section-number">3.1.2.1</span> 选择列</h4>
<p><code>select()</code>函数可以根据位置、列名和条件选择等多种方式从数据中选择列。下面的代码演示<code>select()</code>函数对airquality数据集进行列选择：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 按列位置选择列</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%&gt;%</span>   </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Ozone Solar.R Wind
1    41     190  7.4
2    36     118  8.0
3    12     149 12.6
4    18     313 11.5
5    NA      NA 14.3
6    28      NA 14.9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 按列位置选择列</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="dv">1</span>, <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Ozone Wind Temp Month
1    41  7.4   67     5
2    36  8.0   72     5
3    12 12.6   74     5
4    18 11.5   62     5
5    NA 14.3   56     5
6    28 14.9   66     5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 按列位置列表选择列</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>)) <span class="sc">%&gt;%</span>   </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Ozone Wind Month
1    41  7.4     5
2    36  8.0     5
3    12 12.6     5
4    18 11.5     5
5    NA 14.3     5
6    28 14.9     5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 按列名范围选择列</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">select</span>(Month, Day) <span class="sc">%&gt;%</span>  </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Month Day
1     5   1
2     5   2
3     5   3
4     5   4
5     5   5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 按列名范围选择列</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">select</span>(Temp<span class="sc">:</span>Day) <span class="sc">%&gt;%</span>   </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Temp Month Day
1   67     5   1
2   72     5   2
3   74     5   3
4   62     5   4
5   56     5   5
6   66     5   6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 按列名列表范围选择列</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(Ozone, Temp, Month)) <span class="sc">%&gt;%</span>   </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Ozone Temp Month
1    41   67     5
2    36   72     5
3    12   74     5
4    18   62     5
5    NA   56     5
6    28   66     5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 按列名包含字符选择列</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">"o"</span>)) <span class="sc">%&gt;%</span>   </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Ozone Solar.R Month
1    41     190     5
2    36     118     5
3    12     149     5
4    18     313     5
5    NA      NA     5
6    28      NA     5</code></pre>
</div>
</div>
<p>tidyselect包提供以下功能函数，可以提高列选择操作的效率：</p>
<ul>
<li><code>contains()</code>、<code>starts_with()</code>、<code>ends_with()</code>函数: 通过指定列名包含字符、开始字符和结束字符的条件来选择列；</li>
<li><code>matchs()</code>函数: 通过匹配指定正则表达式的条件来选择列；</li>
<li><code>num_range()</code>函数: 通过指定范围来选择列，用于以字符前缀+数字序号的列名(如x1、x2、x3等)；</li>
<li><code>all_of()</code>和<code>any_of()</code>函数: 从指定的列名列表中选择列，前者会进行列名匹配检查(如果数据集中没有列表中的列名，会报错)，而后者不进行列名匹配检查；</li>
<li><code>everything()</code>函数: 指定所有的列；</li>
<li><code>last_col()</code>函数: 指定最后一列；</li>
<li><code>where()</code>函数: 根据函数返回的逻辑值来选择列。</li>
</ul>
</section>
<section id="行选择" class="level4" data-number="3.1.2.2">
<h4 data-number="3.1.2.2" class="anchored" data-anchor-id="行选择"><span class="header-section-number">3.1.2.2</span> 行选择</h4>
<p><code>slice()</code>和<code>filter()</code>是两个最常用的行选择函数。下面的代码演示这两个函数对airquality数据集进行行选择：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)  <span class="co"># 按行位置选择行</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Ozone Solar.R Wind Temp Month Day
1    41     190  7.4   67     5   1
2    36     118  8.0   72     5   2
3    12     149 12.6   74     5   3
4    18     313 11.5   62     5   4
5    NA      NA 14.3   56     5   5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">10</span>)  <span class="co"># 按行位置选择行</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Ozone Solar.R Wind Temp Month Day
1    41     190  7.4   67     5   1
2    12     149 12.6   74     5   3
3    NA      NA 14.3   56     5   5
4    NA     194  8.6   69     5  10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(Month <span class="sc">==</span> <span class="dv">7</span>, Day <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>))  <span class="co"># 按指定条件选择行</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Ozone Solar.R Wind Temp Month Day
1   135     269  4.1   84     7   1
2    49     248  9.2   85     7   2
3    32     236  9.2   81     7   3
4    NA     101 10.9   84     7   4
5    64     175  4.6   83     7   5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(Month <span class="sc">&gt;</span> <span class="dv">7</span>, Day <span class="sc">&lt;=</span> <span class="dv">3</span>)  <span class="co"># 按指定条件选择行</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Ozone Solar.R Wind Temp Month Day
1    39      83  6.9   81     8   1
2     9      24 13.8   81     8   2
3    16      77  7.4   82     8   3
4    96     167  6.9   91     9   1
5    78     197  5.1   92     9   2
6    73     183  2.8   93     9   3</code></pre>
</div>
</div>
<p><code>filter()</code>函数中的条件表达式可充分运用关系运算符、逻辑运算符以及类似<code>between()</code>、<code>is.na()</code>、<code>near()</code>这样的条件判断函数等。</p>
<p><code>slice_head()</code>和<code>slice_tail()</code>函数分别用于选择指定头部和尾部的行数，类似于Base-R中的<code>head()</code>和<code>tail()</code>两个函数，<code>slice_min()</code>和<code>slice_max()</code>函数分别选择指定列的最小值和最大值所在的行(通过参数n可指定根据最小值和最大值依次排序的行数)，<code>slice_sample()</code>函数用于随机抽取指定行数的行。</p>
</section>
<section id="列操作" class="level4" data-number="3.1.2.3">
<h4 data-number="3.1.2.3" class="anchored" data-anchor-id="列操作"><span class="header-section-number">3.1.2.3</span> 列操作</h4>
<p><code>mutate()</code>函数可创建新的列、修改现有的列(列名与已有列名相同)和删除指定的列(设置列值为<code>NULL</code>)。下面的代码演示<code>mutate()</code>对airqulity数据集进行各种列的操作：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 选择前20行</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 根据Temp(华氏温度)计算摄氏温度并创建Temp_c</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Temp_C =</span> <span class="fu">round</span>((Temp <span class="sc">-</span> <span class="dv">32</span>)<span class="sc">/</span><span class="fl">1.8</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 计算Ozone与Temp的比值并创建新列Ratio</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ratio =</span> <span class="fu">round</span>(Ozone<span class="sc">/</span>Temp_C, <span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 创建新列ID</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 将ID和Ratio列设置为第一和第二列</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(ID, Ratio, <span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 删除Temp列</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Temp =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 修改现有列：将Month和Day列有序因子化</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Month =</span> <span class="fu">ordered</span>(Month),</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">Day =</span> <span class="fu">ordered</span>(Day))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   ID Ratio Ozone Solar.R Wind Month Day Temp_C
1   1  2.11    41     190  7.4     5   1  19.44
2   2  1.62    36     118  8.0     5   2  22.22
3   3  0.51    12     149 12.6     5   3  23.33
4   4  1.08    18     313 11.5     5   4  16.67
5   5    NA    NA      NA 14.3     5   5  13.33
6   6  1.48    28      NA 14.9     5   6  18.89
7   7  1.25    23     299  8.6     5   7  18.33
8   8  1.27    19      99 13.8     5   8  15.00
9   9  0.50     8      19 20.1     5   9  16.11
10 10    NA    NA     194  8.6     5  10  20.56</code></pre>
</div>
</div>
<p>实际上，以上多个<code>mutate()</code>的操作可以合并为一个<code>mutate()</code>函数的操作，但是要注意操作的顺序，避免冲突，例如创建Temp_C列必须在创建Ratio列之前，删除Temp列必须在创建Temp_C列之后：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Temp_C =</span> <span class="fu">round</span>((Temp <span class="sc">-</span> <span class="dv">32</span>)<span class="sc">/</span><span class="fl">1.8</span>, <span class="dv">2</span>),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">Ratio =</span> <span class="fu">round</span>(Ozone<span class="sc">/</span>Temp_C, <span class="dv">2</span>),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.),</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">Temp =</span> <span class="cn">NULL</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">Month =</span> <span class="fu">ordered</span>(Month),</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">Day =</span> <span class="fu">ordered</span>(Day)) <span class="sc">%&gt;%</span> </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(ID, Ratio, <span class="fu">everything</span>())</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   ID Ratio Ozone Solar.R Wind Month Day Temp_C
1   1  2.11    41     190  7.4     5   1  19.44
2   2  1.62    36     118  8.0     5   2  22.22
3   3  0.51    12     149 12.6     5   3  23.33
4   4  1.08    18     313 11.5     5   4  16.67
5   5    NA    NA      NA 14.3     5   5  13.33
6   6  1.48    28      NA 14.9     5   6  18.89
7   7  1.25    23     299  8.6     5   7  18.33
8   8  1.27    19      99 13.8     5   8  15.00
9   9  0.50     8      19 20.1     5   9  16.11
10 10    NA    NA     194  8.6     5  10  20.56</code></pre>
</div>
</div>
</section>
<section id="数据集拼接" class="level4" data-number="3.1.2.4">
<h4 data-number="3.1.2.4" class="anchored" data-anchor-id="数据集拼接"><span class="header-section-number">3.1.2.4</span> 数据集拼接</h4>
<p><code>inner_join()</code>、<code>left_join()</code>、<code>right_join()</code>和<code>full_join()</code>等函数可以将两个数据按特定方式进行合并。下面的代码演示这四个函数对两个数据集的拼接操作：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">5</span>) <span class="sc">*</span> <span class="dv">10</span>, <span class="dv">2</span>),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> x1<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">trt =</span> <span class="fu">sample</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="dv">5</span>, <span class="at">replace =</span> T)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>,</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">8</span>, <span class="dv">5</span>, <span class="dv">1</span>), <span class="dv">2</span>),</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">trt =</span> <span class="fu">sample</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="dv">8</span>, <span class="at">replace =</span> T)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 内拼接</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="fu">inner_join</span>(x, y, <span class="at">by =</span> <span class="st">"trt"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
   ID.x    x1    x2 trt    ID.y    y1
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;int&gt; &lt;dbl&gt;
1     4 -1.86  2.46 e         5  4.37
2     5 -6.33 39.1  h         1  4.92
3     5 -6.33 39.1  h         6  6.09</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 左拼接</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(x, y, <span class="at">by =</span> <span class="st">"trt"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
   ID.x     x1      x2 trt    ID.y    y1
  &lt;int&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;int&gt; &lt;dbl&gt;
1     1  -0.84  -0.294 a        NA NA   
2     2  -9.83  95.6   a        NA NA   
3     3 -18.8  351.    a        NA NA   
4     4  -1.86   2.46  e         5  4.37
5     5  -6.33  39.1   h         1  4.92
6     5  -6.33  39.1   h         6  6.09</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 右拼接</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">right_join</span>(x, y, <span class="at">by =</span> <span class="st">"ID"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 6
     ID     x1      x2 trt.x    y1 trt.y
  &lt;int&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;
1     1  -0.84  -0.294 a      4.92 h    
2     2  -9.83  95.6   a      4.02 b    
3     3 -18.8  351.    a      3.12 c    
4     4  -1.86   2.46  e      4.81 d    
5     5  -6.33  39.1   h      4.37 e    
6     6  NA     NA     &lt;NA&gt;   6.09 h    
7     7  NA     NA     &lt;NA&gt;   4.09 i    
8     8  NA     NA     &lt;NA&gt;   6    g    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 全拼接</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">full_join</span>(x, y)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(ID, trt)`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 5
      ID     x1      x2 trt      y1
   &lt;int&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;
 1     1  -0.84  -0.294 a     NA   
 2     2  -9.83  95.6   a     NA   
 3     3 -18.8  351.    a     NA   
 4     4  -1.86   2.46  e     NA   
 5     5  -6.33  39.1   h     NA   
 6     1  NA     NA     h      4.92
 7     2  NA     NA     b      4.02
 8     3  NA     NA     c      3.12
 9     4  NA     NA     d      4.81
10     5  NA     NA     e      4.37
11     6  NA     NA     h      6.09
12     7  NA     NA     i      4.09
13     8  NA     NA     g      6   </code></pre>
</div>
</div>
<p><code>semi_join()</code>和<code>anti_join()</code>函数根据与第二个数据集匹配的列值来选择第一个数据集中的行，可以视为一种行选择操作。例如以下的操作：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">semi_join</span>(x, y, <span class="at">by =</span> <span class="st">"trt"</span>)  <span class="co"># 选择x中与y中trt列匹配的行</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
     ID    x1    x2 trt  
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;
1     4 -1.86  2.46 e    
2     5 -6.33 39.1  h    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anti_join</span>(x, y, <span class="at">by =</span> <span class="st">"trt"</span>)  <span class="co"># 选择x中与y中trt列不匹配的行</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
     ID     x1      x2 trt  
  &lt;int&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;
1     1  -0.84  -0.294 a    
2     2  -9.83  95.6   a    
3     3 -18.8  351.    a    </code></pre>
</div>
</div>
<p><code>bind_cols()</code>函数对多个等函数的数据集进行列合并，<code>bind_rows()</code>函数对多个数据集进行行合并。以下代码演示了这两个函数的操作：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">y =</span> letters[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">z =</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(df1, df2)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `x` -&gt; `x...1`
• `x` -&gt; `x...3`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  x...1 y     x...3     z
  &lt;int&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt;
1     1 b         1     6
2     2 c         2     7
3     3 d         3     8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(df1, df2)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
      x y         z
  &lt;int&gt; &lt;chr&gt; &lt;int&gt;
1     1 b        NA
2     2 c        NA
3     3 d        NA
4     1 &lt;NA&gt;      6
5     2 &lt;NA&gt;      7
6     3 &lt;NA&gt;      8</code></pre>
</div>
</div>
</section>
<section id="分组汇总统计" class="level4" data-number="3.1.2.5">
<h4 data-number="3.1.2.5" class="anchored" data-anchor-id="分组汇总统计"><span class="header-section-number">3.1.2.5</span> 分组汇总统计</h4>
<p><code>summarise()</code>函数与<code>group_by()</code>协作可实现对一个或多个列变量执行分组汇总统计。以下代码根据Month变量分组，分别统计Ozone、Solar.R、Temp、Wind变量的月均值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Month) <span class="sc">%&gt;%</span> </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">ozone_mean =</span> <span class="fu">mean</span>(Ozone, <span class="at">na.rm =</span> T),</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">Solar.R_mean =</span> <span class="fu">mean</span>(Solar.R, <span class="at">na.rm =</span> T),</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">Temp_mean =</span> <span class="fu">mean</span>(Temp, <span class="at">na.rm =</span> T),</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">Wind_mean =</span> <span class="fu">mean</span>(Wind, <span class="at">na.rm =</span> T))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  Month ozone_mean Solar.R_mean Temp_mean Wind_mean
  &lt;int&gt;      &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1     5       23.6         181.      65.5     11.6 
2     6       29.4         190.      79.1     10.3 
3     7       59.1         216.      83.9      8.94
4     8       60.0         172.      84.0      8.79
5     9       31.4         167.      76.9     10.2 </code></pre>
</div>
</div>
<p>如果采用<code>across()</code>函数，则更简洁：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Month) <span class="sc">%&gt;%</span> </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="at">.cols =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,   <span class="co"># 用位置或列名选择列</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">.fns =</span> mean, <span class="at">na.rm =</span> T,  <span class="co"># 函数或函数列表，可以加上函数的参数设置</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">.names =</span> <span class="st">"{.col}_mean"</span>))  <span class="co"># 设置列名，{.col}表示引用原列名</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  Month Ozone_mean Solar.R_mean Wind_mean Temp_mean
  &lt;int&gt;      &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1     5       23.6         181.     11.6       65.5
2     6       29.4         190.     10.3       79.1
3     7       59.1         216.      8.94      83.9
4     8       60.0         172.      8.79      84.0
5     9       31.4         167.     10.2       76.9</code></pre>
</div>
</div>
<p><code>across()</code>函数还可以对选定的列应用多个函数：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> <span class="sc">~</span><span class="fu">mean</span>(.x, <span class="at">na.rm =</span> T),</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="sc">~</span><span class="fu">sd</span>(.x, <span class="at">na.rm =</span> T))</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Month) <span class="sc">%&gt;%</span> </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="fu">across</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, fn))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  Month Ozone_mean Ozone_sd Solar.R_mean Solar.R_sd
  &lt;int&gt;      &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;
1     5       23.6     22.2         181.      115. 
2     6       29.4     18.2         190.       92.9
3     7       59.1     31.6         216.       80.6
4     8       60.0     39.7         172.       76.8
5     9       31.4     24.1         167.       79.1</code></pre>
</div>
</div>
<p>当应用多个函数时，结果列的名称默认为<code>{.col}_{.fn}</code>。函数列表中函数为匿名函数时采用purrr包中匿名函数的形式，即用<code>~</code>替代<code>function(.x)</code>，如果直接引用函数，则无需加<code>~</code>，直接引用函数名(不加后面的括号，如<code>mean</code>)：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> mean,  <span class="co"># 不能是mean =  mean()</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> sd)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Month) <span class="sc">%&gt;%</span> </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="at">.cols =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, </span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">.fns =</span> fn, <span class="at">na.rm =</span> T))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  Month Ozone_mean Ozone_sd Solar.R_mean Solar.R_sd
  &lt;int&gt;      &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;
1     5       23.6     22.2         181.      115. 
2     6       29.4     18.2         190.       92.9
3     7       59.1     31.6         216.       80.6
4     8       60.0     39.7         172.       76.8
5     9       31.4     24.1         167.       79.1</code></pre>
</div>
</div>
<p><code>summarise()</code>、<code>mutate()</code>与<code>rowwise()</code>协作可实现对行观测的分组汇总统计，前者只返回汇总统计结果，而后者默认返回原始数据与行观测统计结果合并的列(可以通过该函数中参数.keep来改变)。以下代码创建了一个5行×4列的数值变量，然后分别用<code>summarise()</code>和<code>mutate()</code>按行计算均值、标准差与加和：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">nrow =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(<span class="fu">c_across</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)),</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> <span class="fu">sd</span>(<span class="fu">c_across</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)),</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">sum =</span> <span class="fu">sum</span>(<span class="fu">c_across</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
   mean    sd   sum
  &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
1   8.5  6.45    34
2   9.5  6.45    38
3  10.5  6.45    42
4  11.5  6.45    46
5  12.5  6.45    50</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">nrow =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean =</span> <span class="fu">mean</span>(<span class="fu">c_across</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)),</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">sd =</span> <span class="fu">sd</span>(<span class="fu">c_across</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)),</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">sum =</span> <span class="fu">sum</span>(<span class="fu">c_across</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
# Rowwise: 
     V1    V2    V3    V4  mean    sd   sum
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
1     1     6    11    16   8.5  6.45    34
2     2     7    12    17   9.5  6.45    38
3     3     8    13    18  10.5  6.45    42
4     4     9    14    19  11.5  6.45    46
5     5    10    15    20  12.5  6.45    50</code></pre>
</div>
</div>
<p>上面代码中的<code>c_across()</code>函数用于配合<code>rowwise()</code>函数来选择列变量，是结合函数<code>c()</code>的扩展，遵循tidyr包的语法。</p>
</section>
<section id="其他操作-1" class="level4" data-number="3.1.2.6">
<h4 data-number="3.1.2.6" class="anchored" data-anchor-id="其他操作-1"><span class="header-section-number">3.1.2.6</span> 其他操作</h4>
<p><code>arrange()</code>函数可根据指定的一个或多个列对行进行升序排列，降序则需要使用<code>desc()</code>函数：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Ozone, Month) <span class="sc">%&gt;%</span>   <span class="co"># 按Ozone和Month变量升序重新排序</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Ozone Solar.R Wind Temp Month Day
1     1       8  9.7   59     5  21
2     4      25  9.7   61     5  23
3     6      78 18.4   57     5  18
4     7      NA  6.9   74     5  11
5     7      48 14.3   80     7  15
6     7      49 10.3   69     9  24</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Ozone), Month) <span class="sc">%&gt;%</span>   <span class="co"># 按Ozone变量降序和Month变量升序重新排序</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Ozone Solar.R Wind Temp Month Day
1   168     238  3.4   81     8  25
2   135     269  4.1   84     7   1
3   122     255  4.0   89     8   7
4   118     225  2.3   94     8  29
5   115     223  5.7   79     5  30
6   110     207  8.0   90     8   9</code></pre>
</div>
</div>
<p><code>relocate()</code>函数可调整列的位置：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(Month, Day, <span class="fu">everything</span>()) <span class="sc">%&gt;%</span>   <span class="co"># 将Month和Day列调整为第一列和第二列</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Month Day Ozone Solar.R Wind Temp
1     5   1    41     190  7.4   67
2     5   2    36     118  8.0   72
3     5   3    12     149 12.6   74
4     5   4    18     313 11.5   62
5     5   5    NA      NA 14.3   56
6     5   6    28      NA 14.9   66</code></pre>
</div>
</div>
</section>
</section>
<section id="错误和重复数据的处理" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="错误和重复数据的处理"><span class="header-section-number">3.1.3</span> 错误和重复数据的处理</h3>
<p>数据出现错误往往是在原始数据记录环节和计算机输入环节因人为原因导致，也有可能是测量阶段因方法错误、仪器故障等原因导致。对原始数据采用逻辑检查和计算检查，往往可以发现错误数据，如污染物浓度出现负数，用水总量低于新鲜用水量等，合计数据小于其分项数据，汇总的数据单位不一致等。发现错误数据后，应先溯源，看能否找到正确值，如不能找到正确值，应先以缺失值(<code>NA</code>)替代。要注意，一些分析仪器的检测结果可能因低于方法检测限(Method Detect Limit，MDL)而出现ND(Not Detect)数据，这不属于缺失值，也不是错误值，一般可以用0替代来进行处理。</p>
<p>以下代码演示了用0替代ND值、用NA替代负值的操作，处理前后的结果分别见表3.15和表3.16。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>),</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">conc =</span> <span class="fu">c</span>(<span class="fl">2.3</span>, <span class="fl">4.5</span>, <span class="fl">1.4</span>, <span class="fl">4.0</span>, <span class="st">"ND"</span>, <span class="sc">-</span><span class="fl">2.3</span>, <span class="st">"ND"</span>, <span class="fl">6.3</span>)) </span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 有ND字符，强制为字符型数据</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">=</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="dv">2</span>, <span class="sc">~</span><span class="fu">replace</span>(.x, .x <span class="sc">==</span> <span class="st">"ND"</span>, <span class="st">"0"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="dv">2</span>, as.numeric)) <span class="sc">%&gt;%</span> </span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="dv">2</span>, <span class="sc">~</span><span class="fu">replace</span>(.x, .x <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="cn">NA</span>)))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tbl-3.9" class="quarto-layout-panel anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-3.9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3.9: 异常值处理
</figcaption>
<div aria-describedby="tbl-3.9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.9" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.9-1" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.9-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 处理前的数据表
</figcaption>
<div aria-describedby="tbl-3.9-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.9-1" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">id</th>
<th style="text-align: center;">conc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">2.3</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">4.5</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.4</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">4</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">ND</td>
</tr>
<tr class="even">
<td style="text-align: center;">6</td>
<td style="text-align: center;">-2.3</td>
</tr>
<tr class="odd">
<td style="text-align: center;">7</td>
<td style="text-align: center;">ND</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">6.3</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.9" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.9-2" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.9-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 处理后的数据表
</figcaption>
<div aria-describedby="tbl-3.9-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.9-2" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">id</th>
<th style="text-align: center;">conc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">2.3</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">4.5</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.4</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">4.0</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: center;">6</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: center;">7</td>
<td style="text-align: center;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">6.3</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</div>
</div>
</figure>
</div>
<p><code>distinct()</code>函数用于删除数据框中的重复。行对于重复数据，需要严格确认方可删除，以免造成失误。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>),</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">conc =</span> <span class="fu">c</span>(<span class="fl">2.3</span>,<span class="fl">3.2</span>,<span class="fl">1.4</span>,<span class="fl">4.6</span>,<span class="fl">6.8</span>,<span class="fl">2.3</span>,<span class="fl">4.5</span>))</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">=</span> <span class="fu">distinct</span>(df)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tbl-3.10" class="quarto-layout-panel anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-3.10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3.10: 重复值处理操作
</figcaption>
<div aria-describedby="tbl-3.10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.10" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.10-1" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.10-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 处理前的数据表
</figcaption>
<div aria-describedby="tbl-3.10-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.10-1" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">id</th>
<th style="text-align: center;">conc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">2.3</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">3.2</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.4</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">4.6</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">6.8</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">2.3</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">4.5</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-3.10" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-3.10-2" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-3.10-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 处理后的数据表
</figcaption>
<div aria-describedby="tbl-3.10-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-3.10-2" class="do-not-create-environment table">
<thead>
<tr class="header">
<th style="text-align: center;">id</th>
<th style="text-align: center;">conc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">2.3</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">3.2</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.4</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">4.6</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">6.8</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">4.5</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</div>
</div>
</figure>
</div>
</section>
<section id="缺失值的识别与处理" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="缺失值的识别与处理"><span class="header-section-number">3.1.4</span> 缺失值的识别与处理</h3>
<p>对于大数据而言，数据缺失是比较常见的现象，数据缺失可能出现在采集、记录、输入等环节，包括人为错误、机器故障、无法获取或代价太大而放弃获取等。有些缺失数据可通过再次调查和实验来重新获取，但多数情况下无法重新获取准确的数据，尤其是具有时间属性的数据。</p>
<p>数据缺失一般可分为三种模式：第一种是完全随机缺失(MCAR)，即数据缺失是完全随机的，不影响样本的无偏性，数据丢失的概率与不完全变量(存在缺失值的变量)本身和其他完全变量(没有缺失值的变量)都无关。这种情况下，缺失数据可以通过一些方法基于已知变量来估计。该类型缺失值对统计分析的影响可忽略。第二种是随机缺失(MAR)，即数据缺失不是完全随机的，缺失数据的概率与不完全变量本身无关，而与其他完全变量有关。例如只对重点污染源收集环保投资数据，则非重点污染源的环保投资数据出现缺失。该模式的缺失值对统计分析的影响也可忽略。第三种是非随机缺失(MNAR)，即数据缺失不是随机的，缺失数据的概率只与不完全变量本身有关，而与其他完全变量无关。例如某几个企业生产的某类产品因污染排放不达标被勒令停止生产，因此，这几个企业的该类产品污染数据缺失。该类型缺失值对统计分析的影响不可忽略。</p>
<section id="缺失值的识别" class="level4" data-number="3.1.4.1">
<h4 data-number="3.1.4.1" class="anchored" data-anchor-id="缺失值的识别"><span class="header-section-number">3.1.4.1</span> 缺失值的识别</h4>
<p>R提供了<code>is.na()</code>函数来识别向量、矩阵、数据框中是否存在NA值，并在相应位置返回逻辑值TRUE或FLASE。也可用<code>complete.cases()</code>函数检查数据框中行数据是否完整(有缺失则不完整，返回FALSE)。对于数据框，可以采用VIM包对缺失值进行可视化和填补。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(VIM)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>airquality <span class="sc">%&gt;%</span> <span class="fu">aggr</span>(<span class="at">numbers =</span> <span class="cn">TRUE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.1-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.1: 用VIM包对缺失数据进行可视化
</figcaption>
</figure>
</div>
</div>
</div>
<p>显然，<code>aggr()</code>函数通过 <a href="#fig-3.1" class="quarto-xref">图&nbsp;<span>3.1</span></a> 左图指出缺失数据集中在Ozone和Solar.R两个变量中，并通过右图给出了具体的缺失比例。VIM还提供了<code>barMiss()</code>、<code>scattMiss()</code>、<code>histMiss()</code>、<code>matrixplot()</code>、<code>marginplot()</code>、<code>marginmatirx()</code>等多个可视化函数。</p>
<p>naniar包是一个更专业的处理缺失值的工具包，功能更全面，包括丰富的可视化与填补功能，其可视化基于ggplot2，具有与tidyverse一致的tidy风格。naniar包中的<code>vis_miss()</code>(调用visdat包中的同名函数)和<code>gg_miss_*()</code>系列函数提供了丰富的缺失值可视化功能。<a href="#fig-3.2" class="quarto-xref">图&nbsp;<span>3.2</span></a> 为naniar包对airquality数据集中缺失值的可视化探索。</p>
<div class="cell" data-layout-nrow="2">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="fu">vis_miss</span>(airquality)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="fu">gg_miss_upset</span>(airquality)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.2" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.2" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-3.2-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.2-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.2-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.2" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.2-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) vis_miss()可视化图形
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.2" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-3.2-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.2-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.2-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.2" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.2-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) gg_miss_upset()可视化图形
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.2: 用naniar对缺失值进行可视化
</figcaption>
</figure>
</div>
</div>
</section>
<section id="缺失值的处理" class="level4" data-number="3.1.4.2">
<h4 data-number="3.1.4.2" class="anchored" data-anchor-id="缺失值的处理"><span class="header-section-number">3.1.4.2</span> 缺失值的处理</h4>
<p>缺失数据的处理方法包括<strong>不处理</strong>、<strong>删除</strong>和<strong>填补</strong>三种方法。有些分析方法和模型(如基于决策树的模型)对数据缺失不敏感，所以无需删除。当数据量很大时，或缺失比例很小时，或缺失数据在不重要的变量中，可以删除缺失值或不重要的变量；当数据量很少时，或缺失比例很大时，或所属变量为重要变量，删除缺失数据会减少信息，从而影响分析和建模。在必要且符合条件的情况下，可以对缺失数据采取合理的方法进行填补，包括单一填补和多重填补。对于进行缺失值填补后的数据，尽量避免采用距离度量相关的分析方法和模型(如支持向量机SVM、K最近邻模型KNN等)。对于MNAR模式的缺失数据进行填补要特别谨慎，可考虑采用模型预测法填补。填补缺失值之前，需要先明确缺失模式；采用填补方法之前，需要先明确填补方法的使用前提。</p>
<p>(1)删除缺失值</p>
<p>R中<code>na.omit()</code>函数可以用于删除数据集中的缺失数据(对于矩阵和数据框，则删除包含缺失值的行)。tidyr中的<code>drop_na()</code>函数用于删除数据框中包含缺失值的行。对于airquality数据集，原本有153行，执行<code>na.omit(airquality)</code>或<code>drop_na(airquality)</code>后，将删除含有缺失值的42行数据，剩下111行完整数据。<code>drop_na()</code>可以指定包含缺失值的列来选择性删除。</p>
<p>(2)填补缺失值 对于MCAR和MAR模式的缺失值，可以用单一填补法或多重填补法进行填补。 常见的单一填补法包括均值(平均数、中位数、众数)填补、热卡(Hot-Deck)填补(在数据集中找到一个与缺失值最相似的对象并以此来填补，但相似标准很难界定)、K-Means聚类填充(用聚类后的同类均值填补)、KNN填充(用距离最近的若干个同类投票或取均值来填充)等。 多重填补法通常是利用数据集中其他变量来建立缺失变量的预测模型，如多元回归模型、极大似然估计、随机森林模型等。缺失值预测模型可以给出缺失值的单个预测填补值和多重预测填补值，后者为每一个缺失值给出多个填补值，符合缺失值的不确定性，然后对多个填补值根据评分函数来选择，以获得最佳的填补值。</p>
<p>VIM包提供了多种填补方法：基于迭代鲁棒模型填充<code>irmi()</code>、热卡填充<code>hotdeck()</code>、K-最近邻填充<code>kNN()</code>、基于分类变量的快速匹配填充<code>matchImpute()</code>、随机森林填充<code>rangerImpute()</code>和回归模型填充<code>regressionImp()</code>。naniar包提供了<code>impute_below()</code>、<code>impute_mean()</code>、<code>impute_median()</code>等系列函数，来填补缺失值。simputation包整合了较为丰富的缺失值填补方法，语法简单且统一，易于使用。</p>
<p>mice是一个对缺失值进行诊断和多重填补的专业工具包，提供了20多种填补方法，所有的方法都可以通过<code>mice()</code>来调用，而且支持自定义填补方法。该函数默认为缺失数据生成5套填补值，但有些方法如“mean”生成的5套填补值都是相同的。mice中的<code>with()</code>和<code>pool()</code>函数可以对所有填补集进行分析(如建模) 并合并各个填补集的分析结果；<code>complete()</code>函数用于选择其中一套填补方案并生成完整数据集。</p>
<p>下面演示<code>mice()</code>中的随机森林填补模型对airquality数据中的缺失值进行填补：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>imp <span class="ot">=</span> <span class="fu">mice</span>(airquality, <span class="at">method =</span> <span class="st">"rf"</span>, <span class="at">ntree =</span> <span class="dv">50</span>, </span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">printFlag =</span> <span class="cn">FALSE</span>, <span class="at">seed =</span> <span class="dv">2024</span>)</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">=</span> <span class="fu">with</span>(imp, <span class="fu">lm</span>(Ozone <span class="sc">~</span> Solar.R <span class="sc">+</span> Wind <span class="sc">+</span> Temp))</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>pooled <span class="ot">=</span> <span class="fu">pool</span>(mod)</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(pooled)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         term     estimate   std.error statistic       df      p.value
1 (Intercept) -55.15782155 23.08180196 -2.389667 51.79981 2.053847e-02
2     Solar.R   0.06502871  0.02663235  2.441719 23.65223 2.248481e-02
3        Wind  -3.12973182  0.64841387 -4.826750 64.24621 8.925236e-06
4        Temp   1.48934951  0.24510299  6.076423 82.45038 3.639331e-08</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">complete</span>(imp, <span class="at">action =</span> <span class="dv">1</span>)  <span class="co"># 用第一套填补值生成完整数据集</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>如果要观察比较填补前后的变化，可以用mice包中的<code>densityplot()</code>函数绘制分布密度函数曲线，结果如 <a href="#fig-3.3" class="quarto-xref">图&nbsp;<span>3.3</span></a> 所示，显然，不同填补结果的分布密度差异很大。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">densityplot</span>(imp)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.3-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.3: airquality数据集缺失变量填补前后密度图
</figcaption>
</figure>
</div>
</div>
</div>
<p>处理缺失值的R包还有Amelia、mi、pan等，missForest是一个采用随机森林对各类型变量缺失值进行估计的包，Hmisc包也提供了缺失值填补的函数。在CRAN网站的任务视图<a href="https://CRAN.R-project.org/view=MissingData">MissingData</a>中可以探索各种与缺失值有关的R包。</p>
<p>(3)增加虚拟变量</p>
<p>有时，缺失数据不能删除，也没有合适的方法进行填补，或填补后可能导致分析与建模出现较大偏差。此时，可以根据缺失变量创建相应的虚拟变量(也称哑变量，dummy variable)，即对一个存在缺失值的变量，衍生出一个包含0(对应缺失值)和1(对应非缺失值)的二进制虚拟变量，从而尽可能为一些不支持缺失值的分析方法和模型提供更多的信息。虚拟变量也可以用于处理多水平的因子型变量，以生成与因子水平数相同的新列，每列代表该因子型变量的一个水平。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> airquality <span class="sc">%&gt;%</span> </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(Solar.R, <span class="sc">~</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(.x), <span class="dv">0</span>, <span class="dv">1</span>)))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>recipes包中的<code>step_dummy()</code>函数和caret包中的<code>dummyVars()</code>函数都能够将因子变量或字符变量转换为虚拟变量。fastDummies包提供了专门用于将字符型和因子型变量转换为虚拟变量的函数，包括<code>dummy_cols()</code>和<code>dummy_rows()</code>两个函数，前者用于将字符型和因子型列变量转换为二进制虚拟变量，后者则根据字符型、因子型和日期型列变量的所有组合填充缺失的行，这对于创建平衡的面板数据非常方便。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fastDummies)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">comps =</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">toxi =</span> <span class="fu">c</span>(<span class="st">"剧毒"</span>, <span class="st">"低毒"</span>, <span class="st">"高毒"</span>, <span class="st">"中毒"</span>, <span class="st">"低毒"</span>),</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">logP =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.1</span>, <span class="fl">3.2</span>, <span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">2.3</span>, <span class="fl">4.1</span>)</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  comps toxi logP
1     A 剧毒 -1.1
2     B 低毒  3.2
3     C 高毒 -0.5
4     D 中毒  2.3
5     E 低毒  4.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>x_dummy <span class="ot">=</span> <span class="fu">dummy_cols</span>(x, <span class="at">select_columns =</span> <span class="st">"toxi"</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>x_dummy</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  comps toxi logP toxi_中毒 toxi_低毒 toxi_剧毒 toxi_高毒
1     A 剧毒 -1.1         0         0         1         0
2     B 低毒  3.2         0         1         0         0
3     C 高毒 -0.5         0         0         0         1
4     D 中毒  2.3         1         0         0         0
5     E 低毒  4.1         0         1         0         0</code></pre>
</div>
</div>
<p>补全隐性缺失观测:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">city =</span> <span class="fu">c</span>(<span class="st">"HF"</span>, <span class="st">"AQ"</span>, <span class="st">"HF"</span>),</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="fu">c</span>(<span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2021</span>),</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">volume =</span> <span class="fu">c</span>(<span class="dv">1000</span>, <span class="dv">670</span>, <span class="dv">1200</span>))</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  city year volume
1   HF 2020   1000
2   AQ 2021    670
3   HF 2021   1200</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>x_dummy <span class="ot">=</span> <span class="fu">dummy_rows</span>(x, <span class="at">select_columns =</span> <span class="fu">c</span>(<span class="st">"city"</span>, <span class="st">"year"</span>))</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>x_dummy</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  city year volume
1   HF 2020   1000
2   AQ 2021    670
3   HF 2021   1200
4   AQ 2020     NA</code></pre>
</div>
</div>
<p>增加列变量以确定观测是否为缺失观测:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dummy_rows</span>(x, <span class="at">select_columns =</span> <span class="fu">c</span>(<span class="st">"city"</span>, <span class="st">"year"</span>),</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">dummy_indicator =</span> <span class="cn">TRUE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  city year volume dummy_indicator
1   HF 2020   1000               0
2   AQ 2021    670               0
3   HF 2021   1200               0
4   AQ 2020     NA               1</code></pre>
</div>
</div>
</section>
</section>
<section id="异常值的识别与处理" class="level3" data-number="3.1.5">
<h3 data-number="3.1.5" class="anchored" data-anchor-id="异常值的识别与处理"><span class="header-section-number">3.1.5</span> 异常值的识别与处理</h3>
<p>异常值也称离群值(outlier)，指与同组其他观测值相距较远的观测值，即与同组其他数据点有显著差异的数据点。异常值往往可以分为两类：极端值(自然存在)和错误值(测量错误、输入错误、抽样错误等)。突发的环境污染事件可能导致极端的情况出现，因此对自然存在的异常值需要关注。同时，要避免因各种错误导致的异常值。</p>
<p>异常值的存在会显著地影响数据分析结果和建模，因此需要在数据分析之前对异常值进行识别和处理。在大多数情况下，剔除异常值后建立的模型更加稳健。</p>
<section id="异常值的识别" class="level4" data-number="3.1.5.1">
<h4 data-number="3.1.5.1" class="anchored" data-anchor-id="异常值的识别"><span class="header-section-number">3.1.5.1</span> 异常值的识别</h4>
<p>简单识别异常值的方法是通过箱线图、散点图、直方图等。箱线图(如 <a href="#fig-3.4" class="quarto-xref">图&nbsp;<span>3.4</span></a> 所示)默认将超出1.5倍IQR(四分位间距)的上下极端值视为异常值。散点图和直方图等可直观地从图形上发现异常的数据点。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-3.4" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig3.4.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.4: 箱线图及其对异常值的识别
</figcaption>
</figure>
</div>
</div>
</div>
<p>对于正态分布的资料，有2种常用的判断异常值的方法：</p>
<ul>
<li>3σ法：计算数据集的均值μ和标准差σ，将μ±3σ区间之外的数据视为异常值。</li>
<li>IQR法：将所有数据从小到大排列，25%、50%和75%处的数值称为下四分位数(Q1)、中位数(Median)和上四分位数(Q3)，它们将数据集等分为4部分，Q3-Q1即为四分位间距(IQR)。IQR法将[Q1-1.5IQR, Q3+1.5IQR]区间之外的数据视为异常值，这个方法就是箱线图所采用的识别异常值的方法。</li>
</ul>
<p>IQR法可通过调用<code>boxplot.stats()</code>函数来实现。如检测airquality数据集中Ozone的异常值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot.stats</span>(airquality<span class="sc">$</span>Ozone)<span class="sc">$</span>out</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 135 168</code></pre>
</div>
</div>
<p>上边的方法将最大的两个数值识别为异常值。</p>
<p>如果对Ozone数据进行对数转换，再用IQR法进行异常值检测：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">boxplot.stats</span>(<span class="fu">log</span>(airquality<span class="sc">$</span>Ozone))<span class="sc">$</span>out)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>显然，对数转换之后将最小值识别为异常值，说明异常值随分布变化而变化。实际上，Ozone呈右偏态分布，存在较大的数值一般是正常的。因此，对于偏态分布的数据不能直接用以上方法检查异常值，特别是很多环境数据属于右偏态分布。有些偏态资料可以通过数据变换而近似正态分布，在转换后可尝试用上述方法检测异常值。如果偏态资料给出了明确的分布类型，则可依据其概率分布来检测异常值。很多领域的数据可能存在特定的区间或检测限，根据这些逻辑或规则也可以来检测异常值。</p>
<p>DMwR包提供的局部异常值因子法(Local Outlier Factor，LOF)可用于非正态资料的异常值识别，该方法是基于密度的经典算法。也可应用K-means方法聚类，然后计算每个数据点到类中心的距离，通过距离排序判断异常值。</p>
<p>mvoutlier包提供了基于多种原理但主要基于稳健马氏距离(Robust Mahalanobis Distance)的识别异常值的方法。稳健马氏距离算法优于欧氏距离算法，特别是在检测多元数据异常值时，前者会考虑变量间的相关性，且不受量纲的影响。下面演示该包中<code>uni.plot()</code>和<code>aq.plot()</code>函数的应用，两者都基于稳健马氏距离检测多变量数据的异常值，但前者为每个变量绘制一维散点图并标记异常值，而后者则绘制4个图形，包括原始数据散点图、有序马氏距离平方的累积概率分布图(包括卡方累积概率分布曲线和两条垂直的分位数线)和分别基于指定卡方分布分位数和调整的卡方分布分位数的两个异常值散点图。</p>
<p>首先生成50×2列的数据框a，数据服从正态分布(均值为0，标准差为1)，接着生成5×2的数据框b，数据服从正态分布(均值为3，标准差为1)，然后按行合并到df。最后来观察<code>boxplot.stats()</code>、<code>uni.plot()</code>和<code>aq.plot()</code>能否将b从df中作为异常值识别出来。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">50</span>), <span class="at">y =</span> <span class="fu">rnorm</span>(<span class="dv">50</span>)) </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>b <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">1</span>), <span class="at">y =</span> <span class="fu">rnorm</span>(<span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">1</span>))</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">rbind</span>(a, b)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(a, b)  <span class="co"># 删除内存中的a和b</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>先采用boxplot.stats()函数识别异常值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 输出df第一列中异常值的行号</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span>(df<span class="sc">$</span>x <span class="sc">%in%</span> <span class="fu">boxplot.stats</span>(df<span class="sc">$</span>x)<span class="sc">$</span>out)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 53 54 55</code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 输出df第二列中异常值行号</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span>(df<span class="sc">$</span>y <span class="sc">%in%</span> <span class="fu">boxplot.stats</span>(df<span class="sc">$</span>y)<span class="sc">$</span>out)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 55</code></pre>
</div>
</div>
<p>结果第一列只检测到b中第一列的3个数据点，第二列只检测到b中第二列的1个数据点，同时检测为异常值的仅为第55行，未能将第51~55行全部检测出来。</p>
<p>接下来利用<code>uni.plot()</code>函数来检测异常值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvoutlier)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> <span class="fu">uni.plot</span>(<span class="at">x =</span> df, <span class="at">symb =</span> F, <span class="at">quan =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span>(p1<span class="sc">$</span>outliers <span class="sc">==</span> T)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 30 51 52 53 54 55</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-3.5" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.5-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.5: uni.plot()绘制的异常值散点图
</figcaption>
</figure>
</div>
</div>
</div>
<p>结果表明，<code>uni.plot()</code>将5行异常值全部识别出来，但也将原数据中的第30个数据点识别为异常值。异常值散点图如 <a href="#fig-3.5" class="quarto-xref">图&nbsp;<span>3.5</span></a> 所示，其中红色数据点为识别出来的异常值。</p>
<p>接下来利用<code>aq.plot()</code>函数识别异常值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span> <span class="fu">aq.plot</span>(<span class="at">x =</span> df, <span class="at">quan =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span>(p2<span class="sc">$</span>outliers <span class="sc">==</span> T)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 30 51 52 53 54 55</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-3.6" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.6-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.6: aq.plot()绘制的异常值诊断图
</figcaption>
</figure>
</div>
</div>
</div>
<p><code>aq.plot()</code>同样将5行异常值全部识别出来(也包括原数据中的第30个数据点)，并给出如 <a href="#fig-3.6" class="quarto-xref">图&nbsp;<span>3.6</span></a> 所示的四个异常值诊断图。在 <a href="#fig-3.6" class="quarto-xref">图&nbsp;<span>3.6</span></a> 中最重要的图是右上图，数据点所在的位置决定于其稳健马氏距离平方值和对应的累积概率，其中洋红色曲线为拟合的理论卡方累积概率曲线，青色垂线为指定的卡方分位数(默认为0.975)，位于该线右边的数据判定为异常数据(对应为左下图，红色编号为异常值)；蓝色垂线为调整的卡方分位数(采用自适应方法从尾部搜索获得)，该线右边数据判定为异常数据(对应为右下图，红色编号为异常值)；左上图为原始数据散点图。当数据点包含2个以上变量(特征)时，则将数据点投影到前2个稳健的主成份上。</p>
<p>对于稀疏的高维数据，例如生命科学研究中的基因数据，往往有成千上万个变量，建议采用mvoutlier包中的<code>pcout()</code>函数，通过融合主成分降维的思路来检测异常值。此外，该包中还包含多个其他的检测异常值的函数，可阅读帮助信息以进一步学习和掌握。</p>
<p>异常值的检测除了基于距离、概率密度的方法外，还有基于决策树、角度的多种方法，以及针对时空数据异常值的专用检测方法，如DBScan聚类法、孤立森林法(Isolation Forest)、随机砍伐森林法(Random Cut Forest)等。实现这些方法的函数可以在有关的R包中都可以找到，具体参见<a href="https://github.com/pridiltal/ctv-AnomalyDetection">Anomaly Detection with R</a>。</p>
</section>
<section id="异常值的处理" class="level4" data-number="3.1.5.2">
<h4 data-number="3.1.5.2" class="anchored" data-anchor-id="异常值的处理"><span class="header-section-number">3.1.5.2</span> 异常值的处理</h4>
<p>异常值的处理一般包括<strong>删除法</strong>、<strong>替代法</strong>、<strong>转换法</strong>等，亦可<strong>视为缺失值</strong>。删除法简单易行，替代法操作也较为简单，如将超出90%分位数的数据用90%分位数替代，将低于10%分位数的数据用10%分位数替代等；转换法采用数学运算，缩小数据之间的差异，例如平方根法、对数法、去中心缩放法(标准化处理)、归一化缩放法等。也可将异常值转换为缺失值，然后利用缺失值填补方法进行填补。此外，还可以采用分组的方法，将连续型变量转换为离散型变量，转换为等级数据，这也是一种较好的降低异常值对分析结果和建模产生不利影响的方法。</p>
<p>总之，异常值的检查要根据数据分布选择科学的方法进行。删除异常值要特别谨慎，要分析异常值产生的原因，判断真伪，避免删除真实有效的数据。</p>
</section>
</section>
</section>
<section id="制作数据表格" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="制作数据表格"><span class="header-section-number">3.2</span> 制作数据表格</h2>
<p>表格是展示数据特别是数据汇总结果的重要形式，在R的R Markdown、Notebook和Quarto文档中，knitr、DT、kableExtra、htmlTable、table1、formattable、flextable、reactable包都可以帮助用户生成美观的HTML格式的表格，有些包还可以生成pdf格式和图片格式的表格。sjPlot包能够将统计分析的结果呈现为整洁美观的表格。下面介绍R中三种制作三线表的方法。</p>
<section id="htmltable包制作三线表" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="htmltable包制作三线表"><span class="header-section-number">3.2.1</span> htmlTable包制作三线表</h3>
<p>htmlTable包生成的三线表为HTML格式，可以嵌入支持HTML格式的文档中，如果不支持HTML格式，则可以通过截图方式嵌入。以下代码将iris数据前8行数据整理成三线表：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(htmlTable)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="fu">htmlTable</span>(iris[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>,])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table class="gmisc_table table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; border-bottom: 1px solid grey; border-top: 2px solid grey;"></th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey;">Sepal.Length</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey;">Sepal.Width</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey;">Petal.Length</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey;">Petal.Width</th>
<th data-quarto-table-cell-role="th" style="text-align: center; font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey;">Species</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: center;">5.1</td>
<td style="text-align: center;">3.5</td>
<td style="text-align: center;">1.4</td>
<td style="text-align: center;">0.2</td>
<td style="text-align: center;">setosa</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: center;">4.9</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.4</td>
<td style="text-align: center;">0.2</td>
<td style="text-align: center;">setosa</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: center;">4.7</td>
<td style="text-align: center;">3.2</td>
<td style="text-align: center;">1.3</td>
<td style="text-align: center;">0.2</td>
<td style="text-align: center;">setosa</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: center;">4.6</td>
<td style="text-align: center;">3.1</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">0.2</td>
<td style="text-align: center;">setosa</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">3.6</td>
<td style="text-align: center;">1.4</td>
<td style="text-align: center;">0.2</td>
<td style="text-align: center;">setosa</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: center;">5.4</td>
<td style="text-align: center;">3.9</td>
<td style="text-align: center;">1.7</td>
<td style="text-align: center;">0.4</td>
<td style="text-align: center;">setosa</td>
</tr>
<tr class="odd">
<td style="text-align: left;">7</td>
<td style="text-align: center;">4.6</td>
<td style="text-align: center;">3.4</td>
<td style="text-align: center;">1.4</td>
<td style="text-align: center;">0.3</td>
<td style="text-align: center;">setosa</td>
</tr>
<tr class="even">
<td style="text-align: left; border-bottom: 2px solid grey;">8</td>
<td style="text-align: center; border-bottom: 2px solid grey;">5</td>
<td style="text-align: center; border-bottom: 2px solid grey;">3.4</td>
<td style="text-align: center; border-bottom: 2px solid grey;">1.5</td>
<td style="text-align: center; border-bottom: 2px solid grey;">0.2</td>
<td style="text-align: center; border-bottom: 2px solid grey;">setosa</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>显然，只需要先将数据表的行名、列名以及数据整理好，htmlTable包就可以快速生成三线表，以及利用更多的分类变量进行分组，实现更复杂的分组表格，并添加标题和脚注等，具体可参考<a href="https://cran.r-project.org/web/packages/htmlTable/vignettes/general.html">How-to use htmlTable</a>。</p>
</section>
<section id="table1包制作分组统计三线表" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="table1包制作分组统计三线表"><span class="header-section-number">3.2.2</span> table1包制作分组统计三线表</h3>
<p>table1不仅能绘制三线表，而且能分组计算一些描述性的统计量，如总量、算术平均数、中位数、分位数、标准差、缺失值等，制作出所谓的“表1”，这在医学相关研究论文中几乎是一个固定格式。table1采用了公式化的方法来指定行变量和列变量，易于组织，非常简单。下面是用该包对airquality数据集制作“表1”。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(table1)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="fu">table1</span>(<span class="sc">~</span> Ozone <span class="sc">+</span> Solar.R <span class="sc">+</span> Wind <span class="sc">+</span> Temp <span class="sc">|</span> Month, <span class="at">data =</span> airquality)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<div class="Rtable1">
<table class="Rtable1 table table-sm table-striped small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th class="rowlabel firstrow lastrow" data-quarto-table-cell-role="th"></th>
<th class="firstrow lastrow" data-quarto-table-cell-role="th"><span class="stratlabel">5<br>
<span class="stratn">(N=31)</span></span></th>
<th class="firstrow lastrow" data-quarto-table-cell-role="th"><span class="stratlabel">6<br>
<span class="stratn">(N=30)</span></span></th>
<th class="firstrow lastrow" data-quarto-table-cell-role="th"><span class="stratlabel">7<br>
<span class="stratn">(N=31)</span></span></th>
<th class="firstrow lastrow" data-quarto-table-cell-role="th"><span class="stratlabel">8<br>
<span class="stratn">(N=31)</span></span></th>
<th class="firstrow lastrow" data-quarto-table-cell-role="th"><span class="stratlabel">9<br>
<span class="stratn">(N=30)</span></span></th>
<th class="firstrow lastrow" data-quarto-table-cell-role="th"><span class="stratlabel">Overall<br>
<span class="stratn">(N=153)</span></span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowlabel firstrow">Ozone</td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Mean (SD)</td>
<td>23.6 (22.2)</td>
<td>29.4 (18.2)</td>
<td>59.1 (31.6)</td>
<td>60.0 (39.7)</td>
<td>31.4 (24.1)</td>
<td>42.1 (33.0)</td>
</tr>
<tr class="odd">
<td class="rowlabel">Median [Min, Max]</td>
<td>18.0 [1.00, 115]</td>
<td>23.0 [12.0, 71.0]</td>
<td>60.0 [7.00, 135]</td>
<td>52.0 [9.00, 168]</td>
<td>23.0 [7.00, 96.0]</td>
<td>31.5 [1.00, 168]</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">Missing</td>
<td class="lastrow">5 (16.1%)</td>
<td class="lastrow">21 (70.0%)</td>
<td class="lastrow">5 (16.1%)</td>
<td class="lastrow">5 (16.1%)</td>
<td class="lastrow">1 (3.3%)</td>
<td class="lastrow">37 (24.2%)</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">Solar.R</td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Mean (SD)</td>
<td>181 (115)</td>
<td>190 (92.9)</td>
<td>216 (80.6)</td>
<td>172 (76.8)</td>
<td>167 (79.1)</td>
<td>186 (90.1)</td>
</tr>
<tr class="odd">
<td class="rowlabel">Median [Min, Max]</td>
<td>194 [8.00, 334]</td>
<td>189 [31.0, 332]</td>
<td>253 [7.00, 314]</td>
<td>198 [24.0, 273]</td>
<td>192 [14.0, 259]</td>
<td>205 [7.00, 334]</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">Missing</td>
<td class="lastrow">4 (12.9%)</td>
<td class="lastrow">0 (0%)</td>
<td class="lastrow">0 (0%)</td>
<td class="lastrow">3 (9.7%)</td>
<td class="lastrow">0 (0%)</td>
<td class="lastrow">7 (4.6%)</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">Wind</td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Mean (SD)</td>
<td>11.6 (3.53)</td>
<td>10.3 (3.77)</td>
<td>8.94 (3.04)</td>
<td>8.79 (3.23)</td>
<td>10.2 (3.46)</td>
<td>9.96 (3.52)</td>
</tr>
<tr class="odd">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">11.5 [5.70, 20.1]</td>
<td class="lastrow">9.70 [1.70, 20.7]</td>
<td class="lastrow">8.60 [4.10, 14.9]</td>
<td class="lastrow">8.60 [2.30, 15.5]</td>
<td class="lastrow">10.3 [2.80, 16.6]</td>
<td class="lastrow">9.70 [1.70, 20.7]</td>
</tr>
<tr class="even">
<td class="rowlabel firstrow">Temp</td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
<td class="firstrow"></td>
</tr>
<tr class="odd">
<td class="rowlabel">Mean (SD)</td>
<td>65.5 (6.85)</td>
<td>79.1 (6.60)</td>
<td>83.9 (4.32)</td>
<td>84.0 (6.59)</td>
<td>76.9 (8.36)</td>
<td>77.9 (9.47)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">66.0 [56.0, 81.0]</td>
<td class="lastrow">78.0 [65.0, 93.0]</td>
<td class="lastrow">84.0 [73.0, 92.0]</td>
<td class="lastrow">82.0 [72.0, 97.0]</td>
<td class="lastrow">76.0 [63.0, 93.0]</td>
<td class="lastrow">79.0 [56.0, 97.0]</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>从该表可见，它将前4列变量按第5列变量Month做了分组统计，给出均值及标准差、中位数及最大最小值，还统计了缺失值的个数及比例，从而给出数据的全貌特征。table1包可通过其他函数对表格进一步调整和美化，例如给行组变量和列组变量添加标签、指定要计算的统计量等。更详细地使用方法可阅读<a href="https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html">Using the table1 Package to Create HTML Tables of Descriptive Statistics</a>。</p>
</section>
<section id="ggpubr包制作三线表" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="ggpubr包制作三线表"><span class="header-section-number">3.2.3</span> ggpubr包制作三线表</h3>
<p>ggpurr是基于ggplot2用于快速制作出版图形的R包，除了极为方便地绘制满足各类学术期刊要求的专业图形以外，它也能通过<code>ggtexttable()</code>函数来制作表格，不仅能绘制三线表，还能实现多种样式，特别是ggpubr能将绘制的表格方便地整合到指定图形中，从而呈现更全面的信息。要注意，<code>ggtexttable()</code>函数不具备分组统计功能，但提供了丰富的表格样式以及针对单元格的调整功能。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtexttable</span>(iris[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>,], <span class="at">theme =</span> <span class="fu">ttheme</span>(<span class="st">"blank"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_add_hline</span>(<span class="at">at.row =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">row.side =</span> <span class="st">"top"</span>, <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_add_hline</span>(<span class="at">at.row =</span> <span class="fu">c</span>(<span class="dv">9</span>), <span class="at">row.side =</span> <span class="st">"bottom"</span>, <span class="at">linewidth =</span> <span class="dv">2</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CH3_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>添加标题和脚注：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>main.title <span class="ot">&lt;-</span> <span class="st">"鸢尾花数据"</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>subtitle <span class="ot">&lt;-</span> <span class="st">"三种类型，共150个观测数据"</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">ggtexttable</span>(<span class="fu">head</span>(iris), <span class="at">theme =</span> <span class="fu">ttheme</span>(<span class="st">"blank"</span>))</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>tab <span class="sc">%&gt;%</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">tab_add_title</span>(<span class="at">text =</span> subtitle, <span class="at">face =</span> <span class="st">"plain"</span>, <span class="at">size =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">tab_add_title</span>(<span class="at">text =</span> main.title, <span class="at">face =</span> <span class="st">"bold"</span>, </span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="at">padding =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">"line"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">tab_add_hline</span>(<span class="at">at.row =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="at">row.side =</span> <span class="st">"top"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">tab_add_hline</span>(<span class="at">at.row =</span> <span class="fu">c</span>(<span class="dv">9</span>), <span class="at">row.side =</span> <span class="st">"bottom"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">tab_add_footnote</span>(<span class="at">text =</span> <span class="st">"*表格使用ggpubr绘制"</span>, <span class="at">size =</span> <span class="dv">8</span>, <span class="at">face =</span> <span class="st">"italic"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CH3_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>ggpubr制作的表格是图片格式，可以通过R的图形输出功能，输出为pdf格式。</p>
<p>还有很多R包致力于通过表格更好地展示数据，用户可以利用这些R包来制作各种形式的数据表，包括动态交互式表格，以及具有搜索、排序、筛选等功能的数据表。</p>
</section>
</section>
<section id="r绘图基础" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="r绘图基础"><span class="header-section-number">3.3</span> R绘图基础</h2>
<p>图形是最直观、最生动地呈现数据的方式。R在绘制图形方面具有极大的优势，在很多的专业出版物中都可以看到用R绘制的精美图形，已经成为数据可视化的重要工具。&nbsp;R的绘图系统较多，包括基础绘图系统、lattice绘图系统和ggplot2绘图系统。其中ggplot2已经通过各种扩展包<a href="http://exts.ggplot2.tidyverse.org/" class="uri">http://exts.ggplot2.tidyverse.org/</a>形成了比较完善的生态系统，但ggplot2本身不能绘制动态交互式图形和三维图形，需要借助扩展包。目前，已经有很多第三方R包实现了非常好的交互式绘图体验，包括<a href="https://plotly.com/r">plotly</a>、<a href="https://echarts4r.john-coene.com">echarts4r</a>、<a href="https://recharts.yihui.org">recharts</a>、<a href="https://www.highcharts.com">highcharter</a>、<a href="https://rstudio.github.io/leaflet">leaflet</a>等。rgl包能够绘制非常逼真的三维图形，plot3D也是一个不错的绘制三维图形的工具包。</p>
<section id="r的图形设备" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="r的图形设备"><span class="header-section-number">3.3.1</span> R的图形设备</h3>
<p>R语言中绘图设备包括屏幕窗口显示设备和文件打印设备两种。grDevices包中包含了操作管理图形设备的函数。</p>
<p>函数<code>dev.list()</code>列出所有图形设备的类型和编号；函数<code>dev.cur()</code>显示当前图形设备类型和编号；函数<code>dev.off()</code>关闭指定图形设备，如不指定编号，则关闭当前图形设备，同时返回可用的当前图形设备；函数<code>graphics.off()</code>关闭所有图形设备；函数<code>dev.set()</code>设置下一个窗口作为当前图形设备，并返回设备名称和编号。</p>
<section id="窗口显示设备" class="level4" data-number="3.3.1.1">
<h4 data-number="3.3.1.1" class="anchored" data-anchor-id="窗口显示设备"><span class="header-section-number">3.3.1.1</span> 窗口显示设备</h4>
<p>窗口显示设备即通过在屏幕上创建一个窗口来显示图形。创建窗口设备的函数有<code>X11()</code>、<code>x11()</code>、<code>windows()</code>和<code>win.graph()</code>。前2个可用于Windows系统和Linux系统，后2个仅用于Windows系统。创建的窗口设备会有设备编号以及是否为激活状态(inactive或Active)。</p>
<p><code>dev.new()</code>默认创建新的RStudio图形设备(即RStudioGD)以及伴随的png文件设备，如果设置参数noRStudioGD = TRUE则创建的是窗口设备。</p>
</section>
<section id="文件打印设备" class="level4" data-number="3.3.1.2">
<h4 data-number="3.3.1.2" class="anchored" data-anchor-id="文件打印设备"><span class="header-section-number">3.3.1.2</span> 文件打印设备</h4>
<p>文件打印设备即将图形输出到指定格式的图形文件中。R支持将图形输出到多种格式，<code>svg()</code>、<code>postscript()</code>、<code>pdf()</code>、<code>png()</code>、<code>jpeg()</code>、<code>bmp()</code>、<code>tiff()</code>函数分别创建svg(矢量图形)、ps(矢量图形)、pdf、png、jpg、bmp、tiff格式的图形文件设备，<code>pictex()</code>、<code>xifg()</code>、<code>win.metafile()</code>能创建Latex、xfig以及emf格式的图形文件。<code>cairo_ps()</code>和<code>cairo_pdf()</code>也能创建ps和pdf格式，但与<code>postscript()</code>和<code>pdf()</code>不同，一是前二者可以输出为位图格式，二是前二者可以使用更广泛的UTF-8符号，嵌入更多所使用的字体。</p>
<p>要注意，在使用这些文件打印设备时，最后需要使用<code>dev.off()</code>来关闭该设备，以恢复屏幕作为默认的图形输出设备。如以下代码将绘制的图形输出到一个指定位置的pdf格式文档中：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pdf</span>(<span class="st">"d:/test.pdf"</span>)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(iris)</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="r基础绘图系统" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="r基础绘图系统"><span class="header-section-number">3.3.2</span> R基础绘图系统</h3>
<p>R的基础绘图系统基于graphics包。基础绘图系统给用户提供一张白纸，让用户自由地设计图形中的每一个元素。用R的基础绘图系统绘制图形一般包括两个步骤：&nbsp;(1)用高级绘图函数创建图形的主体，比如散点图；&nbsp;(2)然后在主体图形的基础上进行修饰和添加，比如绘制散点图的回归线，调整坐标轴、文字等。</p>
<section id="高级绘图函数" class="level4" data-number="3.3.2.1">
<h4 data-number="3.3.2.1" class="anchored" data-anchor-id="高级绘图函数"><span class="header-section-number">3.3.2.1</span> 高级绘图函数</h4>
<p>所谓高级绘图函数，是在初次调用该绘图函数时，就会打开一个图形设备，并在该设备上绘制图形。R基础绘图系统的高级绘图函数有：</p>
<ul>
<li><code>plot()</code>：通用绘图函数，根据输入的数据结构不同绘制不同的图形。</li>
<li><code>pairs()</code>：绘制双变量散点图或指定可用图形。</li>
<li><code>barplot()</code>：绘制水平或垂直条形图。</li>
<li><code>matplot()</code>：绘制向量或矩阵列的点线图。</li>
<li><code>coplot()</code>：绘制给定条件(因子变量)下两个变量之间依赖关系的散点图或指定可用图形。</li>
<li><code>hist()</code>：绘制直方图。</li>
<li><code>boxplot()</code>：绘制箱线图。</li>
<li><code>dotchart()</code>：绘制数据点图(克利夫兰图)。</li>
<li><code>image()</code>：绘制三个变量的像素图(x与y为坐标，z值用等面积色块表征)。</li>
<li><code>contour()</code>：绘制三个变量的等值线图(x与y为坐标，z值用等值线表征)。</li>
<li><code>persp(</code>)：绘制三个变量的曲面图(x与y为坐标，z值用3D曲面表征)。</li>
<li><code>pie()</code>：绘制饼图。</li>
</ul>
<p>这些高级绘图函数的主要参数有：</p>
<ul>
<li>add=TRUE：强制高级绘图函数作为低级绘图函数，将图形叠加到当前图形设备，仅部分函数支持。</li>
<li>axes=FALSE：禁止生成轴。当需要用axis函数自定义轴时使用。</li>
<li>log=“x”、log=“y”、log=“xy”：生成对数轴，大部分图形可用，但不是全部。</li>
<li>type：该参数控制生成图形的类型，type=“p”绘制散点图(默认)，type=“l”绘制线图，type=“b”绘制线条连接点的图形，type=“o”绘制线条覆盖点的图形，type=“h”绘制点到零轴的垂线图(高密度)，type=“s”和type=“S”绘制阶跃图形，type=“n”不绘制图形，用于创建自定义图形。该参数主要用于<code>plot()</code>函数。</li>
<li>xlab、ylab：生成x和y的轴标签。</li>
<li>main、sub：生成图形标题和副标题。</li>
<li>lty、lwd：设置线型和线宽。线型可指定为数字0-7，分别对应”blank”、“solid”、“dashed”、“dotted”、“dotdash”、“longdash”和”twodash”，其中”blank”线条不可见。</li>
<li>col、cex：前者设置颜色，后者设置数字、符号、文本缩放系数。可以用<code>colors()</code>函数查询R中的颜色名称，也可用<code>demo("colors")</code>查看各种色盘。</li>
<li>pch：设置点的形状(见 <a href="#fig-3.7" class="quarto-xref">图&nbsp;<span>3.7</span></a> )，其中21-25为可上色的点形状，col为边框设置颜色，bg为内部填充设置颜色。除了0-25以外，pch还支持其他的取值，包括多种字符，可参考帮助信息。</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div id="fig-3.7" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig3.7.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.7: R基础绘图系统重点的形状(对应pch参数值0-25)
</figcaption>
</figure>
</div>
</div>
</div>
<p>不同的绘图函数可能有不同的参数，具体参考有关帮助信息。 以下代码演示了<code>hist()</code>绘制airquality数据集中Ozone变量的直方图(自动分组后统计频数，在绘图)，并对xlab、main和col参数值进行了设置，结果如 <a href="#fig-3.8" class="quarto-xref">图&nbsp;<span>3.8</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(airquality<span class="sc">$</span>Ozone,</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Ozone Concentration"</span>,</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Ozone Histogram"</span>,</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">"orange"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.8" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.8-1.png" class="img-fluid figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.8: 用hist()绘制直方图
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="低级绘图函数" class="level4" data-number="3.3.2.2">
<h4 data-number="3.3.2.2" class="anchored" data-anchor-id="低级绘图函数"><span class="header-section-number">3.3.2.2</span> 低级绘图函数</h4>
<p>低级绘图函数用于在当前图形上创建额外的元素，如点、线、文字等。主要的常用低级绘图函数如下：</p>
<ul>
<li><code>points(x, y)</code>、<code>lines(x, y)</code>：在当前图形上添加点、线。</li>
<li><code>text(x, y, labels, …)</code>：在当前图形上指定的位置添加文本内容。</li>
<li><code>abline(a, b)</code>、<code>abline(h=y)</code>、<code>abline(v=x)</code>、<code>abline(lm.obj)</code>：在当前图形上添加直线。第一个用于添加斜率为b、截距为a的直线，第二个添加水平直线，第三个添加垂直直线，第四个添加一个由直线回归模型确定的拟合直线。</li>
<li><code>polygon(x, y, …)</code>：在当前图形上根据有序顶点绘制多边形。</li>
<li><code>legend(x, y, legend, …)</code>：在指定位置添加图例，包括字符、线型、颜色等。</li>
<li><code>title(main, sub)</code>：在当前图形上添加图形标题和副标题。</li>
<li><code>axis(side, …)</code>：在指定的边(参数side，1-4分别代表下、左、上、右)上添加坐标轴。其他参数控制坐标轴、轴刻度线以轴标签的位置。用于自定义轴坐标。</li>
</ul>
<p>低级绘图函数一般都需要指定新添加元素的位置信息(x、y坐标)。坐标是根据高级绘图函数产生的用户坐标系来确定的。</p>
<p>下面的代码自定义了一个根据最小至和最大值来进行数据归一化的函数，通过箱线图比较了数据归一化前后的分布差异。数据归一化消除了不同变量的量纲影响，从而可以更好地比较分布差异。先用<code>boxplot()</code>函数绘制箱线图，再用<code>title()</code>函数定义图形标题和轴标题，前者作为高级绘图函数会创建新的图形，而后者作为低级绘图函数会在当前图形上添加图形标题和轴标题。</p>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> airquality[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">6</span>)]</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 自定义函数，根据最小最大值缩放数据</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>mmscale <span class="ot">=</span> <span class="cf">function</span>(x){</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>   mi <span class="ot">=</span> <span class="fu">min</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>   mx <span class="ot">=</span> <span class="fu">max</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>   sc <span class="ot">=</span> (x <span class="sc">-</span> mi) <span class="sc">/</span> (mx <span class="sc">-</span> mi)</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">return</span>(sc)</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>dfmm <span class="ot">=</span> <span class="fu">apply</span>(df, <span class="dv">2</span>, <span class="at">FUN =</span> mmscale)</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(df, <span class="at">col =</span> <span class="fu">rainbow</span>(<span class="dv">4</span>)) </span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main =</span> <span class="st">"归一化处理前的箱线图"</span>, </span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">"变量"</span>, <span class="at">ylab =</span> <span class="st">"变量值"</span>)</span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(dfmm, <span class="at">col =</span> <span class="fu">rainbow</span>(<span class="dv">4</span>))</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main =</span> <span class="st">"归一化处理后的箱线图"</span>, </span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">"变量"</span>, <span class="at">ylab =</span> <span class="st">"归一化后的变量值"</span> )</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.9" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.9" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.9-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.9-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.9-1.png" class="img-fluid figure-img" style="width:80.0%" data-ref-parent="fig-3.9">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.9-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 变量值归一化前
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.9" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.9-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.9-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.9-2.png" class="img-fluid figure-img" style="width:80.0%" data-ref-parent="fig-3.9">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.9-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 变量值归一化后
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.9: 用boxplot()绘制箱线图
</figcaption>
</figure>
</div>
<p>函数<code>legend()</code>用于为图形添加自定义的图例，下面的代码演示该函数的使用，结果如 <a href="#fig-3.10" class="quarto-xref">图&nbsp;<span>3.10</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">PM2.5 =</span> <span class="fu">c</span>(<span class="dv">62</span>, <span class="dv">51</span>, <span class="dv">25</span>, <span class="dv">87</span>, <span class="dv">54</span>, <span class="dv">35</span>, <span class="dv">28</span>, <span class="dv">77</span>, <span class="dv">50</span>, <span class="dv">43</span>, <span class="dv">20</span>, <span class="dv">59</span>), </span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="fu">rep</span>(<span class="dv">2018</span><span class="sc">:</span><span class="dv">2020</span>, <span class="at">each =</span> <span class="dv">4</span>),</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">season =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Spring"</span>, <span class="st">"Summer"</span>, <span class="st">"Autuam"</span>, <span class="st">"Winter"</span>), <span class="at">times =</span> <span class="dv">3</span>)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制折线图</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(df<span class="sc">$</span>PM2<span class="fl">.5</span>[df<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2018</span>], <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">90</span>), <span class="at">xlab =</span> <span class="st">"Season"</span>, <span class="at">ylab =</span> <span class="st">"Concentration"</span>,</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">mgp =</span> <span class="fu">c</span>(<span class="fl">1.5</span>, <span class="fl">0.5</span>, <span class="dv">0</span>))</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(df<span class="sc">$</span>PM2<span class="fl">.5</span>[df<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2019</span>], <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">col =</span> <span class="st">"darkgreen"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(df<span class="sc">$</span>PM2<span class="fl">.5</span>[df<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2020</span>], <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">3</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"2018"</span>,<span class="st">"2019"</span>,<span class="st">"2020"</span>),</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"darkgreen"</span>, <span class="st">"blue"</span>), </span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">cex =</span> <span class="dv">1</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.10" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.10-1.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.10: 用legend()为图形添加图例
</figcaption>
</figure>
</div>
</div>
</div>
<p>下面的代码可以将6种可见线型绘制出来，结果如 <a href="#fig-3.11" class="quarto-xref">图&nbsp;<span>3.11</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">6</span>); y1 <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">3</span>,<span class="dv">6</span>); y2 <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>linetype <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"dashed"</span>, <span class="st">"dotted"</span>, <span class="st">"dotdash"</span>, <span class="st">"longdash"</span>, <span class="st">"twodash"</span>)</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x1, y1, <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">7</span>),</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">axes =</span> <span class="cn">FALSE</span>)</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)){</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>   x<span class="ot">=</span><span class="fu">c</span>(x1[i], x2[i])</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>   y<span class="ot">=</span><span class="fu">c</span>(y1[i], y2[i])</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">lines</span>(x, y, <span class="at">lty =</span> i, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x =</span> x2 <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">y =</span> y2, <span class="at">labels =</span> linetype)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.11" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.11-1.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.11: 打印R基础u绘图系统的六种可见线型
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="绘图全局参数配置" class="level4" data-number="3.3.2.3">
<h4 data-number="3.3.2.3" class="anchored" data-anchor-id="绘图全局参数配置"><span class="header-section-number">3.3.2.3</span> 绘图全局参数配置</h4>
<p>R提供了<code>par()</code>函数来设置和查询绘图的各种参数。这些参数分为三类：第一类是只读参数(cin、cra、csi、cxy、din、page)，第二类是只能通过<code>par()</code>函数来设置的参数(ask、fig、fin、lheight、mai、mar、mex、mfcol、mfrow、mfg、new、oma、omd、omi、pin、plt、ps、pty、usr、xlog、ylog、ylbias)，剩下的参数为第三类，既可以通过<code>par()</code>函数来设置，也可以通过各种高级绘图函数来设置。通过<code>op = par()</code>返回所有参数，如果设置参数no.readonly = TRUE，则返回所有可以修改的参数。主要的可被修改的参数如下：</p>
<ul>
<li>符号和线条相关参数：如pch、lty、lwd、cex分别设置点型、线型、线宽和符号大小。在前面的高级绘图函数中也可以设置这些参数。<br>
</li>
<li>颜色相关参数：col、col.axis、col.lab、col.main、col.sub、fg、bg分别设置图形(点、线、文本等)、轴刻度、轴标签、标题、副标题、前景和背景颜色。<br>
</li>
<li>文本属性相关参数：cex.axis、cex.lab、cex.main、cex.sub、font分别设置轴刻度、轴标签、标题、副标题文字的缩放系数以及指定字体样式，font值为1~4，分别表示常规、粗体、斜体和粗斜体。同col和cex一样，font也可以加上.*(*为axis、lab、main、sub)形成4个参数，以对轴刻度、轴标签、标题和副标题文字指定字体样式。ps设置字体磅值(最终等于ps × cex)，family设置文本字体族，标准取值为”serif”(衬线)、“sans”(无衬线)、“mono”(等宽)，也可以设置为系统其他字体。<br>
</li>
<li>图形尺寸及边界：pin以英寸设置图形宽度和高度；mai和mar分别是以英寸和行数为单位来设置图形内部(包括轴标题和图形标题)“下左上右”四个边距。omi、oma分别以英寸和行为单位设置图形外部边距。mar、oma都以<em>mex</em>作为距离单位，默认值为1，为0.2英寸。mgp指定轴标题、轴标签和轴线的边距，默认是<code>c(3,1,0)</code>，mgp[1]的值影响轴标题，mgp[2]影响轴标签，mgp[3]影响轴线。<br>
</li>
<li>图形布局：mfrow、mfcol分别按指定向量设置后续图形按行或列排列。<br>
</li>
<li>轴相关参数：las设置轴标签与轴的关系，0为平行(默认)，1为总是水平，2为总是垂直于轴，3是总是竖直。tck和tcl用于设置轴刻度标记的长度，后者单位更小，可以实现更精细的调整。xaxs和yaxs设置x、y轴刻度样式，支持”r”和”i”，前者在数据范围两端扩展4%后确定最佳轴刻度标签，后者在原始数据范围内确定最佳轴刻度标签。xaxt和yaxt设置为”n”则不绘制x、y轴。xlog和ylog为TRUE时表示绘制对数轴刻度。xaxp和yaxp以<code>c(min, max, n)</code>设置在min和max范围内设置n个轴刻度线与标签。</li>
</ul>
<p>在控制台输入<code>?par</code>可以查询所有参数的设置详情和功能。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-3.12" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig3.12.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.12: 图形内部和外部边界参数
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="lattice绘图系统" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="lattice绘图系统"><span class="header-section-number">3.3.3</span> lattice绘图系统</h3>
<p>lattice绘图系统优化了基础绘图的参数默认值，并以框格(trelli)的形式展示多个变量之间的关系，其特点是支持以公式(formula)形式来指定变量进行条件绘图，特别适合多维数据以控制变量来做分组可视化分析。lattice绘图系统的主要高级绘图函数见 <a href="#tbl-3.11" class="quarto-xref">表&nbsp;<span>3.11</span></a> 所示。</p>
<div class="cell">
<div id="tbl-3.11" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-3.11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3.11: lattice绘图系统高级绘图函数
</figcaption>
<div aria-describedby="tbl-3.11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">图形函数</th>
<th style="text-align: left;">图形名称</th>
<th style="text-align: left;">公式</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">barchart</td>
<td style="text-align: left;">条形图</td>
<td style="text-align: left;">x<sub>A或A</sub>x</td>
</tr>
<tr class="even">
<td style="text-align: left;">bwplot</td>
<td style="text-align: left;">箱线图</td>
<td style="text-align: left;">x<sub>A或A</sub>x</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cloud</td>
<td style="text-align: left;">3D散点图</td>
<td style="text-align: left;">z~x*y|A</td>
</tr>
<tr class="even">
<td style="text-align: left;">contourplot</td>
<td style="text-align: left;">3D等高线图</td>
<td style="text-align: left;">z~x*y</td>
</tr>
<tr class="odd">
<td style="text-align: left;">densityplot</td>
<td style="text-align: left;">核密度图</td>
<td style="text-align: left;">~x|A*B</td>
</tr>
<tr class="even">
<td style="text-align: left;">dotplot</td>
<td style="text-align: left;">克利夫兰点图</td>
<td style="text-align: left;">~x|A</td>
</tr>
<tr class="odd">
<td style="text-align: left;">histogram</td>
<td style="text-align: left;">直方图</td>
<td style="text-align: left;">~x</td>
</tr>
<tr class="even">
<td style="text-align: left;">smoothScatter</td>
<td style="text-align: left;">平滑密度散点图</td>
<td style="text-align: left;">x</td>
</tr>
<tr class="odd">
<td style="text-align: left;">levelplot</td>
<td style="text-align: left;">3D层次图</td>
<td style="text-align: left;">z~y*x</td>
</tr>
<tr class="even">
<td style="text-align: left;">parallel</td>
<td style="text-align: left;">平行坐标图</td>
<td style="text-align: left;">数据框对象</td>
</tr>
<tr class="odd">
<td style="text-align: left;">splom</td>
<td style="text-align: left;">散点图矩阵</td>
<td style="text-align: left;">数据框对象</td>
</tr>
<tr class="even">
<td style="text-align: left;">stripplot</td>
<td style="text-align: left;">条纹图</td>
<td style="text-align: left;">A<sub>x或x</sub>A</td>
</tr>
<tr class="odd">
<td style="text-align: left;">xyplot</td>
<td style="text-align: left;">散点图</td>
<td style="text-align: left;">y~x|A</td>
</tr>
<tr class="even">
<td style="text-align: left;">wireframe</td>
<td style="text-align: left;">3D网格图</td>
<td style="text-align: left;">z~y*x</td>
</tr>
<tr class="odd">
<td style="text-align: left;">qqmath</td>
<td style="text-align: left;">理论分位数图</td>
<td style="text-align: left;">x</td>
</tr>
<tr class="even">
<td style="text-align: left;">qq</td>
<td style="text-align: left;">双变量分位数图</td>
<td style="text-align: left;">y~x</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>formula主要是用来指定图中展示的变量及其关系，比如公式”<sub>x|A”就是指将A变量作为因子，绘制变量x在A的不同水平的关系；而”y</sub>x|A*B”则是在因子A和B的不同水平组合中绘制y和x之间的关系；“~x”表示只绘制变量x。</p>
<p>使用lattice绘图系统绘图，需要用<code>library()</code>或<code>require()</code>函数加载lattice包。例如，绘制R内置数据集airquality中不同月份中臭氧与气温的关系，结果如 <a href="#fig-3.13" class="quarto-xref">图&nbsp;<span>3.13</span></a> 所示：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lattice)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> airquality</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>Month <span class="ot">=</span> <span class="fu">as.factor</span>(df<span class="sc">$</span>Month)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(Ozone <span class="sc">~</span> Temp <span class="sc">|</span> Month,<span class="at">data =</span> df,</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">panel =</span> <span class="cf">function</span>(<span class="at">y =</span> df<span class="sc">$</span>Ozone, <span class="at">x =</span> df<span class="sc">$</span>Temp){</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>         <span class="fu">panel.xyplot</span>(x, y, <span class="at">col =</span> <span class="st">"darkgrey"</span>, <span class="at">pch =</span> <span class="dv">20</span>)</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>         <span class="fu">panel.abline</span>(<span class="at">v =</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">h =</span> <span class="fu">mean</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>         <span class="fu">panel.lmline</span>(x, y, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.13" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.13-1.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.13: lattice绘制分面散点图
</figcaption>
</figure>
</div>
</div>
</div>
<p>以上代码通过自定义函数的形式重新定义了panel参数，为臭氧和气温两个变量添加了平均值虚线和拟合直线，可以更直觉地观察和对比不同月份中臭氧、气温的变化以及二者之间的关系。</p>
<p>lattice包提供的自定义panel参数的功能，可以根据需要综合多个绘图函数的功能，从而将分析结果更全面地呈现出来。</p>
<p>R基础绘图系统的绘图函数的参数基本上也适用于lattice绘图函数。此外，lattice绘图函数的其他参数如下所示，这些参数可以方便地调整lattcie图形：</p>
<ul>
<li>aspect: 指定绘图面板的纵横比，即高度/宽度</li>
<li>group: 指定分组变量(因子)</li>
<li>index.coord: 指定面板排列顺序</li>
<li>key、 auto.key: 设置图例</li>
<li>layout: 指定面板布局，列数与行数</li>
<li>panel: 指定在每个面板中生成的图形</li>
<li>scales: 指定如何绘制坐标轴</li>
<li>strip: 指定是否绘制条带</li>
<li>subset: 创建数据子集用于绘图数据</li>
<li>type: 指定散点图绘图选项(“p”、“l”、“r”、“smooth”、“g”分别表示点、线、直线回归线、局部多项式回归拟合和网格图形)</li>
</ul>
<p>更多参数及功能参考各绘图函数的帮助信息。尽管lattice中的绝大多数绘图函数都可以在基础绘图系统中找到相应的替代，如<code>contourplot()</code>和<code>levelplot()</code>可以用基础绘图系统中的<code>contour()</code>和<code>image()</code>替代，但默认出图效果上，lattice优于基础绘图系统，这是因为lattice根据不同图形类型做了较好的参数配置和优化。</p>
</section>
<section id="ggplot2绘图系统" class="level3" data-number="3.3.4">
<h3 data-number="3.3.4" class="anchored" data-anchor-id="ggplot2绘图系统"><span class="header-section-number">3.3.4</span> ggplot2绘图系统</h3>
<p>ggplot2是R中功能强大的著名绘图工具包，基于映射(mapping)和图层(layer)的概念，将数据变量映射到相应的图形美学特征，并层层叠加，从而创建出各种类型的图形，本质上是一种优雅的绘图语法。ggplot2汲取了基础绘图系统和lattice绘图系统的优点，兼具绘图功能强大与图形美观漂亮于一体，具有统一的绘图语法。 使用ggplot2绘图系统需要用<code>library()</code>或<code>require()</code>函数加载ggplot2包。该包是tidyverse套件成员，加载tidyverse套件会自动加载ggplot2包。</p>
<section id="ggplot2图形元素" class="level4" data-number="3.3.4.1">
<h4 data-number="3.3.4.1" class="anchored" data-anchor-id="ggplot2图形元素"><span class="header-section-number">3.3.4.1</span> ggplot2图形元素</h4>
<p>ggplot2将图形分为以下8个元素：</p>
<p>(1)<strong>数据(data)</strong>：绘图的基础，提供绘图所需要的变量。<br>
(2)<strong>美学映射(aesthetic mapping)</strong>：将数据中的变量与x轴、y轴、颜色、大小、形状、线宽、透明度等美学特征进行连接，这些都是在<code>aes()</code>函数中完成。<br>
(3)<strong>几何图形(geometry)</strong>：用于表征变量或变量间关系的几何图形，如点、线、柱形、条形、面等。在ggplot2中对应以<code>geom_</code>开头的各种函数。<br>
(4)<strong>统计变换(statistical transform)</strong>：对原始数据进行统计变换，在将变换后的统计信息添加到图形。在ggplot2中对应以<code>stat_</code>开头的各种函数。统计变化实际上是将特定的数据操作隐藏在可视化的背后。<br>
(5)<strong>标度(scale)</strong>：控制数据映射到图形的细节，如位置、颜色、大小、位置、形状、透明度等。在ggpplot2中对应以<code>sacle_</code>开头的各种函数。标度有助于创建更好的坐标轴刻度和图例。<br>
(6)<strong>坐标系(coordinate)</strong>：坐标系设置，包括笛卡尔坐标系、极坐标系等。在ggplot2中对应以<code>coord_</code>开头的函数。<br>
(7)<strong>分面(facet)</strong>：将数据集根据某个类别或因子型变量分组(分成子集)绘制图形，与lattice中的面板(panel)类似。在ggplot2中对应以<code>facet_</code>开头的各种函数。<br>
(8)<strong>主题(theme)</strong>：整个图形的风格设置，包括背景、网格、轴、字体、字号、颜色等。在ggplot2中对应<code>theme()</code>函数和以<code>theme_</code>开头的各种函数。<br>
</p>
<p>其中最核心的元素是<strong>数据</strong>、<strong>美学映射</strong>和<strong>几何图形/统计变换</strong>(二者可以成为图层)，其中数据和美学映射一般在主函数<code>ggplot()</code>中指定，也可以在几何图形和统计变换函数中指定。ggplot2图形通过“+”将元素一层一层叠加到一起，流程清晰，代码优雅。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-3.14" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig3.14.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.14: ggplot2图形组件
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="ggplot2绘图流程" class="level4" data-number="3.3.4.2">
<h4 data-number="3.3.4.2" class="anchored" data-anchor-id="ggplot2绘图流程"><span class="header-section-number">3.3.4.2</span> ggplot2绘图流程</h4>
<p>ggplot2绘图流程的核心是<code>ggplot()</code>主函数和相关图层函数(<code>geom_*</code>和<code>stat_*</code>系列函数，<code>*</code>代表关键字)，完成从数据到图形的映射和图形的绘制，这是基本的数据组件。根据需要还可以增加其他标度的美学映射，如颜色、形状、大小、线型、填充、透明度等，将数据中其他变量进行可视化。有一些图形需要调整坐标系，如风速风向玫瑰图需要采用极坐标系，地图需要采用地图坐标系并注意设置投影方法等。各种<code>scale_*</code>系列函数可用于各种标度的调整。<code>facet_*</code>系列函数可以根据一个或多个分类变量分面绘图。最后是图形的美化，包括各种标题、标签、图例以及主题风格，属于非数据组件。</p>
<p>下面用代码演示ggplot2绘图的各个环节：</p>
<p>(1)数据、坐标轴映射与图元类型</p>
<p>基于airquality，绘制散点图可视化其中Ozone与Temp两个变量的关系，并分别叠加折线图和拟合线图，结果如 <a href="#fig-3.14" class="quarto-xref">图&nbsp;<span>3.14</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> airquality</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="at">data =</span> df, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> Temp, <span class="at">y =</span> Ozone))</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 省略参数名的代码</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="co"># p = ggplot(df, aes(Temp, Ozone))  </span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a><span class="co">#散点图</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_point</span>()</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 散点图叠加折线图</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_line</span>()  <span class="co"># 因缺失值导致折线有中断</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 散点图叠加拟合线图</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_smooth</span>()  <span class="co"># 默认拟合方法是method = "loess"</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.15" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.15-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.15" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.15-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.15-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.15-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.15">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.15-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 散点图
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.15" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.15-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.15-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.15-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.15">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.15-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 散点图叠加折线图
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.15" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.15-3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.15-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.15-3.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.15">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.15-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) 散点图叠加拟合线图
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.15-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.15: ggplot2散点图及其与折线图和拟合线图的叠加
</figcaption>
</figure>
</div>
<p><code>ggplot()</code>中的参数data =和mapping=分别用于指定绘图数据来源和映射关系，可以省略。其中<code>aes()</code>函数用来指定标度与数据中变量的映射关系，上例中分别将Temp和Ozone变量映射到图形的x和y轴，这是指定图元的位置(position)标度，参数x=和y=也可以省略。<code>geom_point()</code>、<code>geom_line()</code>和<code>geom_smooth()</code>分别指定图元类型为散点图、折线图和平滑拟合线图。</p>
<p>只要不冲突，ggplot2可以实现多种图元类型的叠加，从而可视化更多的信息。这种叠加用“+”号即可实现，但最先绘制的图层在整个图形的底层，而最后添加的图层在顶层。</p>
<p>ggplot2创建的对象，其存储结构为list类型，可用<code>str()</code>函数查看其数据结构：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(p)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 11
 $ data       :'data.frame':    153 obs. of  6 variables:
  ..$ Ozone  : int [1:153] 41 36 12 18 NA 28 23 19 8 NA ...
  ..$ Solar.R: int [1:153] 190 118 149 313 NA NA 299 99 19 194 ...
  ..$ Wind   : num [1:153] 7.4 8 12.6 11.5 14.3 14.9 8.6 13.8 20.1 8.6 ...
  ..$ Temp   : int [1:153] 67 72 74 62 56 66 65 59 61 69 ...
  ..$ Month  : int [1:153] 5 5 5 5 5 5 5 5 5 5 ...
  ..$ Day    : int [1:153] 1 2 3 4 5 6 7 8 9 10 ...
 $ layers     : list()
 $ scales     :Classes 'ScalesList', 'ggproto', 'gg' &lt;ggproto object: Class ScalesList, gg&gt;
    add: function
    add_defaults: function
    add_missing: function
    backtransform_df: function
    clone: function
    find: function
    get_scales: function
    has_scale: function
    input: function
    map_df: function
    n: function
    non_position_scales: function
    scales: NULL
    train_df: function
    transform_df: function
    super:  &lt;ggproto object: Class ScalesList, gg&gt; 
 $ guides     :Classes 'Guides', 'ggproto', 'gg' &lt;ggproto object: Class Guides, gg&gt;
    add: function
    assemble: function
    build: function
    draw: function
    get_custom: function
    get_guide: function
    get_params: function
    get_position: function
    guides: NULL
    merge: function
    missing: &lt;ggproto object: Class GuideNone, Guide, gg&gt;
        add_title: function
        arrange_layout: function
        assemble_drawing: function
        available_aes: any
        build_decor: function
        build_labels: function
        build_ticks: function
        build_title: function
        draw: function
        draw_early_exit: function
        elements: list
        extract_decor: function
        extract_key: function
        extract_params: function
        get_layer_key: function
        hashables: list
        measure_grobs: function
        merge: function
        override_elements: function
        params: list
        process_layers: function
        setup_elements: function
        setup_params: function
        train: function
        transform: function
        super:  &lt;ggproto object: Class GuideNone, Guide, gg&gt;
    package_box: function
    print: function
    process_layers: function
    setup: function
    subset_guides: function
    train: function
    update_params: function
    super:  &lt;ggproto object: Class Guides, gg&gt; 
 $ mapping    :List of 2
  ..$ x: language ~Temp
  .. ..- attr(*, ".Environment")=&lt;environment: R_GlobalEnv&gt; 
  ..$ y: language ~Ozone
  .. ..- attr(*, ".Environment")=&lt;environment: R_GlobalEnv&gt; 
  ..- attr(*, "class")= chr "uneval"
 $ theme      : list()
 $ coordinates:Classes 'CoordCartesian', 'Coord', 'ggproto', 'gg' &lt;ggproto object: Class CoordCartesian, Coord, gg&gt;
    aspect: function
    backtransform_range: function
    clip: on
    default: TRUE
    distance: function
    expand: TRUE
    is_free: function
    is_linear: function
    labels: function
    limits: list
    modify_scales: function
    range: function
    render_axis_h: function
    render_axis_v: function
    render_bg: function
    render_fg: function
    setup_data: function
    setup_layout: function
    setup_panel_guides: function
    setup_panel_params: function
    setup_params: function
    train_panel_guides: function
    transform: function
    super:  &lt;ggproto object: Class CoordCartesian, Coord, gg&gt; 
 $ facet      :Classes 'FacetNull', 'Facet', 'ggproto', 'gg' &lt;ggproto object: Class FacetNull, Facet, gg&gt;
    compute_layout: function
    draw_back: function
    draw_front: function
    draw_labels: function
    draw_panels: function
    finish_data: function
    init_scales: function
    map_data: function
    params: list
    setup_data: function
    setup_params: function
    shrink: TRUE
    train_scales: function
    vars: function
    super:  &lt;ggproto object: Class FacetNull, Facet, gg&gt; 
 $ plot_env   :&lt;environment: R_GlobalEnv&gt; 
 $ layout     :Classes 'Layout', 'ggproto', 'gg' &lt;ggproto object: Class Layout, gg&gt;
    coord: NULL
    coord_params: list
    facet: NULL
    facet_params: list
    finish_data: function
    get_scales: function
    layout: NULL
    map_position: function
    panel_params: NULL
    panel_scales_x: NULL
    panel_scales_y: NULL
    render: function
    render_labels: function
    reset_scales: function
    resolve_label: function
    setup: function
    setup_panel_guides: function
    setup_panel_params: function
    train_position: function
    super:  &lt;ggproto object: Class Layout, gg&gt; 
 $ labels     :List of 2
  ..$ x: chr "Temp"
  ..$ y: chr "Ozone"
 - attr(*, "class")= chr [1:2] "gg" "ggplot"</code></pre>
</div>
</div>
<p>最新的ggplot2函数参考信息见<a href="https://ggplot2.tidyverse.org/reference/index.html" class="uri">https://ggplot2.tidyverse.org/reference/index.html</a></p>
<p>(2)颜色、形状等其他标度的映射</p>
<p>除了数据位置标度的映射(x、y轴)，<code>aes()</code>函数还可以指定图元其他的标度如颜色(color和fill)、大小(size)、形状(shape)、线型(linetype)、透明度(alpha)等与数据变量的映射。</p>
<p>例如，要给 <a href="#fig-3.15-1" class="quarto-xref">图&nbsp;<span>3.15 (a)</span></a> 中的数据点设置颜色，有两种方法：一种是设置统一的颜色，另一种是根据数据集中某个变量来给数据点设置不同的颜色。前者与数据映射无关，不能在<code>aes()</code>函数中设置；后者与数据映射有关，需要在<code>aes()</code>函数中设置。下面的代码演示了这两种设置颜色的方法，结果如 <a href="#fig-3.16" class="quarto-xref">图&nbsp;<span>3.16</span></a> 所示，注意两者的区别：</p>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置统一颜色</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>)</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 根据Month变量设置颜色</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> Month))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.16" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.16-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.16" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.16-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.16-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.16-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.16">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.16-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 设置统一颜色
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.16" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.16-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.16-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.16-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.16">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.16-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 根据变量设置颜色
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.16-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.16: 设置颜色标度
</figcaption>
</figure>
</div>
<p>由于变量Month是连续型变量，所以自动使用了渐变色，同时自动添加图例，以指示颜色标度与相应数据变量的关系。显然，将月份以渐变色来表征与期望不相符。下面的代码将Month变量转换为因子型变量，ggplot2就会自动使用离散色系来表征，可视化效果更好。结果如图 <a href="#fig-3.17-1" class="quarto-xref">图&nbsp;<span>3.17 (a)</span></a> 所示。用户还可以用不同点的形状来映射Month变量，结果如 <a href="#fig-3.17-2" class="quarto-xref">图&nbsp;<span>3.17 (b)</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 将Month变量因子化</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.factor</span>(Month)))</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 将Month变量因子化并映射至shape标度</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">shape =</span> <span class="fu">as.factor</span>(Month)))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.17" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.17-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.17" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.17-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.17-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.17-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.17">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.17-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 设置统一颜色
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.17" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.17-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.17-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.17-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.17">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.17-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 根据变量设置颜色
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.17-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.17: 设置颜色标度
</figcaption>
</figure>
</div>
<p>对于连续型和离散型数据，其标度映射存在差异，如 <a href="#tbl-3.12" class="quarto-xref">表&nbsp;<span>3.12</span></a> 所示。</p>
<div class="cell">
<div id="tbl-3.12" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-3.12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;3.12: ggplot2图元分类及标度映射
</figcaption>
<div aria-describedby="tbl-3.12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<colgroup>
<col style="width: 2%">
<col style="width: 70%">
<col style="width: 11%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">图元</th>
<th style="text-align: left;">函数</th>
<th style="text-align: left;">离散标度</th>
<th style="text-align: left;">连续标度</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">点</td>
<td style="text-align: left;">geom_point、geom_jitter、geom_dotplot等</td>
<td style="text-align: left;">color、fill、shape</td>
<td style="text-align: left;">color、fill、alpha、size</td>
</tr>
<tr class="even">
<td style="text-align: left;">线</td>
<td style="text-align: left;">geom_line、geom_path、geom_curve、geom_density、geom_linerange、 geom_|step、geom_abline、geom_hline等</td>
<td style="text-align: left;">color、linetype</td>
<td style="text-align: left;">color、size、alpha</td>
</tr>
<tr class="odd">
<td style="text-align: left;">形</td>
<td style="text-align: left;">geom_polygon、geom_rect、geom_bar、geom_ribbon、geom_area、 geom_histogram、geom_|violin等</td>
<td style="text-align: left;">color、fill</td>
<td style="text-align: left;">color、fill、alpha</td>
</tr>
<tr class="even">
<td style="text-align: left;">文本</td>
<td style="text-align: left;">geom_text、geom_label</td>
<td style="text-align: left;">color</td>
<td style="text-align: left;">color、angle、vjust、hjust</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>(3)坐标系</p>
<p>坐标系的主要功能是将两个位置上的图元属性组合起来形成二维方位系统。常见的图元位置属性在笛卡尔坐标系中一般被称为x和y，但在极坐标系中称作角度和长度。ggplot2提供了多种坐标系，不同绘图函数的默认坐标系不同，各坐标系的相关函数与功能如下：</p>
<ul>
<li><code>coord_cartesian()</code>：笛卡尔坐标系<br>
</li>
<li><code>coord_fixed()</code>、<code>coord_equal()</code>：同尺度笛卡尔坐标系<br>
</li>
<li><code>coord_polar()</code>：极坐标系<br>
</li>
<li><code>coord_flip()</code>：翻转的笛卡尔坐标系<br>
</li>
<li><code>coord_munch()</code>：切分线段实现独立转换<br>
</li>
<li><code>coord_sf()</code>：绘制sf地图对象的坐标系<br>
</li>
<li><code>coord_map()</code>、<code>coord_quickmap()</code>：地图投影坐标系<br>
</li>
<li><code>coord_trans()</code>：转换连续型变量的坐标系</li>
</ul>
<p>以下代码基于默认的笛卡尔坐标系和极坐标系绘制了airquality数据集中Ozone变量的频数分布图，结果如 <a href="#fig-3.18" class="quarto-xref">图&nbsp;<span>3.18</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(airquality, <span class="fu">aes</span>(Ozone, <span class="at">fill =</span> <span class="fu">as.factor</span>(Month))) </span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 基于默认的笛卡尔坐标系</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_histogram</span>()</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 采用极坐标系</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span> <span class="fu">coord_polar</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.18" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.18-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.18" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.18-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.18-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.18-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.18">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.18-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 笛卡尔坐标系
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.18" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.18-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.18-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.18-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.18">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.18-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 极坐标系
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.18-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.18: 笛卡尔坐标系和极坐标系
</figcaption>
</figure>
</div>
<p>最常用的也是默认的坐标系是笛卡尔坐标系，在<code>coord_cartesian()</code>函数中，可通过<code>xlim</code>和<code>ylim</code>参数设置x和y轴的显示范围，<code>expand</code>参数为<code>TRUE</code>时，会给轴显示范围添加一个小的扩展，以避免数据与轴线重叠。<code>coord_fixed()</code>函数中提供了一个<code>aspect</code>参数来设置纵横比(y与x轴单位长度比)，这在y与x轴对应变量的量纲可比时非常有用。极坐标系用于各种圆形图，如饼图、风速风向玫瑰图等，<code>coord_polar()</code>函数中，参数<code>theta</code>设置角度映射到x还是y轴，参数<code>start</code>设置起始点与12点钟方向的偏移，参数<code>direction</code>设置角度正方向，1为顺时针，-1为逆时针。</p>
<p>(4)坐标轴标度</p>
<p>如果要对x、y轴的刻度进行变换(对数转换、平方根转换等)或逆序排列、调整刻度间隔、改变刻度标签等，可以利用<code>scale_x_</code>和<code>scale_y_</code>系列函数来实现:</p>
<ul>
<li><code>scale_x_continous()</code>、<code>scale_y_continous()</code>：调整连续型变量x、y轴标度<br>
</li>
<li><code>scale_x_discrete()</code>、<code>scale_y_discrete()</code>：调整离散型变量x、y轴标度</li>
<li><code>scale_x_reverse()</code>、<code>scale_y_reverse()</code>：连续型变量轴标度逆序<br>
</li>
<li><code>scale_x_log10()</code>、<code>scale_y_log10()</code>：连续型变量轴标度对数化</li>
<li><code>scale_x_sqrt()</code>、<code>scale_y_sqrt()</code>：连续型变量轴标度平方根化</li>
<li><code>scale_x_binned()</code>、<code>scale_y_binned()</code>：以分箱方法离散化连续型数据</li>
<li><code>scale_x_date()</code>、<code>scale_y_date()</code>：调整日期型数据的轴标度</li>
<li><code>scale_x_datetime()</code>、<code>scale_y_datetime()</code>：调整日期时间型数据的轴标度</li>
<li><code>scale_x_time()</code>、<code>scale_y_time()</code>：调整时间型数据的轴标度</li>
</ul>
<p>在这些函数中通用的参数有：</p>
<ul>
<li>name：轴标度名称(轴标题)<br>
</li>
<li>breaks：调整坐标刻度(NULL不显示刻度，或一组指定的数值向量；默认采用<code>waiver()</code>自动计算)<br>
</li>
<li>labels：调整坐标刻度显示标签(NULL不显示刻度，或一组指定的字符向量；默认是采用<code>waiver()</code>自动计算)<br>
</li>
<li>limits：调整轴标度显示范围(NULL为默认显示范围，或指定两个元素的数值向量或一组字符向量)<br>
</li>
<li>expand：轴两端的扩展，通过<code>expansion()</code>函数为其赋值<br>
</li>
<li>position：y轴可赋值left或right，x轴可赋值top和bottom</li>
</ul>
<p>其他参数详见系统函数帮助信息。</p>
<p>下面的代码调整了 <a href="#fig-3.18" class="quarto-xref">图&nbsp;<span>3.18</span></a> 中x轴刻度的显示，结果如 <a href="#fig-3.19" class="quarto-xref">图&nbsp;<span>3.19</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># x轴刻度逆序</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span> <span class="fu">scale_x_reverse</span>()   </span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="co"># x轴刻度对数化</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span> <span class="fu">scale_x_log10</span>(<span class="at">name=</span><span class="st">"log10(Ozone)"</span>,    </span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">50</span>,<span class="dv">100</span>),</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">add =</span> <span class="fl">0.5</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.19" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.19-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.19" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.19-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.19-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.19-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.19">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.19-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) x轴刻度逆序显示
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.19" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.19-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.19-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.19-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.19">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.19-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) x轴刻度对数变换
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.19-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.19: 调整x轴刻度显示
</figcaption>
</figure>
</div>
<p><a href="#fig-3.19-1" class="quarto-xref">图&nbsp;<span>3.19 (a)</span></a> 实现了x轴刻度逆序，<a href="#fig-3.19-2" class="quarto-xref">图&nbsp;<span>3.19 (b)</span></a> 实现了x轴刻度对数化，并调整了刻度显示和轴两端的扩展。在连续型数据轴标度调整函数(<code>scale_x_continous()</code>和<code>scale_y_continous()</code>)中有一个trans参数可以实现更多类型的数据变换，包括自定义变换函数。</p>
<p>其他标度如alpha(透明度)、color(颜色)、fill(填充色)、linetype(线型)、size(大小)、shape(形状)等的调整，可以利用相应的<code>scale_*_xxx()</code>系列函数实现，其中<code>*</code>为<code>alpha</code>、<code>color</code>、<code>fill</code>、<code>linetype</code>、<code>shape</code>、<code>size</code>等标度关键字，具体使用方法参考各函数的帮助信息。</p>
<p>(5)分面绘图</p>
<p><code>fecet_wrap()</code>和<code>facet_grid()</code>两个函数可以用于实现根据一个或多个分类变量(因子型变量)进行分面绘图，从而比较分析不同因子或因子组合条件下，x和y轴对应变量的关系。前者通常将每个面板尽可能绘制成正方形，以充分利用绘图空间，后者可以将面板形成一行多列、多行一列或多行多列的网格排列。对于单个分类变量分面绘图的，建议采用前者，反之，则建议采用后者。</p>
<p>下面的代码演示了这两个函数根据airquality数据集中Month变量来分面绘制呈现Temp和Ozone变量关系的散点图，结果如 <a href="#fig-3.20" class="quarto-xref">图&nbsp;<span>3.20</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> airquality</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(Temp, Ozone)) <span class="sc">+</span> </span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>)</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">facet_wrap</span>(. <span class="sc">~</span> Month) </span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">facet_grid</span>(. <span class="sc">~</span> Month)</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">facet_grid</span>(Month <span class="sc">~</span> .)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.20" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.20-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.20" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.20-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.20-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.20-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.20">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.20-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) facet_wrap()分面
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.20" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.20-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.20-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.20-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.20">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.20-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) facet_grid()垂直分面
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.20" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.20-3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.20-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.20-3.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.20">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.20-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) facet_grid()水平分面
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.20-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.20: 分面绘图
</figcaption>
</figure>
</div>
<p>(6)图例</p>
<p>除了x、y轴映射之外的其他标度与变量的映射，都会自动产生默认的图例。图例的调整主要通过<code>guides()</code>函数和<code>theme()</code>函数中与图例相关的参数来调整。</p>
<p>删除图例，可用<code>guides(xxx="none")</code>，其中<code>xxx</code>为相应标度的关键字；也可用在<code>theme()</code>函数中将参数legend.position的值设置为”none”来达到同样的目的。</p>
<p>修改图例标题，可用<code>labs()</code>函数中给相应标度关键字赋值字符串即可；如果同时修改图例标签，建议在相应关键字的<code>scale_*_xxx()</code>系列标度函数中，通过name参数指定图例标题，labels参数指定图例标签。</p>
<p>下面的代码演示了两种修改图例的方法，结果如 <a href="#fig-3.21" class="quarto-xref">图&nbsp;<span>3.21</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(airquality, </span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">aes</span>(Month, Ozone, <span class="at">fill =</span> <span class="fu">as.factor</span>(Month))) <span class="sc">+</span> </span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 自动生成的默认图例</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>p</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 修改图例标题</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"月份"</span>)</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 修改图例标题和标签</span></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"月份"</span>,</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">paste0</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">9</span>,<span class="st">"月"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.21" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.21-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.21" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.21-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.21-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.21-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.21">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.21-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 自动生成的图例
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.21" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.21-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.21-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.21-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.21">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.21-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 修改图例标题
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.21" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.21-3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.21-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.21-3.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.21">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.21-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) 修改图例标题和标签
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.21-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.21: 修改图例
</figcaption>
</figure>
</div>
<p><a href="#fig-3.21-1" class="quarto-xref">图&nbsp;<span>3.21 (a)</span></a> 中图例为自动生成的默认图例， <a href="#fig-3.21-2" class="quarto-xref">图&nbsp;<span>3.21 (b)</span></a> 中图图例用<code>labs()</code>函数修改了图例标题，右图用<code>scale_fill_discrete()</code>函数修改了图例标题和标签。</p>
<p>图例的位置可以在<code>theme()</code>函数中用legend.position参数来调整，其取值有”none”、“left”、“right”、“bottom”、“top”和”inside”，或者一个二元素的数值向量(0靠近左和下，1靠近右和上)，一般用于将图例放置在图形中的某个位置。该函数中的legend.direction参数用来调整图例方向，取值有”horizontal”和”vertical”，另一个参数legend.justification用来指图例定对齐。</p>
<p>下面的代码演示了图例位置的调整方法，结果如 <a href="#fig-3.22" class="quarto-xref">图&nbsp;<span>3.22</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 图例调整到图形区下方</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> </span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"Month"</span>)</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 图例调整图形区左上角</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"inside"</span>,</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position.inside =</span> <span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.95</span>),</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.95</span>)) <span class="sc">+</span> </span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"Month"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.22" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.22-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.22" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.22-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.22-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.22-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.22">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.22-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 调整图例至图形区下方
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.22" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.22-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.22-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.22-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.22">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.22-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 调整图例至图形区左上角
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.22-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.22: 调整图例位置
</figcaption>
</figure>
</div>
<p>(7)主题</p>
<p>ggplot2的主题系统用于精细调整图形中的非数据元素，不会影响几何对象和标度等数据元素，使图像更美观，特别是满足整体一致性的要求。R的基础绘图系统和lattice绘图系统没有将数据和非数据元素的控制进行分离，图形精细调整比较复杂。</p>
<p>ggplot2主题系统的设置通过<code>theme()</code>函数完成。在<code>theme()</code>中指定要调整的非数据元素，并通过与之相应的绑定函数来完成该元素的属性(颜色、大小、位置、线型、填充等)调整操作。主题系统将非数据元素分为三大类，即线(line)、矩形(rect)和文本(text)，与之对应的绑定函数分别是<code>element_line()</code>、<code>element_rect()</code>和<code>element_text()</code>。从文本衍生出的标题(title)，用于控制图形、轴以及图例的标题，也与<code>element_text()</code>函数绑定。这些元素的从属对象包括图形(plot)、轴(axis)、图例(legend)、分面面板(panel)和分面面板上部的条带区(strip)，此外还有用于调整绘图面板纵横比的参数aspect.ratio。在控制台输入<code>?theme</code>，可以打开<code>theme()</code>函数的帮助页面，了解所有可以被控制的图形非数据元素，例如title元素同时调整图形、轴和图例的标题，axis.title调整所有坐标轴的标题，axis.title.x调整x轴的标题，axis.title.x.top调整上x轴的标题，这些标题元素都是对文本元素的继承。</p>
<p>下面的代码用于调整 <a href="#fig-3.22-1" class="quarto-xref">图&nbsp;<span>3.22 (a)</span></a> 中轴标题(axis.title)和轴刻度标签(axis.text)大小,结果如 <a href="#fig-3.23-1" class="quarto-xref">图&nbsp;<span>3.23 (a)</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> p <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>以下代码利用<code>element_blank()</code>函清除图形面板背景(panel.background)，再用<code>element_rect()</code>函数绘制图形面板边框并设置填充为透明色，结果如 <a href="#fig-3.23-2" class="quarto-xref">图&nbsp;<span>3.23 (b)</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span> p <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>),</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"transparent"</span>)) <span class="co"># 绘制图形边框</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-3.23" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.23-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.23" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.23-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.23-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.23-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.23">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.23-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 调整轴标题和轴刻度标签文本大小
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.23" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.23-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.23-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.23-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.23">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.23-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 修改图形面板背景和绘制图形面板边框
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.23-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.23: 主题元素调节
</figcaption>
</figure>
</div>
<p><code>element_text()</code>函数用于调整图形文字外观，使用非常频繁。该函数提供了size、family、face、color、angle、vjust和hjust等参数，分别用于设置和调整文字字号、字体族、字体风格、样色、倾斜角度以及水平和垂直位置调整。对于family参数，默认值可以用<code>windowsFonts()</code>函数查看，Windows系统包括”serif”、“sans”和”mono”三个字体族，分别对应字体Time New Roman、Arial和Courier New。如果需要调用windows系统的字体，可以先用<code>windowsFonts()</code>函数将Windows系统中的指定字体赋值给变量，然后在<code>element_text()</code>函数中用<code>windowFont()</code>函数调用相应字体的变量即可：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">windowsFonts</span>(<span class="at">MSYH =</span> <span class="fu">windowsFont</span>(<span class="st">"微软雅黑"</span>))</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"MSYH"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>参数<code>face</code>提供了4种可选的字体风格：plain(常规)、bold(粗体)、italic(斜体)和bold.italic(粗斜体)，可根据需要来设置使用。</p>
<p>除了提供了<code>theme()</code>函数调整图形的各种非数据元素外，ggplot2还提供了8个预置的主题：<code>theme_bw()</code>、<code>theme_classic()</code>、<code>theme_dark()</code>、<code>theme_gray()</code>(默认主题)、<code>theme_light()</code>、<code>theme_linedraw()</code>、<code>theme_minimal()</code>、<code>theme_void()</code>(空主题)和<code>theme_test()</code>(用于视觉测试的主题)。使用预置主题后，用户仍然可以通过<code>theme()</code>函数来调整非数据元素。</p>
<p>(8)添加注释</p>
<p>当需要在绘图区为每个图形元素添加文字注释时，可以使用<code>geom_text()</code>和<code>geom_label()</code>，在其中指定映射到参数label的变量(通常是一个包含在绘图数据框中的字符型变量)。下面的代码演示了这两个函数添加文字注释的方法和视觉差异，结果如 <a href="#fig-3.24" class="quarto-xref">图&nbsp;<span>3.24</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">y =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">label =</span> letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(x, y)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> label), <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">xlim</span>(<span class="dv">1</span>, <span class="dv">6</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">1</span>, <span class="dv">7</span>)</span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(x, y)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> label), <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">xlim</span>(<span class="dv">1</span>, <span class="dv">6</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">1</span>, <span class="dv">7</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.24" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.24-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.24" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.24-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.24-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.24-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.24">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.24-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) geom_label()添加文字注释
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.24" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.24-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.24-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.24-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-3.24">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.24-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) geom_text()添加文字注释
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.24-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.24: 添加文字注释
</figcaption>
</figure>
</div>
<p>如果要添加的注释不是来自绘图数据集中变量的映射，可使用<code>annotate()</code>函数。该函数可以在指定位置添加文字(text)、矩形(rect)、线段(segment)、点线段(pointrange)等。以下代码演示了<code>annotate()</code>在图形中添加文字、矩形、线段(用arrow()函数绘制箭头)和点线段的方法，结果如 <a href="#fig-3.25" class="quarto-xref">图&nbsp;<span>3.25</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">y =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(x, y)) <span class="sc">+</span> <span class="fu">geom_point</span>() </span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 原始图形</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>p</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 添加文字和矩形</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="dv">5</span>,</span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"italic(R)^2 == 0.88"</span>, <span class="at">parse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="fl">2.5</span>, <span class="at">xmax =</span> <span class="fl">3.5</span>,</span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">ymin =</span> <span class="fl">3.5</span>, <span class="at">ymax =</span> <span class="fl">4.5</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>)</span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 添加线段和点线</span></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">annotate</span>(<span class="st">"segment"</span>, <span class="at">x =</span> <span class="fl">2.5</span>, <span class="at">xend =</span> <span class="fl">3.5</span>, <span class="at">y =</span> <span class="fl">3.5</span>,</span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">yend =</span> <span class="fl">4.5</span>, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">angle =</span> <span class="dv">40</span>, <span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.25</span>, <span class="st">"cm"</span>),</span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ends =</span> <span class="st">"last"</span>, <span class="at">type =</span> <span class="st">"open"</span>)) <span class="sc">+</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"pointrange"</span>, <span class="at">x =</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="dv">4</span>, <span class="at">ymin =</span> <span class="dv">3</span>, <span class="at">ymax =</span> <span class="dv">5</span>,</span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.25" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.25-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.25" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.25-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.25-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.25-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.25" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.25-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 原始图形
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.25" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.25-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.25-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.25-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.25" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.25-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 添加文字和矩形
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.25" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.25-3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.25-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.25-3.png" class="img-fluid figure-img" data-ref-parent="fig-3.25" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.25-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) 添加线段和点线
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.25-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.25: annotate()添加多种注释
</figcaption>
</figure>
</div>
<p>如果要添加曲线，可使用<code>geom_curve()</code>函数，同样可以在其中用<code>arrow()</code>为曲线两端绘制箭头。</p>
<p>(9)标题和脚注</p>
<p><code>labs()</code>函数可以设置和调整图形标题(title)、副标题(subtitle)、脚注(caption)、图号标签(tag)、轴标题(x，y)、图例标题(参数为产生图例的标度关键字，如fill、color等)等。<code>ggtitle()</code>函数仅能够设置图形标题(label)和副标题(subtitle)。设置和调整轴标题还可以直接使用<code>xlab()</code>和<code>ylab()</code>函数。以下代码演示为图形设置各种文本元素，结果如 <a href="#fig-3.26" class="quarto-xref">图&nbsp;<span>3.26</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(airquality, </span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">aes</span>(Month, Ozone, <span class="at">fill =</span> <span class="fu">as.factor</span>(Month))) <span class="sc">+</span> </span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"月份"</span>,</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels =</span> <span class="fu">paste0</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">9</span>,<span class="st">"月"</span>))</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a><span class="fu">windowsFonts</span>(<span class="at">MSYH =</span> <span class="fu">windowsFont</span>(<span class="st">"msyh.tcc"</span>))</span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 原始图形</span></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>p</span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 添加</span></span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"空气质量数据箱线图"</span>,</span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"臭氧浓度数据"</span>,</span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">caption =</span> <span class="st">"数据来源: 美国纽约1973年5月至9月监测数据."</span>,</span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">tag =</span> <span class="st">"A"</span>) <span class="sc">+</span></span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"月份"</span>) <span class="sc">+</span> </span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"臭氧浓度"</span>) <span class="sc">+</span></span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"MSYH"</span>,</span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">face =</span> <span class="st">"bold"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.26" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.26-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.26" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.26-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.26-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.26-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.26" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.26-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 原始图形
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.26" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.26-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.26-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.26-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.26" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.26-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 添加标题、脚注等元素
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.26-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.26: 设置图形标题、脚注等元素
</figcaption>
</figure>
</div>
<p>在ggplot2生态中，有很多辅助功能的扩展包，如ggthemes包提供了更多风格的主题、标度和几何图形，ggsci包提供了知名学术期刊的配色，RColorBrewer包也提供了比较丰富的配色方案，ggrepel包可以添加更美观的文本标签，patchwork包可以用很简单的方式将多个图形组合起来。在<a href="https://exts.ggplot2.tidyverse.org/">ggplot2 extensions</a>网站可以查询和了解更多各种ggplot2的扩展包。</p>
</section>
<section id="ggplot2图形保存" class="level4" data-number="3.3.4.3">
<h4 data-number="3.3.4.3" class="anchored" data-anchor-id="ggplot2图形保存"><span class="header-section-number">3.3.4.3</span> ggplot2图形保存</h4>
<p>除了可以用<code>pdf()</code>、<code>svg()</code>、<code>tiff()</code>、<code>png()</code>等文件设备函数保存ggplot2的图形外，ggplot2也提供了一个专用的保存图形的函数——<code>ggsave()</code>，建议ggplot2绘制的图形只用该函数来保存。该函数的参数有：</p>
<ul>
<li>filename：指定文件名<br>
</li>
<li>plot：保存的图形，默认是保存最后显示的图形<br>
</li>
<li>device：指定图形设备，即图形保存类型；可以使用设备函数，也可以是文件类型扩展名，如pdf、png、svg、tiff等<br>
</li>
<li>path：指定文件保存路径<br>
</li>
<li>scale：缩放系数，默认为1<br>
</li>
<li>width：图形宽度<br>
</li>
<li>height：图形高度<br>
</li>
<li>units：图形尺寸的单位，可选英寸(in)、厘米(cm)、毫米(mm)或像素(px)<br>
</li>
<li>dpi：图形分辨率(每英寸点数)，默认为 300，仅应用于栅格图形<br>
</li>
<li>limitsize：为TRUE时，<code>ggsave()</code>函数不会保存尺寸超过50英寸×50英寸的图形<br>
</li>
<li>bg：设置图形背景颜色</li>
</ul>
<p>此外，在图形设备函数中可用的参数也可用于<code>ggsave()</code>函数中。</p>
<p>电脑屏幕显示的图形和<code>ggsave()</code>保存的图形是有差异的，以下代码演示了两者的差异。先将 <a href="#fig-3.26-2" class="quarto-xref">图&nbsp;<span>3.26 (b)</span></a> 用<code>ggsave()</code>函数保存到当前目录的“images”子目录中：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"空气质量数据箱线图"</span>,</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"臭氧浓度数据"</span>,</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">caption =</span> <span class="st">"数据来源: 美国纽约1973年5月至9月监测数据."</span>,</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">tag =</span> <span class="st">"A"</span>) <span class="sc">+</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"月份"</span>) <span class="sc">+</span> </span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"臭氧浓度"</span>) <span class="sc">+</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">"MSYH"</span>,</span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"fig3.27-2.png"</span>, p1, </span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">path =</span> <span class="st">"./images/"</span>, <span class="at">device =</span> <span class="st">"png"</span>,</span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">height =</span> <span class="dv">3</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">units =</span> <span class="st">"in"</span>, </span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">dpi =</span> <span class="dv">300</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 37 rows containing non-finite outside the scale range
(`stat_boxplot()`).</code></pre>
</div>
</div>
<div id="fig-3.27" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.27-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.27" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.27-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.27-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.27-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.27" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.27-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 屏幕显示的图形
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.27" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.27-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.27-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig3.27-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.27" width="750">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.27-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) ggsave()保存的图形
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.27-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.27: 屏幕显示的图形和ggsave()保存的图形
</figcaption>
</figure>
</div>
<div id="exr-3.1" class="theorem exercise">
<p><span class="theorem-title"><strong>练习 3.1</strong></span> <br>
(1)将airquality数据集赋值给df，用<code>summary()</code>函数进行摘要分析。然后利用VIM包中的<code>rangerimpute()</code>函数和数据集中其他变量信息对Ozone变量的缺失值进行填补。填补后再用<code>summary()</code>函数进行摘要分析。<br>
(2)利用<code>data.frame()</code>函数生成一个新的数据框data，其中第一个变量名为date，用<code>seq()</code>函数结合<code>as.Date()</code>函数生成1973年5月1日至1973年9月30日的日期型数据，第二个变量为ozone，取值为df中已经填补缺失值的Ozone变量；然后用<code>summary()</code>函数进行摘要分析。<br>
(3)利用ggplot2将该数据框绘制成散点图叠加连线图，点和线分别采用红色和蓝色。然后调整x和y轴的标题分别为“日期”和“臭氧浓度”，并将字体改为“微软雅黑”，删除绘图面板中的背景色和网格线。<br>
(4)利用<code>ggsave()</code>函数将图形保存为tiff格式，宽度为10cm，高度为6cm，dpi为300。</p>
</div>
</section>
</section>
</section>
<section id="r数据可视化实践" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="r数据可视化实践"><span class="header-section-number">3.4</span> R数据可视化实践</h2>
<section id="数据关系与可视化类型" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="数据关系与可视化类型"><span class="header-section-number">3.4.1</span> 数据关系与可视化类型</h3>
<p>数据通常反映5种关系：<strong>构成</strong>、<strong>比较</strong>、<strong>趋势</strong>、<strong>分布</strong>和<strong>联系</strong>。</p>
<p><strong>构成</strong>反映整体与局部的关系，以呈现整体中每个部分占总体比例的多少。例如在某个地区全年COD总排放量中，不同行业的排放量所占的百分比，此时可选择饼图(pie chart)。</p>
<p><strong>比较</strong>反映相同变量在不同分组或地点或时间上的多少、大小、高低等关系。例如某地自2010年至2020年COD排放总量，又如全国各省会城市2021年PM2.5年平均浓度，此时可选择条形图(bar chart)。</p>
<p><strong>趋势</strong>反映变量随时间、纬度、海拔等变化的关系，常用于时序类数据的分析。例如某地大气中臭氧浓度随小时、月份和季度的变化，此时通常选择线图(line chart)来表示。</p>
<p><strong>分布</strong>反映变量在连续的不同数值范围内或不同地理位置上出现的频数，从而观察在哪个范围或位置上比较集中，是否对称，近似哪种概率分布类型等。例如展示一年内PM<sub>2.5</sub>日均浓度落在≤35、36-75、76-115、116-150、151-250、≥251μg/m<sup>3</sup>六个浓度范围内的个数，来观察在哪个范围频数最多、整体分布是否为正偏态分布，此时往往选用频数分布柱状图(histogram chart)。</p>
<p><strong>联系</strong>反映两个变量之间存在的某种相关关系，例如变量1随变量2增大而减小，或变量1随变量2增大而先增大后减小等，此时一般选择散点图(scatter chart)</p>
<p>此外，反映变量与地理空间位置的关系，一般要结合地图(map)来展示。雷达图(radar chart)常用于展示高维数据(3维以上)的关系。词云图(word cloud chart)用于展示海量文本中重要关键词出现的频率。在这些基本图形类型的基础上，还有很多衍生出来的图形类型，能够更好地可视化各种具体的数据关系，以及更好地呈现变量内或变量间的联系。</p>
</section>
<section id="可视化整体局部关系" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="可视化整体局部关系"><span class="header-section-number">3.4.2</span> 可视化整体局部关系</h3>
<section id="饼图" class="level4" data-number="3.4.2.1">
<h4 data-number="3.4.2.1" class="anchored" data-anchor-id="饼图"><span class="header-section-number">3.4.2.1</span> 饼图</h4>
<p>R基础绘图系统中提供了<code>pie()</code>函数用于绘制饼图，ggpubr包提供了<code>ggpie()</code>函数绘制饼图。下面的代码演示用ggplot2来间接绘制饼图：</p>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pollutant =</span> <span class="fu">c</span>(<span class="st">"粉尘"</span>, <span class="st">"氮氧化物"</span>, <span class="st">"硫氧化物"</span>, <span class="st">"挥发性有机物"</span>),</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">emission =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="fl">3.5</span>, <span class="fl">2.3</span>, <span class="fl">1.2</span>))</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span> (<span class="at">x=</span><span class="st">""</span>, <span class="at">y =</span> emission, <span class="at">fill =</span> pollutant)) <span class="sc">+</span> </span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">'stack'</span>, <span class="at">width =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"pollutant"</span>,</span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"ggplot2绘制的饼图"</span>) <span class="sc">+</span> </span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_polar</span>(<span class="at">theta =</span> <span class="st">"y"</span>)</span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 添加原始数据作为标签</span></span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> emission, <span class="at">x =</span> <span class="fl">1.3</span>),</span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">position =</span> <span class="fu">position_stack</span>(<span class="at">vjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 添加百分比数据作为标签</span></span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste</span>(<span class="fu">round</span>(emission <span class="sc">/</span> <span class="fu">sum</span>(emission) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>), <span class="at">x =</span> <span class="fl">1.3</span>),</span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">position =</span> <span class="fu">position_stack</span>(<span class="at">vjust =</span> <span class="fl">0.5</span>)) </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.28" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.28-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.28" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.28-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.28-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.28-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.28" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.28-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 添加原始数据
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.28" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.28-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.28-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.28-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.28" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.28-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 添加构成百分比
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.28-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.28: ggplot2绘制饼图
</figcaption>
</figure>
</div>
</section>
<section id="圆环图" class="level4" data-number="3.4.2.2">
<h4 data-number="3.4.2.2" class="anchored" data-anchor-id="圆环图"><span class="header-section-number">3.4.2.2</span> 圆环图</h4>
<p>圆环图是饼图的衍生类型，ggpubr中的<code>ggdonutchart()</code>函数能够直接圆环图圆环图(donut chart)。下面演示用ggplot2包来绘制，但使用(图3-39右图)：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>hsize <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x =</span> hsize)</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span> (<span class="at">x =</span> x, <span class="at">y =</span> emission, <span class="at">fill =</span> pollutant)) <span class="sc">+</span></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_polar</span>(<span class="at">theta =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="fl">0.2</span>, hsize <span class="sc">+</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste</span>(<span class="fu">round</span>(emission <span class="sc">/</span> <span class="fu">sum</span>(emission) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>), <span class="at">x =</span> <span class="dv">2</span>),</span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">position =</span> <span class="fu">position_stack</span>(<span class="at">vjust =</span> <span class="fl">0.5</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.29" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.29-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.29-1.png" class="img-fluid figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.29-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.29: ggplot2绘制圆环图
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="矩形树状图" class="level4" data-number="3.4.2.3">
<h4 data-number="3.4.2.3" class="anchored" data-anchor-id="矩形树状图"><span class="header-section-number">3.4.2.3</span> 矩形树状图</h4>
<p>矩形树状图(rectangular treemap)通过嵌套矩形形式可视化数据的层次结构关系，其原理是用面积大小表征每个部分的数量。下面基于 <a href="#fig-3.28" class="quarto-xref">图&nbsp;<span>3.28</span></a> 的数据，利用ggplot2的扩展包treemapif包绘制矩形树状图：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(treemapify)</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">area =</span> emission, <span class="at">fill =</span> pollutant,</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">label =</span> <span class="fu">paste</span>(<span class="fu">round</span>(emission <span class="sc">/</span> <span class="fu">sum</span>(emission) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>))) <span class="sc">+</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_treemap</span>() <span class="sc">+</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_treemap_text</span>(<span class="at">colour =</span> <span class="st">"white"</span>, <span class="at">place =</span> <span class="st">"center"</span>, <span class="at">reflow =</span> T)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.30" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.30-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.30-1.png" class="img-fluid figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.30-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.30: treemapify绘制矩形树状图
</figcaption>
</figure>
</div>
</div>
</div>
<p>此外， ggraph包提供了绘制冰柱图(icicle chart)和旭日图(sunburst chart)的功能。ggraph是ggplot2的一个扩展，擅长于可视化网络结构、图结构和树状结构的数据关系。华夫饼图(waffle chart)用统一大小的方块或点来量化呈现各部分在整体中所占的数量或百分比，waffle包中的<code>waffle()</code>函数可以快速绘制华夫饼图。马赛克图(mosaic chart)是一种类似矩形树状图的可视化方案，也是用面积大小来表征数量或百分比，R的基础绘图系统提供的<code>mosaicplot()</code>函数、ggmosaic包中的<code>geom_mosai()</code>函数以及vcd包中的<code>mosaic()</code>函数都可以绘制马赛克图。</p>
</section>
</section>
<section id="可视化类别比较关系" class="level3" data-number="3.4.3">
<h3 data-number="3.4.3" class="anchored" data-anchor-id="可视化类别比较关系"><span class="header-section-number">3.4.3</span> 可视化类别比较关系</h3>
<section id="条形图" class="level4" data-number="3.4.3.1">
<h4 data-number="3.4.3.1" class="anchored" data-anchor-id="条形图"><span class="header-section-number">3.4.3.1</span> 条形图</h4>
<p>条形图(bar chart)通过条柱的高低来比较各类别中相同的一个或多个变量的差异，还能以百分比的形式比较各类别中相同变量的构成关系。ggplot2包提供了<code>geom_bar()</code>和<code>geom_col()</code>两个绘制柱形图的函数，前者默认使用<code>stat_count()</code>统计函数，后者默认使用<code>stat_identity()</code>统计函数。</p>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建绘图数据</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">emission =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">15</span>, <span class="at">mean =</span> <span class="dv">20</span>, <span class="at">sd =</span> <span class="dv">4</span>), <span class="dv">1</span>),</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">city =</span> <span class="fu">rep</span>(LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>], <span class="at">each =</span> <span class="dv">5</span>),</span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">pollutant =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"PM2.5"</span>, <span class="st">"PM10"</span>, <span class="st">"SOx"</span>, <span class="st">"NOx"</span>, <span class="st">"O3"</span>), <span class="at">time =</span> <span class="dv">3</span>))</span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(city) <span class="sc">%&gt;%</span> </span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent =</span> <span class="fu">round</span>(emission <span class="sc">/</span> <span class="fu">sum</span>(emission), <span class="dv">2</span>))</span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 单变量柱形图</span></span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df[df<span class="sc">$</span>pollutant <span class="sc">==</span> <span class="st">"PM10"</span>, ], <span class="fu">aes</span>(city, emission, <span class="at">fill =</span> city)) <span class="sc">+</span></span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span> </span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"PM10"</span>) <span class="sc">+</span></span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> df[df<span class="sc">$</span>pollutant <span class="sc">==</span> <span class="st">"PM10"</span>, ]<span class="sc">$</span>emission),</span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">vjust =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"white"</span>)</span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 多变量条形图</span></span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(city, emission, </span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a>                   <span class="at">fill =</span> pollutant, </span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a>                   <span class="at">group =</span> city)) <span class="sc">+</span> </span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true" tabindex="-1"></a><span class="co"># position = dodge2，绝对数非堆积形式</span></span>
<span id="cb142-30"><a href="#cb142-30" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">position =</span> <span class="st">"dodge2"</span>) <span class="sc">+</span></span>
<span id="cb142-31"><a href="#cb142-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> emission), <span class="at">color =</span> <span class="st">"white"</span>, </span>
<span id="cb142-32"><a href="#cb142-32" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> <span class="fu">position_dodge2</span>(<span class="fl">0.9</span>),</span>
<span id="cb142-33"><a href="#cb142-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">vjust =</span> <span class="dv">2</span>) </span>
<span id="cb142-34"><a href="#cb142-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-35"><a href="#cb142-35" aria-hidden="true" tabindex="-1"></a><span class="co"># position = stack，绝对数堆积形式</span></span>
<span id="cb142-36"><a href="#cb142-36" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">position =</span> <span class="st">"stack"</span>) <span class="sc">+</span></span>
<span id="cb142-37"><a href="#cb142-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> emission), <span class="at">color =</span> <span class="st">"white"</span>, </span>
<span id="cb142-38"><a href="#cb142-38" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> <span class="fu">position_stack</span>(<span class="fl">0.5</span>))</span>
<span id="cb142-39"><a href="#cb142-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-40"><a href="#cb142-40" aria-hidden="true" tabindex="-1"></a><span class="co"># position = fill，相对数堆积形式</span></span>
<span id="cb142-41"><a href="#cb142-41" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">position =</span> <span class="st">"fill"</span>) <span class="sc">+</span></span>
<span id="cb142-42"><a href="#cb142-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> percent), <span class="at">color =</span> <span class="st">"white"</span>, </span>
<span id="cb142-43"><a href="#cb142-43" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> <span class="fu">position_fill</span>(<span class="fl">0.5</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.31" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.31-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.31" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.31-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.31-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.31-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.31" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.31-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 单变量条形图
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.31" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.31-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.31-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.31-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.31" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.31-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 绝对数非堆积形式多变量条形图
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.31" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.31-3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.31-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.31-3.png" class="img-fluid figure-img" data-ref-parent="fig-3.31" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.31-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) 绝对数堆积形式多变量条形图
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.31" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.31-4" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.31-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.31-4.png" class="img-fluid figure-img" data-ref-parent="fig-3.31" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.31-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d) 相对数堆积形式多变量条形图
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.31-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.31: 不同的条形图
</figcaption>
</figure>
</div>
<p>ggplot2的几何图形函数和统计变换函数中都有一个参数position，其默认值为”identity”，表示不调整几何图元的位置，由映射变量控制。但在一些图形绘制中，需要改变图元位置，此时可利用<code>position_*()</code>系列函数调整图元位置：</p>
<ul>
<li><code>positon_dodge()</code>：图元并排，需要指定分组变量，组内图元无间隙。<br>
</li>
<li><code>positon_dodge2()</code>：图元并排，不需要指定分组变量，组内图元有间隙。对于条形和矩形图元，可以设置可变宽度。<br>
</li>
<li><code>positon_fill()</code>：图元按组内比例堆积。<br>
</li>
<li><code>positon_identity()</code>：不调整图元位置。<br>
</li>
<li><code>positon_jitter()</code>：添加抖动，减少重叠，对于小数据散点图特别有用。<br>
</li>
<li><code>positon_jitterdodge()</code>：图元并排的同时添加抖动，在散点图和箱线图重叠时特别有用。<br>
</li>
<li><code>positon_nudge()</code>：通过指定x和y的值来平移图元位置，在<code>geom_text()</code>函数中内置了该函数，以避免文本与图元重叠。<br>
</li>
<li><code>positon_stack()</code>：图元按绝对数堆积。</li>
</ul>
<p>如果需要，可使用<code>coord_flip()</code>函数翻转x和y轴，形成横向条形图。</p>
<p>如果需要用条形的宽度表征另一个变量，可通过绘制不等宽的条形图来实现。例如下面的数据集，需要用条形的高度代表城市的PM<sub>2.5</sub>年均浓度(μg/m<sup>3</sup>)，柱形的宽度代表城市的年GDP(10亿元)。这可以利用ggplot2中的<code>geom_rect()</code>来绘制，但在使用该函数之前，需要计算出相关的绘图参数。以下代码演示了这一方法，结果如 <a href="#fig-3.32" class="quarto-xref">图&nbsp;<span>3.32</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">city =</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>],</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">pm25 =</span> <span class="fu">c</span>(<span class="dv">67</span>, <span class="dv">45</span>, <span class="dv">23</span>),</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">gdp =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算每个柱形在x轴的起点和终点</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>xmin <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>) df<span class="sc">$</span>xmin[i] <span class="ot">=</span> <span class="fu">sum</span>(df<span class="sc">$</span>gdp[<span class="dv">1</span><span class="sc">:</span>i <span class="sc">-</span> <span class="dv">1</span>])</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) df<span class="sc">$</span>xmax[i] <span class="ot">=</span> <span class="fu">sum</span>(df<span class="sc">$</span>gdp[<span class="dv">1</span><span class="sc">:</span>i])</span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 构造x轴刻度标签的坐标</span></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) df<span class="sc">$</span>xpos[i] <span class="ot">=</span> <span class="fu">sum</span>(df<span class="sc">$</span>gdp[<span class="dv">1</span><span class="sc">:</span>i]) <span class="sc">-</span> df<span class="sc">$</span>gdp[i] <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制不等宽柱形图</span></span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> xmin, <span class="at">xmax =</span> xmax, <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> pm25,</span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a>                <span class="at">fill =</span> city), <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> xpos, <span class="at">y =</span> pm25 <span class="sc">+</span> <span class="dv">3</span>, <span class="at">label =</span> pm25), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb143-18"><a href="#cb143-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> xpos, <span class="at">y =</span> <span class="sc">-</span><span class="dv">4</span>, <span class="at">label =</span> city), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb143-19"><a href="#cb143-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb143-20"><a href="#cb143-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"city"</span>, <span class="at">y =</span> <span class="fu">expression</span>(PM[<span class="fl">2.5</span>]))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.32" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.32-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.32-1.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.32-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.32: 不等宽条形图
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="克利夫兰点图" class="level4" data-number="3.4.3.2">
<h4 data-number="3.4.3.2" class="anchored" data-anchor-id="克利夫兰点图"><span class="header-section-number">3.4.3.2</span> 克利夫兰点图</h4>
<p>克利夫兰点图(Cleveland’s dot plot)及其变体棒棒糖图(lollipop chart，增加了从轴连接到点的线段)、哑铃图(dumbbell plot，线段连接两个端点，用于表征某个变量在两个不同分组上的值)是将柱形图的柱形简化为点和线，减少空间占用，聚焦数据展示，相对而言更加简洁和美观。绘制这三种图可用ggplot2中的<code>geom_segment()</code>和/或<code>geom_point()</code>来实现，也可直接用R基础绘图系统提供的<code>dotchart()</code>函数，更简便 的方法是利用ggpubr包中的<code>ggdotchart()</code>函数绘制。</p>
<p>例如，现有某年15个地区的煤炭使用量(万吨)数据(随机构造)：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">city =</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>],</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">coal =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">15</span>, <span class="dv">40</span>, <span class="dv">10</span>)))</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   city coal
1     A   39
2     B   31
3     C   45
4     D   24
5     E   20
6     F   51
7     G   43
8     H   50
9     I   38
10    J   44
11    K   25
12    L   39
13    M   47
14    N   19
15    O   39</code></pre>
</div>
</div>
<p>使用ggpubr包绘制，结果如图 <a href="#fig-3.33-1" class="quarto-xref">图&nbsp;<span>3.33 (a)</span></a> 所示；使用ggplot2包绘制，结果如图 <a href="#fig-3.33-2" class="quarto-xref">图&nbsp;<span>3.33 (b)</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdotchart</span>(df, <span class="at">x =</span> <span class="st">"city"</span>, <span class="at">y =</span> <span class="st">"coal"</span>,</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"city"</span>, <span class="at">palette =</span> <span class="fu">rainbow</span>(<span class="dv">20</span>),</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">sorting =</span> <span class="st">"descending"</span>, <span class="at">add =</span> <span class="st">"segments"</span>,</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">rotate =</span> <span class="cn">TRUE</span>, <span class="at">dot.size =</span> <span class="dv">3</span>, <span class="at">label =</span> <span class="st">"coal"</span>,</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">font.label =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">8</span>, <span class="at">hjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">ggtheme =</span> <span class="fu">theme_pubr</span>()) <span class="sc">+</span> </span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">70</span>)</span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(coal, city, <span class="at">label =</span> coal)) <span class="sc">+</span></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">xend =</span> coal,</span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> <span class="fu">reorder</span>(city, coal),</span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>                   <span class="at">yend =</span> <span class="fu">reorder</span>(city, coal)),</span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"gray60"</span>) <span class="sc">+</span></span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">fill =</span> coal), <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">hjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">70</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.33" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.33-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.33" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.33-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.33-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.33-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.33" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.33-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) ggpubr绘制
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.33" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.33-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.33-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.33-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.33" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.33-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) ggplot2绘制
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.33-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.33: 棒棒糖图
</figcaption>
</figure>
</div>
</section>
<section id="坡度图" class="level4" data-number="3.4.3.3">
<h4 data-number="3.4.3.3" class="anchored" data-anchor-id="坡度图"><span class="header-section-number">3.4.3.3</span> 坡度图</h4>
<p>坡度图(slope chart)本质上是多组折现图，能够很好地比较在两个或多个不同时间或条件下某些变量的数据变化关系。该图形同样可以利用ggplot2中的<code>geom_segment()</code>和<code>geom_point()</code>函数来绘制出来。</p>
<p>下面的代码构造了5个国家2010年与2020年PM<sub>2.5</sub>年均浓度，然后绘制坡度图比较变化关系，结果如 <a href="#fig-3.34" class="quarto-xref">图&nbsp;<span>3.34</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 输入数据</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Country =</span> <span class="fu">paste0</span>(<span class="st">"C"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>),</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">Y_2010 =</span> <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">73</span>, <span class="dv">46</span>, <span class="dv">53</span>, <span class="dv">32</span>),</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">Y_2020 =</span> <span class="fu">c</span>(<span class="dv">34</span>, <span class="dv">56</span>, <span class="dv">68</span>, <span class="dv">40</span>, <span class="dv">13</span>))</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 增加绘图坐标</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>x0 <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">5</span>) ; df<span class="sc">$</span>x1 <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">5</span>)</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制图形</span></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> x0, <span class="at">xend =</span> x1,</span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> Y_2010, <span class="at">yend =</span> Y_2020),</span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"lightblue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"orange"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> x0, <span class="at">y =</span> Y_2010, <span class="at">color =</span> Country), <span class="at">size =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> Y_2020, <span class="at">color =</span> Country), <span class="at">size =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fl">0.2</span>),</span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2020</span>)) <span class="sc">+</span></span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="fu">expression</span>(PM[<span class="fl">2.5</span>]))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.34" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.34-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.34-1.png" class="img-fluid figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.34-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.34: 坡度图
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="玫瑰图" class="level4" data-number="3.4.3.4">
<h4 data-number="3.4.3.4" class="anchored" data-anchor-id="玫瑰图"><span class="header-section-number">3.4.3.4</span> 玫瑰图</h4>
<p>玫瑰图(rose chart)本质上是极坐标柱形图，特别是适合于风速风向数据的可视化，圆的半径用于度量风向频率，角度用于度量风向(气象数据中0°为正北风向)。ggplot2可以通过使用极坐标很方便地实现玫瑰图。这里特别推荐使用openair包来绘制风速风向玫瑰图，该包是分析、理解和解释空气污染数据的工具，还集成了英国空气污染物监测数据下载的功能。</p>
<p>下面的代码演示利用worldmet包下载气象数据，然后利用openair包对风速风向数据进行可视化，结果如 <a href="#fig-3.35" class="quarto-xref">图&nbsp;<span>3.35</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(worldmet)</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(openair)</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 从NOAA下载和合肥骆岗气象站2021年气象数据</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>dfmet <span class="ot">=</span> <span class="fu">importNOAA</span>(<span class="at">code =</span> <span class="st">"583210-99999"</span>, <span class="at">year =</span> <span class="dv">2021</span>)</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dfmet)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 22
  code         station  date                latitude longitude  elev    ws    wd
  &lt;fct&gt;        &lt;fct&gt;    &lt;dttm&gt;                 &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 583210-99999 LUOGANG… 2021-01-01 00:00:00     31.8      117.  32.9   1.2  140.
2 583210-99999 LUOGANG… 2021-01-01 01:00:00     31.8      117.  32.9   3    180 
3 583210-99999 LUOGANG… 2021-01-01 02:00:00     31.8      117.  32.9   3    180 
4 583210-99999 LUOGANG… 2021-01-01 03:00:00     31.8      117.  32.9   2.9  176.
5 583210-99999 LUOGANG… 2021-01-01 04:00:00     31.8      117.  32.9   3    210 
6 583210-99999 LUOGANG… 2021-01-01 05:00:00     31.8      117.  32.9   3    240 
# ℹ 14 more variables: air_temp &lt;dbl&gt;, atmos_pres &lt;dbl&gt;, visibility &lt;dbl&gt;,
#   dew_point &lt;dbl&gt;, RH &lt;dbl&gt;, ceil_hgt &lt;dbl&gt;, cl_1 &lt;dbl&gt;, cl_2 &lt;dbl&gt;,
#   cl_3 &lt;dbl&gt;, cl &lt;dbl&gt;, cl_1_height &lt;dbl&gt;, cl_2_height &lt;dbl&gt;,
#   cl_3_height &lt;dbl&gt;, precip_6 &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 对风速风向数据进行可视化，按季节分面绘制，布局为4列1行</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="fu">windRose</span>(dfmet, <span class="at">ws =</span> <span class="st">"ws"</span>, <span class="at">wd =</span> <span class="st">"wd"</span>, <span class="at">type =</span> <span class="st">"season"</span>, <span class="at">layout =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">1</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.35" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.35-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.35-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.35-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.35: 风速风向玫瑰图
</figcaption>
</figure>
</div>
</div>
</div>
<p>从 <a href="#fig-3.35" class="quarto-xref">图&nbsp;<span>3.35</span></a> 可以分析合肥市2021年四个季节风速风向的差异。openair能够结合风速风向分析空气污染物浓度变化的规律并进行建模以及开展轨迹分析(trajectory analysis)，是研究空气污染的有力工具。</p>
</section>
<section id="雷达图" class="level4" data-number="3.4.3.5">
<h4 data-number="3.4.3.5" class="anchored" data-anchor-id="雷达图"><span class="header-section-number">3.4.3.5</span> 雷达图</h4>
<p>雷达图(radar chart)也称为蜘蛛网图，用与比较若干个研究对象的多个数值型变量(属性)，例如比较两个城市的人口、燃油车辆保有数量、燃煤消费量、GDP、PM<sub>2.5</sub>浓度等指标，观察哪些指标相近，哪些指标差异很大。又如比较几个厂家生产的某类环保设备的若干指标。雷达图也存在明显的缺点，如不能表征太多的研究对象和变量，否则可视化效果很混乱，不易于阅读。</p>
<p>fmsb包集成了简便绘制雷达图的函数。下面使用ggradar包来演示雷达图的绘制，因为该包是ggplot2的扩展包，绘图语法相同。在绘制雷达图之前，需要将各类变量进行标准化，一般建议将所有观测值按最大最小值缩放到[0, 1]区间。</p>
<p>安装ggradar包：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"ricardo-bion/ggradar"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggradar)</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 构造绘图数据集：</span></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2022</span>)</span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">26</span>]</span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>  人口 <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">26</span>, <span class="dv">50</span>, <span class="dv">10</span>)),</span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">GDP =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">26</span>, <span class="dv">30</span>, <span class="dv">10</span>)),</span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>  煤炭 <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">26</span>, <span class="dv">500</span>, <span class="dv">100</span>)),</span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>  汽车 <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">26</span>, <span class="dv">10</span>, <span class="dv">2</span>)),</span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">PM2.5 =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">26</span>, <span class="dv">50</span>, <span class="dv">20</span>)))</span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(df) <span class="ot">=</span> city</span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 数据归一化，并选出4个城市作为比较研究的对象</span></span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>dfradar <span class="ot">=</span> df <span class="sc">%&gt;%</span>  </span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="at">rownames =</span> <span class="st">"city"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="sc">-</span>city), scales<span class="sc">::</span>rescale) <span class="sc">%&gt;%</span>  <span class="co"># 利用scales中rescale()函数执行归一化</span></span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">4</span>)  <span class="co"># 选取前4个城市</span></span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制雷达图</span></span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggradar</span>(dfradar, <span class="at">base.size =</span> <span class="dv">6</span>,</span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">grid.label.size =</span> <span class="dv">5</span>,</span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.label.size =</span> <span class="dv">5</span>,</span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">group.point.size =</span> <span class="dv">3</span>,</span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text.size =</span> <span class="dv">10</span>,</span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"right"</span>) </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.36" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.36-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.36-1.png" class="img-fluid figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.36-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.36: 雷达图
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="词云图" class="level4" data-number="3.4.3.6">
<h4 data-number="3.4.3.6" class="anchored" data-anchor-id="词云图"><span class="header-section-number">3.4.3.6</span> 词云图</h4>
<p>词云图(word cloud chart)将关键词的大小与其出现的频率成正比，然后通过某种方式(方形、圆形、星星等)排列在一起。词云图可用于探索论文、报告等文章中的哪些关键词出现的频率高，可有助于掌握该文章的重点。 绘制词云图需要提前准备好关键词及其频率的数据。先利用jiebaR包对原始文本内容进行分词，再统计关键词的频数，构造关键词与出现频率的数据集，最后用wordcloud2包绘制词云图。</p>
<p>以下代码先复制<a href="https://www.mee.gov.cn/hjzl/sthjzk/sthjtjnb/202202/t20220218_969391.shtml">中国生态环境部网站2020年中国环境公报</a>综述部分的内容，保存到cneb2020-rev.txt文件中，保存时选择编码方式为UTF-8，并置于当前目录下的data子目录中。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr) </span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jiebaR) </span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jiebaRD) </span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wordcloud2) </span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>word <span class="ot">=</span> <span class="fu">read_lines</span>(<span class="st">"./data/cneb2020-rev.txt"</span>)</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>engine <span class="ot">=</span> <span class="fu">worker</span>(<span class="st">"mix"</span>)</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">segment</span>(word, engine)</span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>word <span class="ot">=</span> jiebaR<span class="sc">::</span><span class="fu">freq</span>(data)</span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>word_s <span class="ot">=</span> word[word<span class="sc">$</span>freq <span class="sc">&gt;=</span> <span class="dv">5</span>, ] </span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a><span class="fu">wordcloud2</span>(word_s, <span class="at">color =</span> <span class="st">"random-light"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.37" class="cell-output-display quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.37-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="wordcloud2 html-widget html-fill-item" id="htmlwidget-dfe6ce4178e5a5c8e95e" style="width:60%;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-dfe6ce4178e5a5c8e95e">{"x":{"word":["中","废水","集中式","排放量","工业","需氧量","的","全国","化学","设施","年","为","亿吨","万吨","其中","源","生活","氨氮","污染","治理","废气","氮氧化物","2020","颗粒物","量"],"freq":[26,7,5,28,8,5,5,8,5,6,5,34,6,32,6,17,8,5,5,5,18,5,5,5,7],"fontFamily":"Segoe UI","fontWeight":"bold","color":"random-light","minSize":0,"weightFactor":5.294117647058823,"backgroundColor":"white","gridSize":0,"minRotation":-0.7853981633974483,"maxRotation":0.7853981633974483,"shuffle":true,"rotateRatio":0.4,"shape":"circle","ellipticity":0.65,"figBase64":null,"hover":null},"evals":[],"jsHooks":{"render":[{"code":"function(el,x){\n                        console.log(123);\n                        if(!iii){\n                          window.location.reload();\n                          iii = False;\n\n                        }\n  }","data":null}]}}</script>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.37-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.37: 词云图
</figcaption>
</figure>
</div>
</div>
</section>
</section>
<section id="可视化趋势发展变化" class="level3" data-number="3.4.4">
<h3 data-number="3.4.4" class="anchored" data-anchor-id="可视化趋势发展变化"><span class="header-section-number">3.4.4</span> 可视化趋势发展变化</h3>
<section id="折线图" class="level4" data-number="3.4.4.1">
<h4 data-number="3.4.4.1" class="anchored" data-anchor-id="折线图"><span class="header-section-number">3.4.4.1</span> 折线图</h4>
<p>折线图(line chart)是最常用的可视化时序类型数据的方法，可以显示变量在时间上的变化趋势，同图可视化同时间段的其他变量，可以观察变量之间的关系。R中绘制折线图的方法非常多，这里演示利用ggplot2包中的<code>geom_line()</code>函数绘制折线图。</p>
<p>下面的案例需要从UCI 机器学习数据库网站下载北京PM<sub>2.5</sub>数据，该数据集包括北京市2010年1月1日至2014年12月31日的PM<sub>2.5</sub>小时浓度数据以及同时间内的气象数据，缺失值用NA表示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggTimeSeries)</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a><span class="co"># filepath = "https://archive.ics.uci.edu/static/public/381/beijing+pm2+5+data.zip"</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a><span class="co"># savepath = "./data/bj-pm2.5-data.zip"</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a><span class="co"># download.file(filepath, savepath)</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="fu">unzip</span>(<span class="st">"./data/bj-pm2.5-data.zip"</span>,<span class="st">"PRSA_data_2010.1.1-2014.12.31.csv"</span>),</span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">col_names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 截取2012年的数据子集</span></span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>start <span class="ot">=</span> <span class="fu">ymd_h</span>(<span class="st">"2012/01/01/0"</span>, <span class="at">tz =</span> <span class="st">"Asia/Shanghai"</span>)</span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>end <span class="ot">=</span> <span class="fu">ymd_h</span>(<span class="st">"2012/12/31/23"</span>, <span class="at">tz =</span> <span class="st">"Asia/Shanghai"</span>)</span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2012</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">datetime =</span> <span class="fu">seq</span>(start, end, <span class="at">by =</span> <span class="st">"hours"</span>)) <span class="sc">%&gt;%</span>  <span class="co"># 生成新变量datetime</span></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">filter</span>(month <span class="sc">==</span> <span class="dv">6</span>)</span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 用geom_line绘制PM2.5时序数据</span></span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(datetime, pm2<span class="fl">.5</span>)) <span class="sc">+</span></span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span> </span>
<span id="cb154-23"><a href="#cb154-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.38" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.38-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.38-1.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.38-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.38: 折线图
</figcaption>
</figure>
</div>
</div>
</div>
<p>可以将同时期内的多个时序变量绘制到同一个图，以用于分析这些变量之间的关系。但考虑到变量的量纲差异，一般需要进行对各变量的数据进行归一化处理(根据最大最小值，线性压缩到[0, 1]区间，这可借助scales包中的 <code>rescale()</code>函数实现)。下面的ggplot2代码将pm2.5、TEMP和Iws三个时序变量绘制到同一个图形中, <a href="#fig-3.29" class="quarto-xref">图&nbsp;<span>3.29</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>dfsub <span class="ot">=</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(datetime, pm2<span class="fl">.5</span>, TEMP, Iws) <span class="sc">%&gt;%</span> </span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 对三类数值变量进行归一化处理</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>dfnorm <span class="ot">=</span> dfsub <span class="sc">%&gt;%</span> </span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="sc">-</span>datetime), scales<span class="sc">::</span>rescale)</span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>dfnorm<span class="sc">$</span>datetime <span class="ot">=</span> dfsub<span class="sc">$</span>datetime</span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 将三列变量汇总成一列变量(宽表转成长表)</span></span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>dfnorm <span class="ot">=</span> dfnorm <span class="sc">%&gt;%</span> </span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">!</span>datetime,</span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"vars"</span>,</span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制图形</span></span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dfnorm, <span class="fu">aes</span>(datetime, value, <span class="at">group =</span> vars)) <span class="sc">+</span></span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> vars)) <span class="sc">+</span></span>
<span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date time"</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span> </span>
<span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_datetime</span>(<span class="at">date_labels =</span> <span class="st">"%m-%d"</span>, <span class="at">date_breaks =</span> <span class="st">"5 days"</span>) <span class="sc">+</span></span>
<span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.39" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.39-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.39-1.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.39-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.39: 折线图
</figcaption>
</figure>
</div>
</div>
</div>
<p>在变量较多、数据量很大的情况下，不建议同图绘制多个变量的时序折线图。此时可以考虑用分面绘制，结果如 <a href="#fig-3.40" class="quarto-xref">图&nbsp;<span>3.40</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dfnorm, <span class="fu">aes</span>(datetime, value, <span class="at">color =</span> vars)) <span class="sc">+</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(vars <span class="sc">~</span> .) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date time"</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span> </span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_datetime</span>(<span class="at">date_labels =</span> <span class="st">"%m-%d"</span>, <span class="at">date_breaks =</span> <span class="st">"5 days"</span>) <span class="sc">+</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.40" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.40-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.40-1.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.40-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.40: 多维时序数据分面折线图
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="面积图" class="level4" data-number="3.4.4.2">
<h4 data-number="3.4.4.2" class="anchored" data-anchor-id="面积图"><span class="header-section-number">3.4.4.2</span> 面积图</h4>
<p>面积图(area plot)是在折线图基础上，在折线与x轴之间填充颜色或纹理而得到的视觉效果更美观的图形。在绘制多个时序变量时，应设置填充的透明度，避免变量数据之间因遮挡和覆盖而无法观察的情况。</p>
<p>在网站<a href="https://ourworldindata.org/grapher/so-emissions-by-world-region-in-million-tonnes">Our World in Data</a>展示了亚洲、非洲、欧洲、南美洲和北美洲自1850-2010年的二氧化硫排放量时序面积图，在该页面下载原始数据到工作目录，用ggplot2中的<code>geom_area()</code>和<code>geom_line()</code>函数绘制出类似的面积图，结果如 <a href="#fig-3.41" class="quarto-xref">图&nbsp;<span>3.41</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"./data/so-emissions-by-world-region-in-million-tonnes.csv"</span>,</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">col_names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(Entity <span class="sc">!=</span> <span class="st">"World"</span>)</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Entity"</span>, <span class="st">"Code"</span>, <span class="st">"Year"</span>, <span class="st">"SO2"</span>)</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df) <span class="sc">+</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="fu">aes</span>(Year, SO2, <span class="at">group =</span> <span class="fu">rev</span>(Entity), <span class="at">fill=</span>Entity),</span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(Year, SO2, <span class="at">color =</span> Entity), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>, <span class="dv">40</span>, <span class="dv">60</span>, <span class="dv">80</span>),</span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">paste</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>, <span class="dv">40</span>, <span class="dv">60</span>, <span class="dv">80</span>), <span class="st">"m tonnes"</span>)) <span class="sc">+</span></span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Global sulphur dioxide emissions by world region"</span>,</span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Annual sulphur dioxide emissions in million tonnes"</span>,</span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Source: Clio Infra, Klimont. et al (2013)."</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.41" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.41-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.41-1.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.41-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.41: 多维时序数据面积图
</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-3.41" class="quarto-xref">图&nbsp;<span>3.41</span></a> 所示的面积图没有采用堆积(stack)的方式，而是直接显示原始时序数据以便比较。和多维折线图一样，当变量和数据过多时，多维面积图的视觉效果很差，建议分面绘制。</p>
</section>
<section id="日历热图" class="level4" data-number="3.4.4.3">
<h4 data-number="3.4.4.3" class="anchored" data-anchor-id="日历热图"><span class="header-section-number">3.4.4.3</span> 日历热图</h4>
<p>日历热图(calendar heatmap)可以展示以日(day)为时间单位的时序数据，例如展示大气污染物日均浓度，从而可以观察污染物浓度随日、周、月等时间尺度上的变化规律。绘制日历热图可以借助ggTimeSeries包中的<code>stat_calendar_heatmap()</code>函数：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggTimeSeries)</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 构造绘图数据</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2022</span>) </span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2020-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2021-12-31"</span>), <span class="st">"days"</span>),</span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(<span class="dv">731</span>, <span class="dv">120</span>, <span class="dv">30</span>)))</span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成新的变量</span></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="fu">as.integer</span>(<span class="fu">year</span>(date)),</span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">month =</span> <span class="fu">as.integer</span>(<span class="fu">month</span>(date)),</span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">week =</span> <span class="fu">as.integer</span>(<span class="fu">week</span>(date)))</span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算x轴刻度位置并生成相应刻度标签</span></span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a>monthlbs <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">month =</span> month.abb,</span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> (<span class="fu">group_by</span>(df, month) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">mean</span>(week)))[ , <span class="dv">2</span>])</span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(monthlbs) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"month"</span>, <span class="st">"mean"</span>)</span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制图形</span></span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">date =</span> date, <span class="at">fill =</span> value)) <span class="sc">+</span> </span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_calendar_heatmap</span>() <span class="sc">+</span> </span>
<span id="cb158-27"><a href="#cb158-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradientn</span>(<span class="at">colours =</span> <span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">11</span>, <span class="st">"Spectral"</span>))) <span class="sc">+</span> </span>
<span id="cb158-28"><a href="#cb158-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="cn">NULL</span>,</span>
<span id="cb158-29"><a href="#cb158-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">7</span>, <span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>), </span>
<span id="cb158-30"><a href="#cb158-30" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, </span>
<span id="cb158-31"><a href="#cb158-31" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Thu"</span>, <span class="st">"Fri"</span>, <span class="st">"Sat"</span>, <span class="st">"Sun"</span>)) <span class="sc">+</span> </span>
<span id="cb158-32"><a href="#cb158-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">name =</span> <span class="cn">NULL</span>, </span>
<span id="cb158-33"><a href="#cb158-33" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> monthlbs<span class="sc">$</span>mean, </span>
<span id="cb158-34"><a href="#cb158-34" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> monthlbs<span class="sc">$</span>month, </span>
<span id="cb158-35"><a href="#cb158-35" aria-hidden="true" tabindex="-1"></a>                     <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb158-36"><a href="#cb158-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> year, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">strip.position =</span> <span class="st">"right"</span>) <span class="sc">+</span> </span>
<span id="cb158-37"><a href="#cb158-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb158-38"><a href="#cb158-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.border =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb158-39"><a href="#cb158-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb158-40"><a href="#cb158-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>, <span class="at">face =</span> <span class="st">"plain"</span>, <span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb158-41"><a href="#cb158-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">0.25</span>),</span>
<span id="cb158-42"><a href="#cb158-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"plain"</span>, <span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb158-43"><a href="#cb158-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"plain"</span>, <span class="at">color =</span> <span class="st">"black"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.42" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.42-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.42-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.42-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.42: ggTimeSeries包绘制的时序数据日历热图
</figcaption>
</figure>
</div>
</div>
</div>
<p>openair包中的<code>calendarPlot()</code>函数是基于lattice包<code>levelplot()</code>函数封装而成，是最简单的绘制绘制日历热图的方法。该函数绘制的日历热图风格与ggTimeSeries有所不同：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(openair)</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 将R环境改为英文模式，以让日期显示更美观</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setlocale</span>(<span class="at">category  =</span> <span class="st">"LC_ALL"</span>, <span class="at">locale =</span> <span class="st">"C"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "C"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="fu">calendarPlot</span>(df, <span class="at">pollutant =</span> <span class="st">"value"</span>, <span class="at">year =</span> <span class="dv">2021</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.43" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.43-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.43-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.43-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.43: openair包绘制的时序数据日历热图
</figcaption>
</figure>
</div>
</div>
</div>
<p>ggplot2的<code>geom_tile()</code>函数结合分面绘图方法也可以实现日期热图，但需要对时序数据进行加工，生成新的绘图变量。例如生成周天(weekday，周一至周日)映射到x轴，生成月周数(monthweek，1<sub>6)变量映射到y轴，用<code>geom_tile()</code>函数生成方块，将时序数值变量以颜色填充到方块中，利用<code>geom_text()</code>函数将月日数(monthday，1</sub>31)变量填充到方块中，再以月份(month)变量分面绘图，最后对图形细节进行调整。</p>
</section>
</section>
<section id="可视化变量频数分布" class="level3" data-number="3.4.5">
<h3 data-number="3.4.5" class="anchored" data-anchor-id="可视化变量频数分布"><span class="header-section-number">3.4.5</span> 可视化变量频数分布</h3>
<section id="统计直方图和核密度估计图" class="level4" data-number="3.4.5.1">
<h4 data-number="3.4.5.1" class="anchored" data-anchor-id="统计直方图和核密度估计图"><span class="header-section-number">3.4.5.1</span> 统计直方图和核密度估计图</h4>
<p>统计直方图(histogram)和前面提到的柱形图(bar chart)很相似，但后者主要用于类别变量的比较，而前者用于对数值变量执行分组(也称分箱，bin)统计并可视化，x轴为数值变量的取值范围，y轴为频数，柱形高度是该落入对应分箱中的频数，柱形宽度是该分箱的取值范围，所有分箱宽度相同。直方图能够显示各组频数的分布情况，可以判断该数值变量的分布类型和偏态。 核密度估计图(kernel density plot)是直方图的变体，使用平滑曲线来拟合频数分布，与直方图相比，可密度图不受分组(分箱)数量多少的影响，能够更清晰地呈现数据分布形状，用户可以将这2种可视化方法结合在一起使用。</p>
<p>ggplot2中的<code>geom_histogram()</code>函数和<code>geom_density()</code>函数分别用于绘制直方图和核密度估计图，前者中重要的参数是<code>binwidth</code>(分箱宽度)和<code>bins</code>(分箱总数)，后者中的主要参数是bw(平滑带宽)和kernel(核函数，默认是”gaussian”)。绘制统计直方图，y轴映射可以选择频数或频率，这需要在<code>aes()</code>函数设置<code>y = ..count..</code>或<code>y = ..density..</code>。</p>
<p>下面以 <a href="#fig-3.38" class="quarto-xref">图&nbsp;<span>3.38</span></a> 中使用的北京市PM<sub>2.5</sub>时序数据集为例，介绍这两种图形的绘制：</p>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="fu">unzip</span>(<span class="st">"./data/bj-pm2.5-data.zip"</span>,<span class="st">"PRSA_data_2010.1.1-2014.12.31.csv"</span>),</span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">col_names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>dfs <span class="ot">=</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2014</span>)</span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dfs, <span class="fu">aes</span>(<span class="at">x =</span> pm2<span class="fl">.5</span>, <span class="at">y =</span> ..count..)) <span class="sc">+</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">stat =</span> <span class="st">"bin"</span>, <span class="at">fill =</span> <span class="st">"orange"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dfs, <span class="fu">aes</span>(<span class="at">x =</span> pm2<span class="fl">.5</span>, <span class="at">y =</span> ..density..)) <span class="sc">+</span></span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">stat =</span> <span class="st">"bin"</span>, <span class="at">fill =</span> <span class="st">"orange"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">stat =</span> <span class="st">"density"</span>, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.44" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.44-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.44" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.44-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.44-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.44-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.44" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.44-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 频率分布直方图”
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.44" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.44-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.44-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.44-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.44" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.44-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 叠加核密度估计曲线
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.44-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.44: 频率分布直方图与核密度估计曲线
</figcaption>
</figure>
</div>
<p>如果要比较2010至2014年连续5年的PM<sub>2.5</sub>分布差异，可以用<code>geom_density()</code>同图绘制核密度估计曲线图，如 <a href="#fig-3.45-1" class="quarto-xref">图&nbsp;<span>3.45 (a)</span></a> 所示。显然，在曲线条数较多时，该方法并不可取，此时，建议使用ggplot2扩展包ggridges中的<code>geom_density_ridges()</code>来绘制峰峦图(ridge plot)，结果如 <a href="#fig-3.45-2" class="quarto-xref">图&nbsp;<span>3.45 (b)</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="ot">=</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2010</span><span class="sc">:</span><span class="dv">2014</span>)</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>dfs<span class="sc">$</span>year <span class="ot">=</span> <span class="fu">as.factor</span>(dfs<span class="sc">$</span>year) <span class="co"># year变量因子化</span></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dfs, <span class="fu">aes</span>(<span class="at">x =</span> pm2<span class="fl">.5</span>, <span class="at">group =</span> year)) <span class="sc">+</span></span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">color =</span> year), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggridges)</span>
<span id="cb163-12"><a href="#cb163-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-13"><a href="#cb163-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dfs, <span class="fu">aes</span>(<span class="at">x =</span> pm2<span class="fl">.5</span>, <span class="at">y =</span> year, <span class="at">fill =</span> year)) <span class="sc">+</span></span>
<span id="cb163-14"><a href="#cb163-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density_ridges</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb163-15"><a href="#cb163-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb163-16"><a href="#cb163-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb163-17"><a href="#cb163-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.45" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.45-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.45" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.45-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.45-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.45-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.45" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.45-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) ggplot2绘制
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.45" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.45-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.45-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.45-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.45" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.45-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) ggridges绘制
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.45-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.45: 多条核密度估计曲线对比
</figcaption>
</figure>
</div>
<p>ggplot2还提供了二维统计直方图和核密度估计图的绘制函数：<code>geom_bin2d()</code>、<code>geom_hex()</code>和<code>stat_density_2d()</code>。通过gplots包中的<code>hist2d()</code>函数计算二维统计直方图数值，再用plot3D包中的<code>hist3D()</code>函数绘制三维直方图。</p>
</section>
<section id="箱线图与小提琴图" class="level4" data-number="3.4.5.2">
<h4 data-number="3.4.5.2" class="anchored" data-anchor-id="箱线图与小提琴图"><span class="header-section-number">3.4.5.2</span> 箱线图与小提琴图</h4>
<p>箱线图(box plot)用箱体和线段来显示数据集的最大值、最小值、中位数以及上下四分位数，可以呈现连续型数据分布的中心位置和分布范围，还可以用来判断异常值。小提琴图(violin plot)则用对称的分布密度曲线来反映数据的分布范围和形状。可以将箱线图和小提琴图结合起来，弥补箱线图不能识别数据多峰的缺陷，以更全面地呈现数据的分布特征。</p>
<p>ggplot2中的<code>geom_boxplot()</code>和<code>geom_violin()</code>函数分别用于绘制箱线图和小提琴图。下面的代码仍然基于北京市PM<sub>2.5</sub>数据集，演示了箱线图和小提琴图的绘制，结果如 <a href="#fig-3.46" class="quarto-xref">图&nbsp;<span>3.46</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dfs, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> pm2<span class="fl">.5</span>, <span class="at">fill =</span> year)) <span class="sc">+</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>() <span class="sc">+</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">y =</span> <span class="fu">expression</span>(PM[<span class="fl">2.5</span>]))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-3.46" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.46-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.46-1.png" class="img-fluid figure-img" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.46-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.46: 箱线图与小提琴图的结合
</figcaption>
</figure>
</div>
</div>
</div>
<p>对于超过10000个观测的大数据集而言，由于箱线图模糊了太多数据信息，不再建议使用。</p>
</section>
</section>
<section id="可视化变量相关关系" class="level3" data-number="3.4.6">
<h3 data-number="3.4.6" class="anchored" data-anchor-id="可视化变量相关关系"><span class="header-section-number">3.4.6</span> 可视化变量相关关系</h3>
<section id="二维散点图" class="level4" data-number="3.4.6.1">
<h4 data-number="3.4.6.1" class="anchored" data-anchor-id="二维散点图"><span class="header-section-number">3.4.6.1</span> 二维散点图</h4>
<p>散点图(scatter plot)是最常见的用于呈现2-3个变量之间关系的可视化方法，可以显示变量之间是否存在数量关联趋势及其类型(线性关系还是非线性关系)，还可以用于观察是否存在异常值。</p>
<p>对于R内置数据集airquality，可以先用VIM包对Ozone和Solar.R变量的缺失值进行填补(K最近邻填补算法)，然后分别绘制Ozone变量与Solar.R、Temp、Wind变量的散点图：</p>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span>  airquality</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(Solar.R, Ozone)) <span class="sc">+</span> </span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(Wind, Ozone)) <span class="sc">+</span> </span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(Temp, Ozone)) <span class="sc">+</span> </span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.47" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.47-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.47" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.47-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.47-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.47-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.47" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.47-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Ozone与Solar.R
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.47" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.47-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.47-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.47-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.47" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.47-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Ozone与Wind
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.47" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.47-3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.47-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.47-3.png" class="img-fluid figure-img" data-ref-parent="fig-3.47" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.47-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) Ozone与Temp
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.47-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.47: 散点图
</figcaption>
</figure>
</div>
<p>绘制散点图时，可附加其他变量到点大小(size)、点颜色(color)、点形状(shape)的映射，从而显示更多维变量关系。当数据点过多而出现较多重叠时，可设置透明度(alpha)以反映重叠程度。</p>
<p>如果需要绘制三个变量的散点图，可采用scatterplot3d包中<code>scatterplot3d()</code>函数、rgl包中的<code>plot3D()</code>函数、或plot3D包中的<code>scatter3D()</code>函数。</p>
</section>
<section id="sec-cormatvis" class="level4" data-number="3.4.6.2">
<h4 data-number="3.4.6.2" class="anchored" data-anchor-id="sec-cormatvis"><span class="header-section-number">3.4.6.2</span> 相关矩阵图</h4>
<p>对于多维变量数据集，为了探索各变量之间的相关关系，可以先计算相关系数矩阵，然后再用颜色(颜色深浅表征相关系数大小，两种颜色对应相关方向)、圆形(面积表征相关系数大小，两种颜色对应相关方向)或椭圆(离心率表征相关系数大小，长轴方向表征相关方向)等来可视化相关系数。这样的图称为相关矩阵图(correlation matrix plot)。</p>
<p>ggplot2包中的<code>geom_tile()</code>函数可用来绘制相关矩阵图，但使用corrplot包提供的<code>corrplot()</code>函数和ggcorrplot包提供的<code>ggcorrplot()</code>函数更简单。</p>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>dfm <span class="ot">=</span> df[, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]  <span class="co"># 数据接图3-57</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">=</span> Hmisc<span class="sc">::</span><span class="fu">rcorr</span>(<span class="fu">as.matrix</span>(dfm))</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a><span class="fu">corrplot</span>(mat<span class="sc">$</span>r, <span class="at">method =</span> <span class="st">"circle"</span>, <span class="at">diag =</span> <span class="cn">FALSE</span>, <span class="at">tl.pos =</span> <span class="st">"d"</span>)</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a><span class="fu">corrplot</span>(mat<span class="sc">$</span>r, <span class="at">method =</span> <span class="st">"ellipse"</span>, <span class="at">diag =</span> <span class="cn">FALSE</span>, <span class="at">tl.pos =</span> <span class="st">"d"</span>)</span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a><span class="fu">corrplot</span>(mat<span class="sc">$</span>r, <span class="at">method =</span> <span class="st">"color"</span>, <span class="at">type =</span> {<span class="st">"lower"</span>}, <span class="at">order =</span> <span class="st">"AOE"</span>,</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">addCoef.col =</span> <span class="st">"black"</span>, <span class="at">diag =</span> <span class="cn">FALSE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.48" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.48-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.48" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.48-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.48-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.48-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.48" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.48-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) method = ‘circle’
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.48" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.48-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.48-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.48-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.48" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.48-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) method = ‘ellipse’
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.48" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.48-3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.48-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.48-3.png" class="img-fluid figure-img" data-ref-parent="fig-3.48" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.48-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) method = ‘color’
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.48-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.48: corrplot包绘制的相关矩阵图
</figcaption>
</figure>
</div>
<p>还有很多可视化方法来呈现变量或对象间的关系，如和弦图(chord diagram)、桑基图(sankey diagram)、韦恩图(venn diagram)等，都可以用R来实现，具体参考<a href="https://www.r-graph-gallery.com">The R Graph Gallery</a>和<a href="https://r-charts.com/">R CHARTS</a>上的示例。</p>
</section>
</section>
<section id="其他可视化类型" class="level3" data-number="3.4.7">
<h3 data-number="3.4.7" class="anchored" data-anchor-id="其他可视化类型"><span class="header-section-number">3.4.7</span> 其他可视化类型</h3>
<section id="地理空间数据可视化" class="level4" data-number="3.4.7.1">
<h4 data-number="3.4.7.1" class="anchored" data-anchor-id="地理空间数据可视化"><span class="header-section-number">3.4.7.1</span> 地理空间数据可视化</h4>
<p>现实世界中的数据几乎都具有地理位置信息(经纬度)。在需要展示地理位置信息时，就需要绘制相关的地图，将有关属性数据与地理位置信息结合在一起可视化。由于地球是一个不规则的椭球，将曲面转化为平面是一个复杂的转换过程，导致地理空间数据比一般数据要复杂，除了位置信息，还要有CRS(coordinate reference system)信息，包括坐标系(地心坐标系和参心坐标系)和投影方法(墨卡托投影、高斯-克吕格投影、阿伯斯投影、兰勃特投影等)等。我国平面地图一般采用高斯-克吕格投影，参心坐标系有北京54坐标系、西安80坐标系和2000国家大地坐标系，世界通用的地心坐标系是WGS-84坐标系。</p>
<p>地理空间数据包括矢量数据(vector data)和栅格数据(raster data)，对应矢量地图和栅格地图。矢量数据由顶点和路径的几何特征组成，分为点、线和面(多边形)；栅格数据是单元格矩阵(例如像素)，每个单元格包含高度、温度、降雨量、污染物浓度等信息，例如遥感卫星图像等。由于GIS软件很多，标准不统一，导致地理空间数据存储格式多种多样，最常见是矢量地图数据格式是shp(ESRI，在同目录下包含多个同名的其他文件，如<em>.shx</em>，.dbf等)和json(GeoJSON)，遥感影像的格式一般是GeoTIFF类型，扩展名为tiff或tif。</p>
<p>可视化地理空间数据的R包有很多，包括ggplot2、ggspatial、ggmap、tmap、sf、sp、terra、raster、rasterVis、leaflet等，可绘制静态和动态的地图。</p>
<p>下面比较一下terra、sf和ggplot2可视化lux.shp地图数据(terra包自带地图数据集)的效果，结果如 <a href="#fig-3.49" class="quarto-xref">图&nbsp;<span>3.49</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>mf <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">"ex/lux.shp"</span>, <span class="at">package =</span> <span class="st">"terra"</span>)</span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>p_lux <span class="ot">=</span> <span class="fu">vect</span>(mf)</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>d_lux <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">read_sf</span>(mf)</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制terra的SpatVector地图对象</span></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p_lux, <span class="st">"NAME_1"</span>)</span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制sf地图对象</span></span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d_lux[<span class="st">"NAME_1"</span>], <span class="at">key.pos =</span> <span class="dv">4</span>, <span class="at">main =</span> <span class="st">""</span>)</span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 基于ggplot2绘制sf地图对象</span></span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_lux) <span class="sc">+</span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> NAME_1)) <span class="sc">+</span></span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.49" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.49-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.49" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.49-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.49-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.49-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.49" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.49-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) terra包绘制SpatVector地图对象
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.49" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.49-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.49-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.49-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.49" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.49-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) sf包绘制sf地图对象
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.49" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.49-3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.49-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.49-3.png" class="img-fluid figure-img" data-ref-parent="fig-3.49" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.49-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) ggplot2包绘制sf地图对象
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.49-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.49: 绘制地图
</figcaption>
</figure>
</div>
<p>terra和sf都是基于扩展的<code>plot()</code>函数来绘制地图。ggplot2可以通过<code>geom_map()</code>和<code>geom_sf()</code>函数来绘制地图，其中前者支持sp对象(SpatialPolygonsDataFrame)，后者支持sf(simple feature)对象，最为常用。 tmap可以采用类似ggplot2的语法创建多个图层的地图，ggspatial是ggplot2的扩展，而leaflet包则可以创建动态交互的地图。具体使用可参考相应工具包的帮助信息。地图最重要的应用是结合其他可视化类型，如密度图、气泡图、柱形图等。</p>
<p>下面的案例从阿里云导入合肥市辖区地区，然后添加合肥市10个空气质量国控监测点及某时点PM<sub>2.5</sub>浓度值，结果如 <a href="#fig-3.50" class="quarto-xref">图&nbsp;<span>3.50</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)    <span class="co"># 用于解决文本标签重叠问题</span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 从阿里云下载合肥市地图，并转化为sf类型</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>map_hefei <span class="ot">=</span> <span class="fu">read_sf</span>(</span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"https://geo.datav.aliyun.com/areas_v3/bound/340100_full.json"</span></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 选择四个市辖区</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>map_hefei <span class="ot">=</span> map_hefei[</span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>  map_hefei<span class="sc">$</span>name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"蜀山区"</span>, <span class="st">"瑶海区"</span>, <span class="st">"包河区"</span>, <span class="st">"庐阳区"</span>), ]</span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a>cp1 <span class="ot">=</span> <span class="fu">as.data.frame</span>(map_hefei[<span class="fu">c</span>(<span class="st">"name"</span>, <span class="st">"centroid"</span>)])</span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 将中心坐标一分为二的自定义函数</span></span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>func_cp <span class="ot">&lt;-</span><span class="cf">function</span>(x){<span class="fu">data.frame</span>(<span class="at">x1 =</span> x[<span class="dv">1</span>], <span class="at">x2 =</span> x[<span class="dv">2</span>])}   </span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>dfcp1 <span class="ot">=</span> <span class="fu">cbind</span>(</span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> cp1<span class="sc">$</span>name,</span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(cp1<span class="sc">$</span>centroid, func_cp)),</span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a>hf_pm25 <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">stid =</span> <span class="fu">paste0</span>(<span class="st">"X"</span>, <span class="dv">1270</span><span class="sc">:</span><span class="dv">1279</span>, <span class="st">"A"</span>),</span>
<span id="cb168-21"><a href="#cb168-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"明珠广场"</span>, <span class="st">"三里街"</span>, <span class="st">"琥珀山庄"</span>, <span class="st">"董铺水库"</span>, <span class="st">"长江中路"</span>,</span>
<span id="cb168-22"><a href="#cb168-22" aria-hidden="true" tabindex="-1"></a>           <span class="st">"庐阳区"</span>, <span class="st">"瑶海区"</span>, <span class="st">"包河区"</span>, <span class="st">"滨湖新区"</span>, <span class="st">"高新区"</span>),</span>
<span id="cb168-23"><a href="#cb168-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">lon =</span> <span class="fu">c</span>(<span class="fl">117.1959</span>, <span class="fl">117.3072</span>, <span class="fl">117.2588</span>, <span class="fl">117.1604</span>, <span class="fl">117.25</span>,</span>
<span id="cb168-24"><a href="#cb168-24" aria-hidden="true" tabindex="-1"></a>          <span class="fl">117.266</span>, <span class="fl">117.336</span>, <span class="fl">117.3027</span>, <span class="fl">117.2776</span>, <span class="fl">117.1318</span>),</span>
<span id="cb168-25"><a href="#cb168-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">lat =</span> <span class="fu">c</span>(<span class="fl">31.7848</span>, <span class="fl">31.8764</span>, <span class="fl">31.8707</span>, <span class="fl">31.9052</span>, <span class="fl">31.8571</span>,</span>
<span id="cb168-26"><a href="#cb168-26" aria-hidden="true" tabindex="-1"></a>          <span class="fl">31.9436</span>, <span class="fl">31.8586</span>, <span class="fl">31.7964</span>, <span class="fl">31.7385</span>, <span class="fl">31.8403</span>),</span>
<span id="cb168-27"><a href="#cb168-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">pm2.5 =</span> <span class="fu">c</span>(<span class="dv">34</span>, <span class="dv">36</span>, <span class="dv">35</span>, <span class="dv">29</span>, <span class="dv">32</span>, <span class="dv">35</span>, <span class="dv">36</span>, <span class="dv">38</span>, <span class="dv">33</span>, <span class="dv">36</span>))</span>
<span id="cb168-28"><a href="#cb168-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-29"><a href="#cb168-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb168-30"><a href="#cb168-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> map_hefei, <span class="at">fill =</span> <span class="st">"white"</span>, </span>
<span id="cb168-31"><a href="#cb168-31" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> .<span class="dv">5</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb168-32"><a href="#cb168-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> dfcp1, <span class="fu">aes</span>(<span class="at">x =</span> X1, <span class="at">y =</span> X2, <span class="at">label =</span> name),</span>
<span id="cb168-33"><a href="#cb168-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">check_overlap =</span> T, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color=</span><span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb168-34"><a href="#cb168-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb168-35"><a href="#cb168-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"经度"</span>, <span class="at">y=</span><span class="st">"纬度"</span>) <span class="sc">+</span> </span>
<span id="cb168-36"><a href="#cb168-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> hf_pm25, <span class="fu">aes</span>(<span class="at">x=</span>lon, <span class="at">y=</span>lat),</span>
<span id="cb168-37"><a href="#cb168-37" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"green"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb168-38"><a href="#cb168-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="at">data =</span> hf_pm25, <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat <span class="sc">*</span> <span class="fl">1.0003</span>, <span class="at">label =</span> name),</span>
<span id="cb168-39"><a href="#cb168-39" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb168-40"><a href="#cb168-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="at">data =</span> hf_pm25, <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat <span class="sc">*</span> <span class="fl">0.9996</span>, <span class="at">label =</span> pm2<span class="fl">.5</span>),</span>
<span id="cb168-41"><a href="#cb168-41" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span><span class="dv">3</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-3.50" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.50-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./images/fig3.50.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.50-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.50: 地图与其他数据的集成可视化
</figcaption>
</figure>
</div>
</div>
</div>
<p>除此以外，R语言还可以处理高程数据(DEM)和遥感影像数据。<a href="https://www.rayshader.com/">rayshader</a>包使用高程数据以及光线跟踪、山坡阴影算法和覆盖的组合来生成效果惊人的2D和3D地图，下面的代码为该包中的示例代码，效果如 <a href="#fig-3.51" class="quarto-xref">图&nbsp;<span>3.51</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rayshader)</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 下载高程图压缩包并解压，然后以raster包来加载数据</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="st">"https://tylermw.com/data/dem_01.tif.zip"</span>, <span class="st">"./data/dem_01.zip"</span>)</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>dem_tif <span class="ot">=</span> raster<span class="sc">::</span><span class="fu">raster</span>(<span class="fu">unzip</span>(<span class="st">"./data/dem_01.zip"</span>, <span class="st">"dem_01.tif"</span>))</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 将高程图数据转换为矩阵</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>elmat <span class="ot">=</span> <span class="fu">raster_to_matrix</span>(dem_tif)</span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 2D图形绘制</span></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>elmat <span class="sc">%&gt;%</span></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sphere_shade</span>(<span class="at">texture =</span> <span class="st">"desert"</span>) <span class="sc">%&gt;%</span>  <span class="co"># 添加内置纹理</span></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_water</span>(<span class="fu">detect_water</span>(elmat), <span class="at">color =</span> <span class="st">"desert"</span>) <span class="sc">%&gt;%</span>  <span class="co"># 检测并添加水系</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>  rayshader<span class="sc">::</span><span class="fu">add_shadow</span>(<span class="fu">ray_shade</span>(elmat), <span class="fl">0.5</span>) <span class="sc">%&gt;%</span>  <span class="co"># 添加阴影</span></span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_map</span>()</span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 3D图形绘制</span></span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>elmat <span class="sc">%&gt;%</span></span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sphere_shade</span>(<span class="at">texture =</span> <span class="st">"desert"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_water</span>(<span class="fu">detect_water</span>(elmat), <span class="at">color =</span> <span class="st">"desert"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a>  rayshader<span class="sc">::</span><span class="fu">add_shadow</span>(<span class="fu">ray_shade</span>(elmat, <span class="at">zscale =</span> <span class="dv">3</span>), <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a>  rayshader<span class="sc">::</span><span class="fu">add_shadow</span>(<span class="fu">ambient_shade</span>(elmat), <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 设置3D图形参数</span></span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_3d</span>(elmat, <span class="at">zscale =</span> <span class="dv">10</span>, <span class="at">fov =</span> <span class="dv">0</span>, <span class="at">theta =</span> <span class="dv">135</span>, <span class="at">zoom =</span> <span class="fl">0.75</span>, </span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a>          <span class="at">phi =</span> <span class="dv">45</span>, <span class="at">windowsize =</span> <span class="fu">c</span>(<span class="dv">1000</span>, <span class="dv">800</span>))  </span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.sleep</span>(<span class="fl">0.2</span>)</span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a><span class="fu">render_snapshot</span>()  <span class="co"># 渲染</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.51" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.51-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.51" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.51-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.51-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.51-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.51" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.51-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 2D高程图
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.51" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.51-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.51-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.51-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.51" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.51-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 3D高程图
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.51-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.51: 高程图
</figcaption>
</figure>
</div>
<p>特别需要注意的是，地图涉及国家主权，使用时必须严格遵守相关法律法规。</p>
</section>
<section id="标量与向量场可视化" class="level4" data-number="3.4.7.2">
<h4 data-number="3.4.7.2" class="anchored" data-anchor-id="标量与向量场可视化"><span class="header-section-number">3.4.7.2</span> 标量与向量场可视化</h4>
<p>等高线图(contour map)是以二维图形呈现三维变量关系的一种可视化方法，这在标量场(scalar filed)的可视化中经常使用，例如气象预报中的等压线、等温线以及地图中的等高线等，可以探究某个变量与其他相关的两个变量的关系。</p>
<p>R内置数据集faithfuld包含美国黄石公园Old Faithful喷泉喷发时长(eruptions)、间隔时长(waiting)及概率密度估计(density)数据。以下代码演示了ggplot2基于该数据集绘制等高线图以及颜色填充的等高线图的方法，结果如 <a href="#fig-3.52" class="quarto-xref">图&nbsp;<span>3.52</span></a> 所示。</p>
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggplot</span>(faithfuld, <span class="fu">aes</span>(waiting, eruptions, <span class="at">z =</span> density))</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 默认等高线图</span></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_contour</span>()</span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 颜色填充的等高线图</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_contour_filled</span>() </span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 等高线叠加颜色填充的等高线图</span></span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">geom_raster</span>(<span class="fu">aes</span>(<span class="at">fill =</span> density)) <span class="sc">+</span> </span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_contour</span>(<span class="at">colour =</span> <span class="st">"white"</span>) </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.52" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.52-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.52" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.52-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.52-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.52-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.52" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.52-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 默认等高线图
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.52" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.52-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.52-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.52-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.52" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.52-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 颜色填充的等高线图
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.52" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-3.52-3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.52-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.52-3.png" class="img-fluid figure-img" data-ref-parent="fig-3.52" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.52-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) 等高线叠加颜色填充的等高线图
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.52-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.52: 等高线图
</figcaption>
</figure>
</div>
<p>风场数据包括风速和风向，流体动力学数据也包括流速和流向，此类向量场(vector field)或流场(flow field)数据的可视化与标量场不同，一般采用带箭头的线段来进行可视化。在可视化前，一般将通过三角函数将向量<span class="math inline">(d,\theta)</span>转化为水平和垂直两个方向上的分量<span class="math inline">(u,v)</span>。ggplot2包中的<code>geom_segment()</code>函数和rasterVis包中的<code>vectorplot()</code>函数以及pracma包中的<code>vectorplot()</code>函数都可以实现向量场数据的可视化。</p>
<p>下面演示用rasterVis包来可视化流场数据。</p>
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rasterVis)</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 构造两个RasterLayer对象u和v</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> v <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="at">xmn=</span><span class="dv">0</span>, <span class="at">xmx=</span><span class="dv">2</span>, <span class="at">ymn=</span><span class="dv">0</span>, <span class="at">ymx=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="fl">1e3</span>, <span class="at">nrow=</span><span class="fl">1e3</span>)</span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 根据u和v生成具有初始值的RasterLayer对象</span></span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">init</span>(u, <span class="at">fun=</span><span class="st">'x'</span>)</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">init</span>(u, <span class="at">fun=</span><span class="st">'y'</span>)</span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 由x和y重新构造u和v</span></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> y <span class="sc">*</span> <span class="fu">cos</span>(x)</span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> y <span class="sc">*</span> <span class="fu">sin</span>(x) </span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 构造RasterStack对象(具有相同空间范围和分辨率的RasterLayer对象的集合)</span></span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a>field <span class="ot">&lt;-</span> <span class="fu">stack</span>(u, v)</span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(field) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'u'</span>, <span class="st">'v'</span>)</span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 以u和v合成值为背景的流场图</span></span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a><span class="fu">vectorplot</span>(field, <span class="at">isField=</span><span class="st">'dXY'</span>, <span class="at">narrows=</span><span class="fl">5e2</span>)</span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 以u和v各自值为背景的流场图</span></span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a><span class="fu">vectorplot</span>(field, <span class="at">isField=</span><span class="st">'dXY'</span>, <span class="at">narrows=</span><span class="fl">5e2</span>, <span class="at">region=</span>field)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-3.53" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3.53-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.53" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.53-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.53-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.53-1.png" class="img-fluid figure-img" data-ref-parent="fig-3.53" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.53-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 以u和v合成值为背景的流场图
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-3.53" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-3.53-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-3.53-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CH3_files/figure-html/fig-3.53-2.png" class="img-fluid figure-img" data-ref-parent="fig-3.53" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-3.53-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 以u和v各自值为背景的流场图
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3.53-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;3.53: rasterVis包绘制的风场图
</figcaption>
</figure>
</div>
<p>总而言之，R语言的可视化功能非常强大，而且学习资源丰富，用户可根据需要，选择和学习相关的工具包，快速掌握R语言的数据可视化方法。</p>
<div id="exr-3.2" class="theorem exercise">
<p><span class="theorem-title"><strong>练习 3.2</strong></span> <br>
从https://archive.ics.uci.edu/dataset/106/water+treatment+plant网址下载Water Treatment Plant数据集，在RStudio中建立一个基于Quarto格式的 数据处理项目，项目目录名为WTP，并在其中创建一个名为data的子目录，将下载的数据压缩包中的文件解压到data目录中。在项目中新建一个名为main.qmd的Quarto文件，其在中对该数据集进行预处理和可视化，主要内容包括：读入数据(见water-treatment.data文件)并添加列名(列名与故障类型等见water-treatment.names文件)，统计摘要分析，对缺失值进行可视化并采取相应处理措施，通过合理的可视化方法展示进水变量和出水变量以及与水处理性能变量之间的变化关系，各个环节应添加必要的描述和结果分析，绘制图形不少于10个，类型不少于5个。注意，数据集中第一列数据为日期数据，其后为38个属性数据，其中问号表示数据缺失。</p>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "已复制");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "已复制");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./CH2.html" class="pagination-link" aria-label="R语言编程基础">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">R语言编程基础</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./CH4.html" class="pagination-link" aria-label="环境数据统计分析">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">环境数据统计分析</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>环境数据分析与机器学习，邓大鹏 编著.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>本书采用<a href="https://quarto.org/">Quarto</a>构建.</p>
</div>
  </div>
</footer>




</body></html>